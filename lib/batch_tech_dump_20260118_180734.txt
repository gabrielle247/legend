
// ==========================================
// FILE: ./main.dart
// ==========================================

import 'app_libs.dart';

void main() async {
  // ---------------------------------------------------------------------------
  // 1. SYSTEM INITIALIZATION
  // ---------------------------------------------------------------------------
  await AppInit.initialize();
  final supabaseClient = Supabase.instance.client;

  // ---------------------------------------------------------------------------
  // 2. BUILD DATA LAYER (Repositories)
  // ---------------------------------------------------------------------------
  final authRepository = AuthRepository(supabaseClient);
  final schoolRepository = SchoolRepository(supabaseClient);

  final dashboardRepository = DashboardRepository();
  final studentRepository = StudentRepository();
  final financeRepository = PowerSyncFinanceRepository();

  // ---------------------------------------------------------------------------
  // 3. BUILD SERVICE LAYER
  // ---------------------------------------------------------------------------
  final authService = AuthService(authRepository, schoolRepository);

  // ---------------------------------------------------------------------------
  // 4. LAUNCH APP WITH PROVIDERS
  // ---------------------------------------------------------------------------
  runApp(
    MultiProvider(
      providers: [
        // =========================
        // CORE SERVICE
        // =========================
        ChangeNotifierProvider<AuthService>(
          create: (_) => authService,
        ),

        // =========================
        // REPOSITORIES
        // =========================
        Provider<AuthRepository>(create: (_) => authRepository),
        Provider<DashboardRepository>(create: (_) => dashboardRepository),
        Provider<StudentRepository>(create: (_) => studentRepository),
        Provider<FinanceRepository>(create: (_) => financeRepository),

        // =========================
        // GLOBAL VIEW MODELS
        // =========================

        ChangeNotifierProvider<SettingsViewModel>(
          create: (context) => SettingsViewModel(
            context.read<AuthService>(),
            context.read<DashboardRepository>(),
          ),
        ),

        ChangeNotifierProvider<FinanceViewModel>(
          create: (context) => FinanceViewModel(
            context.read<FinanceRepository>(),
            context.read<AuthService>(),
          ),
        ),

        ChangeNotifierProvider<DashboardViewModel>(
          create: (context) => DashboardViewModel(
            context.read<DashboardRepository>(),
            context.read<AuthService>(),
          ),
        ),

        // Student list depends on schoolId (from AuthService)
        ChangeNotifierProxyProvider<AuthService, StudentListViewModel>(
          create: (context) => StudentListViewModel(
            context.read<StudentRepository>(),
            context.read<AuthService>().activeSchool?.id ?? '',
          ),
          update: (context, auth, previous) {
            final schoolId = auth.activeSchool?.id ?? '';

            // Reuse existing VM if schoolId unchanged
            if (previous != null && previous.schoolId == schoolId) {
              return previous;
            }

            return StudentListViewModel(
              context.read<StudentRepository>(),
              schoolId,
            );
          },
        ),

        // StatsViewModel now requires FinanceRepository too
        ChangeNotifierProvider<StatsViewModel>(
          create: (context) => StatsViewModel(
            context.read<DashboardRepository>(),
            context.read<FinanceRepository>(),
            context.read<AuthService>(),
          ),
        ),
      ],
      child: const KwaLegendApp(),
    ),
  );
}

// ==========================================
// FILE: ./app_libs.dart
// ==========================================

// ==========================================
// FILE: ./app_libs.dart
// ==========================================

// -----------------------------------------------------------------------------
// 1. DART CORE
// -----------------------------------------------------------------------------
export 'dart:convert';
export 'dart:math';

// -----------------------------------------------------------------------------
// 2. FLUTTER
// -----------------------------------------------------------------------------
export 'package:flutter/foundation.dart';
export 'package:flutter/material.dart' hide Table;

// NOTE: Do NOT export Cupertino here (RefreshCallback clash).
// If a file needs Cupertino, import it locally in that file.
// export 'package:flutter/cupertino.dart'; // intentionally not exported

// -----------------------------------------------------------------------------
// 3. 3RD PARTY PACKAGES
// -----------------------------------------------------------------------------
export 'package:go_router/go_router.dart';
export 'package:google_nav_bar/google_nav_bar.dart';
export 'package:provider/provider.dart';
export 'package:supabase_flutter/supabase_flutter.dart';
export 'package:shared_preferences/shared_preferences.dart';
export 'package:google_fonts/google_fonts.dart';
export 'package:intl/intl.dart' hide TextDirection;
export 'package:uuid/uuid.dart';

// -----------------------------------------------------------------------------
// 4. APP CORE
// -----------------------------------------------------------------------------
export 'package:legend/app.dart';
export 'package:legend/app_init.dart';
export 'package:legend/app_router.dart';

// -----------------------------------------------------------------------------
// 5. CONSTANTS
// -----------------------------------------------------------------------------
export 'package:legend/data/constants/app_constants.dart';
export 'package:legend/data/constants/app_strings.dart';
export 'package:legend/data/constants/subjects.dart';

// -----------------------------------------------------------------------------
// 6. MODELS
// -----------------------------------------------------------------------------
export 'package:legend/data/models/all_models.dart';

// -----------------------------------------------------------------------------
// 7. REPOSITORIES
// -----------------------------------------------------------------------------
export 'package:legend/data/repo/auth/auth.dart';
export 'package:legend/data/repo/auth/school_repo.dart';
export 'package:legend/data/repo/dashboard_repo.dart';
export 'package:legend/data/repo/financial_repo.dart';
export 'package:legend/data/repo/student_repo.dart';

// -----------------------------------------------------------------------------
// 8. SERVICES
// -----------------------------------------------------------------------------
export 'package:legend/data/services/database_serv.dart';
export 'package:legend/data/services/auth/auth.dart';
export 'package:legend/data/services/auth/no_auth_screen.dart';
export 'package:legend/data/services/powersync/supa_connector.dart';
export 'package:legend/data/services/powersync/powersync_factory.dart';

// -----------------------------------------------------------------------------
// 9. VIEW MODELS
// -----------------------------------------------------------------------------
export 'package:legend/data/vmodels/add_student_view_model.dart';
export 'package:legend/data/vmodels/dashboard_vmodel.dart';
export 'package:legend/data/vmodels/finance_vmodel.dart';
export 'package:legend/data/vmodels/settings_vmodel.dart';
export 'package:legend/data/vmodels/stats_view_model.dart';
export 'package:legend/data/vmodels/student_logs_view_model.dart';
export 'package:legend/data/vmodels/students_vmodel.dart';

// -----------------------------------------------------------------------------
// 10. UI
// -----------------------------------------------------------------------------
export 'package:legend/screens/all_screens_export.dart';
export 'package:legend/screens/dashboard/notifications/noti_viewer.dart';
export 'package:legend/screens/utils/subject_selector_field.dart';

export 'package:legend/data/constants/app_routes.dart';
export 'package:legend/screens/finance/logging_payments.dart';
export 'package:legend/screens/settings/splash_screen.dart';
// ==========================================
// FILE: ./data/vmodels/settings_vmodel.dart
// ==========================================

import 'dart:async';

import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/dashboard_repo.dart';
import 'package:legend/data/services/auth/auth.dart';
import 'package:legend/data/services/billing/billing_engine.dart';
import 'package:legend/data/services/database_serv.dart';
import 'package:legend/data/constants/app_strings.dart';
import 'package:powersync/powersync.dart';
import 'package:shared_preferences/shared_preferences.dart';

class SettingsViewModel extends ChangeNotifier {
  final AuthService _authService;
  final DashboardRepository _dashboardRepo;

  bool isLoading = true;
  String? error;

  bool isDarkMode = true;
  bool pushNotifications = true;

  LegendProfile? userProfile;
  String? schoolName;

  SyncStatus? _syncStatus;
  String _syncStatusLabel = AppStrings.subSyncUnknown;
  StreamSubscription<SyncStatus>? _syncSub;
  bool _autoBillingEnabled = false;
  String? _autoBillingError;
  bool _autoBillingLocked = false;
  bool _isDeletingData = false;

  String? get userName => userProfile?.fullName;
  String? get userRole => userProfile?.role;
  String get syncStatusLabel => _syncStatusLabel;
  SyncStatus? get syncStatus => _syncStatus;
  bool get autoBillingEnabled => _autoBillingEnabled;
  String? get autoBillingError => _autoBillingError;
  bool get autoBillingLocked => _autoBillingLocked;
  bool get isDeletingData => _isDeletingData;

  SettingsViewModel(this._authService, this._dashboardRepo);

  Future<void> init() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      await _loadSettings();
      await _loadContext();
      _startSyncWatch();
      await _loadAutoBilling();
    } catch (e) {
      error = e.toString();
      debugPrint("SettingsViewModel.init error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  Future<void> _loadSettings() async {
    final prefs = await SharedPreferences.getInstance();
    isDarkMode = prefs.getBool('isDarkMode') ?? true;
    pushNotifications = prefs.getBool('pushNotifications') ?? true;
  }

  Future<void> _saveSettings() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('isDarkMode', isDarkMode);
    await prefs.setBool('pushNotifications', pushNotifications);
  }

  Future<void> toggleDarkMode() async {
    isDarkMode = !isDarkMode;
    await _saveSettings();
    notifyListeners();
  }

  Future<void> togglePushNotifications() async {
    pushNotifications = !pushNotifications;
    await _saveSettings();
    notifyListeners();
  }

  Future<void> _loadContext() async {
    final user = _authService.user;
    final school = _authService.activeSchool;

    schoolName = school?.name;

    if (user == null) {
      userProfile = null;
      return;
    }

    // If profile is missing, keep it null but do not lie to UI.
    userProfile = await _dashboardRepo.getUserProfile(user.id);
  }

  Future<void> _loadAutoBilling() async {
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) return;
    _autoBillingEnabled = await BillingEngine().isAutoBillingEnabled(schoolId);
  }

  void _startSyncWatch() {
    _syncSub?.cancel();

    final current = DatabaseService().currentStatus;
    if (current != null) {
      _syncStatus = current;
      _syncStatusLabel = _formatSyncStatus(current);
      notifyListeners();
    }

    _syncSub = DatabaseService().statusStream.listen(
      (status) {
        _syncStatus = status;
        _syncStatusLabel = _formatSyncStatus(status);
        notifyListeners();
      },
      onError: (e) {
        _syncStatusLabel = "Sync error";
        notifyListeners();
      },
    );
  }

  Future<void> logout() async {
    try {
      await _authService.logout();
    } catch (e) {
      error = e.toString();
      debugPrint("SettingsViewModel.logout error: $e");
      notifyListeners();
      rethrow;
    }
  }

  Future<void> refresh() => init();

  String _formatSyncStatus(SyncStatus status) {
    if (status.anyError != null) return AppStrings.syncError;
    if (status.connecting) return AppStrings.syncConnecting;
    if (status.downloading || status.uploading) return AppStrings.syncSyncing;
    if (status.connected) {
      final last = status.lastSyncedAt;
      if (last != null) return "${AppStrings.syncLastSyncedPrefix}${_formatSyncTime(last)}";
      return AppStrings.syncConnected;
    }
    return status.hasSynced == true ? AppStrings.syncOfflineCached : AppStrings.syncOffline;
  }

  String _formatSyncTime(DateTime time) {
    final local = time.toLocal();
    final date = local.toIso8601String().split('T').first;
    final clock = local.toIso8601String().split('T').last.substring(0, 5);
    return "$date $clock";
  }

  @override
  void dispose() {
    _syncSub?.cancel();
    super.dispose();
  }

  Future<void> toggleAutoBilling(bool enabled) async {
    _autoBillingError = null;
    _autoBillingLocked = false;
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) return;

    if (enabled) {
      final ok = await BillingEngine().enableAutoBilling(schoolId);
      if (!ok) {
        _autoBillingError = AppStrings.autoBillingLockHeld;
        _autoBillingLocked = true;
        _autoBillingEnabled = false;
        notifyListeners();
        return;
      }
      _autoBillingEnabled = true;
      await BillingEngine().runDaily(schoolId);
    } else {
      await BillingEngine().disableAutoBilling(schoolId);
      _autoBillingEnabled = false;
    }

    notifyListeners();
  }

  Future<void> takeOverAutoBilling() async {
    _autoBillingError = null;
    _autoBillingLocked = false;
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) return;

    await BillingEngine().takeOverAutoBilling(schoolId);
    _autoBillingEnabled = true;
    await BillingEngine().runDaily(schoolId);
    notifyListeners();
  }

  Future<List<Map<String, dynamic>>> loadAutoBillingErrors() async {
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) return [];
    return BillingEngine().getErrorLog(schoolId);
  }

  Future<void> clearAutoBillingErrors() async {
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) return;
    await BillingEngine().clearErrorLog(schoolId);
  }

  Future<void> deleteAllStudentData() async {
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) {
      throw Exception(AppStrings.noActiveSchool);
    }

    _isDeletingData = true;
    notifyListeners();

    try {
      await _dashboardRepo.deleteAllStudentData(schoolId);
    } finally {
      _isDeletingData = false;
      notifyListeners();
    }
  }
}

// ==========================================
// FILE: ./data/vmodels/stats_view_model.dart
// ==========================================

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/dashboard_repo.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/services/auth/auth.dart';

class StatsData {
  final double totalRevenue;
  final double outstandingDebt;
  final int activeStudents;
  final List<FlSpot> revenueTrend;
  final List<Map<String, dynamic>> debtByGrade;
  final Map<String, double> paymentMethods;

  StatsData({
    this.totalRevenue = 0,
    this.outstandingDebt = 0,
    this.activeStudents = 0,
    this.revenueTrend = const [FlSpot(0, 0)],
    this.debtByGrade = const [],
    this.paymentMethods = const {},
  });
}

class StatsViewModel extends ChangeNotifier {
  final DashboardRepository _dashboardRepo;
  final FinanceRepository _financeRepo;
  final AuthService _authService;

  bool _isLoading = false;
  String? _error;
  StatsData _data = StatsData();
  String _timeFilter = 'This Term';
  String _gradeFilter = 'All Grades';
  List<String> _availableGrades = const [];

  bool get isLoading => _isLoading;
  String? get error => _error;
  StatsData get data => _data;
  String get timeFilter => _timeFilter;
  String get gradeFilter => _gradeFilter;
  List<String> get availableGrades => _availableGrades;

  StatsViewModel(this._dashboardRepo, this._financeRepo, this._authService);

  Future<void> loadStats({String? timeFilter, String? gradeFilter}) async {
    if (timeFilter != null) _timeFilter = timeFilter;
    if (gradeFilter != null) _gradeFilter = gradeFilter;

    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school found.");

      final range = await _resolveTimeRange(school.id, _timeFilter);

      // Single source of truth:
      // - totals come from finance stats
      // - charts come from dashboard repo trend queries
      final results = await Future.wait([
        range == null
            ? _dashboardRepo.getRevenueTrend(school.id)
            : _dashboardRepo.getRevenueTrendForRange(
                school.id,
                startDate: range.startDate,
                endDate: range.endDate,
              ),
        _dashboardRepo.getDebtByGrade(school.id),
        _dashboardRepo.getPaymentMethodStats(
          school.id,
          startDate: range?.startDate,
          endDate: range?.endDate,
        ),
        _dashboardRepo.getDashboardStats(school.id),
        _financeRepo.getFinanceStats(
          school.id,
          startDate: range?.startDate,
          endDate: range?.endDate,
        ),
      ]);

      final revenueRows = results[0] as List<Map<String, dynamic>>;
      final debtByGradeAll = results[1] as List<Map<String, dynamic>>;
      final paymentMethods = results[2] as Map<String, double>;
      final dashboardStats = results[3] as DashboardStats;
      final financeStats = results[4] as Map<String, dynamic>;

      // Chart spots (7 days trend)
      final List<FlSpot> spots = [];
      for (int i = 0; i < revenueRows.length; i++) {
        final row = revenueRows[i];
        final amount = (row['total'] as num?)?.toDouble() ?? 0.0;
        spots.add(FlSpot(i.toDouble(), amount / 1000.0));
      }
      if (spots.isEmpty) spots.add(const FlSpot(0, 0));

      _availableGrades = _extractGrades(debtByGradeAll);
      final debtByGrade = _filterDebtByGrade(debtByGradeAll, _gradeFilter);

      _data = StatsData(
        totalRevenue: (financeStats['totalRevenue'] as num?)?.toDouble() ?? 0.0,
        outstandingDebt: dashboardStats.totalOwed,
        activeStudents: dashboardStats.totalStudents,
        revenueTrend: spots,
        debtByGrade: debtByGrade,
        paymentMethods: paymentMethods,
      );
    } catch (e) {
      _error = e.toString();
      debugPrint("StatsViewModel.loadStats error: $e");
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> refresh() => loadStats(timeFilter: _timeFilter, gradeFilter: _gradeFilter);

  List<Map<String, dynamic>> _filterDebtByGrade(List<Map<String, dynamic>> data, String gradeFilter) {
    if (gradeFilter == 'All Grades') return data;
    return data.where((e) => (e['grade']?.toString() ?? '') == gradeFilter).toList();
  }

  List<String> _extractGrades(List<Map<String, dynamic>> data) {
    final grades = data
        .map((e) => e['grade']?.toString() ?? '')
        .where((g) => g.trim().isNotEmpty)
        .toList();
    final unique = <String>[];
    for (final g in grades) {
      if (!unique.contains(g)) unique.add(g);
    }
    return unique;
  }

  Future<_DateRange?> _resolveTimeRange(String schoolId, String filter) async {
    if (filter == 'This Term') {
      final term = await _dashboardRepo.getActiveTerm(schoolId);
      if (term == null) return null;
      return _DateRange(term.startDate, term.endDate);
    }
    if (filter == 'Last Term') {
      final active = await _dashboardRepo.getActiveTerm(schoolId);
      final before = active?.startDate ?? DateTime.now();
      final term = await _dashboardRepo.getPreviousTerm(schoolId, before);
      if (term == null) return null;
      return _DateRange(term.startDate, term.endDate);
    }
    return null;
  }
}

class _DateRange {
  final DateTime startDate;
  final DateTime endDate;
  _DateRange(this.startDate, this.endDate);
}

// ==========================================
// FILE: ./data/vmodels/finance_vmodel.dart
// ==========================================

import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/services/auth/auth.dart';
import 'package:uuid/uuid.dart';

class FinanceViewModel extends ChangeNotifier {
  final FinanceRepository _financeRepo;
  final AuthService _authService;
  final Uuid _uuid = const Uuid();

  bool isLoading = true;
  String? error;

  double totalRevenue = 0.0;
  double pendingAmount = 0.0;
  int unpaidInvoiceCount = 0;
  double percentGrowth = 0.0;

  List<double> monthlyCollections = [];
  List<String> monthLabels = [];

  List<Map<String, dynamic>> recentActivity = [];
  List<Map<String, dynamic>> recentPayments = [];
  List<Map<String, dynamic>> outstandingStudents = [];

  bool isCreatingInvoice = false;
  String? invoiceCreationError;

  bool isRecordingPayment = false;
  String? paymentRecordingError;

  Invoice? currentInvoice;
  List<InvoiceItem> currentInvoiceItems = [];
  bool isLoadingInvoice = false;

  FinanceViewModel(this._financeRepo, this._authService);

  Future<void> init() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) {
        error = "No active school. Please log in again.";
        return;
      }

      await _loadOverviewStats(school.id);
      await _loadRecentActivity(school.id);
      await _loadRecentPayments(school.id);
      await _loadOutstandingStudents(school.id);
    } catch (e) {
      error = e.toString();
      debugPrint("FinanceViewModel.init error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  Future<void> _loadOverviewStats(String schoolId) async {
    final stats = await _financeRepo.getFinanceStats(schoolId);

    totalRevenue = (stats['totalRevenue'] as num?)?.toDouble() ?? 0.0;
    pendingAmount = (stats['pendingAmount'] as num?)?.toDouble() ?? 0.0;
    unpaidInvoiceCount = (stats['unpaidInvoiceCount'] as num?)?.toInt() ?? 0;

    final rawGrowth = (stats['percentGrowth'] as num?)?.toDouble() ?? 0.0;
    percentGrowth = rawGrowth.isFinite ? rawGrowth : 0.0;

    monthlyCollections = List<double>.from(stats['monthlyCollections'] ?? const <double>[]);
    monthLabels = List<String>.from(stats['monthLabels'] ?? const <String>[]);
  }

  Future<void> _loadRecentActivity(String schoolId) async {
    recentActivity = await _financeRepo.getRecentActivity(schoolId);
  }

  Future<void> _loadRecentPayments(String schoolId) async {
    recentPayments = await _financeRepo.getRecentPayments(schoolId, limit: 8);
  }

  Future<void> _loadOutstandingStudents(String schoolId) async {
    outstandingStudents = await _financeRepo.getOutstandingStudents(schoolId, limit: 8);
  }

  Future<void> createInvoice({
    required String studentId,
    required List<InvoiceItem> items,
    required DateTime dueDate,
    String? termId,
    String? title,
    String? snapshotGrade,
  }) async {
    isCreatingInvoice = true;
    invoiceCreationError = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school found.");

      final invoiceId = _uuid.v4();

      final computedTotal = items.fold<double>(
        0.0,
        (sum, it) => sum + (it.amount * (it.quantity <= 0 ? 1 : it.quantity)),
      );

      final invoiceNumber =
          'INV-${DateTime.now().year}${DateTime.now().month.toString().padLeft(2, '0')}-${invoiceId.substring(0, 8)}';

      final normalizedItems = <InvoiceItem>[];
      for (final it in items) {
        normalizedItems.add(
          InvoiceItem(
            id: it.id.isNotEmpty ? it.id : _uuid.v4(),
            schoolId: school.id,
            invoiceId: invoiceId,
            feeStructureId: it.feeStructureId,
            description: it.description,
            amount: it.amount,
            quantity: it.quantity <= 0 ? 1 : it.quantity,
            createdAt: it.createdAt,
          ),
        );
      }

      await _financeRepo.createInvoice(
        Invoice(
          id: invoiceId,
          schoolId: school.id,
          studentId: studentId,
          invoiceNumber: invoiceNumber,
          termId: termId,
          dueDate: dueDate,
          status: InvoiceStatus.draft,
          snapshotGrade: snapshotGrade,
          totalAmount: computedTotal,
          paidAmount: 0.0,
          title: title,
          createdAt: DateTime.now(),
        ),
        normalizedItems,
      );

      await _loadOverviewStats(school.id);
      await _loadRecentActivity(school.id);
      await _loadRecentPayments(school.id);
      await _loadOutstandingStudents(school.id);
    } catch (e) {
      invoiceCreationError = e.toString();
      debugPrint("FinanceViewModel.createInvoice error: $e");
    } finally {
      isCreatingInvoice = false;
      notifyListeners();
    }
  }

  Future<void> loadInvoice(String invoiceId) async {
    isLoadingInvoice = true;
    notifyListeners();

    try {
      currentInvoice = await _financeRepo.getInvoiceById(invoiceId);
      currentInvoiceItems = currentInvoice != null
          ? await _financeRepo.getInvoiceItems(invoiceId)
          : <InvoiceItem>[];
    } catch (e) {
      debugPrint("FinanceViewModel.loadInvoice error: $e");
      currentInvoice = null;
      currentInvoiceItems = [];
    } finally {
      isLoadingInvoice = false;
      notifyListeners();
    }
  }

  Future<void> recordPayment({
    required String studentId,
    required double amount,
    required String method,
    String? reference,
  }) async {
    isRecordingPayment = true;
    paymentRecordingError = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school found.");

      await _financeRepo.recordPayment(
        Payment(
          id: _uuid.v4(),
          schoolId: school.id,
          studentId: studentId,
          amount: amount,
          method: method,
          reference: reference,
          receivedAt: DateTime.now(),
        ),
      );

      await _loadOverviewStats(school.id);
      await _loadRecentActivity(school.id);
      await _loadRecentPayments(school.id);
      await _loadOutstandingStudents(school.id);
    } catch (e) {
      paymentRecordingError = e.toString();
      debugPrint("FinanceViewModel.recordPayment error: $e");
    } finally {
      isRecordingPayment = false;
      notifyListeners();
    }
  }

  Future<void> refresh() => init();
}

// ==========================================
// FILE: ./data/vmodels/student_logs_view_model.dart
// ==========================================

import 'package:flutter/foundation.dart' show ChangeNotifier;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/student_repo.dart';

class StudentLogsViewModel extends ChangeNotifier {
  final StudentRepository _repo;
  final String studentId;

  List<LogEntry> _logs = [];
  double _totalDebits = 0.0;
  double _totalCredits = 0.0;
  double _balance = 0.0;
  bool _isLoading = true;
  String? _error;

  List<LogEntry> get logs => _logs;
  double get totalDebits => _totalDebits;
  double get totalCredits => _totalCredits;
  double get balance => _balance;
  bool get isLoading => _isLoading;
  String? get error => _error;

  StudentLogsViewModel(this._repo, this.studentId);

  Future<void> loadLogs() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final results = await Future.wait([
        _repo.getStudentLogs(studentId),
        _repo.getStudentLedgerSummary(studentId),
      ]);

      _logs = results[0] as List<LogEntry>;
      final summary = results[1] as Map<String, double>;
      _totalDebits = summary['debits'] ?? 0.0;
      _totalCredits = summary['credits'] ?? 0.0;
      _balance = summary['balance'] ?? 0.0;
    } catch (e) {
      _error = "Failed to load logs: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> refresh() => loadLogs();
}

// ==========================================
// FILE: ./data/vmodels/payment_view_model.dart
// ==========================================

import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/repo/student_repo.dart';
import 'package:legend/data/services/auth/auth.dart';

class PaymentViewModel extends ChangeNotifier {
  final FinanceRepository _financeRepo;
  final StudentRepository _studentRepo;
  final AuthService _authService;

  /// Nullable to support bulk/selector flow later.
  String? studentId;

  bool isLoading = true;
  String? error;

  Student? student;
  List<Enrollment> enrollments = [];

  double amount = 0.0;
  String method = "Cash";
  String reference = "";

  PaymentViewModel(
    this._financeRepo,
    this._studentRepo,
    this._authService, {
    required this.studentId,
  });

  // -----------------------------
  // Derived getters for UI
  // -----------------------------
  double get currentDebt => student?.feesOwed ?? 0.0;

  String get studentName {
    final s = student;
    if (s == null) return "";
    return "${s.firstName} ${s.lastName}".trim();
  }

  String get receiptNumber {
    // simple offline receipt format; repository can override if needed
    final now = DateTime.now();
    final y = now.year.toString();
    final m = now.month.toString().padLeft(2, '0');
    final d = now.day.toString().padLeft(2, '0');
    final tail = now.millisecondsSinceEpoch.toString().substring(
          (now.millisecondsSinceEpoch.toString().length - 6).clamp(0, 999),
        );
    return "RCPT-$y$m$d-$tail";
  }

  DateTime get date => DateTime.now();

  String get allocationPreview {
    if (amount <= 0) return "Pending input...";
    if (currentDebt <= 0) return "No outstanding balance";
    if (amount >= currentDebt) return "Clears Full Balance";
    return "Partially covers Outstanding Balance";
  }

  // -----------------------------
  // Lifecycle
  // -----------------------------
  Future<void> init() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school.");

      final sid = studentId;
      if (sid == null || sid.isEmpty) {
        // Bulk/search flow not implemented yet, but UI must not crash.
        student = null;
        enrollments = [];
        return;
      }

      student = await _studentRepo.getStudentById(sid);
      enrollments = await _studentRepo.getEnrollments(sid);
    } catch (e) {
      error = e.toString();
      debugPrint("PaymentViewModel.init error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  // -----------------------------
  // Persist (offline-first)
  // -----------------------------
  Future<void> submitPayment() async {
    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school.");

      final sid = studentId;
      if (sid == null || sid.isEmpty) throw Exception("No student selected.");

      await _financeRepo.recordPayment(
        Payment(
          id: "",
          schoolId: school.id,
          studentId: sid,
          amount: amount,
          method: method,
          reference: reference.isEmpty ? null : reference,
          receivedAt: DateTime.now(),
        ),
      );
    } catch (e) {
      error = e.toString();
      notifyListeners();
      rethrow;
    }
  }
}

// ==========================================
// FILE: ./data/vmodels/view_invoice_view_model.dart
// ==========================================

import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/repo/student_repo.dart';

class ViewInvoiceViewModel extends ChangeNotifier {
  final FinanceRepository _financeRepo;
  final StudentRepository _studentRepo;
  final String invoiceId;

  bool isLoading = true;
  String? error;

  Invoice? invoice;
  List<InvoiceItem> items = [];
  Student? student;

  ViewInvoiceViewModel(this._financeRepo, this._studentRepo, this.invoiceId);

  Future<void> load() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      invoice = await _financeRepo.getInvoiceById(invoiceId);
      if (invoice == null) throw Exception("Invoice not found.");

      items = await _financeRepo.getInvoiceItems(invoiceId);
      student = await _studentRepo.getStudentById(invoice!.studentId);
    } catch (e) {
      error = e.toString();
      debugPrint("ViewInvoiceViewModel.load error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  double get total => items.fold<double>(
        0.0,
        (sum, it) => sum + (it.amount * (it.quantity <= 0 ? 1 : it.quantity)),
      );
}

// ==========================================
// FILE: ./data/vmodels/logging_payments_view_model.dart
// ==========================================

import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/repo/student_repo.dart';
import 'package:legend/data/services/auth/auth.dart';

class LoggingPaymentsViewModel extends ChangeNotifier {
  final FinanceRepository _financeRepo;
  final StudentRepository _studentRepo;
  final AuthService _authService;

  final String studentId;

  bool isLoading = true;
  String? error;

  double amount = 0.0;
  String method = "Cash";
  String reference = "";

  Student? student;
  List<Invoice> unpaidInvoices = [];

  LoggingPaymentsViewModel(
    this._financeRepo,
    this._studentRepo,
    this._authService,
    this.studentId,
  );

  Future<void> init() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school.");

      student = await _studentRepo.getStudentById(studentId);

      unpaidInvoices = await _financeRepo.getOpenInvoicesForStudent(studentId);

      // Ensure sorted: oldest/most urgent first
      unpaidInvoices.sort((a, b) => a.dueDate.compareTo(b.dueDate));
    } catch (e) {
      error = e.toString();
      debugPrint("LoggingPaymentsViewModel.init error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  // --- UI state setters ---
  void updateAmount(double v) {
    amount = v.isFinite ? v : 0.0;
    notifyListeners();
  }

  void setMethod(String v) {
    method = v.trim().isEmpty ? "Cash" : v.trim();
    notifyListeners();
  }

  void setReference(String v) {
    reference = v;
    notifyListeners();
  }

  // --- Derived values ---
  double outstandingOf(Invoice inv) {
    final due = inv.totalAmount - inv.paidAmount;
    return due <= 0 ? 0.0 : due;
  }

  double get totalOutstandingDebt {
    return unpaidInvoices.fold<double>(
      0.0,
      (sum, inv) => sum + outstandingOf(inv),
    );
  }

  double get remainingCreditAfterDebt {
    final surplus = amount - totalOutstandingDebt;
    return surplus > 0 ? surplus : 0.0;
  }

  String getStatusLabel(Invoice inv) {
    final out = outstandingOf(inv);
    if (out <= 0) return "PAID";
    if (inv.paidAmount > 0) return "PARTIAL";
    if (inv.dueDate.isBefore(DateTime.now())) return "OVERDUE";
    return "UNPAID";
  }

  // --- Action ---
  Future<bool> logPayment() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) throw Exception("No active school.");

      if (amount <= 0) throw Exception("Amount must be greater than 0.");

      // Record payment (minimal, guaranteed path)
      await _financeRepo.recordPayment(
        Payment(
          id: "", // repo can generate UUID
          schoolId: school.id,
          studentId: studentId,
          amount: amount,
          method: method,
          reference: reference.trim().isEmpty ? null : reference.trim(),
          receivedAt: DateTime.now(),
        ),
      );

      // Note: allocation across invoices is UI-level here; persisting allocations
      // requires repo support (e.g. apply payment to invoices / ledger entries).
      // Your list will refresh on next load.

      return true;
    } catch (e) {
      error = e.toString();
      debugPrint("LoggingPaymentsViewModel.logPayment error: $e");
      return false;
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

}

// ==========================================
// FILE: ./data/vmodels/all_vmodels.dart
// ==========================================


// ==========================================
// FILE: ./data/vmodels/dashboard_vmodel.dart
// ==========================================

import 'dart:async';

import 'package:flutter/foundation.dart' show ChangeNotifier, debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/dashboard_repo.dart';
import 'package:legend/data/services/noti/notification_engine.dart';
import 'package:legend/data/services/auth/auth.dart';

class DashboardViewModel extends ChangeNotifier {
  final DashboardRepository _repo;
  final AuthService _authService;
  StreamSubscription<DashboardStats>? _statsSub;

  bool isLoading = true;
  String? error;

  LegendProfile? profile;
  DashboardStats stats = DashboardStats(
    totalStudents: 0,
    totalOwed: 0,
    collectedToday: 0,
    pendingInvoices: 0,
  );
  List<Map<String, dynamic>> recentActivity = [];
  Stream<List<LegendNotification>>? notificationsStream;
  Stream<int>? unreadCountStream;
  String? _schoolId;

  DashboardViewModel(this._repo, this._authService);

  Future<void> init() async {
    isLoading = true;
    error = null;
    notifyListeners();

    try {
      final user = _authService.user;
      final school = _authService.activeSchool;
      if (user == null || school == null) throw Exception("Session invalid.");
      _schoolId = school.id;

      _startStatsWatch(school.id);
      _startNotificationsWatch(school.id);

      await Future.wait([
        _loadProfile(user.id),
        _loadStats(school.id),
        _loadActivity(school.id),
      ]);

      unawaited(_runNotificationChecks(school.id, user.id));
    } catch (e) {
      error = e.toString();
      debugPrint("DashboardViewModel.init error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  Future<void> _loadProfile(String userId) async {
    profile = await _repo.getUserProfile(userId);
  }

  Future<void> _loadStats(String schoolId) async {
    stats = await _repo.getDashboardStats(schoolId);
  }

  Future<void> _loadActivity(String schoolId) async {
    recentActivity = await _repo.getRecentActivity(schoolId);
  }

  Future<void> refresh() => init();

  void _startStatsWatch(String schoolId) {
    _statsSub?.cancel();
    _statsSub = _repo.watchDashboardStats(schoolId).listen(
      (next) {
        stats = next;
        notifyListeners();
      },
      onError: (e) {
        error = e.toString();
        notifyListeners();
      },
    );
  }

  void _startNotificationsWatch(String schoolId) {
    notificationsStream = _repo.watchNotifications(schoolId);
    unreadCountStream = _repo.watchUnreadCount(schoolId);
    notifyListeners();
  }

  Future<void> _runNotificationChecks(String schoolId, String userId) async {
    try {
      await NotificationEngine().runChecks(schoolId, userId);
    } catch (e) {
      debugPrint("NotificationEngine.runChecks error: $e");
    }
  }

  Future<void> markNotificationRead(String notiId) => _repo.markAsRead(notiId);
  Future<void> markAllNotificationsRead() async {
    final schoolId = _schoolId;
    if (schoolId == null) return;
    await _repo.markAllAsRead(schoolId);
  }

  Future<void> clearAllNotifications() async {
    final schoolId = _schoolId;
    if (schoolId == null) return;
    await _repo.clearAllNotifications(schoolId);
  }

  Future<void> deleteNotification(String id) => _repo.deleteNotification(id);

  @override
  void dispose() {
    _statsSub?.cancel();
    super.dispose();
  }
}

// ==========================================
// FILE: ./data/vmodels/students_vmodel.dart
// ==========================================

import 'dart:async';

import 'package:flutter/foundation.dart' show ChangeNotifier;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/repo/student_repo.dart';

class StudentListViewModel extends ChangeNotifier {
  final StudentRepository _repo;
  final String schoolId;

  bool _isLoading = false;
  List<Student> _students = [];
  String? _error;
  StreamSubscription<List<Student>>? _studentsSub;

  bool get isLoading => _isLoading;
  List<Student> get students => _students;
  String? get error => _error;

  StudentListViewModel(this._repo, this.schoolId) {
    _startWatching();
  }

  Future<void> loadStudents() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _students = await _repo.getStudents(schoolId);
    } catch (e) {
      _error = "Failed to load students: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> refresh() => loadStudents();

  Future<void> deleteStudent(String id) async {
    try {
      await _repo.deleteStudent(id);
      _students.removeWhere((s) => s.id == id);
      notifyListeners();
    } catch (e) {
      _error = "Failed to delete student: $e";
      notifyListeners();
    }
  }

  void _startWatching() {
    if (schoolId.isEmpty) return;

    _studentsSub?.cancel();
    _isLoading = true;
    _error = null;
    notifyListeners();

    _studentsSub = _repo.watchStudents(schoolId).listen(
      (students) {
        _students = students;
        _isLoading = false;
        notifyListeners();
      },
      onError: (e) {
        _error = "Failed to load students: $e";
        _isLoading = false;
        notifyListeners();
      },
    );
  }

  @override
  void dispose() {
    _studentsSub?.cancel();
    super.dispose();
  }
}

class StudentDetailViewModel extends ChangeNotifier {
  final StudentRepository _repo;

  Student? _student;
  List<Enrollment> _enrollments = [];
  bool _isLoading = false;
  String? _error;

  Student? get student => _student;
  List<Enrollment> get enrollments => _enrollments;
  bool get isLoading => _isLoading;
  String? get error => _error;

  StudentDetailViewModel(this._repo);

  Future<void> loadStudent(String id) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _student = await _repo.getStudentById(id);
      _enrollments = _student != null ? await _repo.getEnrollments(id) : [];
    } catch (e) {
      _error = "Failed to load student: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> saveStudent(Student student) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      if (student.id.isEmpty) throw Exception("Cannot create here. Use registration flow.");
      await _repo.updateStudent(student);
      _student = student;
    } catch (e) {
      _error = "Failed to save student: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}

class StudentFinanceViewModel extends ChangeNotifier {
  final FinanceRepository _repo;
  final String studentId;

  List<Invoice> _invoices = [];
  List<Payment> _payments = [];
  List<LedgerEntry> _ledger = [];
  bool _isLoading = false;
  String? _error;

  List<Invoice> get invoices => _invoices;
  List<Payment> get payments => _payments;
  List<LedgerEntry> get ledger => _ledger;
  bool get isLoading => _isLoading;
  String? get error => _error;

  StudentFinanceViewModel(this._repo, this.studentId, String schoolId);

  Future<void> loadFinanceData() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final results = await Future.wait([
        _repo.getStudentInvoices(studentId),
        _repo.getStudentPayments(studentId),
        _repo.getStudentLedger(studentId),
      ]);

      _invoices = results[0] as List<Invoice>;
      _payments = results[1] as List<Payment>;
      _ledger = results[2] as List<LedgerEntry>;
    } catch (e) {
      _error = "Failed to load finance data: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> refresh() => loadFinanceData();

  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _repo.createInvoice(invoice, items);
      await loadFinanceData();
    } catch (e) {
      _error = "Failed to create invoice: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> recordPayment(Payment payment) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _repo.recordPayment(payment);
      await loadFinanceData();
    } catch (e) {
      _error = "Failed to record payment: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}

// ==========================================
// FILE: ./data/vmodels/add_student_view_model.dart
// ==========================================

import 'package:legend/app_libs.dart';

class AddStudentViewModel extends ChangeNotifier {
  final StudentRepository _repo;
  final String _schoolId;

  // ---------------------------------------------------------------------------
  // STATE
  // ---------------------------------------------------------------------------
  bool _isLoading = true;
  String? _error;
  String? _blockingError;

  List<SchoolClass> _classes = [];
  List<String> _gradeNames = [];

  // ---------------------------------------------------------------------------
  // CONTROLLERS
  // ---------------------------------------------------------------------------
  final firstNameCtrl = TextEditingController();
  final lastNameCtrl = TextEditingController();
  final guardianNameCtrl = TextEditingController();
  final guardianPhoneCtrl = TextEditingController();
  final guardianEmailCtrl = TextEditingController();

  // Financial Controllers
  final openingBalanceCtrl = TextEditingController(text: '0.00');
  final initialPaymentCtrl = TextEditingController(text: '0.00');
  final debtDescriptionCtrl = TextEditingController();
  final tuitionAmountCtrl = TextEditingController(text: '0.00');

  // ---------------------------------------------------------------------------
  // REACTIVE PROPERTIES
  // ---------------------------------------------------------------------------
  String? _selectedGender;
  String? _selectedStudentType;
  String? _selectedGradeName;

  // Default to TERMLY
  String _selectedBillingCycle = 'TERMLY';

  String _selectedPaymentMethod = 'Cash';
  DateTime? _customBillingDate;
  List<String> _selectedSubjects = [];
  bool _generateInvoiceNow = true;

  // Replace _gradeNames with _classNames to avoid lying to yourself/UI
  List<String> _classNames = [];
  List<String> get classes => _classNames;

  // Getters & Setters
  String? get selectedGender => _selectedGender;
  set selectedGender(String? val) {
    _selectedGender = val;
    notifyListeners();
  }

  String? get selectedStudentType => _selectedStudentType;
  set selectedStudentType(String? val) {
    _selectedStudentType = val;
    notifyListeners();
  }

  String? get selectedGradeName => _selectedGradeName;
  set selectedGradeName(String? val) {
    _selectedGradeName = val;
    notifyListeners();
  }

  String get selectedBillingCycle => _selectedBillingCycle;
  set selectedBillingCycle(String val) {
    _selectedBillingCycle = val;
    notifyListeners();
  }

  String get selectedPaymentMethod => _selectedPaymentMethod;
  set selectedPaymentMethod(String val) {
    _selectedPaymentMethod = val;
    notifyListeners();
  }

  DateTime? get customBillingDate => _customBillingDate;
  set customBillingDate(DateTime? val) {
    _customBillingDate = val;
    notifyListeners();
  }

  bool get generateInvoiceNow => _generateInvoiceNow;
  set generateInvoiceNow(bool val) {
    _generateInvoiceNow = val;
    notifyListeners();
  }

  List<String> get selectedSubjects => _selectedSubjects;

  void updateSubjects(List<String> newSubjects) {
    _selectedSubjects = newSubjects;
    notifyListeners();
  }

  void toggleSubject(String subject) {
    if (_selectedSubjects.contains(subject)) {
      _selectedSubjects.remove(subject);
    } else {
      _selectedSubjects.add(subject);
    }
    notifyListeners();
  }

  // Computed Financials for UI Feedback
  double get totalDebt => double.tryParse(openingBalanceCtrl.text) ?? 0.0;
  double get initialPay => double.tryParse(initialPaymentCtrl.text) ?? 0.0;
  double get netOutstanding => totalDebt - initialPay;
  double get tuitionAmount => double.tryParse(tuitionAmountCtrl.text) ?? 0.0;

  // DATA SOURCES
  List<String> get grades => _gradeNames;

  //  FIXED: Renamed to 'billingCycles' to match the UI View
  List<String> get billingCycles => ['MONTHLY_FIXED', 'MONTHLY_CUSTOM', 'TERMLY', 'YEARLY', 'CUSTOM'];

  List<String> get paymentMethods => ['Cash', 'EcoCash', 'Swipe', 'Transfer'];
  List<String> get availableSubjects => ZimsecSubject.allNames;

  // Context Helpers
  String get currentTermLabel {
    final now = DateTime.now();
    if (now.month <= 4) return "Term 1, ${now.year}";
    if (now.month <= 8) return "Term 2, ${now.year}";
    return "Term 3, ${now.year}";
  }

  bool get isLoading => _isLoading;
  String? get error => _error;
  String? get blockingError => _blockingError;

  // ---------------------------------------------------------------------------
  // INITIALIZATION
  // ---------------------------------------------------------------------------
  AddStudentViewModel(this._repo, this._schoolId) {
    _init();
    // Listeners for Real-Time Math
    openingBalanceCtrl.addListener(notifyListeners);
    initialPaymentCtrl.addListener(notifyListeners);
  }

  Future<void> _init() async {
    _isLoading = true;
    notifyListeners();

    _classes = await _repo.getClasses(_schoolId);
    _classNames = _classes.map((c) => c.name).toList();

    if (_classNames.isEmpty) {
      _blockingError = "No Classes found. Please add classes in Settings.";
    }

    // Then update the selected variable names accordingly:
    // String? _selectedClassName; (instead of _selectedGradeName)
    // and in submit() resolve classId by class name.

    try {
      final configError = await _repo.checkSchoolReadiness(_schoolId);
      if (configError != null) {
        _blockingError = configError;
        return;
      }
      _classes = await _repo.getClasses(_schoolId);
      _gradeNames = _classes.map((c) => c.name).toList();

      if (_gradeNames.isEmpty) {
        _blockingError = "No Grades found. Please add classes in Settings.";
      }
    } catch (e) {
      _error = "Init Failed: $e";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // SUBMIT
  // ---------------------------------------------------------------------------
  Future<bool> submit() async {
    if (_blockingError != null) return false;

    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final classId = _classes
          .firstWhere(
            (c) => c.name == _selectedGradeName,
            orElse: () => throw Exception("Selected Grade no longer exists."),
          )
          .id;

      await _repo.registerStudent(
        schoolId: _schoolId,
        firstName: firstNameCtrl.text.trim(),
        lastName: lastNameCtrl.text.trim(),
        gender: _selectedGender ?? 'Male',
        type: _selectedStudentType ?? 'ACADEMY',

        // FINANCIAL CONFIGURATION
        billingCycle: _selectedBillingCycle,

        guardianName: guardianNameCtrl.text.trim(),
        guardianPhone: guardianPhoneCtrl.text.trim(),
        guardianEmail: guardianEmailCtrl.text.trim(),
        classId: classId,
        openingBalance: totalDebt,
        debtDescription: debtDescriptionCtrl.text.trim().isEmpty
            ? "Opening Balance ($currentTermLabel)"
            : debtDescriptionCtrl.text.trim(),
        subjects: _selectedSubjects,
        tuitionAmount: tuitionAmount,
        initialPayment: initialPay,
        paymentMethod: _selectedPaymentMethod,
      );

      return true;
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // DEV HELPERS
  // ---------------------------------------------------------------------------
  void randomizeData() {
    final r = Random();
    final firstNames = [
      'Panashe',
      'Tinashe',
      'Farai',
      'Rutendo',
      'Kudzai',
      'Nyasha',
      'Thabo',
    ];
    final lastNames = [
      'Moyo',
      'Ncube',
      'Sibanda',
      'Chikara',
      'Gumbo',
      'Shumba',
    ];
    final guardians = ['Mr.', 'Mrs.', 'Dr.'];

    firstNameCtrl.text = firstNames[r.nextInt(firstNames.length)];
    lastNameCtrl.text = lastNames[r.nextInt(lastNames.length)];
    _selectedGender = r.nextBool() ? 'Male' : 'Female';
    _selectedStudentType = 'ACADEMY';

    //  Updated to use billingCycles
    _selectedBillingCycle = billingCycles[r.nextInt(billingCycles.length)];

    if (_gradeNames.isNotEmpty) {
      _selectedGradeName = _gradeNames[r.nextInt(_gradeNames.length)];
    }
    _selectedSubjects = [
      'Mathematics',
      'English Language',
      'Combined Science',
      'Shona',
    ];
    if (r.nextBool()) _selectedSubjects.add('Computer Science');

    guardianNameCtrl.text =
        "${guardians[r.nextInt(guardians.length)]} ${lastNameCtrl.text}";
    guardianPhoneCtrl.text = "+263 77${r.nextInt(900000) + 100000}";

    openingBalanceCtrl.text = (r.nextInt(5) * 100 + 50).toString();
    if (r.nextBool()) {
      initialPaymentCtrl.text = (double.parse(openingBalanceCtrl.text) / 2)
          .toString();
    } else {
      initialPaymentCtrl.text = "0.00";
    }
    debtDescriptionCtrl.text = "Term 1 Balance b/f";

    notifyListeners();
  }

  @override
  void dispose() {
    firstNameCtrl.dispose();
    lastNameCtrl.dispose();
    guardianNameCtrl.dispose();
    guardianPhoneCtrl.dispose();
    guardianEmailCtrl.dispose();
    openingBalanceCtrl.dispose();
    initialPaymentCtrl.dispose();
    debtDescriptionCtrl.dispose();
    super.dispose();
  }
}

// ==========================================
// FILE: ./data/services/powersync/supa_connector.dart
// ==========================================

// ==========================================
// FILE: ./services/powersync/supa_connector.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/data/constants/env.dart';
import 'package:powersync/powersync.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SupaConnector extends PowerSyncBackendConnector {
  final String schoolId;
  final SupabaseClient supabaseClient;

  SupaConnector({required this.schoolId, required this.supabaseClient});

  @override
  Future<PowerSyncCredentials?> fetchCredentials() async {
    final session = supabaseClient.auth.currentSession;
    if (session == null) {
      // If session is dead, we return null to pause sync rather than crash
      debugPrint(" PowerSync: No active Supabase session.");
      return null;
    }

    return PowerSyncCredentials(
      endpoint: AppEnv.powerSyncUrl,
      token: session.accessToken,
    );
  }

  @override
  Future<void> uploadData(PowerSyncDatabase database) async {
    final transaction = await database.getNextCrudTransaction();
    if (transaction == null) return;

    // Use the 'legend' schema for Supabase operations
    final rest = supabaseClient.schema('legend');

    try {
      for (var op in transaction.crud) {
        final table = op.table;
        final id = op.id;
        // CRITICAL FIX: Convert SQLite Integers (0/1) back to Postgres Booleans
        final data = _fixTypes(op.opData, table);

        if (op.op == UpdateType.put) {
          // Upsert: Handle both Insert and Update
          await rest.from(table).upsert({...?data, 'id': id});
        } else if (op.op == UpdateType.patch && data != null) {
          // Patch: Update specific fields
          await rest.from(table).update(data).eq('id', id);
        } else if (op.op == UpdateType.delete) {
          // Delete
          await rest.from(table).delete().eq('id', id);
        }
      }
      await transaction.complete();
    } catch (e) {
      debugPrint(" Upload Error (Table: ${transaction.crud.first.table}): $e");
      // Note: We deliberately do NOT rethrow here immediately to avoid 
      // crashing the sync loop forever on one bad record. 
      // But for dev, rethrowing helps you see the error.
      rethrow; 
    }
  }

  /// Helper to sanitize types before sending to Postgres
  Map<String, dynamic>? _fixTypes(Map<String, dynamic>? data, String table) {
    if (data == null) return null;
    
    final Map<String, dynamic> fixed = Map.from(data);

    // List of columns that are BOOLEAN in Postgres but INTEGER in SQLite
    const boolColumns = [
      'is_active',
      'is_locked',
      'is_taxable',
      'is_banned',
      'is_read',
      'is_secret'
    ];

    for (var key in fixed.keys) {
      if (boolColumns.contains(key) && fixed[key] is int) {
        // Convert 1 -> true, 0 -> false
        fixed[key] = fixed[key] == 1;
      }
    }

    return fixed;
  }
}
// ==========================================
// FILE: ./data/services/powersync/powersync_factory.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:path/path.dart';
import 'package:path_provider/path_provider.dart';
import 'package:powersync/powersync.dart';
import 'package:legend/data/constants/app_schema.dart';

class PowerSyncFactory {
  /// Opens and initializes the PowerSync database.
  static Future<PowerSyncDatabase> openDatabase() async {
    try {
      final dir = await getApplicationSupportDirectory();
      final path = join(dir.path, 'kwalegend_offline.db');

      final db = PowerSyncDatabase(schema: schema, path: path);
      await db.initialize();

      return db;
    } catch (e) {
      debugPrint(" PowerSync Init Failed: $e");
      rethrow;
    }
  }
}

// ==========================================
// FILE: ./data/services/billing/billing_engine.dart
// ==========================================

import 'dart:convert';

import 'package:flutter/foundation.dart';
import 'package:legend/data/constants/app_strings.dart';
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/services/database_serv.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:uuid/uuid.dart';

class BillingEngine {

  //TODO Local Notifications example statistics and reminders
  static final BillingEngine _instance = BillingEngine._internal(_DbBillingDataSource());
  factory BillingEngine() => _instance;
  BillingEngine._internal(this._source);
  @visibleForTesting
  BillingEngine.withDataSource(this._source);

  final _uuid = const Uuid();
  final BillingDataSource _source;

  Future<bool> enableAutoBilling(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    final deviceId = await _getOrCreateDeviceId(prefs);
    final lockKey = _lockKey(schoolId);
    final currentLock = prefs.getString(lockKey);

    if (currentLock != null && currentLock != deviceId) {
      await _recordError(
        schoolId,
        AppStrings.autoBillingLockHeld,
        context: {'lock': currentLock, 'device': deviceId},
      );
      return false;
    }

    await prefs.setString(lockKey, deviceId);
    await prefs.setBool(_enabledKey(schoolId), true);
    return true;
  }

  Future<void> disableAutoBilling(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_enabledKey(schoolId), false);
    await prefs.remove(_lockKey(schoolId));
  }

  Future<bool> isAutoBillingEnabled(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_enabledKey(schoolId)) ?? false;
  }

  Future<bool> takeOverAutoBilling(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    final deviceId = await _getOrCreateDeviceId(prefs);
    await prefs.setString(_lockKey(schoolId), deviceId);
    await prefs.setBool(_enabledKey(schoolId), true);
    return true;
  }

  Future<void> runDaily(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    if (!await _canRun(prefs, schoolId)) return;

    final today = DateTime.now();
    if (_isSameDay(today, _lastRunDate(prefs, schoolId))) return;

    try {
      await _runForSchool(schoolId, today);
      await prefs.setString(_lastRunKey(schoolId), _dateKey(today));
    } catch (e) {
      await _recordError(schoolId, "${AppStrings.autoBillingFailedPrefix}$e");
    }
  }

  @visibleForTesting
  Future<void> runForSchoolAt(String schoolId, DateTime now) async {
    await _runForSchool(schoolId, now);
  }

  // ---------------------------------------------------------------------------
  // CORE RUN
  // ---------------------------------------------------------------------------

  Future<void> _runForSchool(String schoolId, DateTime now) async {
    final term = await _source.getActiveTerm(schoolId);
    final year = await _source.getActiveYear(schoolId);
    final students = await _source.loadActiveStudents(schoolId);

    for (final row in students) {
      final tuitionAmount = row.tuitionAmount;
      if (tuitionAmount <= 0) {
        await _recordError(
          schoolId,
          AppStrings.autoBillingErrMissingTuition,
          context: {'studentId': row.studentId, 'enrollmentId': row.enrollmentId},
        );
        continue;
      }

      switch (row.billingCycle) {
        case 'MONTHLY_FIXED':
          if (term == null) {
            await _recordError(schoolId, AppStrings.autoBillingErrNoActiveTermMonthlyFixed);
            break;
          }
          await _runMonthlyFixed(row, term, now);
          break;
        case 'MONTHLY_CUSTOM':
          await _runMonthlyCustom(row, now);
          break;
        case 'TERMLY':
          if (term == null) {
            await _recordError(schoolId, AppStrings.autoBillingErrNoActiveTermTermly);
            break;
          }
          await _runTermly(row, term, now);
          break;
        case 'YEARLY':
          if (year == null) {
            await _recordError(schoolId, AppStrings.autoBillingErrNoActiveYearYearly);
            break;
          }
          await _runYearly(row, year, now);
          break;
        case 'CUSTOM':
        default:
          break;
      }
    }
  }

  Future<void> _runMonthlyFixed(BillingStudentRow row, Term term, DateTime now) async {
    final months = _monthsInRange(term.startDate, term.endDate);
    for (final m in months) {
      // FIX: Changed from 5 to 1. "Fixed" implies start of month.
      // Maximum Impact: Get paid sooner.
      final due = DateTime(m.year, m.month, 1); 
      
      if (due.isBefore(term.startDate)) continue;
      if (due.isAfter(term.endDate)) continue;
      // FIX: Use !isAfter to ensure we bill ON the due date, not the day after.
      if (due.isAfter(now)) continue; 

      final periodKey = "${m.year}-${m.month.toString().padLeft(2, '0')}";
      final title = "Tuition - $periodKey";
      await _ensureInvoice(row, due, title, termId: term.id, periodLabel: periodKey);
    }
  }

  Future<void> _runMonthlyCustom(BillingStudentRow row, DateTime now) async {
    final start = row.enrollmentDate;
    if (start == null) {
      await _recordError(
        row.schoolId,
        AppStrings.autoBillingErrMissingEnrollmentDate,
        context: {'studentId': row.studentId, 'enrollmentId': row.enrollmentId},
      );
      return;
    }

    final months = _monthsInRange(start, now);
    for (final m in months) {
      final dueDay = _clampDay(m.year, m.month, start.day);
      final due = DateTime(m.year, m.month, dueDay);
      // FIX: Ensure we bill ON the due date.
      if (due.isAfter(now)) continue;

      final periodKey = "${m.year}-${m.month.toString().padLeft(2, '0')}";
      final title = "Tuition - $periodKey";
      await _ensureInvoice(row, due, title, periodLabel: periodKey);
    }
  }

  Future<void> _runTermly(BillingStudentRow row, Term term, DateTime now) async {
    if (term.startDate.isAfter(now)) return;
    final title = "Tuition - ${term.name}";
    await _ensureInvoice(row, term.startDate, title, termId: term.id, periodLabel: term.name);
  }

  Future<void> _runYearly(BillingStudentRow row, BillingAcademicYear year, DateTime now) async {
    if (year.startDate.isAfter(now)) return;
    final title = "Tuition - ${year.name}";
    await _ensureInvoice(row, year.startDate, title, periodLabel: year.name);
  }

  Future<void> _ensureInvoice(
    BillingStudentRow row,
    DateTime dueDate,
    String title, {
    String? termId,
    required String periodLabel,
  }) async {
    final invoiceId = await _source.findInvoiceId(row.schoolId, row.studentId, title);
    final itemDescription = "Tuition - $periodLabel";

    if (invoiceId != null) {
      final hasItem = await _source.invoiceHasItem(invoiceId, itemDescription);
      if (!hasItem) {
        final item = InvoiceItem(
          id: _uuid.v4(),
          schoolId: row.schoolId,
          invoiceId: invoiceId,
          description: itemDescription,
          amount: row.tuitionAmount,
          quantity: 1,
        );
        await _source.addInvoiceItem(item);
      }
      return;
    }

    final inv = Invoice(
      id: _uuid.v4(),
      schoolId: row.schoolId,
      studentId: row.studentId,
      invoiceNumber: _invoiceNumber(row.studentId, periodLabel),
      dueDate: dueDate,
      status: InvoiceStatus.pending,
      snapshotGrade: row.gradeLevel,
      totalAmount: row.tuitionAmount,
      paidAmount: 0.0,
      title: title,
      termId: termId,
    );

    final item = InvoiceItem(
      id: _uuid.v4(),
      schoolId: row.schoolId,
      invoiceId: inv.id,
      description: itemDescription,
      amount: row.tuitionAmount,
      quantity: 1,
    );

    await _source.createInvoice(inv, [item]);
  }

  // ---------------------------------------------------------------------------
  // DEVICE LOCK + ERROR LOGGING
  // ---------------------------------------------------------------------------

  Future<bool> _canRun(SharedPreferences prefs, String schoolId) async {
    final enabled = prefs.getBool(_enabledKey(schoolId)) ?? false;
    if (!enabled) return false;

    final deviceId = await _getOrCreateDeviceId(prefs);
    final lock = prefs.getString(_lockKey(schoolId));
    if (lock != null && lock != deviceId) return false;
    return true;
  }

  DateTime? _lastRunDate(SharedPreferences prefs, String schoolId) {
    final val = prefs.getString(_lastRunKey(schoolId));
    if (val == null || val.trim().isEmpty) return null;
    return DateTime.tryParse(val);
  }

  Future<String> _getOrCreateDeviceId(SharedPreferences prefs) async {
    final existing = prefs.getString(_deviceIdKey);
    if (existing != null && existing.trim().isNotEmpty) return existing;
    final id = _uuid.v4();
    await prefs.setString(_deviceIdKey, id);
    return id;
  }

  Future<void> _recordError(String schoolId, String message, {Map<String, dynamic>? context}) async {
    final prefs = await SharedPreferences.getInstance();
    final key = _errorKey(schoolId);
    final raw = prefs.getString(key);
    final list = <Map<String, dynamic>>[];
    if (raw != null) {
      try {
        final decoded = jsonDecode(raw);
        if (decoded is List) {
          for (final item in decoded) {
            if (item is Map) {
              list.add(item.map((k, v) => MapEntry(k.toString(), v)));
            }
          }
        }
      } catch (_) {}
    }

    list.add({
      'ts': DateTime.now().toIso8601String(),
      'message': message,
      'context': context ?? const {},
    });

    if (list.length > 50) {
      list.removeRange(0, list.length - 50);
    }

    await prefs.setString(key, jsonEncode(list));
  }

  Future<List<Map<String, dynamic>>> getErrorLog(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    final raw = prefs.getString(_errorKey(schoolId));
    if (raw == null || raw.trim().isEmpty) return [];

    try {
      final decoded = jsonDecode(raw);
      if (decoded is! List) return [];
      return decoded
          .whereType<Map>()
          .map((e) => e.map((k, v) => MapEntry(k.toString(), v)))
          .toList();
    } catch (_) {
      return [];
    }
  }

  Future<void> clearErrorLog(String schoolId) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_errorKey(schoolId));
  }

  // ---------------------------------------------------------------------------
  // HELPERS
  // ---------------------------------------------------------------------------

  String _invoiceNumber(String studentId, String periodLabel) {
    final tail = studentId.length > 6 ? studentId.substring(0, 6) : studentId;
    final clean = periodLabel.replaceAll(RegExp(r'\\s+'), '-');
    return "INV-TUI-$clean-$tail";
  }

  List<DateTime> _monthsInRange(DateTime start, DateTime end) {
    final normalizedStart = DateTime(start.year, start.month, 1);
    final normalizedEnd = DateTime(end.year, end.month, 1);
    final months = <DateTime>[];
    var cursor = normalizedStart;
    while (!cursor.isAfter(normalizedEnd)) {
      months.add(cursor);
      cursor = DateTime(cursor.year, cursor.month + 1, 1);
    }
    return months;
  }

  int _clampDay(int year, int month, int day) {
    final last = DateTime(year, month + 1, 0).day;
    return day > last ? last : day;
  }

  String _dateKey(DateTime d) => "${d.year}-${d.month.toString().padLeft(2, '0')}-${d.day.toString().padLeft(2, '0')}";

  bool _isSameDay(DateTime a, DateTime? b) {
    if (b == null) return false;
    return a.year == b.year && a.month == b.month && a.day == b.day;
  }

  String _enabledKey(String schoolId) => "billing_enabled_$schoolId";
  String _lockKey(String schoolId) => "billing_lock_$schoolId";
  String _lastRunKey(String schoolId) => "billing_last_run_$schoolId";
  String _errorKey(String schoolId) => "billing_error_log_$schoolId";

  static const String _deviceIdKey = "billing_device_id";
}

class BillingStudentRow {
  final String studentId;
  final String schoolId;
  final String billingCycle;
  final String enrollmentId;
  final DateTime? enrollmentDate;
  final double tuitionAmount;
  final String gradeLevel;

  BillingStudentRow({
    required this.studentId,
    required this.schoolId,
    required this.billingCycle,
    required this.enrollmentId,
    required this.enrollmentDate,
    required this.tuitionAmount,
    required this.gradeLevel,
  });
}

class BillingAcademicYear {
  final String id;
  final String schoolId;
  final String name;
  final DateTime startDate;
  final DateTime endDate;

  BillingAcademicYear({
    required this.id,
    required this.schoolId,
    required this.name,
    required this.startDate,
    required this.endDate,
  });
}

abstract class BillingDataSource {
  Future<Term?> getActiveTerm(String schoolId);
  Future<BillingAcademicYear?> getActiveYear(String schoolId);
  Future<List<BillingStudentRow>> loadActiveStudents(String schoolId);
  Future<String?> findInvoiceId(String schoolId, String studentId, String title);
  Future<bool> invoiceHasItem(String invoiceId, String description);
  Future<void> addInvoiceItem(InvoiceItem item);
  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items);
}

class _DbBillingDataSource implements BillingDataSource {
  final PowerSyncFinanceRepository _financeRepo = PowerSyncFinanceRepository();

  @override
  Future<Term?> getActiveTerm(String schoolId) async {
    final row = await db.getOptional(
      "SELECT * FROM terms WHERE school_id = ? AND is_active = 1 LIMIT 1",
      [schoolId],
    );
    return row == null ? null : Term.fromRow(row);
  }

  @override
  Future<BillingAcademicYear?> getActiveYear(String schoolId) async {
    final row = await db.getOptional(
      "SELECT * FROM academic_years WHERE school_id = ? AND is_active = 1 LIMIT 1",
      [schoolId],
    );
    if (row == null) return null;
    return BillingAcademicYear(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: (row['name'] as String?) ?? 'Year',
      startDate: _parseDate(row['start_date']) ?? DateTime.now(),
      endDate: _parseDate(row['end_date']) ?? DateTime.now(),
    );
  }

  @override
  Future<List<BillingStudentRow>> loadActiveStudents(String schoolId) async {
    final rows = await db.getAll(
      '''
      SELECT
        s.id as student_id,
        s.school_id,
        s.billing_cycle,
        s.status,
        e.id as enrollment_id,
        e.enrollment_date,
        e.created_at as enrollment_created_at,
        e.tuition_amount,
        e.grade_level
      FROM students s
      JOIN enrollments e ON e.student_id = s.id AND e.is_active = 1
      WHERE s.school_id = ? AND s.status = 'ACTIVE'
      ''',
      [schoolId],
    );

    return rows.map((r) {
      final enrollDate = _parseDate(r['enrollment_date']) ?? _parseDate(r['enrollment_created_at']);
      return BillingStudentRow(
        studentId: r['student_id'] as String,
        schoolId: r['school_id'] as String,
        billingCycle: (r['billing_cycle'] as String?)?.toUpperCase() ?? 'TERMLY',
        enrollmentId: r['enrollment_id'] as String,
        enrollmentDate: enrollDate,
        tuitionAmount: (r['tuition_amount'] as num?)?.toDouble() ?? 0.0,
        gradeLevel: (r['grade_level'] as String?) ?? 'Unknown',
      );
    }).toList();
  }

  @override
  Future<String?> findInvoiceId(String schoolId, String studentId, String title) async {
    final row = await db.getOptional(
      "SELECT id FROM invoices WHERE school_id = ? AND student_id = ? AND title = ? LIMIT 1",
      [schoolId, studentId, title],
    );
    return row?['id'] as String?;
  }

  @override
  Future<bool> invoiceHasItem(String invoiceId, String description) async {
    final row = await db.getOptional(
      "SELECT count(*) as count FROM invoice_items WHERE invoice_id = ? AND description = ?",
      [invoiceId, description],
    );
    return ((row?['count'] as num?)?.toInt() ?? 0) > 0;
  }

  @override
  Future<void> addInvoiceItem(InvoiceItem item) async {
    await _financeRepo.addInvoiceItem(item.invoiceId, item);
  }

  @override
  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items) async {
    await _financeRepo.createInvoice(invoice, items);
  }
}

DateTime? _parseDate(dynamic raw) {
  if (raw == null) return null;
  if (raw is DateTime) return raw;
  if (raw is int) return DateTime.fromMillisecondsSinceEpoch(raw);
  return DateTime.tryParse(raw.toString());
}
// ==========================================
// FILE: ./data/services/auth/auth.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/data/models/school_config.dart';
import 'package:legend/data/repo/auth/auth.dart';
import 'package:legend/data/repo/auth/school_repo.dart';
import 'package:legend/data/services/database_serv.dart';
import 'package:legend/data/services/billing/billing_engine.dart';
import 'package:legend/data/services/powersync/supa_connector.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class AuthService extends ChangeNotifier {
  final AuthRepository _authRepo;
  final SchoolRepository _schoolRepo;

  // STATE
  SchoolConfig? _activeSchool;
  bool _isLoading = true;
  bool _requiresOnlineSetup = false;

  // GETTERS
  User? get user => _authRepo.currentUser;
  SchoolConfig? get activeSchool => _activeSchool;
  bool get isLoading => _isLoading;
  bool get requiresOnlineSetup => _requiresOnlineSetup;
  bool get isAuthenticated => _authRepo.currentUser != null;

  AuthService(this._authRepo, this._schoolRepo) {
    _restoreSession();
  }

  // ---------------------------------------------------------------------------
  // 1) SESSION RESTORATION (OFFLINE-FIRST)
  // ---------------------------------------------------------------------------
  Future<void> _restoreSession() async {
    final userId = _authRepo.currentUser?.id;

    if (userId == null) {
      _isLoading = false;
      _requiresOnlineSetup = false;
      _activeSchool = null;
      notifyListeners();
      return;
    }

    debugPrint(" Restoring session for: $userId");

    try {
      // A) Try local cache FIRST (must be user-scoped)
      _activeSchool = await _schoolRepo.getLocalSchool(userId);

      if (_activeSchool != null) {
        debugPrint(" Offline Session Restored: ${_activeSchool!.name}");
        _requiresOnlineSetup = false;

        // Ignite PowerSync immediately with cached config
        await _connectPowerSync();

        // Optional background refresh (does not block UI)
        _backgroundRefresh(userId);
      } else {
        // B) No cache -> MUST go online once
        debugPrint(" No local school found. Attempting online fetch...");
        await _fetchSchoolOnline(userId);
      }
    } catch (e) {
      debugPrint(" Session Restoration Failed: $e");

      // If we have a user session but no school config, we cannot proceed offline.
      if (_activeSchool == null) {
        _requiresOnlineSetup = true;
      }
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // 2) HELPERS
  // ---------------------------------------------------------------------------

  Future<void> _fetchSchoolOnline(String userId) async {
    // If offline or blocked by RLS, this throws and caller handles it
    _activeSchool = await _schoolRepo.getSchoolForUser(userId);
    _requiresOnlineSetup = false;
    await _connectPowerSync();
  }

  Future<void> _backgroundRefresh(String userId) async {
    try {
      final remote = await _schoolRepo.getSchoolForUser(userId);

      // Update if anything important changed
      final changed = (_activeSchool == null) ||
          (_activeSchool!.id != remote.id) ||
          (_activeSchool!.name != remote.name);

      if (changed) {
        _activeSchool = remote;
        notifyListeners();
      }
    } catch (_) {
      // Silent fail is OK here: we already have cache + powersync running.
    }
  }

  Future<void> _connectPowerSync() async {
    if (_activeSchool == null) return;

    debugPrint(" Connecting PowerSync...");
    final connector = SupaConnector(
      schoolId: _activeSchool!.id,
      supabaseClient: Supabase.instance.client,
    );
    await DatabaseService().connect(connector);
    try {
      await BillingEngine().runDaily(_activeSchool!.id);
    } catch (e) {
      debugPrint("Auto-billing run failed: $e");
    }
  }

  // ---------------------------------------------------------------------------
  // 3) USER ACTIONS
  // ---------------------------------------------------------------------------

  Future<void> login(String email, String password) async {
    _isLoading = true;
    notifyListeners();

    try {
      final response = await _authRepo.signInWithPassword(email, password);
      final userId = response.user?.id;

      if (userId == null) {
        throw Exception("Login succeeded but userId is null.");
      }

      // Must succeed on initial login: fetch school online + cache + connect powersync
      await _fetchSchoolOnline(userId);
    } catch (e) {
      debugPrint("Login Error: $e");
      rethrow;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> logout() async {
    final userId = _authRepo.currentUser?.id;

    try {
      await _authRepo.signOut();
    } catch (_) {
      // ignore
    }

    try {
      await DatabaseService().close();
    } catch (_) {
      // ignore
    }

    // Clear state
    _activeSchool = null;
    _requiresOnlineSetup = false;

    // Clear user-scoped cache (if we still know userId)
    if (userId != null) {
      await _schoolRepo.clearCache(userId);
    }

    notifyListeners();
  }
}

// ==========================================
// FILE: ./data/services/auth/no_auth_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

class OfflineSetupScreen extends StatelessWidget {
  const OfflineSetupScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Padding(
        padding: const EdgeInsets.all(32.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.security, size: 80, color: AppColors.primaryBlue),
            const SizedBox(height: 32),
            const Text(
              "Security Check Required",
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.white),
            ),
            const SizedBox(height: 16),
            Text(
              "For your security, KwaLegend requires an internet connection for the initial setup. This ensures your school's data is verified directly from the server.\n\nOnce verified, you can work offline for up to 7 days.",
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 16, color: Colors.white.withAlpha(180), height: 1.5),
            ),
            const SizedBox(height: 48),
            SizedBox(
              width: double.infinity,
              height: 56,
              child: ElevatedButton(
                onPressed: () {
                  // Trigger a retry via AuthService
                  context.read<AuthService>().login(
                    "RETRY_MODE", 
                    "RETRY_MODE",
                  ); 
                },
                style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
                child: const Text("I'm Online Now - Retry", style: TextStyle(color: Colors.white, fontSize: 16)),
              ),
            ),
            const SizedBox(height: 16),
            TextButton(
              onPressed: () => context.go(AppRoutes.login),
              child: const Text("Back to Login", style: TextStyle(color: AppColors.textGrey)),
            )
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./data/services/noti/notification_engine.dart
// ==========================================

import 'dart:convert';
import 'dart:async';
import 'package:legend/data/constants/app_routes.dart';
import 'package:legend/data/services/database_serv.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:uuid/uuid.dart';

class NotificationEngine {
  static final NotificationEngine _instance = NotificationEngine._internal();
  factory NotificationEngine() => _instance;
  NotificationEngine._internal();

  final _uuid = const Uuid();

  /// Call this whenever a major action happens (Payment received, Student added)
  /// or run it on a Timer every 5-10 minutes.
  Future<void> runChecks(String schoolId, String userId) async {
    final prefs = await SharedPreferences.getInstance();
    
    // Run checks in parallel for efficiency
    await Future.wait([
      _checkStudentGrowth(schoolId, userId, prefs),
      _checkIncomeMomentum(schoolId, userId, prefs),
      _checkCollectionHealth(schoolId, userId, prefs),
      _checkMonthlySummary(schoolId, userId, prefs),
    ]);
  }

  // ---------------------------------------------------------------------------
  // 1. GROWTH & MILESTONES (The Cheerleader)
  // ---------------------------------------------------------------------------
  Future<void> _checkStudentGrowth(
    String schoolId, 
    String userId, 
    SharedPreferences prefs
  ) async {
    final key = 'noti_last_student_count_$schoolId';
    final lastCount = prefs.getInt(key) ?? 0;

    final res = await db.getOptional(
      "SELECT count(*) as count FROM students WHERE school_id = ? AND status = 'ACTIVE'",
      [schoolId],
    );
    final currentCount = (res?['count'] as num?)?.toInt() ?? 0;

    // Only notify on significant growth (increments of 10, 50, 100)
    // Adjust logic: If we crossed a "ten" boundary we haven't seen before
    if (currentCount > lastCount) {
      bool milestone = false;
      String message = "";

      if (lastCount < 50 && currentCount >= 50) {
        milestone = true;
        message = "Fifty active students! The campus is coming to life.";
      } else if (lastCount < 100 && currentCount >= 100) {
        milestone = true;
        message = "Triple digits! You've reached 100 active students. Serious growth.";
      } else if ((currentCount ~/ 50) > (lastCount ~/ 50)) {
        // Every 50 students after 100
        milestone = true;
        message = "Another 50 students joined. Your reach is expanding.";
      }

      if (milestone) {
        await _createNotification(
          schoolId: schoolId,
          userId: userId,
          title: "Growth Milestone ",
          message: message,
          type: 'INSIGHT',
          metadata: {'route': AppRoutes.students, 'value': currentCount},
        );
      }
      
      // Update state
      await prefs.setInt(key, currentCount);
    }
  }

  // ---------------------------------------------------------------------------
  // 2. INCOME MOMENTUM (The CFO)
  // ---------------------------------------------------------------------------
  Future<void> _checkIncomeMomentum(
    String schoolId, 
    String userId, 
    SharedPreferences prefs
  ) async {
    final todayStr = DateTime.now().toIso8601String().substring(0, 10);
    final key = 'noti_income_check_$schoolId';
    final lastCheckDate = prefs.getString(key);

    // Don't spam: Only run this check once per day in the evening (e.g., after 4 PM)
    // or if we haven't checked today.
    if (lastCheckDate == todayStr) return; // Already checked today

    final now = DateTime.now();
    if (now.hour < 16) return; // Wait until end of day for the summary

    // Compare Today vs Yesterday
    final todayRes = await db.getOptional(
      "SELECT SUM(amount) as total FROM payments WHERE school_id = ? AND substr(received_at, 1, 10) = ?",
      [schoolId, todayStr],
    );
    final yesterdayStr = now.subtract(const Duration(days: 1)).toIso8601String().substring(0, 10);
    final yesterdayRes = await db.getOptional(
      "SELECT SUM(amount) as total FROM payments WHERE school_id = ? AND substr(received_at, 1, 10) = ?",
      [schoolId, yesterdayStr],
    );

    final todayTotal = (todayRes?['total'] as num?)?.toDouble() ?? 0.0;
    final yesterdayTotal = (yesterdayRes?['total'] as num?)?.toDouble() ?? 0.0;

    if (todayTotal > 0) {
      if (todayTotal > (yesterdayTotal * 1.5) && yesterdayTotal > 0) {
        // 50% increase over yesterday
        await _createNotification(
          schoolId: schoolId,
          userId: userId,
          title: "Revenue Spike ",
          message: "Strong performance today! Collections are up 50% compared to yesterday.",
          type: 'SUCCESS',
          metadata: {'route': AppRoutes.finance, 'amount': todayTotal},
        );
      } else if (todayTotal > 1000) { 
        // Arbitrary "Good Day" threshold - customize this based on config currency later
        await _createNotification(
          schoolId: schoolId,
          userId: userId,
          title: "Solid Collection Day",
          message: "You've collected ${_formatCurrency(todayTotal)} today. Keep the momentum going.",
          type: 'INSIGHT',
          metadata: {'route': AppRoutes.finance, 'amount': todayTotal},
        );
      }
      // Mark as checked for today
      await prefs.setString(key, todayStr);
    }
  }

  // ---------------------------------------------------------------------------
  // 3. COLLECTION HEALTH (The Risk Analyst)
  // ---------------------------------------------------------------------------
  Future<void> _checkCollectionHealth(
    String schoolId, 
    String userId, 
    SharedPreferences prefs
  ) async {
    // Run this weekly (e.g., every Friday)
    final key = 'noti_health_check_week_$schoolId';
    final currentWeek = "${DateTime.now().year}-${_getWeekOfYear(DateTime.now())}";
    
    if (prefs.getString(key) == currentWeek) return;

    final stats = await db.getOptional(
      """
      SELECT 
        (SELECT count(*) FROM invoices WHERE school_id = ? AND status = 'PAID') as paid_count,
        (SELECT count(*) FROM invoices WHERE school_id = ? AND status != 'PAID') as pending_count
      """,
      [schoolId, schoolId],
    );

    final paid = (stats?['paid_count'] as num?)?.toInt() ?? 0;
    final pending = (stats?['pending_count'] as num?)?.toInt() ?? 0;
    final total = paid + pending;

    if (total > 10) { // Only analyse if we have data
      final pendingRate = pending / total;
      
      if (pendingRate > 0.6) {
        await _createNotification(
          schoolId: schoolId,
          userId: userId,
          title: "Cash Flow Alert ",
          message: "Action required: Over 60% of invoices are still pending. Consider sending a bulk reminder.",
          type: 'WARNING',
          metadata: {'route': AppRoutes.finance, 'pending_rate': pendingRate},
        );
      }
    }

    await prefs.setString(key, currentWeek);
  }

  // ---------------------------------------------------------------------------
  // 4. MONTHLY REPORTS (The Secretary)
  // ---------------------------------------------------------------------------
  Future<void> _checkMonthlySummary(
    String schoolId, 
    String userId, 
    SharedPreferences prefs
  ) async {
    final now = DateTime.now();
    // Only run on the 1st of the month
    if (now.day != 1) return;

    final lastMonth = DateTime(now.year, now.month - 1);
    final monthKey = "${lastMonth.year}-${lastMonth.month}";
    final key = 'noti_month_report_$schoolId';

    if (prefs.getString(key) == monthKey) return; // Already generated

    // Calculate last month's total
    final startStr = "${lastMonth.year}-${lastMonth.month.toString().padLeft(2,'0')}-01";
    final endStr = "${lastMonth.year}-${lastMonth.month.toString().padLeft(2,'0')}-31";

    final res = await db.getOptional(
      """
      SELECT SUM(amount) as total 
      FROM payments 
      WHERE school_id = ? 
      AND date(received_at) >= date(?) 
      AND date(received_at) <= date(?)
      """,
      [schoolId, startStr, endStr],
    );

    final total = (res?['total'] as num?)?.toDouble() ?? 0.0;

    await _createNotification(
      schoolId: schoolId,
      userId: userId,
      title: "Monthly Report Ready ",
      message: "Last month closed with ${_formatCurrency(total)} in collections. Tap to see the breakdown.",
      type: 'INFO',
      metadata: {'route': '${AppRoutes.dashboard}/${AppRoutes.statistics}', 'month': monthKey},
    );

    await prefs.setString(key, monthKey);
  }

  // ---------------------------------------------------------------------------
  // INTERNAL HELPERS
  // ---------------------------------------------------------------------------

  Future<void> _createNotification({
    required String schoolId,
    required String userId,
    required String title,
    required String message,
    required String type,
    Map<String, dynamic>? metadata,
  }) async {
    await db.execute(
      """
      INSERT INTO noti (id, school_id, user_id, title, message, type, is_read, metadata, created_at)
      VALUES (?, ?, ?, ?, ?, ?, 0, ?, ?)
      """,
      [
        _uuid.v4(),
        schoolId,
        userId,
        title,
        message,
        type,
        jsonEncode(metadata ?? {}),
        DateTime.now().toIso8601String(),
      ],
    );
  }

  String _formatCurrency(double amount) {
    return "\$${amount.toStringAsFixed(2)}";
  }

  int _getWeekOfYear(DateTime date) {
    final dayOfYear = int.parse("${date.difference(DateTime(date.year, 1, 1, 0, 0)).inDays}");
    return ((dayOfYear - date.weekday + 10) / 7).floor();
  }
}

// ==========================================
// FILE: ./data/services/database_serv.dart
// ==========================================

// ==========================================
// FILE: ./services/database_serv.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/data/services/powersync/powersync_factory.dart';
import 'package:powersync/powersync.dart';

class DatabaseService {
  // Singleton Pattern
  static final DatabaseService _instance = DatabaseService._internal();
  factory DatabaseService() => _instance;
  DatabaseService._internal();

  PowerSyncDatabase? _db;
  bool _isInitialized = false;

  /// Accessor for the DB instance. 
  /// Throws a clear error if accessed too early.
  PowerSyncDatabase get db {
    if (_db == null || !_isInitialized) {
      throw Exception(" DATA LAYER ERROR: Database accessed before initialization. Call initializeStandalone() first.");
    }
    return _db!;
  }

  PowerSyncDatabase? get dbOrNull => _isInitialized ? _db : null;

  SyncStatus? get currentStatus => _isInitialized ? _db?.currentStatus : null;

  Stream<SyncStatus> get statusStream =>
      _isInitialized && _db != null ? _db!.statusStream : const Stream.empty();

  /// 1. Initialize the SQLite file (Offline Mode)
  /// Call this in main.dart before runApp()
  Future<void> initializeStandalone() async {
    if (_isInitialized) return;

    try {
      _db = await PowerSyncFactory.openDatabase();
      _isInitialized = true;
      debugPrint(" Database (Offline) Ready");
    } catch (e) {
      debugPrint(" Database Init Failed: $e");
      rethrow;
    }
  }

  /// 2. Connect to the Cloud (Online Mode)
  /// Call this in AuthService after login
  Future<void> connect(PowerSyncBackendConnector connector) async {
    if (!_isInitialized) await initializeStandalone();

    try {
      _db!.connect(connector: connector);
      debugPrint(" Database Connecting to Cloud...");
    } catch (e) {
      debugPrint(" Database Connection Failed: $e");
    }
  }

  /// 3. Clean up
  Future<void> close() async {
    await _db?.disconnect();
    debugPrint(" Database Disconnected");
  }
}

// Global accessor for cleaner code in Repositories
PowerSyncDatabase get db => DatabaseService().db;

// ==========================================
// FILE: ./data/models/menu_item.dart
// ==========================================

// lib/models/screen_models.dart

/// Menu Items for the Drawer/Nav.
class MenuItem {
  final String title;
  final String route;
  final dynamic icon; // IconData usually

  MenuItem(this.title, this.route, this.icon);
}

// ==========================================
// FILE: ./data/models/legend_notification.dart
// ==========================================

import 'dart:convert';
import 'package:legend/data/models/notification_type.dart';

/// Represents a notification or insight from the Legend Engine.
/// Maps to table: `legend.noti`
class LegendNotification {
  final String id;
  final String schoolId;
  final String? userId; // If null, it's a broadcast message
  final String title;
  final String message;
  final NotificationType type;
  final bool isRead;
  final Map<String, dynamic> metadata; // For linking to invoices/students
  final DateTime createdAt;

  LegendNotification({
    required this.id,
    required this.schoolId,
    this.userId,
    required this.title,
    required this.message,
    this.type = NotificationType.info,
    this.isRead = false,
    this.metadata = const {},
    required this.createdAt,
  });

  /// Factory to parse from PowerSync/SQLite Row
  factory LegendNotification.fromRow(Map<String, dynamic> row) {
    return LegendNotification(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      userId: row['user_id'] as String?,
      title: row['title'] as String,
      message: row['message'] as String,
      type: _parseType(row['type']),
      // SQLite stores booleans as 0 or 1 usually, but PowerSync might map to bool.
      // We handle both just in case.
      isRead: row['is_read'] == 1 || row['is_read'] == true,
      metadata: _parseJson(row['metadata']),
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  /// Convert to Map for Saving (if generating local notifications)
  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'user_id': userId,
      'title': title,
      'message': message,
      'type': type.name.toUpperCase(),
      'is_read': isRead ? 1 : 0,
      'metadata': jsonEncode(metadata),
      'created_at': createdAt.toIso8601String(),
    };
  }

  /// Helper to safely parse the Enum
  static NotificationType _parseType(String? val) {
    switch (val?.toUpperCase()) {
      case 'GROWTH': return NotificationType.insight;
      case 'FINANCE': return NotificationType.success;
      case 'ALERT': return NotificationType.warning;
      case 'REPORT': return NotificationType.info;
      case 'SUCCESS': return NotificationType.success;
      case 'WARNING': return NotificationType.warning;
      case 'INSIGHT': return NotificationType.insight;
      case 'SYSTEM': return NotificationType.system;
      default: return NotificationType.info;
    }
  }

  /// Helper to safely parse JSONB columns
  static Map<String, dynamic> _parseJson(dynamic val) {
    if (val == null) return {};
    if (val is Map) return Map<String, dynamic>.from(val);
    if (val is String) {
      try {
        return jsonDecode(val) as Map<String, dynamic>;
      } catch (e) {
        // Fallback if parsing fails
        return {}; 
      }
    }
    return {};
  }
}

// ==========================================
// FILE: ./data/models/invoice.dart
// ==========================================

// lib/data/models/invoice.dart
import 'package:legend/data/models/invoice_status.dart';

class Invoice {
  final String id;
  final String schoolId;
  final String studentId;
  final String invoiceNumber;

  //  DB columns you already have
  final String? termId;
  final DateTime dueDate;
  final InvoiceStatus status;
  final String? snapshotGrade;
  final double totalAmount;
  final double paidAmount;
  final String? title;
  final DateTime? createdAt;

  Invoice({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.invoiceNumber,
    this.termId,
    required this.dueDate,
    this.status = InvoiceStatus.draft,
    this.snapshotGrade,
    this.totalAmount = 0.0,
    this.paidAmount = 0.0,
    this.title,
    this.createdAt,
  });

  factory Invoice.fromRow(Map<String, dynamic> row) {
    return Invoice(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      invoiceNumber: row['invoice_number'] as String,
      termId: row['term_id'] as String?,
      dueDate: _parseDate(row['due_date']),
      status: _parseStatus(row['status'] as String?),
      snapshotGrade: row['snapshot_grade'] as String?,
      totalAmount: (row['total_amount'] as num?)?.toDouble() ?? 0.0,
      paidAmount: (row['paid_amount'] as num?)?.toDouble() ?? 0.0,
      title: row['title'] as String?,
createdAt: row['created_at'] != null ? DateTime.tryParse(row['created_at'].toString()) : null,

    );
  }

  static DateTime _parseDate(dynamic raw, {DateTime? fallback}) {
  if (raw == null) return fallback ?? DateTime.fromMillisecondsSinceEpoch(0);
  if (raw is DateTime) return raw;
  if (raw is int) return DateTime.fromMillisecondsSinceEpoch(raw);
  if (raw is String) return DateTime.parse(raw);
  return fallback ?? DateTime.fromMillisecondsSinceEpoch(0);
}


  static InvoiceStatus _parseStatus(String? val) {
    final v = val?.trim().toUpperCase();
    switch (v) {
      case 'PENDING':
        return InvoiceStatus.pending;
      case 'PAID':
        return InvoiceStatus.paid;
      case 'PARTIAL':
        return InvoiceStatus.partial;
      case 'OVERDUE':
        return InvoiceStatus.overdue;

      // Accept both
      case 'VOID':
      case 'VOIDED':
        return InvoiceStatus.voided;

      // Accept both spellings
      case 'CANCELLED':
      case 'CANCELED':
        return InvoiceStatus.cancelled;

      case 'DRAFT':
      default:
        return InvoiceStatus.draft;
    }
  }

  
}

// ==========================================
// FILE: ./data/models/ledger_type.dart
// ==========================================

// lib/models/billing_models.dart

enum LedgerType { debit, credit }

// ==========================================
// FILE: ./data/models/enrollment.dart
// ==========================================

import 'dart:convert';

class Enrollment {
  final String id;
  final String schoolId;
  final String studentId;
  final String academicYearId;

  final String gradeLevel; // "Form 1"
  final String? classStream; // "East"
  final bool isActive;

  // Added to match DB columns and existing UI expectations
  final DateTime? createdAt;
  final DateTime? enrollmentDate;

  // Stored as jsonb in Supabase; TEXT(JSON) in SQLite
  final List<String> subjects;
  final double tuitionAmount;

  Enrollment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.academicYearId,
    required this.gradeLevel,
    this.classStream,
    this.isActive = true,
    this.createdAt,
    this.enrollmentDate,
    this.subjects = const [],
    this.tuitionAmount = 0.0,
  });

  // Backward aliases for older code
  DateTime? get enrollment_date => enrollmentDate;

  static DateTime? _parseDate(dynamic raw) {
    if (raw == null) return null;
    if (raw is DateTime) return raw;

    // Sometimes adapters return int timestamps
    if (raw is int) {
      return DateTime.fromMillisecondsSinceEpoch(raw);
    }

    return DateTime.tryParse(raw.toString());
  }

  static List<String> _parseSubjects(dynamic raw) {
    if (raw == null) return const [];

    // Supabase jsonb typically arrives as List<dynamic>
    if (raw is List) return _subjectListFromDynamic(raw);

    // SQLite TEXT containing JSON
    final s = raw.toString().trim();
    if (s.isEmpty) return const [];

    final decoded = _decodeSubjectsString(s);
    if (decoded.isNotEmpty) return decoded;

    // Fallback: CSV/semicolon or single subject string
    final parts = s.split(RegExp(r'[;,]')).map((e) => e.trim()).where((e) => e.isNotEmpty).toList();
    if (parts.isNotEmpty) return parts;

    return const [];
  }

  static List<String> _decodeSubjectsString(String s) {
    try {
      final decoded = jsonDecode(s);
      if (decoded is List) return _subjectListFromDynamic(decoded);
      if (decoded is String) {
        final nested = jsonDecode(decoded);
        if (nested is List) return _subjectListFromDynamic(nested);
      }
    } catch (_) {}

    return const [];
  }

  static List<String> _subjectListFromDynamic(List<dynamic> items) {
    return items
        .map((e) {
          if (e is Map) {
            final name = e['subjectName'] ?? e['name'];
            return name?.toString();
          }
          return e.toString();
        })
        .where((e) => e != null && e.trim().isNotEmpty)
        .map((e) => e!.trim())
        .toList();
  }

  factory Enrollment.fromRow(Map<String, dynamic> row) {
    return Enrollment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      academicYearId: row['academic_year_id'] as String,
      gradeLevel: (row['grade_level'] as String?) ?? 'Unknown',
      classStream: row['class_stream'] as String?,
      isActive: row['is_active'] == 1 || row['is_active'] == true,
      createdAt: _parseDate(row['created_at']),
      enrollmentDate: _parseDate(row['enrollment_date']),
      subjects: _parseSubjects(row['subjects']),
      tuitionAmount: (row['tuition_amount'] as num?)?.toDouble() ?? 0.0,
    );
  }
}

// ==========================================
// FILE: ./data/models/student_status.dart
// ==========================================

// lib/models/student_models.dart

/// Represents the status of a student in the academy.
enum StudentStatus { active, suspended, alumni, archived }

// ==========================================
// FILE: ./data/models/dashboard_stats.dart
// ==========================================

// lib/models/screen_models.dart

/// Dashboard Statistics (Aggregated).
class DashboardStats {
  final int totalStudents;
  final double totalOwed;
  final double collectedToday;
  final int pendingInvoices;

  DashboardStats({
    this.totalStudents = 0,
    this.totalOwed = 0.0,
    this.collectedToday = 0.0,
    this.pendingInvoices = 0,
  });
}

// ==========================================
// FILE: ./data/models/academy_year.dart
// ==========================================

class AcademicYear {
  final String id;
  final String schoolId;
  final String name;
  final DateTime startDate;
  final DateTime endDate;
  final bool isActive;
  final bool isLocked;
  final DateTime createdAt;

  AcademicYear({
    required this.id,
    required this.schoolId,
    required this.name,
    required this.startDate,
    required this.endDate,
    this.isActive = false,
    this.isLocked = false,
    required this.createdAt,
  });

  factory AcademicYear.fromRow(Map<String, dynamic> row) {
    return AcademicYear(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      startDate: DateTime.tryParse(row['start_date'] ?? '') ?? DateTime.now(),
      endDate: DateTime.tryParse(row['end_date'] ?? '') ?? DateTime.now(),
      isActive: row['is_active'] == 1 || row['is_active'] == true,
      isLocked: row['is_locked'] == 1 || row['is_locked'] == true,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'name': name,
      'start_date': startDate.toIso8601String(),
      'end_date': endDate.toIso8601String(),
      'is_active': isActive ? 1 : 0,
      'is_locked': isLocked ? 1 : 0,
      'created_at': createdAt.toIso8601String(),
    };
  }

  AcademicYear copyWith({
    String? id,
    String? schoolId,
    String? name,
    DateTime? startDate,
    DateTime? endDate,
    bool? isActive,
    bool? isLocked,
    DateTime? createdAt,
  }) {
    return AcademicYear(
      id: id ?? this.id,
      schoolId: schoolId ?? this.schoolId,
      name: name ?? this.name,
      startDate: startDate ?? this.startDate,
      endDate: endDate ?? this.endDate,
      isActive: isActive ?? this.isActive,
      isLocked: isLocked ?? this.isLocked,
      createdAt: createdAt ?? this.createdAt,
    );
  }
}
// ==========================================
// FILE: ./data/models/all_models.dart
// ==========================================

//-------------------------------------------------
// lib/models/all_models.dart
// Barrel file to export all models
// ------------------------------------------------

export 'dart:convert';

// Core Academic
export 'academy_year.dart';
export 'term.dart';
export 'grade.dart';
export 'class.dart';
export 'school_config.dart';

// People
export 'legend_profile.dart';
export 'student.dart';
export 'enrollment.dart';
export 'student_status.dart';
export 'student_type.dart';

// Finance
export 'fees_cat.dart';
export 'fee_structure.dart';
export 'invoice.dart';
export 'invoice_item.dart';
export 'invoice_status.dart';
export 'payment.dart';
export 'payment_allocation.dart';
export 'ledger_entry.dart';
export 'ledger_type.dart';

// System / Utility
export 'legend_notification.dart';
export 'notification_type.dart';
export 'legend_dev_info.dart';
export 'log_entry.dart';
export 'log_type.dart';

// UI / Dashboard
export 'menu_item.dart';
export 'dashboard_stats.dart';
export 'insight_item.dart';

export 'package:legend/data/constants/subjects.dart';
// ==========================================
// FILE: ./data/models/payment_allocation.dart
// ==========================================

class PaymentAllocation {
  final String id;
  final String schoolId;
  final String paymentId;
  final String invoiceItemId;
  final double amountAllocated;
  final DateTime createdAt;

  PaymentAllocation({
    required this.id,
    required this.schoolId,
    required this.paymentId,
    required this.invoiceItemId,
    required this.amountAllocated,
    required this.createdAt,
  });

  factory PaymentAllocation.fromRow(Map<String, dynamic> row) {
    return PaymentAllocation(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      paymentId: row['payment_id'] as String,
      invoiceItemId: row['invoice_item_id'] as String,
      amountAllocated: (row['amount_allocated'] as num).toDouble(),
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'payment_id': paymentId,
      'invoice_item_id': invoiceItemId,
      'amount_allocated': amountAllocated,
      'created_at': createdAt.toIso8601String(),
    };
  }
}
// ==========================================
// FILE: ./data/models/invoice_item.dart
// ==========================================

// lib/data/models/invoice_item.dart
class InvoiceItem {
  final String id;
  final String schoolId;
  final String invoiceId;

  //  DB columns you already have
  final String? feeStructureId;
  final String description;
  final double amount;
  final int quantity;
  final DateTime? createdAt;

  InvoiceItem({
    required this.id,
    required this.schoolId,
    required this.invoiceId,
    this.feeStructureId,
    required this.description,
    required this.amount,
    this.quantity = 1,
    this.createdAt,
  });

  factory InvoiceItem.fromRow(Map<String, dynamic> row) {
    return InvoiceItem(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      invoiceId: row['invoice_id'] as String,
      feeStructureId: row['fee_structure_id'] as String?,
      description: row['description'] as String,
      amount: (row['amount'] as num).toDouble(),
      quantity: (row['quantity'] as num?)?.toInt() ?? 1,
      createdAt: row['created_at'] != null ? DateTime.tryParse(row['created_at']) : null,
    );
  }
}

// ==========================================
// FILE: ./data/models/ledger_entry.dart
// ==========================================

// lib/data/models/ledger_entry.dart
import 'package:legend/data/models/ledger_type.dart';

class LedgerEntry {
  final String id;
  final String schoolId;
  final String studentId;
  final LedgerType type;

  //  DB columns you already have
  final String category;
  final double amount;
  final String? invoiceId;
  final String? paymentId;

  final String description;
  final DateTime date;

  DateTime get occurredAt => date; //  Backwards compatible alias

  LedgerEntry({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.type,
    required this.category,
    required this.amount,
    this.invoiceId,
    this.paymentId,
    required this.description,
    required this.date,
  });

  factory LedgerEntry.fromRow(Map<String, dynamic> row) {
    return LedgerEntry(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      type: ((row['type'] as String?)?.toUpperCase() == 'DEBIT')
          ? LedgerType.debit
          : LedgerType.credit,
      category: (row['category'] as String?) ?? 'GENERAL',
      amount: (row['amount'] as num).toDouble(),
      invoiceId: row['invoice_id'] as String?,
      paymentId: row['payment_id'] as String?,
      description: (row['description'] as String?) ?? 'Transaction',
      date: DateTime.parse(row['occurred_at']),
    );
  }
}

// ==========================================
// FILE: ./data/models/student_type.dart
// ==========================================

// lib/models/student_models.dart

/// Represents the type of student (Regular School vs Private Lesson).
enum StudentType { academy, private }

// ==========================================
// FILE: ./data/models/fees_cat.dart
// ==========================================

class FeeCategory {
  final String id;
  final String schoolId;
  final String name;
  final bool isTaxable;
  final DateTime createdAt;

  FeeCategory({
    required this.id,
    required this.schoolId,
    required this.name,
    this.isTaxable = false,
    required this.createdAt,
  });

  factory FeeCategory.fromRow(Map<String, dynamic> row) {
    return FeeCategory(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      isTaxable: row['is_taxable'] == 1 || row['is_taxable'] == true,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'name': name,
      'is_taxable': isTaxable ? 1 : 0,
      'created_at': createdAt.toIso8601String(),
    };
  }
}
// ==========================================
// FILE: ./data/models/log_type.dart
// ==========================================

enum LogType { financial, academic, system, alert }

// ==========================================
// FILE: ./data/models/term.dart
// ==========================================

class Term {
  final String id;
  final String academicYearId;
  final String schoolId;
  final String name;
  final DateTime startDate;
  final DateTime endDate;
  final bool isActive;

  Term({
    required this.id,
    required this.academicYearId,
    required this.schoolId,
    required this.name,
    required this.startDate,
    required this.endDate,
    this.isActive = false,
  });

  factory Term.fromRow(Map<String, dynamic> row) {
    return Term(
      id: row['id'] as String,
      academicYearId: row['academic_year_id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      startDate: DateTime.tryParse(row['start_date'] ?? '') ?? DateTime.now(),
      endDate: DateTime.tryParse(row['end_date'] ?? '') ?? DateTime.now(),
      isActive: row['is_active'] == 1 || row['is_active'] == true,
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'academic_year_id': academicYearId,
      'school_id': schoolId,
      'name': name,
      'start_date': startDate.toIso8601String(),
      'end_date': endDate.toIso8601String(),
      'is_active': isActive ? 1 : 0,
    };
  }
}
// ==========================================
// FILE: ./data/models/class.dart
// ==========================================

class SchoolClass {
  final String id;
  final String schoolId;
  final String gradeId;
  final String name;
  final String? teacherId;
  final DateTime createdAt;

  SchoolClass({
    required this.id,
    required this.schoolId,
    required this.gradeId,
    required this.name,
    this.teacherId,
    required this.createdAt,
  });

  factory SchoolClass.fromRow(Map<String, dynamic> row) {
    return SchoolClass(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      gradeId: row['grade_id'] as String,
      name: row['name'] as String,
      teacherId: row['teacher_id'] as String?,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'grade_id': gradeId,
      'name': name,
      'teacher_id': teacherId,
      'created_at': createdAt.toIso8601String(),
    };
  }
}
// ==========================================
// FILE: ./data/models/notification_type.dart
// ==========================================

/// Types of notifications generated by the system.
enum NotificationType { info, success, warning, insight, system }



// ==========================================
// FILE: ./data/models/grade.dart
// ==========================================

class Grade {
  final String id;
  final String schoolId;
  final String name;
  final int levelIndex; // For sorting (e.g., Form 1 < Form 2)
  final DateTime createdAt;

  Grade({
    required this.id,
    required this.schoolId,
    required this.name,
    this.levelIndex = 0,
    required this.createdAt,
  });

  factory Grade.fromRow(Map<String, dynamic> row) {
    return Grade(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      levelIndex: (row['level_index'] as num?)?.toInt() ?? 0,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'name': name,
      'level_index': levelIndex,
      'created_at': createdAt.toIso8601String(),
    };
  }
}
// ==========================================
// FILE: ./data/models/student.dart
// ==========================================

// lib/models/student_models.dart

import 'package:legend/data/models/student_status.dart';
import 'package:legend/data/models/student_type.dart';

class Student {
  final String id;
  final String schoolId;
  final String firstName;
  final String lastName;
  final String? admissionNumber;
  final String? gender; // 'M' or 'F'
  final DateTime? dob;
  
  // Status & Type
  final StudentStatus status;
  final StudentType type;

  // Guardian Info (Denormalized for Pro Schema Efficiency)
  final String? guardianName;
  final String? guardianPhone;
  final String? guardianEmail;
  final String? guardianRelationship;

  // Cached Financials (Quick access without joining ledger)
  final double feesOwed;

  // Add this field
final String billingCycle; // MONTHLY_FIXED / MONTHLY_CUSTOM / TERMLY / YEARLY / CUSTOM

  // Audit
  final DateTime? createdAt;

  Student({
    // Add to constructor (default TERMLY)
this.billingCycle = 'TERMLY',

    required this.id,
    required this.schoolId,
    required this.firstName,
    required this.lastName,
    this.admissionNumber,
    this.gender,
    this.dob,
    this.status = StudentStatus.active,
    this.type = StudentType.academy,
    this.guardianName,
    this.guardianPhone,
    this.guardianEmail,
    this.guardianRelationship,
    this.feesOwed = 0.0,
    this.createdAt,
  });

  String get fullName => "$firstName $lastName";

  /// Factory to parse from PowerSync/SQLite Row
  factory Student.fromRow(Map<String, dynamic> row) {
    return Student(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      firstName: row['first_name'] as String,
      lastName: row['last_name'] as String,
      admissionNumber: row['admission_number'] as String?,
      gender: row['gender'] as String?,
      dob: row['dob'] != null ? DateTime.tryParse(row['dob']) : null,
      status: _parseStatus(row['status']),
      type: _parseType(row['student_type']),
      guardianName: row['guardian_name'] as String?,
      guardianPhone: row['guardian_phone'] as String?,
      guardianEmail: row['guardian_email'] as String?,
      guardianRelationship: row['guardian_relationship'] as String?,
      feesOwed: (row['fees_owed'] as num?)?.toDouble() ?? 0.0,
      createdAt: row['created_at'] != null ? DateTime.tryParse(row['created_at']) : null,
      // Add to fromRow(...)
billingCycle: (row['billing_cycle'] as String?) ?? 'TERMLY',
    );
  }

  /// Convert to Map for Saving
  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'first_name': firstName,
      'last_name': lastName,
      'admission_number': admissionNumber,
      'gender': gender,
      'dob': dob?.toIso8601String(),
      'status': status.name.toUpperCase(),
      'student_type': type.name.toUpperCase(),
      'guardian_name': guardianName,
      'guardian_phone': guardianPhone,
      'guardian_email': guardianEmail,
      'guardian_relationship': guardianRelationship,
      // 'fees_owed' is usually calculated or updated via triggers, not direct UI edit
      'billing_cycle': billingCycle,
    };
  }

  static StudentStatus _parseStatus(String? val) {
    switch (val?.toUpperCase()) {
      case 'SUSPENDED': return StudentStatus.suspended;
      case 'ALUMNI': return StudentStatus.alumni;
      case 'ARCHIVED': return StudentStatus.archived;
      default: return StudentStatus.active;
    }
  }

  static StudentType _parseType(String? val) {
    return val?.toUpperCase() == 'PRIVATE' ? StudentType.private : StudentType.academy;
  }

  void operator [](String other) {}
}

// ==========================================
// FILE: ./data/models/invoice_status.dart
// ==========================================


// lib/data/models/invoice_status.dart
enum InvoiceStatus { draft, pending, paid, partial, overdue, voided, cancelled }

// ==========================================
// FILE: ./data/models/legend_profile.dart
// ==========================================

// lib/models/screen_models.dart

/// Sir Legend's Profile (Logged In User).
class LegendProfile {
  final String id;
  final String fullName;
  final String role; // OWNER, ADMIN
  final bool isBanned;

  LegendProfile({
    required this.id,
    required this.fullName,
    required this.role,
    this.isBanned = false,
  });

  factory LegendProfile.fromRow(Map<String, dynamic> row) {
    return LegendProfile(
      id: (row['id'] as String?) ?? '',
      fullName: (row['full_name'] as String?) ?? 'Unknown User',
      role: (row['role'] as String?) ?? 'USER',
      isBanned: (row['is_banned'] == 1) || (row['is_banned'] == true),
    );
  }
}

// ==========================================
// FILE: ./data/models/payment.dart
// ==========================================

// lib/models/billing_models.dart

/// The Payment: Money In.
class Payment {
  final String id;
  final String schoolId;
  final String studentId;
  final double amount;
  final String method; // Cash, EcoCash
  final String? reference;
  final DateTime receivedAt;

  Payment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.amount,
    required this.method,
    this.reference,
    required this.receivedAt,
  });

  factory Payment.fromRow(Map<String, dynamic> row) {
    return Payment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      amount: (row['amount'] as num).toDouble(),
      method: row['method'] as String,
      reference: row['reference_code'] as String?,
      receivedAt: DateTime.parse(row['received_at']),
    );
  }
}

// ==========================================
// FILE: ./data/models/legend_dev_info.dart
// ==========================================

import 'dart:convert';

/// Represents developer channel info (The "Red Phone").
/// Maps to table: `legend.dev`
class LegendDevInfo {
  final String id;
  final String schoolId;
  final String section; // e.g., 'CONTACT', 'PATCH_NOTES'
  final String? content;
  final Map<String, dynamic> payload; // Version numbers, feature flags
  final bool isSecret;
  final DateTime createdAt;

  LegendDevInfo({
    required this.id,
    required this.schoolId,
    required this.section,
    this.content,
    this.payload = const {},
    this.isSecret = true,
    required this.createdAt,
  });

  factory LegendDevInfo.fromRow(Map<String, dynamic> row) {
    return LegendDevInfo(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      section: row['section'] as String,
      content: row['content'] as String?,
      payload: _parseJson(row['payload']),
      isSecret: row['is_secret'] == 1 || row['is_secret'] == true,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  static Map<String, dynamic> _parseJson(dynamic val) {
    if (val == null) return {};
    if (val is Map) return Map<String, dynamic>.from(val);
    if (val is String) {
      try {
        return jsonDecode(val) as Map<String, dynamic>;
      } catch (e) {
        return {};
      }
    }
    return {};
  }
}
// ==========================================
// FILE: ./data/models/log_entry.dart
// ==========================================

import 'package:legend/data/models/log_type.dart';

class LogEntry {
  final String id;
  final String title;
  final String description;
  final DateTime timestamp;
  final LogType type;
  final String performedBy; // "Admin", "System", "Guardian"

  LogEntry({
    required this.id,
    required this.title,
    required this.description,
    required this.timestamp,
    required this.type,
    required this.performedBy,
  });

  // ---------------------------------------------------------------------------
  // FACTORY: DB Row -> Object
  // ---------------------------------------------------------------------------
  factory LogEntry.fromRow(Map<String, dynamic> row) {
    return LogEntry(
      id: row['id'] as String,
      title: row['title'] ?? 'Unknown Activity',
      description: row['description'] ?? '',
      // Safe Date Parsing
      timestamp: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
      // Safe Enum Parsing (Default to System if unknown)
      type: _parseLogType(row['type']),
      performedBy: row['performed_by'] ?? 'System',
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER: Enum Parser
  // ---------------------------------------------------------------------------
  static LogType _parseLogType(String? val) {
    if (val == null) return LogType.system;
    
    switch (val.toUpperCase()) {
      case 'FINANCIAL': return LogType.financial;
      case 'ALERT':     return LogType.alert;
      case 'ACADEMIC':  return LogType.academic;
      case 'SYSTEM':    return LogType.system;
      default:          return LogType.system;
    }
  }

  // ---------------------------------------------------------------------------
  // OPTIONAL: Object -> DB Row (For writing logs)
  // ---------------------------------------------------------------------------
  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'title': title,
      'description': description,
      'created_at': timestamp.toIso8601String(),
      'type': type.name.toUpperCase(),
      'performed_by': performedBy,
    };
  }
}
// ==========================================
// FILE: ./data/models/fee_structure.dart
// ==========================================

import 'dart:convert';

class FeeStructure {
  final String id;
  final String schoolId;
  final String academicYearId;
  final String categoryId;
  final String name;
  final double amount;
  final String billingType; // 'tuition', 'exam', etc.
  final String recurrence; // 'termly', 'monthly'
  final List<int> billableMonths; // [1, 5, 9] for termly starts
  final String? targetGrade; // Specific grade or null for all
  final DateTime createdAt;

  FeeStructure({
    required this.id,
    required this.schoolId,
    required this.academicYearId,
    required this.categoryId,
    required this.name,
    required this.amount,
    this.billingType = 'tuition',
    this.recurrence = 'termly',
    this.billableMonths = const [],
    this.targetGrade,
    required this.createdAt,
  });

  factory FeeStructure.fromRow(Map<String, dynamic> row) {
    return FeeStructure(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      academicYearId: row['academic_year_id'] as String,
      categoryId: row['category_id'] as String,
      name: row['name'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      billingType: row['billing_type'] ?? 'tuition',
      recurrence: row['recurrence'] ?? 'termly',
      billableMonths: _parseBillableMonths(row['billable_months']),
      targetGrade: row['target_grade'] as String?,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'academic_year_id': academicYearId,
      'category_id': categoryId,
      'name': name,
      'amount': amount,
      'billing_type': billingType,
      'recurrence': recurrence,
      // PowerSync stores arrays/JSON as strings
      'billable_months': jsonEncode(billableMonths),
      'target_grade': targetGrade,
      'created_at': createdAt.toIso8601String(),
    };
  }

  // Handle SQLite/PowerSync data vagueness
  static List<int> _parseBillableMonths(dynamic val) {
    if (val == null) return [];
    try {
      if (val is String) {
        // Handle Postgres Array syntax '{1,2,3}' if raw, or JSON '[1,2,3]'
        final cleaned = val.replaceAll('{', '[').replaceAll('}', ']');
        final List<dynamic> list = jsonDecode(cleaned);
        return list.map((e) => e as int).toList();
      }
      if (val is List) return val.map((e) => e as int).toList();
    } catch (e) {
      return [];
    }
    return [];
  }
}
// ==========================================
// FILE: ./data/models/insight_item.dart
// ==========================================

// lib/models/screen_models.dart

/// Notification / Insight Item.
class InsightItem {
  final String title;
  final String message;
  final String type; // ALERT, INFO
  final DateTime time;

  InsightItem({
    required this.title,
    required this.message,
    required this.type,
    required this.time,
  });
}

// ==========================================
// FILE: ./data/models/school_config.dart
// ==========================================

// ==========================================
// FILE: ./models/school_config.dart
// ==========================================

class SchoolConfig {
  final String id;
  final String name;
  final String currency;
  final String? address;
  final String? logoUrl;
  final String ownerId;

  SchoolConfig({
    required this.id,
    required this.name,
    required this.currency,
    this.address,
    this.logoUrl,
    required this.ownerId,
  });

  factory SchoolConfig.fromJson(Map<String, dynamic> json) {
    return SchoolConfig(
      id: json['id'] as String,
      name: json['school_name'] as String,
      currency: json['currency'] as String? ?? 'USD',
      address: json['address'] as String?,
      logoUrl: json['logo_url'] as String?,
      ownerId: json['owner_id'] as String,
    );
  }

  // Used for PowerSync Local Saves
  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_name': name,
      'currency': currency,
      'address': address,
      'logo_url': logoUrl,
      'owner_id': ownerId,
    };
  }
  
  // Used for Supabase Remote Saves (Standard JSON)
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'school_name': name,
      'currency': currency,
      'address': address,
      'logo_url': logoUrl,
      'owner_id': ownerId,
    };
  }
}
// ==========================================
// FILE: ./data/repo/student_repo.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:powersync/powersync.dart';

class StudentException implements Exception {
  final String message;
  StudentException(this.message);
  @override
  String toString() => message;
}

class StudentRepository {
  PowerSyncDatabase get _db => DatabaseService().db;
  final _uuid = const Uuid();

  // ---------------------------------------------------------------------------
  // 1) READINESS & CONFIG
  // ---------------------------------------------------------------------------

  Future<String?> checkSchoolReadiness(String schoolId) async {
    try {
      final yearResult = await _db.get(
        "SELECT count(*) as count FROM academic_years WHERE school_id = ? AND is_active = 1",
        [schoolId],
      );
      if (((yearResult['count'] as num?)?.toInt() ?? 0) == 0) {
        return "No Active Academic Year found. Please go to Settings > Academic Year.";
      }

      final classResult = await _db.get(
        "SELECT count(*) as count FROM classes WHERE school_id = ?",
        [schoolId],
      );
      if (((classResult['count'] as num?)?.toInt() ?? 0) == 0) {
        return "No Classes defined. Please go to Settings > Classes.";
      }

      return null;
    } catch (e) {
      return "System Error checking readiness: $e";
    }
  }

  Future<List<SchoolClass>> getClasses(String schoolId) async {
    final rows = await _db.getAll(
      "SELECT * FROM classes WHERE school_id = ? ORDER BY name ASC",
      [schoolId],
    );
    return rows.map((r) => SchoolClass.fromRow(r)).toList();
  }

  Future<List<String>> getBillingCycles() async {
    // UI labels. DB values are MONTHLY_FIXED/MONTHLY_CUSTOM/TERMLY/YEARLY/CUSTOM.
    return ['Monthly Fixed', 'Monthly Custom', 'Termly', 'Yearly', 'Custom'];
  }

  // ---------------------------------------------------------------------------
  // 2) STANDARD CRUD
  // ---------------------------------------------------------------------------

  Future<List<Student>> getStudents(String schoolId) async {
    try {
      final result = await _db.getAll(
        '''
        SELECT * FROM students 
        WHERE school_id = ? AND status != 'ARCHIVED'
        ORDER BY last_name, first_name
        ''',
        [schoolId],
      );
      return result.map((row) => Student.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching students: $e");
      rethrow;
    }
  }

  Stream<List<Student>> watchStudents(String schoolId) {
    return _db
        .watch(
          '''
          SELECT * FROM students
          WHERE school_id = ? AND status != 'ARCHIVED'
          ORDER BY last_name, first_name
          ''',
          parameters: [schoolId],
        )
        .map((rows) => rows.map((row) => Student.fromRow(row)).toList());
  }

  Future<Student?> getStudentById(String id) async {
    try {
      final result = await _db.getOptional(
        'SELECT * FROM students WHERE id = ?',
        [id],
      );
      return result != null ? Student.fromRow(result) : null;
    } catch (e) {
      debugPrint("Error fetching student: $e");
      rethrow;
    }
  }

  Future<List<Enrollment>> getEnrollments(
    String studentId, {
    bool includeInactive = true,
  }) async {
    try {
      final sql = includeInactive
          ? '''
          SELECT *
          FROM enrollments
          WHERE student_id = ?
          ORDER BY is_active DESC, created_at DESC
        '''
          : '''
          SELECT *
          FROM enrollments
          WHERE student_id = ? AND is_active = 1
          ORDER BY created_at DESC
        ''';

      final result = await _db.getAll(sql, [studentId]);
      return result.map((row) => Enrollment.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching enrollments: $e");
      rethrow;
    }
  }

  Future<void> deleteStudent(String id) async {
    try {
      await _db.execute(
        "UPDATE students SET status = 'ARCHIVED' WHERE id = ?",
        [id],
      );
    } catch (e) {
      debugPrint("Error deleting student: $e");
      rethrow;
    }
  }

  Future<void> updateStudent(Student student) async {
    try {
      await _db.execute(
        '''
        UPDATE students SET
          first_name = ?, last_name = ?, gender = ?, 
          guardian_name = ?, guardian_phone = ?, guardian_email = ?, student_type = ?
        WHERE id = ?
        ''',
        [
          student.firstName,
          student.lastName,
          student.gender,
          student.guardianName,
          student.guardianPhone,
          student.guardianEmail,
          student.type.name.toUpperCase(), // ACADEMY/PRIVATE
          student.id,
        ],
      );
    } catch (e) {
      debugPrint("Error updating student: $e");
      rethrow;
    }
  }

  Future<void> registerStudent({
    required String schoolId,
    required String firstName,
    required String lastName,
    required String gender,
    required String type,
    required String billingCycle,
    required String guardianName,
    required String guardianPhone,
    String? guardianEmail,
    required String classId,
    required double openingBalance,
    String? debtDescription,
    required List<String> subjects,
    required double tuitionAmount,
    required double initialPayment,
    required String paymentMethod,
  }) async {
    debugPrint(" Starting Atomic Registration & Billing...");

    // Hard guards (no UI trust)
    final ob = openingBalance.isFinite ? openingBalance : 0.0;
    final ip = initialPayment.isFinite ? initialPayment : 0.0;

    if (ob < 0) {
      throw StudentException("Opening Balance cannot be negative.");
    }
    if (ip < 0) {
      throw StudentException("Initial Payment cannot be negative.");
    }
    if (ob == 0 && ip > 0) {
      throw StudentException(
        "Initial Payment requires an Opening Balance invoice. Set Opening Balance > 0 or record payment later.",
      );
    }
    if (ob > 0 && ip > ob) {
      throw StudentException(
        "Initial Payment cannot exceed the Opening Balance.",
      );
    }
    if (subjects.isEmpty) {
      throw StudentException("At least one subject must be selected.");
    }
    if (tuitionAmount < 0) {
      throw StudentException("Tuition amount cannot be negative.");
    }

    await _db.writeTransaction((tx) async {
      // 1) DEPENDENCIES
      final activeYearRow = await tx.getOptional(
        "SELECT id FROM academic_years WHERE school_id = ? AND is_active = 1 LIMIT 1",
        [schoolId],
      );
      if (activeYearRow == null) {
        throw StudentException(
          "Cannot register: No Active Academic Year found.",
        );
      }
      final String activeYearId = activeYearRow['id'] as String;

      final activeTermRow = await tx.getOptional(
        "SELECT id FROM terms WHERE school_id = ? AND is_active = 1 LIMIT 1",
        [schoolId],
      );
      final String? activeTermId = activeTermRow?['id'] as String?;

      if (ob > 0 && activeTermId == null) {
        throw StudentException(
          "Cannot create opening balance: No Active Term found. Go to Settings > Terms.",
        );
      }

      final gradeRow = await tx.get(
        "SELECT g.name as grade_name FROM classes c JOIN grades g ON c.grade_id = g.id WHERE c.id = ?",
        [classId],
      );
      final String gradeLevel =
          (gradeRow['grade_name'] as String?) ?? 'Unknown';

      // 2) IDS
      final String studentId = _uuid.v4();
      final String enrollmentId = _uuid.v4();
      final String admissionNumber =
          "STU-${DateTime.now().millisecondsSinceEpoch.toString().substring(8)}";

      // Use UTC to avoid date() issues across devices
      final now = DateTime.now().toUtc();
      final nowIso = now.toIso8601String();

      // 3) NORMALIZE ENUM STRINGS (DB CHECK CONSTRAINT SAFE)
      final String studentTypeDb = _normStudentType(type);
      final String billingCycleDb = _normBillingCycle(billingCycle);
      final String genderDb = _normGender(gender);

      final String? guardianEmailDb = (guardianEmail ?? '').trim().isEmpty
          ? null
          : guardianEmail!.trim();

      // 4) INSERT STUDENT
      await tx.execute(
        """
      INSERT INTO students (
        id, school_id, first_name, last_name, gender, admission_number,
        guardian_name, guardian_phone, guardian_email, student_type,
        billing_cycle, status, fees_owed, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'ACTIVE', 0, ?)
      """,
        [
          studentId,
          schoolId,
          firstName.trim(),
          lastName.trim(),
          genderDb,
          admissionNumber,
          guardianName.trim(),
          guardianPhone.trim(),
          guardianEmailDb,
          studentTypeDb,
          billingCycleDb,
          nowIso,
        ],
      );

      // 5) INSERT ENROLLMENT (subjects JSON)
      final subjectsJson = jsonEncode(subjects);
      await tx.execute(
        """
      INSERT INTO enrollments (
        id, school_id, student_id, class_id, academic_year_id,
        enrollment_date, subjects, tuition_amount, grade_level, is_active, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 1, ?)
      """,
        [
          enrollmentId,
          schoolId,
          studentId,
          classId,
          activeYearId,
          nowIso,
          subjectsJson,
          tuitionAmount,
          gradeLevel,
          nowIso,
        ],
      );

      String? openingInvoiceId;

      // 6) OPENING BALANCE (DEBIT -> INVOICE + LEDGER + STUDENT FEES_OWED)
      if (ob > 0) {
        openingInvoiceId = _uuid.v4();

        // IMPORTANT: must be in your enum universe
        const openingStatus = 'PENDING';

        final invoiceNum =
            'INV-${now.year}-${now.month.toString().padLeft(2, '0')}-${now.millisecondsSinceEpoch.toString().substring(9)}';

        await tx.execute(
          """
        INSERT INTO invoices (
          id, school_id, student_id, term_id, invoice_number,
          total_amount, paid_amount, status, due_date, title, created_at
        )
        VALUES (?, ?, ?, ?, ?, ?, 0, ?, ?, ?, ?)
        """,
          [
            openingInvoiceId,
            schoolId,
            studentId,
            activeTermId,
            invoiceNum,
            ob,
            openingStatus,
            nowIso, // due_date (you can change later to policy-based due dates)
            "Opening Balance",
            nowIso,
          ],
        );

        await tx.execute(
          """
        INSERT INTO invoice_items (
          id, school_id, invoice_id, fee_structure_id,
          description, amount, quantity, created_at
        )
        VALUES (?, ?, ?, NULL, ?, ?, 1, ?)
        """,
          [
            _uuid.v4(),
            schoolId,
            openingInvoiceId,
            (debtDescription ?? '').trim().isEmpty
                ? "Previous Debt"
                : debtDescription!.trim(),
            ob,
            nowIso,
          ],
        );

        await tx.execute(
          """
        INSERT INTO ledger (
          id, school_id, student_id, type, category, amount,
          invoice_id, payment_id, description, occurred_at
        )
        VALUES (?, ?, ?, 'DEBIT', 'INVOICE', ?, ?, NULL, ?, ?)
        """,
          [
            _uuid.v4(),
            schoolId,
            studentId,
            ob,
            openingInvoiceId,
            "Opening Balance Raised",
            nowIso,
          ],
        );

        // fees_owed increases by opening balance
        await tx.execute(
          "UPDATE students SET fees_owed = COALESCE(fees_owed, 0) + ? WHERE id = ?",
          [ob, studentId],
        );
      }

      // 7) INITIAL PAYMENT (CREDIT -> PAYMENT + LEDGER + APPLY TO OPENING INVOICE)
      if (ip > 0) {
        final paymentId = _uuid.v4();
        final methodDb = _normPaymentMethod(paymentMethod);

        await tx.execute(
          """
        INSERT INTO payments (
          id, school_id, student_id, amount, method, reference_code, received_at
        )
        VALUES (?, ?, ?, ?, ?, 'INITIAL_DEPOSIT', ?)
        """,
          [paymentId, schoolId, studentId, ip, methodDb, nowIso],
        );

        // Link this credit to the opening invoice via ledger if we have one
        await tx.execute(
          """
        INSERT INTO ledger (
          id, school_id, student_id, type, category, amount,
          invoice_id, payment_id, description, occurred_at
        )
        VALUES (?, ?, ?, 'CREDIT', 'PAYMENT', ?, ?, ?, ?, ?)
        """,
          [
            _uuid.v4(),
            schoolId,
            studentId,
            ip,
            openingInvoiceId, // may be null (but we guard against ip>0 when ob==0)
            paymentId,
            "Initial Deposit via $methodDb",
            nowIso,
          ],
        );

        // Apply to invoice: paid_amount + status
        if (openingInvoiceId != null) {
          final newPaid = ip;
          final newStatus = (newPaid >= ob) ? 'PAID' : 'PARTIAL';

          await tx.execute(
            """
          UPDATE invoices
          SET paid_amount = COALESCE(paid_amount, 0) + ?,
              status = ?
          WHERE id = ?
          """,
            [ip, newStatus, openingInvoiceId],
          );
        }

        // Reduce fees_owed (never negative)
        await tx.execute(
          """
        UPDATE students
        SET fees_owed = CASE
          WHEN COALESCE(fees_owed, 0) - ? < 0 THEN 0
          ELSE COALESCE(fees_owed, 0) - ?
        END
        WHERE id = ?
        """,
          [ip, ip, studentId],
        );
      }
    });

    debugPrint(" Atomic Registration & Billing Complete!");
  }

  // Keep your existing normalizers; add this if you dont have it yet:
  String _normPaymentMethod(String v) {
    final s = v.trim().toUpperCase();
    switch (s) {
      case 'CASH':
        return 'CASH';
      case 'ECOCASH':
        return 'ECOCASH';
      case 'BANK':
      case 'TRANSFER':
        return 'TRANSFER';
      case 'SWIPE':
        return 'SWIPE';
      default:
        return 'CASH';
    }
  }

  // ---------------------------------------------------------------------------
  // 4) LOGS (REAL IMPLEMENTATION: derived from ledger)
  // ---------------------------------------------------------------------------

  Future<Map<String, double>> getStudentLedgerSummary(String studentId) async {
    try {
      final row = await _db.getOptional(
        """
        SELECT
          COALESCE(SUM(CASE WHEN UPPER(type) = 'DEBIT' THEN amount ELSE 0 END), 0) as debits,
          COALESCE(SUM(CASE WHEN UPPER(type) = 'CREDIT' THEN amount ELSE 0 END), 0) as credits
        FROM ledger
        WHERE student_id = ?
        """,
        [studentId],
      );

      final debits = (row?['debits'] as num?)?.toDouble() ?? 0.0;
      final credits = (row?['credits'] as num?)?.toDouble() ?? 0.0;
      return {
        'debits': debits,
        'credits': credits,
        'balance': (debits - credits),
      };
    } catch (e) {
      debugPrint("Error fetching ledger summary: $e");
      return {
        'debits': 0.0,
        'credits': 0.0,
        'balance': 0.0,
      };
    }
  }

  Future<List<LogEntry>> getStudentLogs(String studentId) async {
    try {
      final rows = await _db.getAll(
        """
        SELECT id, type, category, amount, description, occurred_at
        FROM ledger
        WHERE student_id = ?
        ORDER BY occurred_at DESC
        LIMIT 50
        """,
        [studentId],
      );

      return rows.map((r) {
        final occurredAt =
            DateTime.tryParse((r['occurred_at'] as String?) ?? '') ??
            DateTime.now();
        final category = (r['category'] as String?) ?? 'SYSTEM';
        final type = ((r['type'] as String?) ?? '').toUpperCase();
        final amount = (r['amount'] as num?)?.toDouble() ?? 0.0;

        final title = "$category ${type == 'CREDIT' ? 'Credit' : 'Debit'}";
        final desc = (r['description'] as String?) ?? '$category transaction';
        final logType = LogType.financial;

        return LogEntry(
          id: (r['id'] as String?) ?? _uuid.v4(),
          title: title,
          description: "$desc ($amount)",
          timestamp: occurredAt,
          type: logType,
          performedBy: "System",
        );
      }).toList();
    } catch (e) {
      debugPrint("Error fetching logs from ledger: $e");
      return [];
    }
  }

  // ---------------------------------------------------------------------------
  // HELPERS: normalize values to satisfy DB CHECK constraints
  // ---------------------------------------------------------------------------

  String _normBillingCycle(String raw) {
    final v = raw.trim().toUpperCase();
    if (v == 'MONTHLY') return 'MONTHLY_FIXED';
    if (v == 'MONTHLY_FIXED') return 'MONTHLY_FIXED';
    if (v == 'MONTHLY_CUSTOM') return 'MONTHLY_CUSTOM';
    if (v == 'TERMLY' || v == 'TERM' || v == 'TERMly'.toUpperCase())
      return 'TERMLY';
    if (v == 'YEARLY' || v == 'ANNUAL' || v == 'ANNUALLY') return 'YEARLY';
    if (v == 'CUSTOM') return 'CUSTOM';

    // UI labels support
    if (v.startsWith('MON')) return 'MONTHLY_FIXED';
    if (v.startsWith('TER')) return 'TERMLY';
    if (v.startsWith('YEA') || v.startsWith('ANN')) return 'YEARLY';
    if (v.startsWith('CUS')) return 'CUSTOM';

    // Safe default (matches DB default too)
    return 'TERMLY';
  }

  String _normStudentType(String raw) {
    final v = raw.trim().toUpperCase();
    if (v == 'PRIVATE') return 'PRIVATE';
    if (v == 'ACADEMY') return 'ACADEMY';

    // UI labels support
    if (v.startsWith('PRI')) return 'PRIVATE';

    return 'ACADEMY';
  }

  String _normGender(String raw) {
    final v = raw.trim().toUpperCase();
    if (v == 'M' || v == 'MALE') return 'M';
    if (v == 'F' || v == 'FEMALE') return 'F';
    // DB allows Male/Female/M/F, but keep it strict to avoid surprises.
    return v.isNotEmpty ? v[0] : 'M';
  }
}

// ==========================================
// FILE: ./data/repo/auth/school_repo.dart
// ==========================================

import 'package:flutter/foundation.dart' show debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SchoolException implements Exception {
  final String message;
  SchoolException(this.message);
  @override
  String toString() => message;
}

class SchoolRepository {
  final SupabaseClient _supabase;
  static const String _storagePrefix = 'cached_school_config';

  SchoolRepository(this._supabase);

  static String _keyForUser(String userId) => '$_storagePrefix:$userId';

  // ---------------------------------------------------------------------------
  // 1) LOCAL CACHE (OFFLINE FIRST STARTUP)
  // ---------------------------------------------------------------------------

  Future<SchoolConfig?> getLocalSchool(String userId) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final jsonStr = prefs.getString(_keyForUser(userId));
      if (jsonStr == null) return null;

      final Map<String, dynamic> envelope = jsonDecode(jsonStr);

      // Hard ownership check (prevents cross-user bleed)
      if (envelope['userId'] != userId) return null;

      final Map<String, dynamic> configJson =
          (envelope['config'] as Map).cast<String, dynamic>();

      debugPrint(" [SchoolRepo] Loaded School from Local Cache");
      return SchoolConfig.fromJson(configJson);
    } catch (e) {
      debugPrint(" [SchoolRepo] Cache read failed: $e");
      return null;
    }
  }

  Future<void> _saveLocalSchool(String userId, SchoolConfig config) async {
    try {
      final prefs = await SharedPreferences.getInstance();

      final envelope = {
        'userId': userId,
        'cachedAt': DateTime.now().toIso8601String(),
        'config': config.toJson(),
      };

      await prefs.setString(_keyForUser(userId), jsonEncode(envelope));
    } catch (e) {
      debugPrint(" [SchoolRepo] Cache write failed: $e");
    }
  }

  Future<void> clearCache(String userId) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyForUser(userId));
  }

  // ---------------------------------------------------------------------------
  // 2) REMOTE FETCH (VERIFY + CACHE)
  // ---------------------------------------------------------------------------

  Future<SchoolConfig> getSchoolForUser(String userId) async {
    try {
      debugPrint(" [SchoolRepo] Fetching remote config for: $userId");

      final profile = await _supabase
          .schema('legend')
          .from('profiles')
          .select('school_id')
          .eq('id', userId)
          .maybeSingle();

      if (profile == null) {
        throw SchoolException("Profile not found.");
      }

      final schoolId = profile['school_id'] as String?;
      if (schoolId == null || schoolId.isEmpty) {
        throw SchoolException("You are not linked to any school.");
      }

      final configRow = await _supabase
          .schema('legend')
          .from('config')
          .select()
          .eq('id', schoolId)
          .maybeSingle();

      if (configRow == null) {
        throw SchoolException("Critical: School configuration is missing.");
      }

      final config = SchoolConfig.fromJson(configRow);
      await _saveLocalSchool(userId, config);

      return config;
    } on PostgrestException catch (e) {
      debugPrint("DB ERROR: ${e.message}");
      throw SchoolException("Database Access Error: ${e.message}");
    } on AuthException catch (e) {
      debugPrint("AUTH ERROR: ${e.message}");
      throw SchoolException("Auth Error: ${e.message}");
    } catch (e) {
      debugPrint("SYSTEM ERROR: $e");
      throw SchoolException("Could not verify school online.");
    }
  }

  // ---------------------------------------------------------------------------
  // 3) SCHOOL CREATION (Admin Only)
  // ---------------------------------------------------------------------------

  Future<SchoolConfig> createSchool({
    required String ownerId,
    required String schoolName,
    String currency = 'USD',
  }) async {
    try {
      final response = await _supabase
          .schema('legend')
          .from('config')
          .insert({
            'owner_id': ownerId,
            'school_name': schoolName,
            'currency': currency,
          })
          .select()
          .single();

      final config = SchoolConfig.fromJson(response);

      // cache immediately
      await _saveLocalSchool(ownerId, config);

      return config;
    } on PostgrestException catch (e) {
      throw SchoolException("Failed to register new school: ${e.message}");
    } catch (_) {
      throw SchoolException("Failed to register new school.");
    }
  }
}

// ==========================================
// FILE: ./data/repo/auth/auth.dart
// ==========================================

import 'package:supabase_flutter/supabase_flutter.dart';

/// Custom Exception for UI consumption
class AppAuthException implements Exception {
  final String message;
  final String? code;
  AppAuthException(this.message, [this.code]);
  
  @override
  String toString() => message;
}

class AuthRepository {
  final SupabaseClient _supabase;

  AuthRepository(this._supabase);

  // ---------------------------------------------------------------------------
  // SESSION MANAGEMENT
  // ---------------------------------------------------------------------------
  
  User? get currentUser => _supabase.auth.currentUser;
  
  Stream<AuthState> get authStateChanges => _supabase.auth.onAuthStateChange;

  // ---------------------------------------------------------------------------
  // AUTH ACTIONS
  // ---------------------------------------------------------------------------

  /// Login with Email & Password
  Future<AuthResponse> signInWithPassword(String email, String password) async {
    try {
      final response = await _supabase.auth.signInWithPassword(
        email: email,
        password: password,
      );
      return response;
    } on AuthException catch (e) {
      throw AppAuthException(_mapAuthError(e.message), e.code);
    } catch (e) {
      throw AppAuthException('An unexpected error occurred during login.');
    }
  }

  /// Sign Up (Triggers OTP/Confirmation Email)
  Future<AuthResponse> signUp(String email, String password, String fullName) async {
    try {
      final response = await _supabase.auth.signUp(
        email: email,
        password: password,
        data: {'full_name': fullName}, // Stored in raw_user_meta_data
      );
      return response;
    } on AuthException catch (e) {
      throw AppAuthException(e.message, e.code);
    } catch (e) {
      throw AppAuthException('Sign up failed. Please try again.');
    }
  }

  /// Login with OTP (Magic Link / Code)
  Future<void> signInWithOtp(String email) async {
    try {
      await _supabase.auth.signInWithOtp(
        email: email,
        emailRedirectTo: 'io.supabase.flutter://login-callback/',
      );
    } on AuthException catch (e) {
      throw AppAuthException(e.message);
    }
  }

  /// Password Reset Request (OTP Email)
  Future<void> sendRecoveryOtp(String email) async {
    try {
      await _supabase.auth.resetPasswordForEmail(email);
    } on AuthException catch (e) {
      throw AppAuthException(_mapAuthError(e.message), e.code);
    }
  }

  /// Verify OTP (Email or Phone) - Used for Login OR Recovery
  Future<AuthResponse> verifyOtp(String email, String token, OtpType type) async {
    try {
      final response = await _supabase.auth.verifyOTP(
        email: email,
        token: token,
        type: type,
      );
      return response;
    } on AuthException {
      throw AppAuthException('Invalid Code. Please check and try again.');
    }
  }

  /// Sign Out
  Future<void> signOut() async {
    try {
      await _supabase.auth.signOut();
    } catch (e) {
      // Fail silently on logout errors, just clear local state usually
    }
  }

  /// Password Reset Request (Step 1: Send Email)
  Future<void> resetPasswordForEmail(String email) async {
    try {
      await _supabase.auth.resetPasswordForEmail(email);
    } on AuthException catch (e) {
      throw AppAuthException(e.message);
    }
  }

  /// Update User Password (Step 2: Save New Password)
  /// Requires an active session (which verifyOtp provides)
  Future<void> updatePassword(String newPassword) async {
    try {
      await _supabase.auth.updateUser(
        UserAttributes(password: newPassword),
      );
    } on AuthException catch (e) {
      throw AppAuthException("Failed to update password: ${e.message}");
    }
  }

  // ---------------------------------------------------------------------------
  // HELPER: Error Mapping
  // ---------------------------------------------------------------------------
  String _mapAuthError(String rawMessage) {
    if (rawMessage.contains("Invalid login credentials")) {
      return "Incorrect email or password.";
    }
    if (rawMessage.contains("Email not confirmed")) {
      return "Please confirm your email address first.";
    }
    return rawMessage;
  }
}

// ==========================================
// FILE: ./data/repo/financial_repo.dart
// ==========================================

// ==========================================
// FILE: ./financial_repo.dart
// ==========================================

import 'package:legend/app_libs.dart';

// =============================================================================
// FINANCE REPOSITORY INTERFACE
// =============================================================================
abstract class FinanceRepository {
  Future<List<Invoice>> getStudentInvoices(String studentId);
  Future<List<Invoice>> getOpenInvoicesForStudent(String studentId);
  Future<List<Payment>> getStudentPayments(String studentId);
  Future<List<LedgerEntry>> getStudentLedger(String studentId);
  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items);
  Future<void> recordPayment(Payment payment);
  Future<List<Map<String, dynamic>>> getRecentActivity(String schoolId, {int limit = 10});
  Future<List<Map<String, dynamic>>> getOutstandingStudents(String schoolId, {int limit = 10});
  Future<List<Map<String, dynamic>>> getRecentPayments(
    String schoolId, {
    int limit = 10,
    DateTime? onDate,
  });
  Future<Invoice?> getInvoiceById(String invoiceId);
  Future<List<InvoiceItem>> getInvoiceItems(String invoiceId);
  Future<Map<String, dynamic>> getFinanceStats(String schoolId, {DateTime? startDate, DateTime? endDate});
  Future<void> addInvoiceItem(String invoiceId, InvoiceItem item);
}

// =============================================================================
// POWERSYNC/LOCAL SQLITE IMPLEMENTATION
// =============================================================================
class PowerSyncFinanceRepository implements FinanceRepository {
  final Uuid _uuid = const Uuid();

  static const _openStatuses = "'PENDING','PARTIAL','OVERDUE'";

  @override
  Future<List<Invoice>> getStudentInvoices(String studentId) async {
    try {
      final result = await db.getAll(
        '''
      SELECT
        i.id,
        i.school_id,
        i.student_id,
        i.invoice_number,
        i.term_id,
        i.due_date,
        i.status,
        i.snapshot_grade,
        -- Total = sum(items) else fall back to stored invoice total_amount
        COALESCE(
          (SELECT SUM(COALESCE(ii.amount,0) * COALESCE(ii.quantity,1))
           FROM invoice_items ii
           WHERE ii.invoice_id = i.id),
          i.total_amount,
          0
        ) AS total_amount,
        COALESCE(i.paid_amount, 0) AS paid_amount,
        i.title,
        i.created_at
      FROM invoices i
      WHERE i.student_id = ?
      ORDER BY datetime(i.due_date) DESC
      ''',
        [studentId],
      );

      return result.map((row) => Invoice.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching invoices: $e");
      rethrow;
    }
  }

  @override
  Future<List<Invoice>> getOpenInvoicesForStudent(String studentId) async {
    try {
      final result = await db.getAll(
        '''
      SELECT *
      FROM invoices
      WHERE student_id = ?
        AND UPPER(status) IN ($_openStatuses)
      ORDER BY datetime(due_date) ASC
      ''',
        [studentId],
      );
      return result.map((row) => Invoice.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching open invoices: $e");
      rethrow;
    }
  }

  @override
  Future<List<Payment>> getStudentPayments(String studentId) async {
    try {
      final result = await db.getAll(
        '''
      SELECT *
      FROM payments
      WHERE student_id = ?
      ORDER BY datetime(received_at) DESC
      ''',
        [studentId],
      );
      return result.map((row) => Payment.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching payments: $e");
      rethrow;
    }
  }

  @override
  Future<List<LedgerEntry>> getStudentLedger(String studentId) async {
    try {
      final result = await db.getAll(
        '''
      SELECT *
      FROM ledger
      WHERE student_id = ?
      ORDER BY datetime(occurred_at) DESC
      ''',
        [studentId],
      );
      return result.map((row) => LedgerEntry.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching ledger: $e");
      rethrow;
    }
  }

  @override
  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items) async {
    final now = DateTime.now().toIso8601String();

    // Source of truth: items (quantity-aware)
    final computedTotal = items.fold<double>(
      0.0,
      (sum, it) => sum + (it.amount * (it.quantity <= 0 ? 1 : it.quantity)),
    );

    try {
      await db.execute('BEGIN');

      // 1) Insert invoice (offline-first: write key fields)
      await db.execute(
        '''
      INSERT INTO invoices (
        id, school_id, student_id, invoice_number,
        due_date, status, snapshot_grade,
        created_at, total_amount, paid_amount, title, term_id
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      ''',
        [
          invoice.id,
          invoice.schoolId,
          invoice.studentId,
          invoice.invoiceNumber,
          invoice.dueDate.toIso8601String(),
          invoice.status.name.toUpperCase(),
          invoice.snapshotGrade,
          now,
          computedTotal, // reconciled: do NOT trust invoice.totalAmount
          invoice.paidAmount, // usually 0.0 at creation
          invoice.title,
          invoice.termId, // nullable OK
        ],
      );

      // 2) Insert items (include fee_structure_id + quantity)
      for (final item in items) {
        final qty = item.quantity <= 0 ? 1 : item.quantity;

        await db.execute(
          '''
        INSERT INTO invoice_items (
          id, school_id, invoice_id, fee_structure_id,
          description, amount, quantity, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''',
          [
            item.id,
            item.schoolId,
            item.invoiceId,
            item.feeStructureId, // nullable OK
            item.description,
            item.amount,
            qty,
            now,
          ],
        );
      }

      // 3) Update student fees_owed using computedTotal
      await db.execute(
        '''
      UPDATE students
      SET fees_owed = COALESCE(fees_owed, 0) + ?
      WHERE id = ? AND school_id = ?
      ''',
        [computedTotal, invoice.studentId, invoice.schoolId],
      );

      // 4) Ledger debit for the invoice (student balance increases)
      await db.execute(
        '''
      INSERT INTO ledger (
        id, school_id, student_id,
        type, category, amount,
        invoice_id, payment_id, description, occurred_at
      ) VALUES (?, ?, ?, 'DEBIT', 'INVOICE', ?, ?, NULL, ?, ?)
      ''',
        [
          _uuid.v4(),
          invoice.schoolId,
          invoice.studentId,
          computedTotal,
          invoice.id,
          'Invoice ${invoice.invoiceNumber}',
          now,
        ],
      );

      await db.execute('COMMIT');
    } catch (e) {
      try {
        await db.execute('ROLLBACK');
      } catch (_) {}
      rethrow;
    }
  }

  @override
  Future<void> recordPayment(Payment payment) async {
    // Use the payment's receivedAt as the single time source (UTC)
    final occurredAt = payment.receivedAt.toUtc();
    final occurredAtIso = occurredAt.toIso8601String();

    final paymentId = (payment.id.isNotEmpty) ? payment.id : _uuid.v4();

    // Guard rails (no UI trust)
    final amount = payment.amount.isFinite ? payment.amount : 0.0;
    if (amount <= 0) {
      throw Exception("Payment amount must be greater than 0.");
    }

    try {
      await db.writeTransaction((tx) async {
        // 1) Insert payment row
        await tx.execute(
          '''
      INSERT INTO payments (
        id, school_id, student_id, amount, method, reference_code, received_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
      ''',
          [
            paymentId,
            payment.schoolId,
            payment.studentId,
            amount,
            payment.method, // optionally normalize to uppercase here
            payment.reference, // maps to reference_code
            occurredAtIso,
          ],
        );

        // 2) If invoices exist for this student, treat invoices as the truth.
        final invCountRow = await tx.get(
          '''
      SELECT count(*) as c
      FROM invoices
      WHERE school_id = ? AND student_id = ?
      ''',
          [payment.schoolId, payment.studentId],
        );
        final int invoiceCount = (invCountRow['c'] as num?)?.toInt() ?? 0;

        double remaining = amount;

        if (invoiceCount > 0) {
          // 2a) Fetch open invoices (oldest due first)
          final openInvoices = await tx.getAll(
          '''
        SELECT id, invoice_number, total_amount, paid_amount, status, due_date, created_at
        FROM invoices
        WHERE school_id = ?
          AND student_id = ?
          AND status IN ('PENDING', 'PARTIAL', 'OVERDUE')
        ORDER BY datetime(due_date) ASC, datetime(created_at) ASC
        ''',
            [payment.schoolId, payment.studentId],
          );

          // 2b) Allocate payment across invoices
          for (final inv in openInvoices) {
            if (remaining <= 0) break;

            final String invoiceId = inv['id'] as String;
            final String invoiceNumber =
                (inv['invoice_number'] as String?) ?? invoiceId;

            final double total = (inv['total_amount'] as num?)?.toDouble() ?? 0.0;
            final double paid = (inv['paid_amount'] as num?)?.toDouble() ?? 0.0;

            final double outstanding = (total - paid) <= 0 ? 0.0 : (total - paid);
            if (outstanding <= 0) continue;

            final double apply = remaining < outstanding
                ? remaining
                : outstanding;
            final double newPaid = paid + apply;

            final String newStatus = (newPaid >= total && total > 0)
                ? 'PAID'
                : 'PARTIAL';

            // Update invoice
            await tx.execute(
            '''
          UPDATE invoices
          SET paid_amount = ?, status = ?
          WHERE id = ? AND school_id = ?
          ''',
              [newPaid, newStatus, invoiceId, payment.schoolId],
            );

            // Ledger row (linked to invoice + payment)
            await tx.execute(
            '''
          INSERT INTO ledger (
            id, school_id, student_id,
            type, category, amount,
            invoice_id, payment_id,
            description, occurred_at
          ) VALUES (?, ?, ?, 'CREDIT', 'PAYMENT', ?, ?, ?, ?, ?)
          ''',
              [
                _uuid.v4(),
                payment.schoolId,
                payment.studentId,
                apply,
                invoiceId,
                paymentId,
                'Payment via ${payment.method} -> $invoiceNumber',
                occurredAtIso,
              ],
            );

            remaining -= apply;
          }

          // 2c) If payment exceeds open invoices, keep it as unallocated credit in ledger
          // (No schema for "credit_balance" yet, but at least we do not lose the audit trail)
          if (remaining > 0) {
            await tx.execute(
            '''
          INSERT INTO ledger (
            id, school_id, student_id,
            type, category, amount,
            invoice_id, payment_id,
            description, occurred_at
          ) VALUES (?, ?, ?, 'CREDIT', 'PAYMENT', ?, NULL, ?, ?, ?)
          ''',
              [
                _uuid.v4(),
                payment.schoolId,
                payment.studentId,
                remaining,
                paymentId,
                'Unallocated overpayment via ${payment.method} (advance credit)',
                occurredAtIso,
              ],
            );
          }

          // 2d) Reconcile student.fees_owed from invoices (single source of truth)
          final owedRow = await tx.get(
          '''
        SELECT COALESCE(SUM(
          CASE
            WHEN COALESCE(total_amount,0) - COALESCE(paid_amount,0) < 0 THEN 0
            ELSE COALESCE(total_amount,0) - COALESCE(paid_amount,0)
          END
        ), 0) as owed
        FROM invoices
        WHERE school_id = ?
          AND student_id = ?
          AND status IN ('PENDING', 'PARTIAL', 'OVERDUE')
        ''',
            [payment.schoolId, payment.studentId],
          );

          final double newOwed = (owedRow['owed'] as num?)?.toDouble() ?? 0.0;

          await tx.execute(
          '''
        UPDATE students
        SET fees_owed = ?
        WHERE id = ? AND school_id = ?
        ''',
            [newOwed, payment.studentId, payment.schoolId],
          );
        } else {
          // Legacy fallback: no invoices exist, so we only adjust fees_owed and ledger without invoice_id.

          await tx.execute(
          '''
        INSERT INTO ledger (
          id, school_id, student_id,
          type, category, amount,
          payment_id, description, occurred_at
        ) VALUES (?, ?, ?, 'CREDIT', 'PAYMENT', ?, ?, ?, ?)
        ''',
            [
              _uuid.v4(),
              payment.schoolId,
              payment.studentId,
              amount,
              paymentId,
              'Payment via ${payment.method}',
              occurredAtIso,
            ],
          );

          await tx.execute(
          '''
        UPDATE students
        SET fees_owed = CASE
          WHEN COALESCE(fees_owed, 0) - ? < 0 THEN 0
          ELSE COALESCE(fees_owed, 0) - ?
        END
        WHERE id = ? AND school_id = ?
        ''',
            [amount, amount, payment.studentId, payment.schoolId],
          );
        }
      });
    } catch (e) {
      debugPrint("Error recording payment: $e");
      rethrow;
    }
  }

  @override
  Future<List<Map<String, dynamic>>> getRecentActivity(String schoolId, {int limit = 10}) async {
    try {
      final result = await db.getAll(
        '''
        SELECT 
          l.*,
          s.first_name || ' ' || s.last_name as student_name
        FROM ledger l
        LEFT JOIN students s ON l.student_id = s.id
        WHERE l.school_id = ?
        ORDER BY l.occurred_at DESC
        LIMIT ?
        ''',
        [schoolId, limit],
      );

      return result.map((row) {
        final type = (row['type'] as String?) ?? '';
        final isIncome = type.toUpperCase() == 'CREDIT';
        final amount = (row['amount'] as num?)?.toDouble() ?? 0.0;
        final desc = (row['description'] as String?) ?? '';

        return {
          'name': row['student_name'] ?? 'Unknown',
          'desc': desc,
          'amount': isIncome ? amount : -amount,
          'time': _formatTime(DateTime.parse(row['occurred_at'] as String)),
          'type': isIncome ? 'INCOME' : 'EXPENSE',
          'targetId': row['student_id'] as String?,
        };
      }).toList();
    } catch (e) {
      debugPrint("Error fetching recent activity: $e");
      return [];
    }
  }

  @override
  Future<List<Map<String, dynamic>>> getOutstandingStudents(String schoolId, {int limit = 10}) async {
    try {
      final result = await db.getAll(
        '''
        SELECT
          s.id,
          s.first_name || ' ' || s.last_name as name,
          COALESCE(s.fees_owed, 0) as fees_owed,
          e.grade_level as grade
        FROM students s
        LEFT JOIN enrollments e ON e.student_id = s.id AND e.is_active = 1
        WHERE s.school_id = ?
          AND COALESCE(s.fees_owed, 0) > 0
        ORDER BY COALESCE(s.fees_owed, 0) DESC
        LIMIT ?
        ''',
        [schoolId, limit],
      );

      return result.map((row) {
        return {
          'id': row['id']?.toString() ?? '',
          'name': (row['name'] ?? 'Unknown').toString(),
          'grade': row['grade']?.toString() ?? '',
          'amount': (row['fees_owed'] as num?)?.toDouble() ?? 0.0,
        };
      }).toList();
    } catch (e) {
      debugPrint("Error fetching outstanding students: $e");
      return [];
    }
  }

  @override
  Future<List<Map<String, dynamic>>> getRecentPayments(
    String schoolId, {
    int limit = 10,
    DateTime? onDate,
  }) async {
    try {
      final dateFilter = onDate != null ? "AND substr(p.received_at, 1, 10) = ?" : "";
      final params = <Object?>[schoolId];
      if (onDate != null) {
        final dateStr = onDate.toIso8601String().substring(0, 10);
        params.add(dateStr);
      }
      params.add(limit);

      final result = await db.getAll(
        '''
        SELECT
          p.id,
          p.student_id,
          p.amount,
          p.method,
          p.received_at,
          s.first_name || ' ' || s.last_name as name
        FROM payments p
        LEFT JOIN students s ON p.student_id = s.id
        WHERE p.school_id = ?
        $dateFilter
        ORDER BY datetime(p.received_at) DESC
        LIMIT ?
        ''',
        params,
      );

      return result.map((row) {
        final receivedAt = DateTime.tryParse((row['received_at'] as String?) ?? '') ?? DateTime.now();
        return {
          'id': row['id']?.toString() ?? '',
          'studentId': row['student_id']?.toString() ?? '',
          'name': (row['name'] ?? 'Unknown').toString(),
          'amount': (row['amount'] as num?)?.toDouble() ?? 0.0,
          'method': (row['method'] ?? '').toString(),
          'time': _formatTime(receivedAt),
        };
      }).toList();
    } catch (e) {
      debugPrint("Error fetching recent payments: $e");
      return [];
    }
  }

  @override
  Future<Invoice?> getInvoiceById(String invoiceId) async {
    try {
      final result = await db.getOptional(
        'SELECT * FROM invoices WHERE id = ?',
        [invoiceId],
      );
      return result != null ? Invoice.fromRow(result) : null;
    } catch (e) {
      debugPrint("Error fetching invoice: $e");
      rethrow;
    }
  }

  @override
  Future<List<InvoiceItem>> getInvoiceItems(String invoiceId) async {
    try {
      final result = await db.getAll(
        'SELECT * FROM invoice_items WHERE invoice_id = ?',
        [invoiceId],
      );
      return result.map((row) => InvoiceItem.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching invoice items: $e");
      rethrow;
    }
  }

  @override
  Future<Map<String, dynamic>> getFinanceStats(String schoolId, {DateTime? startDate, DateTime? endDate}) async {
    try {
      final hasRange = startDate != null && endDate != null;
      final revenueSql = hasRange
          ? """
            SELECT SUM(amount) as total
            FROM ledger
            WHERE school_id = ?
              AND type = 'CREDIT'
              AND datetime(occurred_at) >= datetime(?)
              AND datetime(occurred_at) <= datetime(?)
          """
          : "SELECT SUM(amount) as total FROM ledger WHERE school_id = ? AND type = 'CREDIT'";
      final revenueParams = hasRange
          ? [
              schoolId,
              startDate.toUtc().toIso8601String(),
              endDate.toUtc().toIso8601String(),
            ]
          : [schoolId];

      final revenueResult = await db.getOptional(revenueSql, revenueParams);
      final totalRevenue = (revenueResult?['total'] as num?)?.toDouble() ?? 0.0;

      final pendingResult = await db.getOptional(
        '''
        SELECT SUM(ii.amount * COALESCE(ii.quantity, 1)) as total 
        FROM invoices i
        JOIN invoice_items ii ON i.id = ii.invoice_id
        WHERE i.school_id = ? AND i.status != 'PAID'
        ''',
        [schoolId],
      );
      final pendingAmount =
          (pendingResult?['total'] as num?)?.toDouble() ?? 0.0;

      final countResult = await db.getOptional(
        "SELECT COUNT(*) as count FROM invoices WHERE school_id = ? AND status != 'PAID'",
        [schoolId],
      );
      final unpaidInvoiceCount = (countResult?['count'] as int?) ?? 0;

      return {
        'totalRevenue': totalRevenue,
        'pendingAmount': pendingAmount,
        'unpaidInvoiceCount': unpaidInvoiceCount,
      };
    } catch (e) {
      debugPrint("Error fetching finance stats: $e");
      rethrow;
    }
  }

  String _formatTime(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);
    if (diff.inDays == 0) return 'Today';
    if (diff.inDays == 1) return 'Yesterday';
    return '${date.day}/${date.month}';
  }

  @override
  Future<void> addInvoiceItem(String invoiceId, InvoiceItem item) async {
    try {
      await db.execute('BEGIN');

      final invoiceRow = await db.getOptional(
        '''
        SELECT id, school_id, student_id, total_amount
        FROM invoices
        WHERE id = ?
        ''',
        [invoiceId],
      );
      if (invoiceRow == null) {
        throw Exception("Invoice not found for item insert.");
      }

      final qty = item.quantity <= 0 ? 1 : item.quantity;
      final lineTotal = item.amount * qty;

      await db.execute(
        '''
        INSERT INTO invoice_items (
          id, school_id, invoice_id, fee_structure_id,
          description, amount, quantity, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''',
        [
          item.id,
          item.schoolId,
          item.invoiceId,
          item.feeStructureId,
          item.description,
          item.amount,
          qty,
          DateTime.now().toIso8601String(),
        ],
      );

      await db.execute(
        '''
        UPDATE invoices
        SET total_amount = COALESCE(total_amount, 0) + ?
        WHERE id = ?
        ''',
        [lineTotal, invoiceId],
      );

      await db.execute(
        '''
        UPDATE students
        SET fees_owed = COALESCE(fees_owed, 0) + ?
        WHERE id = ? AND school_id = ?
        ''',
        [lineTotal, invoiceRow['student_id'], invoiceRow['school_id']],
      );

      await db.execute('COMMIT');
    } catch (e) {
      try {
        await db.execute('ROLLBACK');
      } catch (_) {}
      rethrow;
    }
  }
}

// ==========================================
// FILE: ./data/repo/dashboard_repo.dart
// ==========================================

import 'package:flutter/foundation.dart' show debugPrint;
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/services/database_serv.dart'; // provides global `db`

class DashboardRepository {
  // Canonical meaning of "pending/unsettled" across the app:
  // Anything not settled but issued.
  static const _openStatuses = "'PENDING','PARTIAL','OVERDUE'";

  // ===========================================================================
  // 1. DASHBOARD HOME (Metrics & Feeds)
  // ===========================================================================

  Future<DashboardStats> getDashboardStats(String schoolId) async {
    try {
      final studentsRes = await db.get(
        "SELECT count(*) as count FROM students WHERE school_id = ? AND status = 'ACTIVE'",
        [schoolId],
      );

      // IMPORTANT: Never use POSTED. Your enum set has no POSTED.
      // Open invoices = PENDING / PARTIAL / OVERDUE
      final invoiceRes = await db.get(
        """
        SELECT count(*) as count
        FROM invoices
        WHERE school_id = ?
          AND UPPER(status) IN ($_openStatuses)
        """,
        [schoolId],
      );

      // Safer than date(received_at) if received_at is ISO8601 text:
      // compare the YYYY-MM-DD prefix to today's local date.
      final todayRes = await db.get(
        """
        SELECT COALESCE(SUM(amount), 0) as total
        FROM payments
        WHERE school_id = ?
          AND substr(received_at, 1, 10) = date('now','localtime')
        """,
        [schoolId],
      );

      final owedRes = await db.get(
        "SELECT COALESCE(sum(fees_owed), 0) as total FROM students WHERE school_id = ?",
        [schoolId],
      );

      return DashboardStats(
        totalStudents: (studentsRes['count'] as num?)?.toInt() ?? 0,
        pendingInvoices: (invoiceRes['count'] as num?)?.toInt() ?? 0,
        collectedToday: (todayRes['total'] as num?)?.toDouble() ?? 0.0,
        totalOwed: (owedRes['total'] as num?)?.toDouble() ?? 0.0,
      );
    } catch (e) {
      debugPrint('Error fetching dashboard stats: $e');
      return DashboardStats(
        totalStudents: 0,
        pendingInvoices: 0,
        collectedToday: 0.0,
        totalOwed: 0.0,
      );
    }
  }

  Stream<DashboardStats> watchDashboardStats(String schoolId) {
    return db
        .watch(
          """
          SELECT
            (SELECT count(*) FROM students WHERE school_id = ? AND status = 'ACTIVE') as total_students,
            (SELECT count(*) FROM invoices
              WHERE school_id = ? AND UPPER(status) IN ($_openStatuses)) as pending_invoices,
            (SELECT COALESCE(SUM(amount), 0) FROM payments
              WHERE school_id = ? AND substr(received_at, 1, 10) = date('now','localtime')) as collected_today,
            (SELECT COALESCE(SUM(fees_owed), 0) FROM students WHERE school_id = ?) as total_owed
          """,
          parameters: [schoolId, schoolId, schoolId, schoolId],
        )
        .map((rows) {
          final row = rows.isNotEmpty ? rows.first : const <String, Object?>{};
          return DashboardStats(
            totalStudents: (row['total_students'] as num?)?.toInt() ?? 0,
            pendingInvoices: (row['pending_invoices'] as num?)?.toInt() ?? 0,
            collectedToday: (row['collected_today'] as num?)?.toDouble() ?? 0.0,
            totalOwed: (row['total_owed'] as num?)?.toDouble() ?? 0.0,
          );
        });
  }

  Future<List<Map<String, dynamic>>> getRecentActivity(String schoolId) async {
    try {
      const sql = """
      SELECT
        p.id,
        'payment' as type,
        p.amount,
        s.first_name || ' ' || s.last_name as name,
        'Payment - ' || p.method as description,
        p.received_at as date
      FROM payments p
      LEFT JOIN students s ON p.student_id = s.id
      WHERE p.school_id = ?
      ORDER BY p.received_at DESC
      LIMIT 5
    """;

      final rows = await db.getAll(sql, [schoolId]);

      return rows.map((row) {
        final date = DateTime.tryParse((row['date'] as String?) ?? '') ?? DateTime.now();
        final diff = DateTime.now().difference(date);

        final String timeLabel;
        if (diff.inMinutes < 60) {
          timeLabel = '${diff.inMinutes} mins ago';
        } else if (diff.inHours < 24) {
          timeLabel = '${diff.inHours} hours ago';
        } else {
          timeLabel = '${diff.inDays} days ago';
        }

        return {
          'name': row['name'] ?? 'Unknown',
          'desc': row['description'] ?? 'No description',
          'time': timeLabel,
          'amount': ((row['amount'] as num?) ?? 0).toDouble(),
        };
      }).toList();
    } catch (e) {
      debugPrint('Error fetching recent activity: $e');
      return [];
    }
  }

  // ===========================================================================
  // 2. STATISTICS SCREEN (Charts & Analysis)
  // ===========================================================================

  Future<List<Map<String, dynamic>>> getRevenueTrend(String schoolId) async {
    const sql = """
      SELECT
        date(received_at) as day,
        sum(amount) as total
      FROM payments
      WHERE school_id = ?
        AND datetime(received_at) >= datetime('now', '-7 days')
      GROUP BY day
      ORDER BY day ASC
    """;
    return db.getAll(sql, [schoolId]);
  }

  Future<List<Map<String, dynamic>>> getRevenueTrendForRange(
    String schoolId, {
    required DateTime startDate,
    required DateTime endDate,
  }) async {
    const sql = """
      SELECT
        date(received_at) as day,
        sum(amount) as total
      FROM payments
      WHERE school_id = ?
        AND datetime(received_at) >= datetime(?)
        AND datetime(received_at) <= datetime(?)
      GROUP BY day
      ORDER BY day ASC
    """;
    return db.getAll(
      sql,
      [
        schoolId,
        startDate.toUtc().toIso8601String(),
        endDate.toUtc().toIso8601String(),
      ],
    );
  }

  Future<List<Map<String, dynamic>>> getDebtByGrade(String schoolId) async {
    const sql = """
      SELECT
        e.grade_level as grade,
        sum(s.fees_owed) as amount
      FROM students s
      JOIN enrollments e ON s.id = e.student_id
      WHERE s.school_id = ?
        AND e.is_active = 1
      GROUP BY e.grade_level
      ORDER BY amount DESC
    """;
    return db.getAll(sql, [schoolId]);
  }

  Future<Map<String, double>> getPaymentMethodStats(String schoolId,
      {DateTime? startDate, DateTime? endDate}) async {
    final hasRange = startDate != null && endDate != null;
    final sql = hasRange
        ? """
          SELECT method, count(*) as count
          FROM payments
          WHERE school_id = ?
            AND datetime(received_at) >= datetime(?)
            AND datetime(received_at) <= datetime(?)
          GROUP BY method
        """
        : "SELECT method, count(*) as count FROM payments WHERE school_id = ? GROUP BY method";
    final params = hasRange
        ? [
            schoolId,
            startDate.toUtc().toIso8601String(),
            endDate.toUtc().toIso8601String(),
          ]
        : [schoolId];

    final rows = await db.getAll(sql, params);

    final Map<String, double> result = {};
    for (final row in rows) {
      final method = (row['method'] as String?) ?? 'UNKNOWN';
      result[method] = (row['count'] as num?)?.toDouble() ?? 0.0;
    }
    return result;
  }

  // ===========================================================================
  // 3. NOTIFICATIONS (Live Streams)
  // ===========================================================================

  Stream<List<LegendNotification>> watchNotifications(String schoolId) {
    return db
        .watch(
          "SELECT * FROM noti WHERE school_id = ? ORDER BY created_at DESC",
          parameters: [schoolId],
        )
        .map((rows) => rows.map((r) => LegendNotification.fromRow(r)).toList());
  }

  Stream<int> watchUnreadCount(String schoolId) {
    return db
        .watch(
          "SELECT count(*) as count FROM noti WHERE school_id = ? AND is_read = 0",
          parameters: [schoolId],
        )
        .map((rows) => (rows.isEmpty) ? 0 : ((rows.first['count'] as num?)?.toInt() ?? 0));
  }

  Future<void> markAsRead(String notiId) => db.execute("UPDATE noti SET is_read = 1 WHERE id = ?", [notiId]);
  Future<void> markAllAsRead(String schoolId) => db.execute("UPDATE noti SET is_read = 1 WHERE school_id = ?", [schoolId]);
  Future<void> clearAllNotifications(String schoolId) => db.execute("DELETE FROM noti WHERE school_id = ?", [schoolId]);
  Future<void> deleteNotification(String id) => db.execute("DELETE FROM noti WHERE id = ?", [id]);

  Future<LegendProfile?> getUserProfile(String userId) async {
    try {
      final result = await db.getOptional("SELECT * FROM profiles WHERE id = ?", [userId]);
      return result != null ? LegendProfile.fromRow(result) : null;
    } catch (e) {
      debugPrint('Error fetching user profile: $e');
      return null;
    }
  }

  Future<Term?> getActiveTerm(String schoolId) async {
    try {
      final row = await db.getOptional(
        "SELECT * FROM terms WHERE school_id = ? AND is_active = 1 LIMIT 1",
        [schoolId],
      );
      return row != null ? Term.fromRow(row) : null;
    } catch (e) {
      debugPrint('Error fetching active term: $e');
      return null;
    }
  }

  Future<Term?> getPreviousTerm(String schoolId, DateTime beforeDate) async {
    try {
      final row = await db.getOptional(
        """
        SELECT * FROM terms
        WHERE school_id = ?
          AND datetime(end_date) < datetime(?)
        ORDER BY datetime(end_date) DESC
        LIMIT 1
        """,
        [schoolId, beforeDate.toUtc().toIso8601String()],
      );
      return row != null ? Term.fromRow(row) : null;
    } catch (e) {
      debugPrint('Error fetching previous term: $e');
      return null;
    }
  }

  // ===========================================================================
  // 4. NUCLEAR RESET (Student + Finance Data)
  // ===========================================================================

  Future<void> deleteAllStudentData(String schoolId) async {
    await db.writeTransaction((tx) async {
      await tx.execute("DELETE FROM payment_allocations WHERE school_id = ?", [schoolId]);
      await tx.execute("DELETE FROM invoice_items WHERE school_id = ?", [schoolId]);
      await tx.execute("DELETE FROM payments WHERE school_id = ?", [schoolId]);
      await tx.execute("DELETE FROM invoices WHERE school_id = ?", [schoolId]);
      await tx.execute("DELETE FROM ledger WHERE school_id = ?", [schoolId]);
      await tx.execute("DELETE FROM enrollments WHERE school_id = ?", [schoolId]);
      await tx.execute("DELETE FROM students WHERE school_id = ?", [schoolId]);
    });
  }
}

// ==========================================
// FILE: ./data/constants/app_strings.dart
// ==========================================

class AppStrings {
  static const String appName = "KwaLegend Manager";

  // Shell Titles
  static const String dashboardTitle = "Dashboard";
  static const String studentsTitle = "Students";
  static const String financeTitle = "Finance";
  static const String settingsTitle =
      "Profile"; // Combined Settings/Profile for Sir Legend

  // Screen Titles
  static const String statsTitle = "Statistics";
  static const String notificationsTitle = "Notifications";
  static const String invoicesTitle = "Invoices";
  static const String createInvoiceTitle = "New Invoice";
  static const String logsTitle = "Activity Logs";
  static const String tosTitle = "Terms of Service";
  static const String contactDevTitle = "Contact Developer";
  static const String devContactName = "Nyasha Gabriel";
  static const String devContactMessage =
      "Contact the developer when ever the app \nmisbehaves so that data can be preserved \nand a solution can be found";
  static const String devWhatsAppUrl = "https://wa.me/263785930886";
  static const String devEmailUrl = "mailto:gabwixgamesite2024@gmail.com";
  static const String devBuildLabel = "BUILD: KWALEGEND \nALPHA 0.9.2";

  //Rando Strings
  static const String savingSubjects = "Saving Subjects:";

  //Success Messages
  static const String studentRegisterSuccess =
      "Student Registered Successfully";

  static const String newAdmission = "Student Registered Successfully";

  static const String save = "SAVE";
  static const String identity = "Identity";
  static const String fieldFirstName = "First Name";
  static const String fieldLastName = "Last Name";
  static const String required = "Required";

  static const String genderMale = "M";
  static const String genderFemale = "F";
  static const String gender = "Gender";

  static const String studentTypeAcademy = "ACADEMY";
  static const String studentTypePrivate = "PRIVATE";
  static const String studentType = "Student Type";

  static const String placement = "Placement";
  static const String gLevel = "Level";

  static const String gContact = "Guardian Contact";
  static const String gName = "Guardian Name";
  static const String gPhone = "Guardian Phone";

  static const String bEssentials = "Billing Essentials";
  static const String bSchedule = "Billing Schedule";
  static const String selectBDate = "Select Billing Date";
  static const String defaultB = 'Monthly (Custom Date)';
  static const String prevTuition = "PREVIOUS TUITION CHARGES";
  static const String amntOwing = "Amount (Owing)";
  static const String description = "Description";
  static const String generateInvoice = "Generate Current Invoice?";
  static const String standardAction = "Will apply standard fees immediately.";
  static const String dateFormat = "MMM d, yyyy";

  static const List<String> grades = [
    'Form 1',
    'Form 2',
    'Form 3',
    'Form 4',
    'Lower 6',
    'Upper 6',
  ];
  static const billingTypes = [
    'Standard Termly',
    'Monthly (Fixed)',
    'Monthly (Custom Date)',
  ];
  static const balBroughtDown = "Balance Brought Forward";

  static const String strNew = "New";
  static const String exampleStuId = "STU00-000-000";
  static const logsF = "Financials";
  static const logsS = "System";
  static const logsA = "Alerts";

  static const activityHistory = "Activity History";
  static const exportLogs = "Export Logs";
  static const actionMessageExporting = "Exporting audit trail to CSV...";
  static const strAll = "All";
  static const mmm = "MMM";
  static const String dd = "dd";
  static const String hhmm = "HH:mm";

  static const String errLogsNotFound = "Error logs not found";
  static const String errNoStu= "No Students Found";
  static const noActiveSchool = "No active school found";
  static const logInAgain = "Please LogIn Again";
  static const stuDir = "Student Directory";

  static const comingSoon= "Coming Soon Feature";
  static const plusStudent = "Add Student";
  static const search = "Search";
  static const name = "name";
  static const threeDots = "...";
  static const searchByName = "$search $name $threeDots";
  static const outstanding = "Outstanding Debt";

  static const fontFamily = "JetBrains Mono";
  static const owing = "Owing";
  static const paid = "Paid";


  static const errLoadingStu = "Error loading Students";
  static const retry = "Retry";
  static const noStuFound = "No Students found";
  static const noStuId = "No STU-ID";



  static const String pageTitle = "Student Profile";

  // Status Labels
  static const String statusActive = "ACTIVE";
  static const String statusArrears = "ARREARS";

  // Tabs
  static const String tabOverview = "Overview";
  static const String tabFinance = "Finance";
  static const String tabAcademic = "Academic";

  // Actions
  static const String actCall = "Call Guardian";
  static const String actWhatsApp = "WhatsApp";
  static const String actLogPayment = "Log Payment";

  // Section Headers
  static const String secIdentity = "Identity & Class";
  static const String secGuardian = "Guardian / Payer";
  static const String secSubjects = "Enrolled Subjects";
  static const String secLedger = "Recent Transactions";

  // Labels
  static const String lblAdmNum = "ID";
  static const String lblDob = "DOB";
  static const String lblGender = "Gender";
  static const String lblType = "Type";
  static const String lblPhone = "Phone";
  static const String lblRelation = "Relation";

  // Finance
  static const String lblOwed = "Outstanding Balance";
  static const String lblPaid = "Paid YTD";

  // Fallbacks
  static const String noSubjects = "No subjects registered";
  static const String loading = "Loading student profile...";
  static const String error = "Could not load student data.";

  static const String pageTitleSet = "Profile & Settings";

  static const String secApp = "Application";
  static const String secData = "Data & Sync";
  static const String secSupport = "Support";

  // Items
  static const String itemEditProfile = "Edit Profile";
  static const String subEditProfile = "Update name and role";

  static const String itemSchool = "School Details";
  static const String subSchool = "Logo, address, and contact";

  static const String itemTheme = "Dark Mode";
  static const String itemNotifs = "Notifications";

  static const String itemSync = "Sync Status";
  static const String subSyncUnknown = "Sync status unavailable";
  static const String itemAutoBilling = "Auto Billing";
  static const String subAutoBilling = "Run billing once per day on this device";

  static const String itemContactDev = "Contact Developer";
  static const String subContactDev = "Report bugs or request features";

  static const String itemLogout = "Log Out";
  static const String unavailable = "Unavailable";

    static const String backToLogin = "Back to Login";
  
  // Step 1: Request
  static const String headRequest = "Forgot Password?";
  static const String subRequest = "Enter your email address to receive a verification code.";
  static const String btnSend = "Send Reset Code";
  
  // Step 2: Verify & Reset
  static const String headReset = "Secure Your Account";
  static const String subReset = "Enter the code sent to your email and set your new password.";
  static const String hintCode = "123456";
  static const String btnReset = "Reset Password";
  static const String resendLink = "Didn't receive code? Resend";
  
  // Messages
  static const String msgSent = "Code sent to your email";
  static const String msgSuccess = "Password reset successfully. Please login.";
  static const String errMatch = "Passwords do not match";
  static const String errCode = "Invalid code format";
  static const String cancel = "Cancel";
  static const String close = "Close";
  static const String delete = "Delete";

  // Contact Dev
  static const String devUplinkFailed = "UPLINK FAILED. CHECK SIGNAL.";
  static const String devSystemOnline = "SYSTEM ONLINE";
  static const String devWhatsAppUplink = "WHATSAPP_UPLINK";
  static const String devEmailPayload = "EMAIL_PAYLOAD";
  static const String devEmailPayloadSub = "Formal // Detailed";
  static const String devDirectUplink = "Direct uplink established.\nSelect transmission protocol.";
  static const String devWhatsAppUplinkSub = "Encrypted // Instant";
  static const String devFingerprintIdPrefix = "ID: ";
  static const String routeError = "Route Error";

  // Settings
  static const String subManageProfile = "Manage your personal details";
  static const String subSchoolConfig = "School configuration";
  static const String subThemeFixed = "Always active in Legend";
  static const String subPushAlerts = "Push alerts for updates";
  static const String subAutoBillingDesc = "Generate invoices automatically";
  static const String itemAutoBillingErrors = "Auto-billing errors";
  static const String subAutoBillingErrors = "View the last 50 engine errors";
  static const String secDangerZone = "Danger Zone";
  static const String itemDeleteAllStudentData = "Delete all student data";
  static const String subDeleteAllStudentData = "Removes students, enrollments, invoices, and payments";
  static const String autoBillingLockedTitle = "Auto-billing locked";
  static const String autoBillingLockedBody =
      "Another device holds the billing lock. You can take over and run billing here.";
  static const String autoBillingTakeOver = "Take Over";
  static const String autoBillingNoErrors = "No auto-billing errors recorded.";
  static const String autoBillingErrorsTitle = "Auto-billing errors";
  static const String autoBillingClearLog = "Clear Log";
  static const String deleteAllDataTitle = "Delete all student data";
  static const String deleteAllDataBody =
      "This will delete all students, enrollments, invoices, payments, allocations, and ledger entries for this school.";
  static const String deleteAllDataPrompt = "Type DELETE to confirm.";
  static const String deleteAllDataHint = "DELETE";
  static const String deleteAllDataSuccess = "All student data deleted.";
  static const String unknownUser = "Unknown User";
  static const String locked = "LOCKED";
  static const String syncDisconnected = "Disconnected";
  static const String syncSynchronized = "Synchronized";
  static const String syncStatusPrefix = "Status: ";
  static const String initialsFallback = "?";

  // Sync status
  static const String syncError = "Sync error";
  static const String syncConnecting = "Connecting...";
  static const String syncSyncing = "Syncing...";
  static const String syncConnected = "Connected";
  static const String syncOfflineCached = "Offline (cached)";
  static const String syncOffline = "Offline";
  static const String syncLastSyncedPrefix = "Last synced: ";
  static const String autoBillingLockHeld = "Auto-billing lock held by another device.";
  static const String autoBillingFailedPrefix = "Auto-billing failed: ";
  static const String autoBillingErrMissingTuition = "Missing tuition amount for enrollment.";
  static const String autoBillingErrMissingEnrollmentDate = "Missing enrollment date for monthly custom.";
  static const String autoBillingErrNoActiveTermMonthlyFixed = "Active term not found for monthly fixed.";
  static const String autoBillingErrNoActiveTermTermly = "Active term not found for termly billing.";
  static const String autoBillingErrNoActiveYearYearly = "Active academic year not found for yearly billing.";
}

// ==========================================
// FILE: ./data/constants/env.dart
// ==========================================

class AppEnv {
  //Secrets Cannot be implemented on a project that is not working yet.
  static const bool isProduction = bool.fromEnvironment('dart.vm.product');
  static const String powerSyncUrl =
      "https://6943ea857e2a07e6df7daa4e.powersync.journeyapps.com";
  static const String supabaseUrl = "https://hcxvsygvihhdkkyynqzw.supabase.co";
  static const String supabaseAnonKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjeHZzeWd2aWhoZGtreXlucXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTA3OTEsImV4cCI6MjA3ODQ4Njc5MX0.Tn1vzaNWHW9bV6FchGU_du-HQ9QDDXphxWJL1cM75qY";
}

// ==========================================
// FILE: ./data/constants/app_constants.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

// -----------------------------------------------------------------------------
// APP COLORS (Slate & Blue)
// -----------------------------------------------------------------------------
class AppColors {
  // Backgrounds
  static const Color backgroundBlack = Color(0xFF0F172A); // Slate 900
  static const Color surfaceDarkGrey = Color(0xFF1E293B); // Slate 800
  static const Color surfaceLightGrey = Color(0xFF334155); // Slate 700

  // Brand
  static const Color primaryBlue = Color(0xFF3B82F6); // Blue 500
  static const Color primaryBlueDark = Color(0xFF2563EB); // Blue 600
  static const Color primaryBlueLight = Color(0xFF60A5FA); // Blue 400

  // Text
  static const Color textWhite = Color(0xFFF8FAFC); // Slate 50
  static const Color textGrey = Color(0xFF94A3B8); // Slate 400
  
  // Functional
  static const Color errorRed = Color(0xFFEF4444);
  static const Color successGreen = Color(0xFF10B981);
}

// -----------------------------------------------------------------------------
// APP THEME
// -----------------------------------------------------------------------------
class AppTheme {
  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      scaffoldBackgroundColor: AppColors.backgroundBlack,
      primaryColor: AppColors.primaryBlue,
      fontFamily: GoogleFonts.jetBrainsMono().fontFamily,
      colorScheme: const ColorScheme.dark(
        primary: AppColors.primaryBlue,
        onPrimary: Colors.white,
        secondary: AppColors.surfaceDarkGrey,
        onSecondary: Colors.white,
        surface: AppColors.surfaceDarkGrey,
        error: AppColors.errorRed,
        background: AppColors.backgroundBlack,
      ),
      appBarTheme: const AppBarTheme(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: false,
        titleTextStyle: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white),
        iconTheme: IconThemeData(color: Colors.white),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColors.primaryBlue,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          textStyle: const TextStyle(fontWeight: FontWeight.bold),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./data/constants/app_schema.dart
// ==========================================

import 'package:powersync/powersync.dart';

final schema = Schema([
  // ---------------------------------------------------------------------------
  // 1. SYSTEM & CONFIGURATION
  // ---------------------------------------------------------------------------
  Table('config', [
    Column.text('school_name'),
    Column.text('address'),
    Column.text('currency'),
    Column.text('logo_url'),
    Column.text('owner_id'),
    Column.text('created_at'),
  ]),

  Table('dev', [
    Column.text('school_id'),
    Column.text('section'),
    Column.text('content'),
    Column.text('payload'),
    Column.integer('is_secret'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_dev_school', [IndexedColumn('school_id')]),
  ]),

  Table('noti', [
    Column.text('school_id'),
    Column.text('user_id'),
    Column.text('title'),
    Column.text('message'),
    Column.text('type'),
    Column.integer('is_read'),
    Column.text('metadata'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_noti_school', [IndexedColumn('school_id')]),
    Index('idx_noti_user', [IndexedColumn('user_id')]),
  ]),

  // ---------------------------------------------------------------------------
  // 2. CORE ACADEMIC STRUCTURE
  // ---------------------------------------------------------------------------
  Table('academic_years', [
    Column.text('school_id'),
    Column.text('name'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('is_active'),
    Column.integer('is_locked'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_years_school', [IndexedColumn('school_id')]),
  ]),

  Table('terms', [
    Column.text('school_id'),
    Column.text('academic_year_id'),
    Column.text('name'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('is_active'),
  ], indexes: [
    Index('idx_terms_school', [IndexedColumn('school_id')]),
    Index('idx_terms_year', [IndexedColumn('academic_year_id')]),
  ]),

  Table('grades', [
    Column.text('school_id'),
    Column.text('name'),
    Column.integer('level_index'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_grades_school', [IndexedColumn('school_id')]),
  ]),

  Table('classes', [
    Column.text('school_id'),
    Column.text('grade_id'),
    Column.text('name'),
    Column.text('teacher_id'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_classes_school', [IndexedColumn('school_id')]),
    Index('idx_classes_grade', [IndexedColumn('grade_id')]),
  ]),

  // ---------------------------------------------------------------------------
  // 3. FINANCE CONFIGURATION
  // ---------------------------------------------------------------------------
  Table('fee_categories', [
    Column.text('school_id'),
    Column.text('name'),
    Column.integer('is_taxable'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_feecat_school', [IndexedColumn('school_id')]),
  ]),

  Table('fee_structures', [
    Column.text('school_id'),
    Column.text('academic_year_id'),
    Column.text('category_id'),
    Column.text('name'),
    Column.real('amount'),
    Column.text('billing_type'),
    Column.text('recurrence'),
    Column.text('billable_months'),
    Column.text('target_grade'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_feestruct_school', [IndexedColumn('school_id')]),
    Index('idx_feestruct_year', [IndexedColumn('academic_year_id')]),
  ]),

  // ---------------------------------------------------------------------------
  // 4. PEOPLE (Students & Staff)
  // ---------------------------------------------------------------------------
  Table('profiles', [
    Column.text('school_id'),
    Column.text('full_name'),
    Column.text('role'),
    Column.integer('is_banned'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_profiles_school', [IndexedColumn('school_id')]),
  ]),

  Table('students', [
    Column.text('school_id'),
    Column.text('first_name'),
    Column.text('last_name'),
    Column.text('admission_number'),
    Column.text('gender'),
    Column.text('status'),
    Column.text('student_type'),
    
    //  ADDED: This was missing and caused the mismatch!
    Column.text('billing_cycle'), 
    
    Column.text('guardian_name'),
    Column.text('guardian_phone'),
    Column.text('guardian_email'),
    Column.text('guardian_relationship'),
    Column.real('fees_owed'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_students_school', [IndexedColumn('school_id')]),
    Index('idx_students_admnum', [IndexedColumn('admission_number')]),
  ]),

  Table('enrollments', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('academic_year_id'),
    Column.text('grade_level'), 
    Column.text('class_stream'),
    Column.text('class_id'),
    Column.text('enrollment_date'),
    Column.text('subjects'),    // JSON String
    Column.real('tuition_amount'),
    Column.integer('is_active'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_enroll_school', [IndexedColumn('school_id')]),
    Index('idx_enroll_student', [IndexedColumn('student_id')]),
    Index('idx_enroll_class', [IndexedColumn('class_id')]),
  ]),

  // ---------------------------------------------------------------------------
  // 5. BILLING & TRANSACTIONS
  // ---------------------------------------------------------------------------
  Table('invoices', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('invoice_number'),
    Column.text('term_id'),
    Column.text('due_date'),
    Column.text('status'),
    Column.text('snapshot_grade'),
    Column.real('total_amount'), 
    Column.real('paid_amount'),
    Column.text('title'), 
    Column.text('created_at'),
  ], indexes: [
    Index('idx_invoices_school', [IndexedColumn('school_id')]),
    Index('idx_invoices_student', [IndexedColumn('student_id')]),
    Index('idx_invoices_status', [IndexedColumn('status')]),
  ]),

  Table('invoice_items', [
    Column.text('school_id'),
    Column.text('invoice_id'),
    Column.text('fee_structure_id'),
    Column.text('description'),
    Column.real('amount'),
    Column.integer('quantity'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_invitems_invoice', [IndexedColumn('invoice_id')]),
  ]),

  Table('payments', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.real('amount'),
    Column.text('method'),
    Column.text('reference_code'),
    Column.text('received_at'),
  ], indexes: [
    Index('idx_payments_school', [IndexedColumn('school_id')]),
    Index('idx_payments_student', [IndexedColumn('student_id')]),
  ]),

  Table('payment_allocations', [
    Column.text('school_id'),
    Column.text('payment_id'),
    Column.text('invoice_item_id'),
    Column.real('amount_allocated'),
    Column.text('created_at'),
  ], indexes: [
    Index('idx_payalloc_payment', [IndexedColumn('payment_id')]),
    Index('idx_payalloc_invitem', [IndexedColumn('invoice_item_id')]),
  ]),

  Table('ledger', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('type'),
    Column.text('category'),
    Column.real('amount'),
    Column.text('invoice_id'),
    Column.text('payment_id'),
    Column.text('description'),
    Column.text('occurred_at'),
  ], indexes: [
    Index('idx_ledger_school', [IndexedColumn('school_id')]),
    Index('idx_ledger_student', [IndexedColumn('student_id')]),
  ]),
]);

// ==========================================
// FILE: ./data/constants/subjects.dart
// ==========================================

// File: lib/models/subjects.dart

class ZimsecSubject {
  //TODO Add all zimsec subjects in popularity order
  static const Map<int, String> _codeMap = {
    // --- FORM 1 - 4 (O-LEVEL) CORE ---
    // These are the "Must-Haves" for almost every student.
    4005: 'English Language',
    4004: 'Mathematics',
    4003: 'Combined Science', // Replaces Integrated Science
    4006: 'Heritage Studies',
    4007: 'Shona',
    4068: 'Ndebele',
    4001: 'Agriculture',

    // --- FORM 1 - 4 (O-LEVEL) POPULAR ELECTIVES ---
    // Commercials & Arts
    4049: 'Commerce',
    4037: 'Geography',
    4044: 'History',
    4047: 'Family & Religious Studies', // F.R.S (formerly Divinity/R.E)
    4048: 'Business Enterprise Skills',
    4051: 'Principles of Accounting',

    // Sciences & Tech
    4029: 'Computer Science',
    4025: 'Biology',
    4023: 'Physics',
    4024:
        'Chemistry', // Often listed as 5070/5071 in older systems, but 4024 in new curriculum maps
    4059: 'Wood Technology and Design',

    // --- FORM 5 - 6 (A-LEVEL) ---
    // Commercials
    6001: 'Accounting (A-Level)',
    6025: 'Business Studies',
    6073: 'Economics',

    // Arts / Humanities
    6022: 'Geography (A-Level)',
    6006: 'History (A-Level)',
    6003: 'Divinity',
    6009: 'Literature in English',
    6081: 'Heritage Studies (A-Level)',

    // Sciences
    6042: 'Pure Mathematics',
    6030: 'Biology (A-Level)',
    6031: 'Chemistry (A-Level)',
    6032: 'Physics (A-Level)',
    6046: 'Statistics',
    6008: 'Computer Science (A-Level)',
  };

  // This is the getter your Registration Page is looking for:
  static List<String> get allNames => _codeMap.values.toList();

  static String nameFromCode(int code) => _codeMap[code] ?? 'Unknown';
}

class EnrolledSubject {
  final String subjectName;
  final String studentId;

  EnrolledSubject({required this.subjectName, required this.studentId});

  Map<String, dynamic> toJson() => {
    'subjectName': subjectName,
    'studentId': studentId,
  };

  factory EnrolledSubject.fromJson(Map<String, dynamic> json) {
    return EnrolledSubject(
      subjectName: json['subjectName'],
      studentId: json['studentId'],
    );
  }
}

// ==========================================
// FILE: ./data/constants/app_routes.dart
// ==========================================

class AppRoutes {
  // Auth & Legal
  static const login = '/login';
  static const signup = '/signup';
  static const resetPassword = '/reset-password';
  static const tos = '/tos';
  static const offlineSetup = '/offline-setup';
  static const splash = '/';

  // Shell roots
  static const dashboard = '/dashboard';
  static const students = '/students';
  static const finance = '/finance';
  static const settings = '/settings';

  // Dashboard children
  static const notifications = 'notifications';
  static const notificationDetail = 'notifications/detail';
  static const statistics = 'statistics';
  static const outstanding = 'outstanding';
  static const received = 'received';
  static const activity = 'activity';

  // Student children
  static const addStudent = 'add';
  static const viewStudent = 'view/:studentId';
  static const studentLogs = 'logs/:studentId';
  static const studentInvoices = 'invoices/:studentId';

  // Finance children
  static const createInvoice = 'invoice/new';
  static const viewInvoice = 'invoice/:invoiceId';
  static const recordPayment = 'payment/new';
  static const loggingPayments = 'payment/log/:studentId'; // <-- include this

  // Settings children
  static const contactDev = 'contact-dev';
}

// ==========================================
// FILE: ./app_router.dart
// ==========================================

import 'package:legend/app_libs.dart'; // Assumes this exports all your Screens and Models




final GlobalKey<NavigatorState> _rootNavigatorKey = GlobalKey<NavigatorState>();
// ignore: unused_element
final GlobalKey<NavigatorState> _shellNavigatorKey = GlobalKey<NavigatorState>();

class LegendRouter {
  final AuthService authService;

  LegendRouter(this.authService);

  late final GoRouter router = GoRouter(
    navigatorKey: _rootNavigatorKey,
    initialLocation: AppRoutes.splash,
    
    // 1. AUTH LISTENER
    refreshListenable: authService,

    // 2. REDIRECT LOGIC
    redirect: (context, state) {
      final isLoggedIn = authService.isAuthenticated;
      final requiresSetup = authService.requiresOnlineSetup;
      final location = state.uri.toString();

      final isAuthRoute = location == AppRoutes.login || 
                          location == AppRoutes.signup || 
                          location == AppRoutes.resetPassword ||
                          location == AppRoutes.tos;
      
      final isSetupRoute = location == '/offline-setup';
      final isSplashRoute = location == AppRoutes.splash;

      // A. Not Logged In? -> Go Login
      if (!isLoggedIn) {
        if (!isAuthRoute && !isSplashRoute) return AppRoutes.login;
        return null;
      }

      // B. Logged In?
      if (isLoggedIn) {
        // i. Security Check
        if (requiresSetup) {
          if (!isSetupRoute && !isSplashRoute) return '/offline-setup';
          return null;
        }
        
        // ii. Already Auth? -> Go Dashboard
        if (isAuthRoute || isSetupRoute) return AppRoutes.dashboard;
      }

      return null;
    },

    errorBuilder: (context, state) => const Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Center(child: Text(AppStrings.routeError, style: TextStyle(color: Colors.white))),
    ),

    routes: [
      // =======================================================================
      // PUBLIC / AUTH ROUTES (Root Navigator)
      // =======================================================================
      GoRoute(
        path: AppRoutes.splash,
        builder: (context, state) => const SplashScreen(),
      ),
      GoRoute(
        path: AppRoutes.login,
        builder: (context, state) => const LoginScreen(),
      ),
      GoRoute(
        path: AppRoutes.signup,
        builder: (context, state) => const SignupScreen(),
      ),
      GoRoute(
        path: AppRoutes.resetPassword,
        builder: (context, state) => const ForgotPasswordScreen(),
      ),
      GoRoute(
        path: AppRoutes.tos,
        builder: (context, state) => const TosScreen(),
      ),
      GoRoute(
        path: '/offline-setup',
        builder: (context, state) => const OfflineSetupScreen(),
      ),

      // =======================================================================
      // SHELL ROUTE (The Fixed Bottom Nav Wrapper)
      // =======================================================================
      StatefulShellRoute.indexedStack(
        builder: (context, state, navigationShell) {
          return AppShell(navigationShell: navigationShell);
        },
        branches: [
          
          // BRANCH 1: DASHBOARD
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.dashboard,
                builder: (context, state) => const DashboardScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.notifications, // "notifications"
                    builder: (context, state) => const NotificationsScreen(),
                    routes: [
                      GoRoute(
                        path: 'detail',
                        parentNavigatorKey: _rootNavigatorKey, // Fullscreen
                        builder: (context, state) {
                          final noti = state.extra as LegendNotification;
                          return NotificationDetailScreen(notification: noti);
                        },
                      ),
                    ],
                  ),
                  GoRoute(
                    path: AppRoutes.statistics, // "statistics"
                    builder: (context, state) => const StatisticsScreen(),
                  ),
                  GoRoute(
                    path: AppRoutes.outstanding,
                    builder: (context, state) => const OutstandingStudentsScreen(),
                  ),
                  GoRoute(
                    path: AppRoutes.received,
                    builder: (context, state) => const ReceivedPaymentsScreen(),
                  ),
                  GoRoute(
                    path: AppRoutes.activity,
                    builder: (context, state) => const DashboardActivityScreen(),
                  ),
                ],
              ),
            ],
          ),

          // BRANCH 2: STUDENTS
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.students,
                builder: (context, state) => const StudentsScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.addStudent,
                    parentNavigatorKey: _rootNavigatorKey, // Hide Nav Bar
                    builder: (context, state) => const AddStudentScreen(),
                  ),
                  GoRoute(
                    // Ensure AppRoutes.viewStudent contains ":studentId" 
                    // e.g. "view/:studentId"
                    path: AppRoutes.viewStudent, 
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => ViewStudentScreen(
                      studentId: state.pathParameters['studentId']!,
                    ),
                  ),
                  GoRoute(
                    path: AppRoutes.studentLogs,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => StudentLogsScreen(
                      studentId: state.pathParameters['studentId']!,
                    ),
                  ),
                  GoRoute(
                    path: AppRoutes.studentInvoices,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => StudentInvoicesScreen(
                      studentId: state.pathParameters['studentId']!,
                    ),
                  ),
                ],
              ),
            ],
          ),

          // BRANCH 3: FINANCE
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.finance,
                builder: (context, state) => const FinanceScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.createInvoice,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => const CreateInvoiceScreen(),
                  ),
                  GoRoute(
                    path: AppRoutes.viewInvoice,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => ViewInvoiceScreen(
                      invoiceId: state.pathParameters['invoiceId'],
                    ),
                  ),
                  GoRoute(
                    path: AppRoutes.recordPayment,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => RecordPaymentScreen(
                      studentId: state.uri.queryParameters['studentId'],
                    ),
                  ),
                  // Wired Logging Payments here so it relates to Finance flow
                  GoRoute(
                    path: AppRoutes.loggingPayments,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => LoggingPaymentsScreen(
                      studentId: state.pathParameters['studentId']!,
                    ),
                  ),
                ],
              ),
            ],
          ),

          // BRANCH 4: SETTINGS
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.settings,
                builder: (context, state) => const SettingsScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.contactDev,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => const ContactDevScreen(),
                  ),
                ],
              ),
            ],
          ),
        ],
      ),
    ],
  );
}

// =============================================================================
// APP SHELL WIDGET
// =============================================================================
class AppShell extends StatelessWidget {
  final StatefulNavigationShell navigationShell;

  const AppShell({required this.navigationShell, super.key});

  void _onTabSelected(int index) {
    navigationShell.goBranch(
      index,
      initialLocation: index == navigationShell.currentIndex,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: navigationShell, // The current branch content
      bottomNavigationBar: Container(
        decoration: const BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          boxShadow: [
            BoxShadow(
              color: Colors.black26, 
              blurRadius: 10, 
              offset: Offset(0, -5),
            )
          ],
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            child: GNav(
              backgroundColor: AppColors.surfaceDarkGrey,
              color: AppColors.textGrey,
              activeColor: Colors.white,
              tabBackgroundColor: AppColors.primaryBlue.withAlpha(40),
              gap: 8,
              padding: const EdgeInsets.all(12),
              iconSize: 24,
              textSize: 14,
              selectedIndex: navigationShell.currentIndex,
              onTabChange: _onTabSelected,
              tabs: const [
                GButton(
                  icon: Icons.dashboard_outlined,
                  text: 'Dashboard',
                ),
                GButton(
                  icon: Icons.people_outline,
                  text: 'Students',
                ),
                GButton(
                  icon: Icons.account_balance_wallet_outlined,
                  text: 'Finance',
                ),
                GButton(
                  icon: Icons.settings_outlined,
                  text: 'Settings',
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/utils/all_utils.dart
// ==========================================

export 'subject_selector_field.dart';
// ==========================================
// FILE: ./screens/utils/responsive.dart
// ==========================================

import 'dart:math' as math;
import 'package:flutter/widgets.dart';

enum SizeClass { compact, medium, expanded }

class Responsive {
  static SizeClass sizeClass(BuildContext context) {
    final w = MediaQuery.sizeOf(context).width;
    if (w < 600) return SizeClass.compact;       // phones
    if (w < 1024) return SizeClass.medium;       // tablets / small landscape
    return SizeClass.expanded;                   // large tablets / desktop
  }

  static bool isCompact(BuildContext c) => sizeClass(c) == SizeClass.compact;
  static bool isMedium(BuildContext c) => sizeClass(c) == SizeClass.medium;
  static bool isExpanded(BuildContext c) => sizeClass(c) == SizeClass.expanded;

  /// Standard page padding (gutter)
  static EdgeInsets pagePadding(BuildContext c) {
    final w = MediaQuery.sizeOf(c).width;
    final h = MediaQuery.sizeOf(c).height;
    final base = math.max(16.0, math.min(24.0, w * 0.05));
    // a bit more breathing room on tall displays
    return EdgeInsets.symmetric(horizontal: base, vertical: math.min(24.0, h * 0.03));
  }

  /// Keeps content readable on wide screens (not desktop specific, just max width)
  static double maxContentWidth(BuildContext c) {
    final sc = sizeClass(c);
    if (sc == SizeClass.compact) return double.infinity;
    if (sc == SizeClass.medium) return 760;
    return 920;
  }
}

class ResponsiveCenter extends StatelessWidget {
  final Widget child;
  const ResponsiveCenter({super.key, required this.child});

  @override
  Widget build(BuildContext context) {
    final pad = Responsive.pagePadding(context);
    final maxW = Responsive.maxContentWidth(context);

    return Align(
      alignment: Alignment.topCenter,
      child: ConstrainedBox(
        constraints: BoxConstraints(maxWidth: maxW),
        child: Padding(padding: pad, child: child),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/utils/subject_selector_field.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:legend/data/constants/app_constants.dart';
import '../../data/constants/subjects.dart'; // Ensure this points to your ZimsecSubject model

class SubjectSelectorField extends StatefulWidget {
  final List<String> selectedSubjects;
  final ValueChanged<List<String>> onChanged;

  const SubjectSelectorField({
    super.key,
    required this.selectedSubjects,
    required this.onChanged,
  });

  @override
  State<SubjectSelectorField> createState() => _SubjectSelectorFieldState();
}

class _SubjectSelectorFieldState extends State<SubjectSelectorField> {
  void _openSearchModal() async {
    final result = await showModalBottomSheet<List<String>>(
      context: context,
      isScrollControlled: true, // Critical for full height
      backgroundColor: Colors.transparent,
      builder: (context) => _SubjectSearchModal(
        initialSelection: widget.selectedSubjects,
        allSubjects: ZimsecSubject.allNames, 
      ),
    );

    if (result != null) {
      widget.onChanged(result);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // 1. THE TRIGGER BUTTON
        InkWell(
          onTap: _openSearchModal,
          borderRadius: BorderRadius.circular(12),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            decoration: BoxDecoration(
              color: AppColors.backgroundBlack,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
            ),
            child: Row(
              children: [
                const Icon(Icons.menu_book_outlined, color: AppColors.textGrey, size: 20),
                const SizedBox(width: 12),
                Text(
                  widget.selectedSubjects.isEmpty 
                      ? "Select Subjects..." 
                      : "${widget.selectedSubjects.length} Subjects Selected",
                  style: TextStyle(
                    color: widget.selectedSubjects.isEmpty ? AppColors.textGrey : Colors.white,
                    fontSize: 16,
                  ),
                ),
                const Spacer(),
                const Icon(Icons.arrow_drop_down, color: AppColors.textGrey),
              ],
            ),
          ),
        ),

        // 2. THE CHIP DISPLAY (If items selected)
        if (widget.selectedSubjects.isNotEmpty) ...[
          const SizedBox(height: 12),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: widget.selectedSubjects.map((subject) {
              return Chip(
                label: Text(
                  subject, 
                  style: const TextStyle(fontSize: 12, color: Colors.white),
                ),
                backgroundColor: AppColors.primaryBlue.withAlpha(40),
                deleteIcon: const Icon(Icons.close, size: 14, color: Colors.white70),
                side: BorderSide.none,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                onDeleted: () {
                  final newList = List<String>.from(widget.selectedSubjects);
                  newList.remove(subject);
                  widget.onChanged(newList);
                },
              );
            }).toList(),
          ),
        ],
      ],
    );
  }
}

// -----------------------------------------------------------------------------
// INTERNAL MODAL WIDGET (With Custom Adder)
// -----------------------------------------------------------------------------
class _SubjectSearchModal extends StatefulWidget {
  final List<String> initialSelection;
  final List<String> allSubjects;

  const _SubjectSearchModal({
    required this.initialSelection,
    required this.allSubjects,
  });

  @override
  State<_SubjectSearchModal> createState() => _SubjectSearchModalState();
}

class _SubjectSearchModalState extends State<_SubjectSearchModal> {
  late List<String> _selected;
  late List<String> _filteredList;
  final TextEditingController _searchCtrl = TextEditingController();
  
  // Custom Subject Helper State
  String? _customSubjectCandidate;

  @override
  void initState() {
    super.initState();
    _selected = List.from(widget.initialSelection);
    _filteredList = List.from(widget.allSubjects);
    
    // Ensure existing custom subjects (not in the static list) are visible
    for (var s in _selected) {
      if (!_filteredList.contains(s)) {
        _filteredList.add(s);
      }
    }
    
    _sortList();
  }

  void _sortList() {
    _filteredList.sort((a, b) {
      final aSelected = _selected.contains(a);
      final bSelected = _selected.contains(b);
      if (aSelected && !bSelected) return -1;
      if (!aSelected && bSelected) return 1;
      return a.compareTo(b);
    });
  }

  void _filter(String query) {
    setState(() {
      final cleanQuery = query.trim();
      
      if (cleanQuery.isEmpty) {
        _filteredList = List.from(widget.allSubjects);
        // Re-add selected custom ones if any
        for (var s in _selected) {
          if (!_filteredList.contains(s)) _filteredList.add(s);
        }
        _customSubjectCandidate = null;
      } else {
        // Standard Filter
        _filteredList = widget.allSubjects
            .where((s) => s.toLowerCase().contains(cleanQuery.toLowerCase()))
            .toList();
        
        // Check if exact match exists
        final exactMatch = _filteredList.any((s) => s.toLowerCase() == cleanQuery.toLowerCase());
        
        // If no exact match, propose adding it
        if (!exactMatch && cleanQuery.isNotEmpty) {
          _customSubjectCandidate = cleanQuery;
        } else {
          _customSubjectCandidate = null;
        }
      }
      _sortList();
    });
  }

  void _toggleItem(String subject) {
    setState(() {
      if (_selected.contains(subject)) {
        _selected.remove(subject);
      } else {
        _selected.add(subject);
      }
      _searchCtrl.clear();
      _filter(''); // Reset filter to show selection
    });
  }

  void _addCustomSubject() {
    if (_customSubjectCandidate != null) {
      // Capitalize first letter for neatness
      final formatted = toBeginningOfSentenceCase(_customSubjectCandidate!) ?? _customSubjectCandidate!;
      
      setState(() {
        if (!_filteredList.contains(formatted)) {
          _filteredList.insert(0, formatted); // Add to local list view
        }
        if (!_selected.contains(formatted)) {
          _selected.add(formatted);
        }
        _searchCtrl.clear();
        _customSubjectCandidate = null;
        _filter(''); // Reset view
      });
    }
  }
  
  // Helper for capitalization since intl might not be everywhere
  String? toBeginningOfSentenceCase(String input) {
    if (input.isEmpty) return input;
    return input[0].toUpperCase() + input.substring(1);
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.85, 
      decoration: const BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          // 1. DRAG HANDLE & TITLE
          const SizedBox(height: 12),
          Container(
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: AppColors.surfaceLightGrey,
              borderRadius: BorderRadius.circular(2),
            ),
          ),
          const Padding(
            padding: EdgeInsets.symmetric(vertical: 16),
            child: Text(
              "Manage Enrollment",
              style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold),
            ),
          ),

          // 2. SEARCH BAR
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20),
            child: TextField(
              controller: _searchCtrl,
              onChanged: _filter,
              style: const TextStyle(color: Colors.white),
              decoration: InputDecoration(
                hintText: "Search or add custom...",
                hintStyle: const TextStyle(color: AppColors.textGrey),
                prefixIcon: const Icon(Icons.search, color: AppColors.textGrey),
                filled: true,
                fillColor: AppColors.surfaceDarkGrey,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                contentPadding: const EdgeInsets.symmetric(vertical: 12),
              ),
            ),
          ),
          const SizedBox(height: 16),

          // 3. LIST VIEW
          Expanded(
            child: ListView(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              children: [
                // A. CUSTOM ADDER TILE (Only if candidate exists)
                if (_customSubjectCandidate != null) ...[
                  ListTile(
                    onTap: _addCustomSubject,
                    contentPadding: EdgeInsets.zero,
                    leading: Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: AppColors.successGreen.withAlpha(20),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: const Icon(Icons.add, color: AppColors.successGreen, size: 20),
                    ),
                    title: RichText(
                      text: TextSpan(
                        text: "Add custom: ",
                        style: const TextStyle(color: AppColors.textGrey, fontSize: 14),
                        children: [
                          TextSpan(
                            text: '"$_customSubjectCandidate"',
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const Divider(color: AppColors.surfaceLightGrey, height: 24),
                ],

                // B. STANDARD LIST
                ..._filteredList.map((subject) {
                  final isSelected = _selected.contains(subject);
                  return Column(
                    children: [
                      ListTile(
                        onTap: () => _toggleItem(subject),
                        contentPadding: EdgeInsets.zero,
                        title: Text(
                          subject,
                          style: TextStyle(
                            color: isSelected ? AppColors.primaryBlueLight : Colors.white,
                            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                          ),
                        ),
                        trailing: isSelected
                            ? const Icon(Icons.check_circle, color: AppColors.primaryBlue)
                            : const Icon(Icons.circle_outlined, color: AppColors.textGrey),
                      ),
                      const Divider(color: AppColors.surfaceDarkGrey, height: 1),
                    ],
                  );
                }),
              ],
            ),
          ),

          // 4. DONE BUTTON
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(20),
              child: SizedBox(
                width: double.infinity,
                height: 50,
                child: ElevatedButton(
                  onPressed: () => Navigator.pop(context, _selected),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                  child: Text("Done (${_selected.length})", style: const TextStyle(fontWeight: FontWeight.bold)),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/students/student_invoices_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

class StudentInvoicesScreen extends StatefulWidget {
  final String studentId;

  const StudentInvoicesScreen({super.key, required this.studentId});

  @override
  State<StudentInvoicesScreen> createState() => _StudentInvoicesScreenState();
}

class _StudentInvoicesScreenState extends State<StudentInvoicesScreen> {
  late Future<List<Invoice>> _future;

  @override
  void initState() {
    super.initState();
    _future = _load();
  }

  Future<List<Invoice>> _load() async {
    return context.read<FinanceRepository>().getStudentInvoices(widget.studentId);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text("All Invoices", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
      ),
      body: FutureBuilder<List<Invoice>>(
        future: _future,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }
          if (snapshot.hasError) {
            return Center(
              child: Text("Error: ${snapshot.error}", style: const TextStyle(color: AppColors.errorRed)),
            );
          }

          final invoices = snapshot.data ?? [];
          if (invoices.isEmpty) {
            return const Center(
              child: Text("No invoices found.", style: TextStyle(color: AppColors.textGrey)),
            );
          }

          return ListView.separated(
            padding: const EdgeInsets.all(20),
            itemCount: invoices.length,
            separatorBuilder: (_, __) => const SizedBox(height: 12),
            itemBuilder: (context, index) {
              final inv = invoices[index];
              final statusColor = inv.status == InvoiceStatus.paid ? AppColors.successGreen : Colors.orangeAccent;
              return InkWell(
                onTap: () => context.push(
                  '${AppRoutes.finance}/${AppRoutes.viewInvoice}'.replaceAll(':invoiceId', inv.id),
                ),
                borderRadius: BorderRadius.circular(16),
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: const Color(0xFF1E2029),
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.orangeAccent.withAlpha(20),
                          shape: BoxShape.circle,
                        ),
                        child: const Icon(Icons.description, color: Colors.orangeAccent, size: 20),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(inv.title ?? "Invoice", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15)),
                            Text(
                              "Due ${inv.dueDate.toIso8601String().split('T')[0]}",
                              style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
                            ),
                          ],
                        ),
                      ),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          Text(
                            "\$${inv.totalAmount.toStringAsFixed(2)}",
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15),
                          ),
                          const SizedBox(height: 4),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                            decoration: BoxDecoration(
                              color: statusColor.withAlpha(30),
                              borderRadius: BorderRadius.circular(4),
                            ),
                            child: Text(
                              inv.status.name.toUpperCase(),
                              style: TextStyle(color: statusColor, fontSize: 10, fontWeight: FontWeight.bold),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              );
            },
          );
        },
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/students/view_student_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';
import 'package:url_launcher/url_launcher.dart';

import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/constants/app_routes.dart';
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/repo/student_repo.dart';
import 'package:legend/data/services/auth/auth.dart';
import 'package:legend/data/vmodels/students_vmodel.dart';

class ViewStudentScreen extends StatefulWidget {
  final String? studentId;
  const ViewStudentScreen({super.key, this.studentId});

  @override
  State<ViewStudentScreen> createState() => _ViewStudentScreenState();
}

class _ViewStudentScreenState extends State<ViewStudentScreen> {
  late final StudentDetailViewModel _detailVm;
  StudentFinanceViewModel? _financeVm;

  @override
  void initState() {
    super.initState();

    final auth = context.read<AuthService>();
    final studentRepo = context.read<StudentRepository>();
    final financeRepo = context.read<FinanceRepository>();

    _detailVm = StudentDetailViewModel(studentRepo);

    final schoolId = auth.activeSchool?.id ?? '';

    if (widget.studentId != null) {
      _detailVm.loadStudent(widget.studentId!);
      _financeVm = StudentFinanceViewModel(financeRepo, widget.studentId!, schoolId);
      _financeVm!.loadFinanceData();
    }
  }

  @override
  void dispose() {
    _detailVm.dispose();
    _financeVm?.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider<StudentDetailViewModel>.value(value: _detailVm),
        if (_financeVm != null)
          ChangeNotifierProvider<StudentFinanceViewModel>.value(value: _financeVm!),
      ],
      child: Consumer<StudentDetailViewModel>(
        builder: (context, vm, _) {
          if (vm.isLoading) {
            return const Scaffold(
              backgroundColor: AppColors.backgroundBlack,
              body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
            );
          }

          if (vm.student == null) {
            return Scaffold(
              backgroundColor: AppColors.backgroundBlack,
              appBar: AppBar(
                backgroundColor: AppColors.backgroundBlack,
                leading: const BackButton(color: Colors.white),
              ),
              body: const Center(
                child: Text("Student not found", style: TextStyle(color: Colors.white)),
              ),
            );
          }

          final student = vm.student!;
          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: DefaultTabController(
              length: 3,
              child: NestedScrollView(
                headerSliverBuilder: (context, innerBoxIsScrolled) => [
                  SliverOverlapAbsorber(
                    handle: NestedScrollView.sliverOverlapAbsorberHandleFor(context),
                    sliver: SliverAppBar(
                      expandedHeight: 280, // Increased height for the new profile UI
                      pinned: true,
                      backgroundColor: AppColors.backgroundBlack,
                      leading: IconButton(
                        icon: Container(
                          padding: const EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: Colors.black.withAlpha(100),
                            shape: BoxShape.circle,
                          ),
                          child: const Icon(Icons.arrow_back, color: Colors.white, size: 20),
                        ),
                        onPressed: () => context.pop(),
                      ),
                      actions: [
                        IconButton(
                          icon: const Icon(Icons.more_horiz, color: Colors.white),
                          onPressed: () => context.push('${AppRoutes.addStudent}?studentId=${student.id}'),
                        ),
                      ],
                      flexibleSpace: FlexibleSpaceBar(
                        background: _StudentHeader(student: student, enrollments: vm.enrollments),
                      ),
                      bottom: const TabBar(
                        indicatorColor: AppColors.primaryBlue,
                        indicatorWeight: 3,
                        labelColor: Colors.white,
                        unselectedLabelColor: AppColors.textGrey,
                        labelStyle: TextStyle(fontWeight: FontWeight.bold, fontSize: 13),
                        tabs: [
                          Tab(text: "Overview"),
                          Tab(text: "Finance"),
                          Tab(text: "Academic"),
                        ],
                      ),
                    ),
                  ),
                ],
                body: TabBarView(
                  children: [
                    _OverviewTab(student: student, enrollments: vm.enrollments),
                    _FinanceTab(student: student),
                    _AcademicTab(enrollments: vm.enrollments),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

// =============================================================================
// Header (Redesigned based on Image 2)
// =============================================================================

class _StudentHeader extends StatelessWidget {
  final Student student;
  final List<Enrollment> enrollments;

  const _StudentHeader({required this.student, required this.enrollments});

  @override
  Widget build(BuildContext context) {
    final active = enrollments.where((e) => e.isActive).toList();
    final current = (active.isNotEmpty) ? active.first : (enrollments.isNotEmpty ? enrollments.first : null);

    final grade = current?.gradeLevel ?? "No Grade";
    final type = student.type.name.toUpperCase();

    return Container(
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        // Subtle top gradient to give depth
        gradient: RadialGradient(
          center: Alignment.topCenter,
          radius: 1.5,
          colors: [
            AppColors.primaryBlue.withAlpha(40),
            AppColors.backgroundBlack,
          ],
        ),
      ),
      child: SafeArea(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const SizedBox(height: 10),
            // Avatar with Status Dot
            Stack(
              alignment: Alignment.bottomRight,
              children: [
                Container(
                  padding: const EdgeInsets.all(4),
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    border: Border.all(color: AppColors.primaryBlue.withAlpha(100), width: 1),
                  ),
                  child: CircleAvatar(
                    radius: 40,
                    backgroundColor: AppColors.surfaceLightGrey,
                    child: Text(
                      "${student.firstName.isNotEmpty ? student.firstName[0] : ''}${student.lastName.isNotEmpty ? student.lastName[0] : ''}",
                      style: const TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Colors.white),
                    ),
                  ),
                ),
                Container(
                  padding: const EdgeInsets.all(4),
                  decoration: const BoxDecoration(
                    color: AppColors.backgroundBlack,
                    shape: BoxShape.circle,
                  ),
                  child: Container(
                    width: 14,
                    height: 14,
                    decoration: BoxDecoration(
                      color: student.status == StudentStatus.active ? AppColors.successGreen : AppColors.textGrey,
                      shape: BoxShape.circle,
                      border: Border.all(color: AppColors.backgroundBlack, width: 2),
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            
            // Name & Status Badge
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text(
                  student.fullName,
                  style: const TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold),
                ),
                const SizedBox(width: 8),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                  decoration: BoxDecoration(
                    color: AppColors.successGreen.withAlpha(30),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: AppColors.successGreen.withAlpha(100)),
                  ),
                  child: Text(
                    student.status.name.toUpperCase(),
                    style: const TextStyle(color: AppColors.successGreen, fontSize: 10, fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            
            // Grade & Type Chips
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                _HeaderChip(text: grade, color: AppColors.primaryBlue),
                const SizedBox(width: 12),
                _HeaderChip(text: type, color: AppColors.surfaceLightGrey),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

class _HeaderChip extends StatelessWidget {
  final String text;
  final Color color;
  const _HeaderChip({required this.text, required this.color});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: color.withAlpha(50)),
      ),
      child: Text(
        text.toUpperCase(),
        style: TextStyle(color: color, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.5),
      ),
    );
  }
}

// =============================================================================
// Tab: Overview (Integrated Image 2 "Billing Core" & "Payer" UI)
// =============================================================================

class _OverviewTab extends StatelessWidget {
  final Student student;
  final List<Enrollment> enrollments;

  const _OverviewTab({required this.student, required this.enrollments});

  @override
  Widget build(BuildContext context) {
    final hasPhone = (student.guardianPhone ?? '').trim().isNotEmpty;
    final hasEmail = (student.guardianEmail ?? '').trim().isNotEmpty;

    // Define 'current' enrollment (active or first)
    final active = enrollments.where((e) => e.isActive).toList();
    final current = (active.isNotEmpty) ? active.first : (enrollments.isNotEmpty ? enrollments.first : null);

    return Builder(
      builder: (context) {
        return CustomScrollView(
          key: const PageStorageKey("overview"),
          slivers: [
            SliverOverlapInjector(handle: NestedScrollView.sliverOverlapAbsorberHandleFor(context)),
            SliverPadding(
              padding: const EdgeInsets.all(20),
              sliver: SliverList(
                delegate: SliverChildListDelegate([
                  _SectionTitle(title: "BILLING CORE"),
                  const SizedBox(height: 12),
                  
                  // Admission Card (Matches Image 2 Top Card)
                  Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1E2029), // Slightly lighter than black
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                      boxShadow: [
                         BoxShadow(color: Colors.black.withAlpha(50), blurRadius: 10, offset: const Offset(0, 5))
                      ]
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text("ADMISSION ID", style: TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                            GestureDetector(
                              onTap: () => _copy(context, student.admissionNumber ?? ""),
                              child: Container(
                                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                decoration: BoxDecoration(
                                  color: AppColors.surfaceLightGrey.withAlpha(30),
                                  borderRadius: BorderRadius.circular(20)
                                ),
                                child: const Row(
                                  children: [
                                    Icon(Icons.copy, size: 12, color: Colors.white),
                                    SizedBox(width: 6),
                                    Text("Copy", style: TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold)),
                                  ],
                                ),
                              ),
                            )
                          ],
                        ),
                        const SizedBox(height: 8),
                        Text(
                          student.admissionNumber ?? "N/A",
                          style: const TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold, letterSpacing: 1),
                        ),
                        const SizedBox(height: 20),
                        Divider(color: AppColors.surfaceLightGrey.withAlpha(20)),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(
                              child: _DetailColumn(
                                label: "STUDENT TYPE",
                                value: student.type.name.capitalize(),
                                icon: Icons.school,
                              ),
                            ),
                            Expanded(
                              child: _DetailColumn(
                                label: "TUITION (PER PERIOD)",
                                value: current == null ? "N/A" : _money(current.tuitionAmount),
                                icon: Icons.payments_outlined,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),
                  _SectionTitle(title: "PRIMARY PAYER"),
                  const SizedBox(height: 12),

                  // Guardian Card (Matches Image 2 Bottom Card)
                  Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1E2029),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                    ),
                    child: Column(
                      children: [
                        Row(
                          children: [
                            CircleAvatar(
                              backgroundColor: AppColors.surfaceLightGrey.withAlpha(50),
                              child: const Icon(Icons.person, color: Colors.white),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    student.guardianName ?? "No Guardian",
                                    style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                                  ),
                                  Text(
                                    student.guardianRelationship ?? 'Guardian',
                                    style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
                                  ),
                                ],
                              ),
                            ),
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                              decoration: BoxDecoration(
                                color: AppColors.primaryBlue.withAlpha(30),
                                borderRadius: BorderRadius.circular(4)
                              ),
                              child: const Text("GUARDIAN", style: TextStyle(color: AppColors.primaryBlue, fontSize: 10, fontWeight: FontWeight.bold)),
                            )
                          ],
                        ),
                        const SizedBox(height: 20),
                        Row(
                          children: [
                            Expanded(
                              child: _ActionLargeBtn(
                                icon: Icons.phone,
                                label: "Call Mobile",
                                onTap: hasPhone ? () => _launchPhone(context, student.guardianPhone!) : null,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: _ActionLargeBtn(
                                icon: Icons.email,
                                label: "Send Email",
                                onTap: hasEmail ? () => _launchEmail(context, student.guardianEmail!, student.fullName) : null,
                              ),
                            ),
                          ],
                        )
                      ],
                    ),
                  ),
                  const SizedBox(height: 80),
                ]),
              ),
            ),
          ],
        );
      },
    );
  }

  static Future<void> _copy(BuildContext context, String value) async {
    await Clipboard.setData(ClipboardData(text: value));
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("Copied info"), behavior: SnackBarBehavior.floating),
    );
  }

  static Future<void> _launchPhone(BuildContext context, String phone) async {
    final uri = Uri(scheme: 'tel', path: phone);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      _showLaunchError(context);
    }
  }

  static Future<void> _launchEmail(BuildContext context, String email, String studentName) async {
    final uri = Uri(
      scheme: 'mailto',
      path: email,
      queryParameters: {'subject': 'Guardian Contact: $studentName'},
    );
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      _showLaunchError(context);
    }
  }

  static void _showLaunchError(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text("Could not open the app."),
        backgroundColor: AppColors.errorRed,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  String _money(double value) => "\$${value.toStringAsFixed(2)}";
}

class _DetailColumn extends StatelessWidget {
  final String label;
  final String value;
  final IconData icon;
  const _DetailColumn({required this.label, required this.value, required this.icon});

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Icon(icon, size: 12, color: AppColors.textGrey),
            const SizedBox(width: 6),
            Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold)),
          ],
        ),
        const SizedBox(height: 6),
        Text(value, style: const TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.w600)),
      ],
    );
  }
}

class _ActionLargeBtn extends StatelessWidget {
  final IconData icon;
  final String label;
  final VoidCallback? onTap;
  const _ActionLargeBtn({required this.icon, required this.label, required this.onTap});

  @override
  Widget build(BuildContext context) {
    final enabled = onTap != null;
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 16),
        decoration: BoxDecoration(
          color: enabled ? AppColors.backgroundBlack : AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        child: Column(
          children: [
            Icon(icon, color: enabled ? AppColors.textGrey : AppColors.surfaceLightGrey, size: 20),
            const SizedBox(height: 8),
            Text(
              label,
              style: TextStyle(
                color: enabled ? Colors.white : AppColors.textGrey,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// =============================================================================
// Tab: Finance (Integrated Image 1 UI)
// =============================================================================

class _FinanceTab extends StatelessWidget {
  final Student student;
  const _FinanceTab({required this.student});

  @override
  Widget build(BuildContext context) {
    final financeVm = context.watch<StudentFinanceViewModel?>();

    if (financeVm == null || financeVm.isLoading) {
      return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
    }

    final invoices = financeVm.invoices;
    final payments = financeVm.payments;
    final totalInvoiced = invoices.fold<double>(0.0, (s, i) => s + i.totalAmount);
    final totalPaid = payments.fold<double>(0.0, (s, p) => s + p.amount);
    final outstanding = (totalInvoiced - totalPaid) < 0 ? 0.0 : (totalInvoiced - totalPaid);
    final progress = totalInvoiced <= 0 ? 0.0 : (totalPaid / totalInvoiced).clamp(0.0, 1.0);
    final nextDueDate = _nextDueDate(invoices);
    final hasGuardianPhone = (student.guardianPhone ?? '').trim().isNotEmpty;
    final hasGuardianEmail = (student.guardianEmail ?? '').trim().isNotEmpty;

    return Builder(
      builder: (context) {
        return CustomScrollView(
          key: const PageStorageKey("finance"),
          slivers: [
            SliverOverlapInjector(handle: NestedScrollView.sliverOverlapAbsorberHandleFor(context)),
            SliverPadding(
              padding: const EdgeInsets.all(20),
              sliver: SliverList(
                delegate: SliverChildListDelegate([
                  
                  // Big Outstanding Card (Image 1 Style)
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1E2029),
                      borderRadius: BorderRadius.circular(24),
                      border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text("TOTAL OUTSTANDING", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                            Icon(Icons.wallet, color: AppColors.surfaceLightGrey.withAlpha(50), size: 32)
                          ],
                        ),
                        const SizedBox(height: 8),
                        Text(
                          "\$${outstanding.toStringAsFixed(2)}",
                          style: const TextStyle(color: Colors.white, fontSize: 42, fontWeight: FontWeight.w900, fontFamily: 'JetBrains Mono'),
                        ),
                        const SizedBox(height: 24),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text("PAYMENT PLAN PROGRESS", style: TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold)),
                            Text("${(progress * 100).toInt()}% PAID", style: const TextStyle(color: AppColors.primaryBlue, fontSize: 10, fontWeight: FontWeight.bold)),
                          ],
                        ),
                        const SizedBox(height: 10),
                        ClipRRect(
                          borderRadius: BorderRadius.circular(6),
                          child: LinearProgressIndicator(
                            value: progress,
                            backgroundColor: AppColors.backgroundBlack,
                            color: AppColors.primaryBlue,
                            minHeight: 10,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Text("Paid: \$${totalPaid.toStringAsFixed(0)}", style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
                            Text("Total: \$${totalInvoiced.toStringAsFixed(0)}", style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
                          ],
                        ),
                        const SizedBox(height: 24),
                        if (hasGuardianPhone || hasGuardianEmail) ...[
                          const SizedBox(height: 20),
                          _NotificationActions(
                            student: student,
                            outstanding: outstanding,
                            nextDueDate: nextDueDate,
                            hasGuardianEmail: hasGuardianEmail,
                            hasGuardianPhone: hasGuardianPhone,
                          ),
                        ],
                      ],
                    ),
                  ),

                  const SizedBox(height: 32),
                  Row(
                    children: [
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: () => context.go('${AppRoutes.finance}/${AppRoutes.loggingPayments}'.replaceAll(':studentId', student.id)),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primaryBlue,
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          ),
                          icon: const Icon(Icons.receipt_long, size: 18),
                          label: const Text("Log Payment", style: TextStyle(fontWeight: FontWeight.bold)),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: () => context.go('${AppRoutes.students}/${AppRoutes.studentLogs}'.replaceAll(':studentId', student.id)),
                          style: OutlinedButton.styleFrom(
                            foregroundColor: Colors.white,
                            side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(40)),
                            padding: const EdgeInsets.symmetric(vertical: 14),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          ),
                          icon: const Icon(Icons.history, size: 18),
                          label: const Text("Student Logs"),
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 32),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      _SectionTitle(title: "RECENT INVOICES"),
                      GestureDetector(
                        onTap: () => context.go(
                          '${AppRoutes.students}/${AppRoutes.studentInvoices}'.replaceAll(':studentId', student.id),
                        ),
                        child: const Text("See All", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12, fontWeight: FontWeight.bold)),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  
                  if (invoices.isEmpty)
                     const Padding(padding: EdgeInsets.all(20), child: Text("No invoices found.", style: TextStyle(color: AppColors.textGrey)))
                  else
                    ...invoices.take(3).map((inv) => _InvoiceTile(inv: inv)),

                  const SizedBox(height: 24),
                  _SectionTitle(title: "PAYMENT HISTORY"),
                  const SizedBox(height: 16),
                  
                  if (payments.isEmpty)
                     const Padding(padding: EdgeInsets.all(20), child: Text("No payments found.", style: TextStyle(color: AppColors.textGrey)))
                  else
                    ...payments.take(3).map((p) => _PaymentTile(p: p)),

                  const SizedBox(height: 80),
                ]),
              ),
            ),
          ],
        );
      },
    );
  }

  DateTime? _nextDueDate(List<Invoice> invoices) {
    final unpaid = invoices.where((i) => i.status != InvoiceStatus.paid).toList();
    if (unpaid.isEmpty) return null;
    unpaid.sort((a, b) => a.dueDate.compareTo(b.dueDate));
    return unpaid.first.dueDate;
  }
}

class _NotificationActions extends StatelessWidget {
  final Student student;
  final double outstanding;
  final DateTime? nextDueDate;
  final bool hasGuardianPhone;
  final bool hasGuardianEmail;

  const _NotificationActions({
    required this.student,
    required this.outstanding,
    required this.nextDueDate,
    required this.hasGuardianEmail,
    required this.hasGuardianPhone,
  });

  @override
  Widget build(BuildContext context) {
    final message = _buildMessage();
    return Row(
      children: [
        if (hasGuardianPhone)
          Expanded(
            child: ElevatedButton.icon(
              onPressed: () => _launchWhatsApp(context, message),
              icon: const Icon(Icons.chat_bubble_outline, size: 18),
              label: const Text("WhatsApp Parent"),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF25D366),
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
              ),
            ),
          ),
        if (hasGuardianPhone && hasGuardianEmail) const SizedBox(width: 12),
        if (hasGuardianEmail)
          Expanded(
            child: OutlinedButton.icon(
              onPressed: () => _launchEmail(context, message),
              icon: const Icon(Icons.alternate_email, size: 18),
              label: const Text("Email Parent"),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.primaryBlue,
                side: BorderSide(color: AppColors.primaryBlue.withAlpha(120)),
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
              ),
            ),
          ),
      ],
    );
  }

  String _buildMessage() {
    final studentName = student.fullName;
    final dueText = _dueText();
    final billing = student.billingCycle.trim().isEmpty ? "" : "Billing cycle: ${student.billingCycle}.";
    return "Hello ${student.guardianName ?? 'Parent'}, $studentName owes \$${outstanding.toStringAsFixed(2)}. $dueText $billing";
  }

  String _dueText() {
    if (nextDueDate == null) return "No due date set.";
    final date = nextDueDate!.toIso8601String().split('T')[0];
    final days = nextDueDate!.difference(DateTime.now()).inDays;
    if (days < 0) return "Due date: $date (overdue).";
    if (days == 0) return "Due date: $date (today).";
    if (days <= 7) return "Due date: $date (in $days days).";
    return "Due date: $date.";
  }

  Future<void> _launchWhatsApp(BuildContext context, String message) async {
    final phone = (student.guardianPhone ?? '').replaceAll(RegExp(r'\D'), '');
    final uri = Uri.parse("https://wa.me/$phone?text=${Uri.encodeComponent(message)}");
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      _showLaunchError(context);
    }
  }

  Future<void> _launchEmail(BuildContext context, String message) async {
    final email = (student.guardianEmail ?? '').trim();
    final uri = Uri(
      scheme: 'mailto',
      path: email,
      queryParameters: {
        'subject': 'Payment Reminder: ${student.fullName}',
        'body': message,
      },
    );
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      _showLaunchError(context);
    }
  }

  void _showLaunchError(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text("Could not open messaging app."),
        backgroundColor: AppColors.errorRed,
      ),
    );
  }
}

class _InvoiceTile extends StatelessWidget {
  final Invoice inv;
  const _InvoiceTile({required this.inv});

  @override
  Widget build(BuildContext context) {
    final statusColor = inv.status == InvoiceStatus.paid ? AppColors.successGreen : Colors.orange;
    return InkWell(
      onTap: () => context.push(
        '${AppRoutes.finance}/${AppRoutes.viewInvoice}'.replaceAll(':invoiceId', inv.id),
      ),
      borderRadius: BorderRadius.circular(16),
      child: Container(
        margin: const EdgeInsets.only(bottom: 12),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: const Color(0xFF1E2029),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.orange.withAlpha(20),
                shape: BoxShape.circle,
              ),
              child: const Icon(Icons.description, color: Colors.orange, size: 20),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(inv.title ?? "Invoice", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15)),
                  Text("Due ${inv.dueDate.toIso8601String().split('T')[0]}", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                ],
              ),
            ),
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text("\$${inv.totalAmount.toStringAsFixed(2)}", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15)),
                const SizedBox(height: 4),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                  decoration: BoxDecoration(
                    color: statusColor.withAlpha(30),
                    borderRadius: BorderRadius.circular(4)
                  ),
                  child: Text(inv.status.name.toUpperCase(), style: TextStyle(color: statusColor, fontSize: 10, fontWeight: FontWeight.bold)),
                )
              ],
            )
          ],
        ),
      ),
    );
  }
}

class _PaymentTile extends StatelessWidget {
  final Payment p;
  const _PaymentTile({required this.p});

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1E2029),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withAlpha(20),
              shape: BoxShape.circle,
            ),
            child: const Icon(Icons.credit_card, color: AppColors.primaryBlue, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("Payment  ${p.method}", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15)),
                Text(p.receivedAt.toIso8601String().split('T')[0], style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text("\$${p.amount.toStringAsFixed(2)}", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15)),
              const SizedBox(height: 4),
              const Text("Success", style: TextStyle(color: AppColors.successGreen, fontSize: 10, fontWeight: FontWeight.bold)),
            ],
          )
        ],
      ),
    );
  }
}

// =============================================================================
// Tab: Academic (Integrated Image 3 "Journey" & "Subject List" UI)
// =============================================================================

class _AcademicTab extends StatelessWidget {
  final List<Enrollment> enrollments;
  const _AcademicTab({required this.enrollments});

  @override
  Widget build(BuildContext context) {
    final active = enrollments.where((e) => e.isActive).toList();
    final current = (active.isNotEmpty) ? active.first : (enrollments.isNotEmpty ? enrollments.first : null);
    
    // Calculate Journey Duration
    final start = current?.enrollmentDate ?? current?.createdAt;
    final duration = start == null ? null : DateTime.now().difference(start);
    final years = duration == null ? 0 : (duration.inDays / 365).floor();
    final months = duration == null ? 0 : ((duration.inDays % 365) / 30).floor();
    final timeStr = duration == null ? "Unknown" : (years > 0 ? "$years Yrs, $months Mos" : "$months Mos");

    return Builder(
      builder: (context) {
        return CustomScrollView(
          key: const PageStorageKey("academic"),
          slivers: [
            SliverOverlapInjector(handle: NestedScrollView.sliverOverlapAbsorberHandleFor(context)),
            SliverPadding(
              padding: const EdgeInsets.all(20),
              sliver: SliverList(
                delegate: SliverChildListDelegate([
                  _SectionTitle(title: "STUDENT JOURNEY"),
                  const SizedBox(height: 12),

                  // Journey Card (Image 3 Style)
                  Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1E2029),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text("TIME WITH SCHOOL", style: TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1)),
                            Container(
                              padding: const EdgeInsets.all(8),
                              decoration: BoxDecoration(
                                color: AppColors.primaryBlue.withAlpha(20),
                                shape: BoxShape.circle
                              ),
                              child: const Icon(Icons.school, size: 16, color: AppColors.primaryBlue),
                            )
                          ],
                        ),
                        const SizedBox(height: 4),
                        Text(
                          timeStr,
                          style: const TextStyle(color: Colors.white, fontSize: 28, fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 16),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text("ENROLLED", style: TextStyle(color: AppColors.textGrey, fontSize: 10)),
                                const SizedBox(height: 4),
                                Text(
                                  start != null ? start.toIso8601String().split('T')[0] : "Unknown",
                                  style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold),
                                ),
                              ],
                            ),
                          ],
                        )
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      _SectionTitle(title: "CURRENT SUBJECT ENROLLMENT"),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: AppColors.surfaceLightGrey.withAlpha(20),
                          borderRadius: BorderRadius.circular(4)
                        ),
                        child: Text("Term 1 - ${DateTime.now().year}", style: const TextStyle(color: AppColors.textGrey, fontSize: 10)),
                      )
                    ],
                  ),
                  const SizedBox(height: 12),

                  if (current?.subjects.isEmpty ?? true)
                     const Padding(padding: EdgeInsets.all(20), child: Text("No subjects enrolled.", style: TextStyle(color: AppColors.textGrey)))
                  else
                    ...current!.subjects.map((sub) => _SubjectTile(subject: sub)),

                  const SizedBox(height: 80),
                ]),
              ),
            ),
          ],
        );
      },
    );
  }
}

class _SubjectTile extends StatelessWidget {
  final String subject;
  const _SubjectTile({required this.subject});

  IconData _getIcon(String s) {
    final l = s.toLowerCase();
    if (l.contains("math")) return Icons.calculate;
    if (l.contains("sci") || l.contains("chem") || l.contains("bio") || l.contains("phys")) return Icons.science;
    if (l.contains("lit") || l.contains("eng")) return Icons.menu_book;
    if (l.contains("art") || l.contains("music")) return Icons.music_note;
    if (l.contains("sport") || l.contains("gym")) return Icons.sports_soccer;
    return Icons.book;
  }

  Color _getColor(String s) {
    final l = s.toLowerCase();
    if (l.contains("math")) return Colors.blueAccent;
    if (l.contains("lit")) return Colors.purpleAccent;
    if (l.contains("chem")) return Colors.orangeAccent;
    if (l.contains("sport")) return Colors.greenAccent;
    return AppColors.primaryBlue;
  }

  @override
  Widget build(BuildContext context) {
    final color = _getColor(subject);
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1E2029),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: color.withAlpha(20),
              shape: BoxShape.circle,
            ),
            child: Icon(_getIcon(subject), color: color, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(subject, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14)),
                const Text("Core  Tuition Included", style: TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold)),
              ],
            ),
          ),
          Icon(Icons.check_circle, color: AppColors.surfaceLightGrey.withAlpha(50), size: 18)
        ],
      ),
    );
  }
}

// =============================================================================
// Shared Helpers
// =============================================================================

class _SectionTitle extends StatelessWidget {
  final String title;
  const _SectionTitle({required this.title});

  @override
  Widget build(BuildContext context) {
    return Text(
      title,
      style: const TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2),
    );
  }
}

extension StringExtension on String {
  String capitalize() {
    return "${this[0].toUpperCase()}${substring(1).toLowerCase()}";
  }
}

// ==========================================
// FILE: ./screens/students/add_student_screen.dart
// ==========================================

// lib/screens/students/add_student_screen.dart

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';

import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/repo/student_repo.dart';
import 'package:legend/data/services/auth/auth.dart';
import 'package:legend/data/vmodels/add_student_view_model.dart';

class AddStudentScreen extends StatelessWidget {
  const AddStudentScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final auth = context.read<AuthService>();
    final repo = context.read<StudentRepository>();

    // If no active school, do NOT create a VM with '' (it produces misleading config errors).
    if (auth.activeSchool == null) {
      return const _NoActiveSchoolScreen();
    }

    return ChangeNotifierProvider<AddStudentViewModel>(
      create: (_) => AddStudentViewModel(repo, auth.activeSchool!.id),
      child: const _AddStudentContent(),
    );
  }
}

class _NoActiveSchoolScreen extends StatelessWidget {
  const _NoActiveSchoolScreen();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        title: const Text("NEW ADMISSION", style: TextStyle(color: Colors.white)),
        leading: IconButton(
          icon: const Icon(Icons.close, color: AppColors.textGrey),
          onPressed: () => context.pop(),
        ),
      ),
      body: Center(
        child: Container(
          padding: const EdgeInsets.all(18),
          margin: const EdgeInsets.all(18),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(60)),
          ),
          child: const Text(
            "No active school context was found.\nPlease login again.",
            style: TextStyle(color: Colors.white, height: 1.3),
            textAlign: TextAlign.center,
          ),
        ),
      ),
    );
  }
}

class _AddStudentContent extends StatefulWidget {
  const _AddStudentContent();

  @override
  State<_AddStudentContent> createState() => _AddStudentContentState();
}

class _AddStudentContentState extends State<_AddStudentContent> {
  final _formKey = GlobalKey<FormState>();
  final ScrollController _scrollController = ScrollController();

  Future<void> _handleSubmit(AddStudentViewModel vm) async {
    // 1) Form validators
    if (!_formKey.currentState!.validate()) {
      _showError("Fix the highlighted fields.");
      return;
    }

    // 2) Required: Class + Subjects
    if (vm.selectedGradeName == null || vm.selectedGradeName!.trim().isEmpty) {
      _showError("Assigned Class / Grade is required.");
      return;
    }
    if (vm.selectedSubjects.isEmpty) {
      _showError("Select at least one subject.");
      return;
    }

    // 3) Financial guardrails (critical to prevent silent credit loss)
    final openingDebt = vm.totalDebt;
    final initialPayment = vm.initialPay;

    if (openingDebt <= 0 && initialPayment > 0) {
      _showError("Initial Payment requires an Opening Balance. Set Opening Balance first or keep Initial Payment at 0.");
      return;
    }
    if (initialPayment > openingDebt && openingDebt > 0) {
      _showError("Initial Payment cannot be greater than Opening Balance.");
      return;
    }

    // 4) Submit
    final success = await vm.submit();

    if (!mounted) return;

    if (success) {
      context.pop();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Student admitted. Financial profile created."),
          backgroundColor: AppColors.successGreen,
          behavior: SnackBarBehavior.floating,
        ),
      );
    } else {
      _showError(vm.error ?? "Admission failed.");
    }
  }

  void _showError(String msg) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.error_outline, color: Colors.white, size: 18),
            const SizedBox(width: 10),
            Expanded(child: Text(msg)),
          ],
        ),
        backgroundColor: AppColors.errorRed,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  Future<void> _pickSubjects(BuildContext context, AddStudentViewModel vm, {required bool desktop}) async {
    if (desktop) {
      final res = await showDialog<List<String>>(
        context: context,
        barrierColor: Colors.black.withAlpha(180),
        builder: (_) => _SubjectsDialog(
          allSubjects: vm.availableSubjects,
          alreadySelected: vm.selectedSubjects,
        ),
      );
      if (res != null) vm.updateSubjects(res);
      return;
    }

    final res = await showModalBottomSheet<List<String>>(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (_) => SubjectSelectionModal(
        allSubjects: vm.availableSubjects,
        alreadySelected: vm.selectedSubjects,
      ),
    );

    if (res != null) vm.updateSubjects(res);
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final vm = context.watch<AddStudentViewModel>();

    if (vm.isLoading) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
      );
    }

    if (vm.blockingError != null) {
      return _buildBlockingError(context, vm.blockingError!);
    }

    return LayoutBuilder(
      builder: (context, constraints) {
        final isWide = constraints.maxWidth >= 980;
        final maxBodyWidth = isWide ? 1200.0 : double.infinity;

        final form = Form(
          key: _formKey,
          child: Column(
            children: [
              _IdentitySection(vm: vm, isWide: isWide),
              const SizedBox(height: 16),
              _AcademicSection(vm: vm, isWide: isWide, onPickSubjects: () => _pickSubjects(context, vm, desktop: isWide)),
              const SizedBox(height: 16),
              _GuardianSection(vm: vm, isWide: isWide),
              const SizedBox(height: 16),
              _FinancialSection(vm: vm, isWide: isWide),
              const SizedBox(height: 18),
              if (!isWide) const SizedBox(height: 64), // space for bottom bar
            ],
          ),
        );

        return Scaffold(
          backgroundColor: AppColors.backgroundBlack,
          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            leading: IconButton(
              icon: const Icon(Icons.close, color: AppColors.textGrey),
              onPressed: () => context.pop(),
            ),
            title: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  "NEW ADMISSION",
                  style: TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.bold),
                ),
                Text(
                  vm.currentTermLabel,
                  style: const TextStyle(color: AppColors.primaryBlue, fontSize: 10, fontWeight: FontWeight.w600),
                ),
              ],
            ),
            actions: [
              IconButton(
                onPressed: vm.randomizeData,
                tooltip: "Auto-Fill",
                icon: const Icon(Icons.auto_fix_high, color: Colors.purpleAccent, size: 20),
              ),
              const SizedBox(width: 6),
              if (isWide)
                Padding(
                  padding: const EdgeInsets.only(right: 16.0, left: 8),
                  child: TextButton.icon(
                    onPressed: () => _handleSubmit(vm),
                    style: TextButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                    ),
                    icon: const Icon(Icons.save_alt, size: 16),
                    label: const Text("COMMIT", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                  ),
                ),
            ],
          ),

          // Mobile: sticky action bar
          bottomNavigationBar: isWide
              ? null
              : SafeArea(
                  child: Container(
                    padding: const EdgeInsets.fromLTRB(14, 10, 14, 12),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceDarkGrey,
                      border: Border(top: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(50))),
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          child: _MiniSummaryLine(vm: vm),
                        ),
                        const SizedBox(width: 12),
                        ElevatedButton.icon(
                          onPressed: () => _handleSubmit(vm),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primaryBlue,
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                          ),
                          icon: const Icon(Icons.save_alt, size: 18),
                          label: const Text("Commit", style: TextStyle(fontWeight: FontWeight.bold)),
                        ),
                      ],
                    ),
                  ),
                ),

          body: Center(
            child: ConstrainedBox(
              constraints: BoxConstraints(maxWidth: maxBodyWidth),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: isWide
                    ? Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Expanded(
                            flex: 7,
                            child: Scrollbar(
                              thumbVisibility: true,
                              controller: _scrollController,
                              child: SingleChildScrollView(
                                controller: _scrollController,
                                primary: false,
                                child: form,
                              ),
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            flex: 4,
                            child: _AdmissionSummaryPanel(vm: vm),
                          ),
                        ],
                      )
                    : Scrollbar(
                        thumbVisibility: true,
                        controller: _scrollController,
                        child: SingleChildScrollView(
                          controller: _scrollController,
                          primary: false,
                          child: form,
                        ),
                      ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildBlockingError(BuildContext context, String error) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: AppColors.textGrey),
          onPressed: () => context.pop(),
        ),
      ),
      body: Center(
        child: Container(
          padding: const EdgeInsets.all(24),
          margin: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            border: Border.all(color: AppColors.errorRed),
            borderRadius: BorderRadius.circular(12),
            color: AppColors.errorRed.withAlpha(25),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.block, color: AppColors.errorRed, size: 40),
              const SizedBox(height: 16),
              Text(
                error,
                style: const TextStyle(color: Colors.white, fontSize: 16),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () => context.pop(),
                style: ElevatedButton.styleFrom(backgroundColor: AppColors.surfaceLightGrey),
                child: const Text("Go Back"),
              )
            ],
          ),
        ),
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// SECTIONS
// -----------------------------------------------------------------------------
class _IdentitySection extends StatelessWidget {
  final AddStudentViewModel vm;
  final bool isWide;
  const _IdentitySection({required this.vm, required this.isWide});

  @override
  Widget build(BuildContext context) {
    return _SectionCard(
      title: "LEGAL IDENTITY",
      icon: Icons.badge_outlined,
      subtitle: "Required for enrollment + billing identity.",
      children: [
        _Responsive2Col(
          isWide: isWide,
          left: _CompactTextField(
            controller: vm.firstNameCtrl,
            label: "First Name",
            hint: "e.g. Nyasha",
            validator: (v) => (v == null || v.trim().isEmpty) ? "Required" : null,
            textInputAction: TextInputAction.next,
          ),
          right: _CompactTextField(
            controller: vm.lastNameCtrl,
            label: "Last Name",
            hint: "e.g. Gabriel",
            validator: (v) => (v == null || v.trim().isEmpty) ? "Required" : null,
            textInputAction: TextInputAction.next,
          ),
        ),
        const SizedBox(height: 12),
        _Responsive2Col(
          isWide: isWide,
          left: _CompactDropdown(
            value: vm.selectedGender,
            items: const ['Male', 'Female'],
            label: "Gender",
            hint: "Select gender...",
            onChanged: (v) => vm.selectedGender = v,
          ),
          right: _CompactDropdown(
            value: vm.selectedStudentType,
            items: const ['ACADEMY', 'PRIVATE'],
            label: "Student Type",
            hint: "Select type...",
            onChanged: (v) => vm.selectedStudentType = v,
          ),
        ),
      ],
    );
  }
}

class _AcademicSection extends StatelessWidget {
  final AddStudentViewModel vm;
  final bool isWide;
  final VoidCallback onPickSubjects;

  const _AcademicSection({required this.vm, required this.isWide, required this.onPickSubjects});

  @override
  Widget build(BuildContext context) {
    return _SectionCard(
      title: "ACADEMIC PLACEMENT",
      icon: Icons.school_outlined,
      subtitle: "Class placement and subject enrollment.",
      children: [
        _CompactDropdown(
          value: vm.selectedGradeName,
          items: vm.grades,
          label: "Assigned Class / Grade",
          hint: "Select grade level...",
          onChanged: (v) => vm.selectedGradeName = v,
        ),
        const SizedBox(height: 12),

        // Subjects picker
        InkWell(
          onTap: onPickSubjects,
          borderRadius: BorderRadius.circular(8),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
            decoration: BoxDecoration(
              color: AppColors.backgroundBlack,
              border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(77)),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                const Icon(Icons.menu_book_outlined, size: 16, color: AppColors.textGrey),
                const SizedBox(width: 10),
                Expanded(
                  child: Text(
                    vm.selectedSubjects.isEmpty
                        ? "Select subjects (required)"
                        : "${vm.selectedSubjects.length} subject(s) selected",
                    style: TextStyle(
                      color: vm.selectedSubjects.isEmpty ? AppColors.textGrey : Colors.white,
                      fontSize: 13,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
                const Icon(Icons.arrow_forward_ios, size: 12, color: AppColors.textGrey),
              ],
            ),
          ),
        ),

        if (vm.selectedSubjects.isNotEmpty) ...[
          const SizedBox(height: 10),
          Wrap(
            spacing: 6,
            runSpacing: 6,
            children: vm.selectedSubjects
                .map(
                  (s) => Chip(
                    label: Text(s, style: const TextStyle(fontSize: 11, color: Colors.white)),
                    backgroundColor: AppColors.surfaceLightGrey.withAlpha(40),
                    side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(50)),
                    visualDensity: VisualDensity.compact,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                  ),
                )
                .toList(),
          ),
        ],
      ],
    );
  }
}

class _GuardianSection extends StatelessWidget {
  final AddStudentViewModel vm;
  final bool isWide;
  const _GuardianSection({required this.vm, required this.isWide});

  @override
  Widget build(BuildContext context) {
    return _SectionCard(
      title: "PAYER / GUARDIAN",
      icon: Icons.family_restroom_outlined,
      subtitle: "Receives reminders and settles invoices.",
      children: [
        _CompactTextField(
          controller: vm.guardianNameCtrl,
          label: "Full Name",
          hint: "Payer name",
          icon: Icons.person_outline,
          validator: (v) => (v == null || v.trim().isEmpty) ? "Required" : null,
          textInputAction: TextInputAction.next,
        ),
        const SizedBox(height: 12),
        _Responsive2Col(
          isWide: isWide,
          left: _CompactTextField(
            controller: vm.guardianPhoneCtrl,
            label: "Phone",
            hint: "+263...",
            icon: Icons.phone_outlined,
            inputType: TextInputType.phone,
            validator: (v) => (v == null || v.trim().isEmpty) ? "Required" : null,
            textInputAction: TextInputAction.next,
          ),
          right: _CompactTextField(
            controller: vm.guardianEmailCtrl,
            label: "Email (Optional)",
            hint: "name@email.com",
            icon: Icons.email_outlined,
            inputType: TextInputType.emailAddress,
            textInputAction: TextInputAction.next,
          ),
        ),
      ],
    );
  }
}

class _FinancialSection extends StatelessWidget {
  final AddStudentViewModel vm;
  final bool isWide;
  const _FinancialSection({required this.vm, required this.isWide});

  @override
  Widget build(BuildContext context) {
    final openingDebt = vm.totalDebt;
    final initialPaid = vm.initialPay;
    final netDue = vm.netOutstanding;

    final bool hasDebt = openingDebt > 0;
    final bool invalidDeposit = (openingDebt <= 0 && initialPaid > 0) || (initialPaid > openingDebt && openingDebt > 0);

    return _SectionCard(
      title: "FINANCIAL PROFILE",
      icon: Icons.account_balance_outlined,
      subtitle: "Defines billing cycle and opening balances. Offline-first safe.",
      borderColor: AppColors.primaryBlue.withAlpha(90),
      children: [
        _InfoBanner(
          tone: _BannerTone.info,
          title: "Billing Cycle",
          message: "This sets how the tuition billing engine will generate invoices (later).",
        ),
        const SizedBox(height: 10),

        _CompactDropdown(
          value: vm.selectedBillingCycle,
          items: vm.billingCycles,
          label: "Billing Cycle (Recurring)",
          hint: "How is this student billed?",
          onChanged: (v) => vm.selectedBillingCycle = (v ?? 'TERMLY'),
        ),

        const SizedBox(height: 14),
        const Divider(color: AppColors.surfaceLightGrey, thickness: 0.5),
        const SizedBox(height: 14),

        _InfoBanner(
          tone: _BannerTone.neutral,
          title: "Tuition Amount (Per Period)",
          message: "Used by auto-billing to create tuition invoices for this enrollment.",
        ),
        const SizedBox(height: 10),

        _MoneyField(
          controller: vm.tuitionAmountCtrl,
          label: "Tuition Amount",
          hint: "0.00",
          accent: AppColors.primaryBlue,
          validator: (v) {
            final val = (double.tryParse((v ?? '').trim()) ?? 0.0);
            if (val < 0) return "Cannot be negative";
            return null;
          },
        ),

        const SizedBox(height: 14),
        const Divider(color: AppColors.surfaceLightGrey, thickness: 0.5),
        const SizedBox(height: 14),

        _InfoBanner(
          tone: _BannerTone.neutral,
          title: "Opening Balance (Previous Debt)",
          message: "Only use this if the student is joining with an existing balance brought forward.",
        ),
        const SizedBox(height: 10),

        _Responsive2Col(
          isWide: isWide,
          left: _MoneyField(
            controller: vm.openingBalanceCtrl,
            label: "Opening Balance",
            hint: "0.00",
            accent: hasDebt ? AppColors.errorRed : Colors.white,
            validator: (v) {
              final val = (double.tryParse((v ?? '').trim()) ?? 0.0);
              if (val < 0) return "Cannot be negative";
              return null;
            },
          ),
          right: _CompactTextField(
            controller: vm.debtDescriptionCtrl,
            label: "Description (Recommended)",
            hint: "e.g. Term 1 arrears",
            validator: (_) => null,
            textInputAction: TextInputAction.next,
          ),
        ),

        const SizedBox(height: 14),
        const Divider(color: AppColors.surfaceLightGrey, thickness: 0.5),
        const SizedBox(height: 14),

        _InfoBanner(
          tone: _BannerTone.neutral,
          title: "Initial Payment (Deposit)",
          message: "For now, this only applies to the Opening Balance. No Opening Balance = keep Initial Payment at 0.",
        ),
        const SizedBox(height: 10),

        _Responsive2Col(
          isWide: isWide,
          left: _MoneyField(
            controller: vm.initialPaymentCtrl,
            label: "Initial Payment",
            hint: "0.00",
            accent: AppColors.successGreen,
            validator: (v) {
              final val = (double.tryParse((v ?? '').trim()) ?? 0.0);
              if (val < 0) return "Cannot be negative";
              return null;
            },
          ),
          right: _CompactDropdown(
            value: vm.selectedPaymentMethod,
            items: vm.paymentMethods,
            label: "Payment Method",
            hint: "Select method...",
            onChanged: (v) => vm.selectedPaymentMethod = (v ?? 'Cash'),
          ),
        ),

        if (invalidDeposit) ...[
          const SizedBox(height: 10),
          _InfoBanner(
            tone: _BannerTone.danger,
            title: "Fix Payment Inputs",
            message: openingDebt <= 0
                ? "Initial Payment requires an Opening Balance."
                : "Initial Payment cannot exceed the Opening Balance.",
          ),
        ],

        const SizedBox(height: 14),

        // Summary block
        Container(
          width: double.infinity,
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(10),
            border: Border.all(
              color: invalidDeposit
                  ? AppColors.errorRed.withAlpha(130)
                  : AppColors.surfaceLightGrey.withAlpha(60),
            ),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("FINANCIAL SUMMARY", style: TextStyle(color: AppColors.textGrey, fontSize: 11, fontWeight: FontWeight.bold)),
              const SizedBox(height: 8),
              _kv("Opening Balance", _money(openingDebt), valueColor: openingDebt > 0 ? AppColors.errorRed : Colors.white),
              const SizedBox(height: 6),
              _kv("Initial Payment", _money(initialPaid), valueColor: initialPaid > 0 ? AppColors.successGreen : Colors.white),
              const SizedBox(height: 6),
              const Divider(color: AppColors.surfaceLightGrey, thickness: 0.4),
              const SizedBox(height: 6),
              _kv(
                "Net Carry-Over",
                _money(netDue),
                valueColor: netDue <= 0 ? AppColors.successGreen : AppColors.errorRed,
                bold: true,
              ),
              const SizedBox(height: 6),
              Text(
                netDue <= 0 && openingDebt > 0 ? "Status: Cleared at admission" : "Status: Balance carries forward",
                style: TextStyle(
                  color: netDue <= 0 && openingDebt > 0 ? AppColors.successGreen : AppColors.textGrey,
                  fontSize: 12,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _kv(String k, String v, {Color? valueColor, bool bold = false}) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(k, style: const TextStyle(color: Colors.white, fontSize: 13)),
        Text(
          v,
          style: TextStyle(
            color: valueColor ?? Colors.white,
            fontSize: 13,
            fontWeight: bold ? FontWeight.bold : FontWeight.w700,
          ),
        ),
      ],
    );
  }
}

// -----------------------------------------------------------------------------
// DESKTOP SUMMARY PANEL
// -----------------------------------------------------------------------------
class _AdmissionSummaryPanel extends StatelessWidget {
  final AddStudentViewModel vm;
  const _AdmissionSummaryPanel({required this.vm});

  @override
  Widget build(BuildContext context) {
    final openingDebt = vm.totalDebt;
    final initialPaid = vm.initialPay;

    final bool missingGrade = vm.selectedGradeName == null || vm.selectedGradeName!.trim().isEmpty;
    final bool missingSubjects = vm.selectedSubjects.isEmpty;
    final bool depositInvalid = (openingDebt <= 0 && initialPaid > 0) || (openingDebt > 0 && initialPaid > openingDebt);

    final warnings = <String>[];
    if (missingGrade) warnings.add("Grade not selected");
    if (missingSubjects) warnings.add("No subjects selected");
    if (depositInvalid) {
      warnings.add(openingDebt <= 0 ? "Initial Payment requires Opening Balance" : "Initial Payment exceeds Opening Balance");
    }

    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(60)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("ADMISSION SUMMARY", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, letterSpacing: 0.8)),
          const SizedBox(height: 10),
          _summaryLine("Student", _safe("${vm.firstNameCtrl.text} ${vm.lastNameCtrl.text}".trim(), fallback: "")),
          _summaryLine("Grade", _safe(vm.selectedGradeName, fallback: "")),
          _summaryLine("Subjects", vm.selectedSubjects.isEmpty ? "" : "${vm.selectedSubjects.length} selected"),
          _summaryLine("Billing Cycle", vm.selectedBillingCycle),
          const SizedBox(height: 10),
          const Divider(color: AppColors.surfaceLightGrey, thickness: 0.5),
          const SizedBox(height: 10),
          _summaryLine("Opening Balance", _money(vm.totalDebt)),
          _summaryLine("Initial Payment", _money(vm.initialPay)),
          _summaryLine("Net Carry-Over", _money(vm.netOutstanding)),
          const SizedBox(height: 12),
          if (warnings.isNotEmpty) ...[
            _InfoBanner(
              tone: _BannerTone.danger,
              title: "Blocking Issues",
              message: warnings.join("  "),
            ),
          ] else ...[
            const _InfoBanner(
              tone: _BannerTone.success,
              title: "Ready",
              message: "Fields look consistent for admission.",
            ),
          ],
          const Spacer(),
          Text(
            "Tip: This screen is desktop-safe; it scales for Windows/Linux builds.",
            style: TextStyle(color: AppColors.textGrey.withAlpha(180), fontSize: 11, height: 1.2),
          ),
        ],
      ),
    );
  }

  Widget _summaryLine(String k, String v) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(k, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
          Flexible(
            child: Text(
              v,
              style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.w600),
              textAlign: TextAlign.right,
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  String _safe(String? v, {required String fallback}) {
    final s = (v ?? '').trim();
    return s.isEmpty ? fallback : s;
  }
}

class _MiniSummaryLine extends StatelessWidget {
  final AddStudentViewModel vm;
  const _MiniSummaryLine({required this.vm});

  @override
  Widget build(BuildContext context) {
    final grade = (vm.selectedGradeName ?? '').trim();
    final subjects = vm.selectedSubjects.length;
    return Text(
      "${grade.isEmpty ? "No grade" : grade}  $subjects subject(s)",
      style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.w600),
      overflow: TextOverflow.ellipsis,
    );
  }
}

// -----------------------------------------------------------------------------
// UI HELPERS
// -----------------------------------------------------------------------------
class _SectionCard extends StatelessWidget {
  final String title;
  final String? subtitle;
  final IconData icon;
  final List<Widget> children;
  final Color? borderColor;

  const _SectionCard({
    required this.title,
    required this.icon,
    required this.children,
    this.subtitle,
    this.borderColor,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: borderColor ?? AppColors.surfaceLightGrey.withAlpha(35)),
      ),
      child: Padding(
        padding: const EdgeInsets.fromLTRB(14, 12, 14, 14),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(icon, size: 16, color: AppColors.primaryBlueLight),
                const SizedBox(width: 8),
                Text(
                  title,
                  style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 12, letterSpacing: 1.0),
                ),
              ],
            ),
            if (subtitle != null) ...[
              const SizedBox(height: 6),
              Text(
                subtitle!,
                style: TextStyle(color: AppColors.textGrey.withAlpha(200), fontSize: 12, height: 1.2),
              ),
            ],
            const SizedBox(height: 12),
            ...children,
          ],
        ),
      ),
    );
  }
}

class _Responsive2Col extends StatelessWidget {
  final bool isWide;
  final Widget left;
  final Widget right;

  const _Responsive2Col({required this.isWide, required this.left, required this.right});

  @override
  Widget build(BuildContext context) {
    if (!isWide) {
      return Column(
        children: [
          left,
          const SizedBox(height: 12),
          right,
        ],
      );
    }

    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(child: left),
        const SizedBox(width: 12),
        Expanded(child: right),
      ],
    );
  }
}

class _CompactTextField extends StatelessWidget {
  final TextEditingController controller;
  final String label;
  final String? hint;
  final IconData? icon;
  final TextInputType inputType;
  final String? Function(String?)? validator;
  final TextInputAction? textInputAction;

  const _CompactTextField({
    required this.controller,
    required this.label,
    this.hint,
    this.icon,
    this.inputType = TextInputType.text,
    this.validator,
    this.textInputAction,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
        const SizedBox(height: 6),
        TextFormField(
          controller: controller,
          keyboardType: inputType,
          validator: validator,
          textInputAction: textInputAction,
          style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.w600),
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 13),
            prefixIcon: icon != null ? Icon(icon, size: 16, color: AppColors.textGrey) : null,
            filled: true,
            fillColor: AppColors.backgroundBlack,
            isDense: true,
            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(65)),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: const BorderSide(color: AppColors.primaryBlue),
            ),
            errorBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: const BorderSide(color: AppColors.errorRed),
            ),
          ),
        ),
      ],
    );
  }
}

class _MoneyField extends StatelessWidget {
  final TextEditingController controller;
  final String label;
  final String? hint;
  final Color? accent;
  final String? Function(String?)? validator;

  const _MoneyField({
    required this.controller,
    required this.label,
    this.hint,
    this.accent,
    this.validator,
  });

  @override
  Widget build(BuildContext context) {
    // 2 decimals max
    final formatters = <TextInputFormatter>[
      FilteringTextInputFormatter.allow(RegExp(r'^\d*\.?\d{0,2}$')),
    ];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
        const SizedBox(height: 6),
        TextFormField(
          controller: controller,
          keyboardType: const TextInputType.numberWithOptions(decimal: true),
          inputFormatters: formatters,
          validator: validator,
          style: TextStyle(color: accent ?? Colors.white, fontSize: 13, fontWeight: FontWeight.w700),
          decoration: InputDecoration(
            prefixText: "\$ ",
            prefixStyle: TextStyle(color: AppColors.textGrey.withAlpha(200), fontWeight: FontWeight.w700),
            hintText: hint,
            hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 13),
            filled: true,
            fillColor: AppColors.backgroundBlack,
            isDense: true,
            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(65)),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: const BorderSide(color: AppColors.primaryBlue),
            ),
            errorBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: const BorderSide(color: AppColors.errorRed),
            ),
          ),
        ),
      ],
    );
  }
}

class _CompactDropdown extends StatelessWidget {
  final String? value;
  final List<String> items;
  final String label;
  final String? hint;
  final ValueChanged<String?> onChanged;

  const _CompactDropdown({
    required this.value,
    required this.items,
    required this.label,
    required this.onChanged,
    this.hint,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
        const SizedBox(height: 6),
        DropdownButtonFormField<String>(
          initialValue: (value != null && value!.isNotEmpty) ? value : null,
          hint: Text(hint ?? "Select...", style: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 13)),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
          dropdownColor: AppColors.surfaceDarkGrey,
          icon: const Icon(Icons.arrow_drop_down, color: AppColors.textGrey, size: 22),
          style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.w600),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            isDense: true,
            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(65)),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: const BorderSide(color: AppColors.primaryBlue),
            ),
          ),
        ),
      ],
    );
  }
}

// -----------------------------------------------------------------------------
// BANNERS
// -----------------------------------------------------------------------------
enum _BannerTone { info, neutral, danger, success }

class _InfoBanner extends StatelessWidget {
  final _BannerTone tone;
  final String title;
  final String message;

  const _InfoBanner({
    required this.tone,
    required this.title,
    required this.message,
  });

  @override
  Widget build(BuildContext context) {
    Color border;
    Color bg;
    IconData icon;

    switch (tone) {
      case _BannerTone.info:
        border = AppColors.primaryBlue.withAlpha(90);
        bg = AppColors.primaryBlue.withAlpha(18);
        icon = Icons.info_outline;
        break;
      case _BannerTone.success:
        border = AppColors.successGreen.withAlpha(110);
        bg = AppColors.successGreen.withAlpha(18);
        icon = Icons.check_circle_outline;
        break;
      case _BannerTone.danger:
        border = AppColors.errorRed.withAlpha(120);
        bg = AppColors.errorRed.withAlpha(18);
        icon = Icons.warning_amber_rounded;
        break;
      case _BannerTone.neutral:
        border = AppColors.surfaceLightGrey.withAlpha(80);
        bg = AppColors.surfaceLightGrey.withAlpha(12);
        icon = Icons.tips_and_updates_outlined;
        break;
    }

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(10),
      decoration: BoxDecoration(
        color: bg,
        borderRadius: BorderRadius.circular(10),
        border: Border.all(color: border),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(icon, size: 18, color: Colors.white.withAlpha(220)),
          const SizedBox(width: 10),
          Expanded(
            child: RichText(
              text: TextSpan(
                style: const TextStyle(color: Colors.white, fontSize: 12, height: 1.2),
                children: [
                  TextSpan(text: "$title: ", style: const TextStyle(fontWeight: FontWeight.bold)),
                  TextSpan(text: message),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// SUBJECT PICKER (kept local to avoid dependency conflicts for now)
// -----------------------------------------------------------------------------
class SubjectSelectionModal extends StatefulWidget {
  final List<String> allSubjects;
  final List<String> alreadySelected;

  const SubjectSelectionModal({super.key, required this.allSubjects, required this.alreadySelected});

  @override
  State<SubjectSelectionModal> createState() => _SubjectSelectionModalState();
}

class _SubjectSelectionModalState extends State<SubjectSelectionModal> {
  late List<String> _tempSelected;
  String _searchQuery = "";

  @override
  void initState() {
    super.initState();
    _tempSelected = List.from(widget.alreadySelected);
  }

  @override
  Widget build(BuildContext context) {
    final visibleSubjects = widget.allSubjects
        .where((s) => s.toLowerCase().contains(_searchQuery.toLowerCase()))
        .toList();

    return Container(
      height: MediaQuery.of(context).size.height * 0.85,
      decoration: const BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        children: [
          Padding(
            padding: const EdgeInsets.fromLTRB(16, 14, 16, 10),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text("Select Subjects", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                Row(
                  children: [
                    TextButton(
                      onPressed: () => setState(() => _tempSelected.clear()),
                      child: const Text("CLEAR", style: TextStyle(color: AppColors.textGrey, fontWeight: FontWeight.bold)),
                    ),
                    TextButton(
                      onPressed: () => Navigator.pop(context, _tempSelected),
                      child: const Text("DONE", style: TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold)),
                    ),
                  ],
                ),
              ],
            ),
          ),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0),
            child: TextField(
              style: const TextStyle(color: Colors.white, fontSize: 14),
              decoration: InputDecoration(
                hintText: "Search subjects...",
                hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(140)),
                prefixIcon: const Icon(Icons.search, color: AppColors.textGrey, size: 20),
                filled: true,
                fillColor: AppColors.backgroundBlack,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(10), borderSide: BorderSide.none),
                contentPadding: const EdgeInsets.symmetric(vertical: 0, horizontal: 16),
                isDense: true,
              ),
              onChanged: (val) => setState(() => _searchQuery = val),
            ),
          ),
          const SizedBox(height: 10),
          Expanded(
            child: ListView.builder(
              itemCount: visibleSubjects.length,
              itemBuilder: (context, index) {
                final subject = visibleSubjects[index];
                final isSelected = _tempSelected.contains(subject);

                return CheckboxListTile(
                  title: Text(subject, style: const TextStyle(color: Colors.white, fontSize: 14)),
                  value: isSelected,
                  activeColor: AppColors.primaryBlue,
                  checkColor: Colors.white,
                  dense: true,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16),
                  onChanged: (checked) {
                    setState(() {
                      if (checked == true) {
                        _tempSelected.add(subject);
                      } else {
                        _tempSelected.remove(subject);
                      }
                    });
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

class _SubjectsDialog extends StatelessWidget {
  final List<String> allSubjects;
  final List<String> alreadySelected;

  const _SubjectsDialog({required this.allSubjects, required this.alreadySelected});

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceDarkGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
      child: SizedBox(
        width: 720,
        height: 640,
        child: SubjectSelectionModal(allSubjects: allSubjects, alreadySelected: alreadySelected),
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// SMALL UTILS
// -----------------------------------------------------------------------------
String _money(double v) => "\$${v.toStringAsFixed(2)}";

// ==========================================
// FILE: ./screens/students/students_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/constants/app_strings.dart';
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/vmodels/students_vmodel.dart';
import 'package:legend/screens/students/add_student_screen.dart';
import 'package:legend/screens/students/view_student_screen.dart';
import 'package:provider/provider.dart';

class StudentsScreen extends StatefulWidget {
  const StudentsScreen({super.key});

  @override
  State<StudentsScreen> createState() => _StudentsScreenState();
}

class _StudentsScreenState extends State<StudentsScreen> {
  final TextEditingController _searchCtrl = TextEditingController();
  String _searchQuery = "";

  @override
  void initState() {
    super.initState();
    // Load students on startup
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<StudentListViewModel>().loadStudents();
    });
  }

  @override
  void dispose() {
    _searchCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          Navigator.push(
            context,
            MaterialPageRoute(builder: (_) => const AddStudentScreen()),
          ).then((_) {
            // Refresh list after adding
            context.read<StudentListViewModel>().loadStudents();
          });
        },
        backgroundColor: AppColors.primaryBlue,
        icon: const Icon(Icons.add, color: Colors.white),
        label: const Text("New Student", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
      ),
      body: Consumer<StudentListViewModel>(
        builder: (context, vm, child) {
          if (vm.isLoading) {
            return const Center(child: CircularProgressIndicator());
          }

          if (vm.error != null) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Icon(Icons.error_outline, color: AppColors.errorRed, size: 48),
                  const SizedBox(height: 16),
                  Text(vm.error!, style: const TextStyle(color: AppColors.textGrey)),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: vm.loadStudents,
                    child: const Text("Retry"),
                  )
                ],
              ),
            );
          }

          // Filter Logic
          final filteredStudents = vm.students.where((s) {
            final query = _searchQuery.toLowerCase();
            return s.firstName.toLowerCase().contains(query) ||
                s.lastName.toLowerCase().contains(query) ||
                (s.admissionNumber?.toLowerCase().contains(query) ?? false);
          }).toList();

          return CustomScrollView(
            slivers: [
              // 1. Header & Stats
              SliverToBoxAdapter(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        AppStrings.studentsTitle,
                        style: TextStyle(
                          fontSize: 28,
                          fontWeight: FontWeight.bold,
                          color: AppColors.textWhite,
                        ),
                      ),
                      const SizedBox(height: 16),
                      // THE STATS HEADER (Crash Fixed Here)
                      _buildStatsHeader(vm.students),
                      const SizedBox(height: 16),
                      // Search Bar
                      TextField(
                        controller: _searchCtrl,
                        onChanged: (val) => setState(() => _searchQuery = val),
                        style: const TextStyle(color: Colors.white),
                        decoration: InputDecoration(
                          hintText: "Search students...",
                          hintStyle: TextStyle(color: Colors.white.withAlpha(100)),
                          prefixIcon: const Icon(Icons.search, color: AppColors.primaryBlue),
                          filled: true,
                          fillColor: AppColors.surfaceDarkGrey,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(12),
                            borderSide: BorderSide.none,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),

              // 2. Student List
              if (filteredStudents.isEmpty)
                SliverFillRemaining(
                  child: Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.people_outline, size: 64, color: Colors.white.withAlpha(50)),
                        const SizedBox(height: 16),
                        Text(
                          _searchQuery.isEmpty ? "No students yet." : "No matches found.",
                          style: TextStyle(color: Colors.white.withAlpha(100)),
                        ),
                      ],
                    ),
                  ),
                )
              else
                SliverList(
                  delegate: SliverChildBuilderDelegate(
                    (context, index) {
                      final student = filteredStudents[index];
                      return _StudentListItem(student: student);
                    },
                    childCount: filteredStudents.length,
                  ),
                ),
                
              // Padding for FAB
              const SliverToBoxAdapter(child: SizedBox(height: 80)),
            ],
          );
        },
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // CRASH FIX: SAFE STATS CALCULATION
  // ---------------------------------------------------------------------------
  Widget _buildStatsHeader(List<Student> students) {
    final totalStudents = students.length;
    final totalFeesOwed = students.fold(0.0, (sum, s) => sum + s.feesOwed);
    
    // Assume a mock collected amount for visual balance, or calculate from ledger if available
    // For this screen, we usually just show debt vs total count
    final activeCount = students.where((s) => s.status == StudentStatus.active).length;

    // Safety: If total is 0, percentage is 0. NEVER divide by zero.
    // This was the source of the "Infinity or NaN" crash.
    final debtPerStudent = totalStudents > 0 ? (totalFeesOwed / totalStudents) : 0.0;
    final activePercentage = totalStudents > 0 ? ((activeCount / totalStudents) * 100).toInt() : 0;

    return Row(
      children: [
        Expanded(
          child: _StatCard(
            label: "Total Students",
            value: totalStudents.toString(),
            icon: Icons.people,
            color: AppColors.primaryBlue,
            subtext: "$activePercentage% Active",
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: _StatCard(
            label: "Total Debt",
            value: "\$${totalFeesOwed.toStringAsFixed(0)}",
            icon: Icons.money_off,
            color: AppColors.errorRed,
            subtext: "Avg: \$${debtPerStudent.toStringAsFixed(0)}",
          ),
        ),
      ],
    );
  }
}

class _StatCard extends StatelessWidget {
  final String label;
  final String value;
  final IconData icon;
  final Color color;
  final String subtext;

  const _StatCard({
    required this.label,
    required this.value,
    required this.icon,
    required this.color,
    required this.subtext,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white.withAlpha(20)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Icon(icon, color: color, size: 20),
              Text(
                subtext,
                style: TextStyle(
                  color: color.withAlpha(200),
                  fontSize: 12,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            value,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 24,
              fontWeight: FontWeight.bold,
            ),
          ),
          Text(
            label,
            style: const TextStyle(
              color: AppColors.textGrey,
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }
}

class _StudentListItem extends StatelessWidget {
  final Student student;

  const _StudentListItem({required this.student});

  @override
  Widget build(BuildContext context) {
    final isArrears = student.feesOwed > 0;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 4.0),
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (_) => ViewStudentScreen(studentId: student.id),
            ),
          ).then((_) {
             // Refresh on return
             context.read<StudentListViewModel>().loadStudents();
          });
        },
        borderRadius: BorderRadius.circular(12),
        child: Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border(
              left: BorderSide(
                color: isArrears ? AppColors.errorRed : AppColors.successGreen,
                width: 4,
              ),
            ),
          ),
          child: Row(
            children: [
              CircleAvatar(
                backgroundColor: AppColors.backgroundBlack,
                child: Text(
                  student.firstName[0],
                  style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      student.fullName,
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      "${student.admissionNumber ?? 'No ID'}  ${student.gender ?? '-'}",
                      style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
                    ),
                  ],
                ),
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Text(
                    isArrears ? "-\$${student.feesOwed.toStringAsFixed(0)}" : "Paid",
                    style: TextStyle(
                      color: isArrears ? AppColors.errorRed : AppColors.successGreen,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                    decoration: BoxDecoration(
                      color: Colors.white.withAlpha(20),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      student.status.name.toUpperCase(),
                      style: const TextStyle(color: Colors.white, fontSize: 10),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/students/student_logs_screen.dart
// ==========================================

import 'package:legend/app_libs.dart'; 

class StudentLogsScreen extends StatelessWidget {
  final String studentId;

  const StudentLogsScreen({super.key, required this.studentId});

  @override
  Widget build(BuildContext context) {
    // Inject VM with Repo
    return ChangeNotifierProvider(
      create: (context) => StudentLogsViewModel(
        context.read<StudentRepository>(), 
        studentId
      )..loadLogs(), // Load immediately
      child: const _StudentLogsContent(),
    );
  }
}

class _StudentLogsContent extends StatefulWidget {
  const _StudentLogsContent();

  @override
  State<_StudentLogsContent> createState() => _StudentLogsContentState();
}

class _StudentLogsContentState extends State<_StudentLogsContent> {
  String _filter = AppStrings.strAll; // "All", "Financial", "System"

  // Filter Logic
  List<LogEntry> _getFilteredLogs(List<LogEntry> logs) {
    if (_filter == AppStrings.strAll) return logs;
    if (_filter == AppStrings.logsF) {
      return logs.where((l) => l.type == LogType.financial).toList();
    }
    if (_filter == AppStrings.logsS) {
      return logs.where((l) => l.type == LogType.system).toList();
    }
    if (_filter == AppStrings.logsA) {
      return logs.where((l) => l.type == LogType.alert).toList();
    }
    return logs;
  }

  @override
  Widget build(BuildContext context) {
    final vm = context.watch<StudentLogsViewModel>();
    final filteredLogs = _getFilteredLogs(vm.logs);

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          AppStrings.activityHistory,
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.download_outlined, color: AppColors.primaryBlue),
            tooltip: AppStrings.exportLogs,
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text(AppStrings.actionMessageExporting), backgroundColor: AppColors.surfaceLightGrey),
              );
            },
          ),
        ],
      ),
      body: vm.isLoading
          ? const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue))
          : Column(
              children: [
                // 0. SUMMARY
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceDarkGrey,
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
                    ),
                    child: Row(
                      children: [
                        _summaryItem("To Be Paid", vm.totalDebits, AppColors.errorRed),
                        const SizedBox(width: 12),
                        _summaryItem("Paid", vm.totalCredits, AppColors.successGreen),
                        const SizedBox(width: 12),
                        _summaryItem("Balance", vm.balance, vm.balance > 0 ? AppColors.errorRed : AppColors.successGreen),
                      ],
                    ),
                  ),
                ),

                // 1. FILTER CHIPS
                SingleChildScrollView(
                  scrollDirection: Axis.horizontal,
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  child: Row(
                    children: [
                      _buildFilterChip(AppStrings.strAll),
                      const SizedBox(width: 8),
                      _buildFilterChip(AppStrings.logsF),
                      const SizedBox(width: 8),
                      _buildFilterChip(AppStrings.logsS),
                      const SizedBox(width: 8),
                      _buildFilterChip(AppStrings.logsA),
                    ],
                  ),
                ),

                // 2. TIMELINE LIST
                Expanded(
                  child: filteredLogs.isEmpty
                      ? _buildEmptyState()
                      : ListView.builder(
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                          itemCount: filteredLogs.length,
                          itemBuilder: (context, index) {
                            final log = filteredLogs[index];
                            final isLast = index == filteredLogs.length - 1;
                            return _buildTimelineItem(log, isLast);
                          },
                        ),
                ),
              ],
            ),
    );
  }

  // ===========================================================================
  // WIDGET BUILDERS
  // ===========================================================================

  Widget _buildFilterChip(String label) {
    final isSelected = _filter == label;
    return ChoiceChip(
      label: Text(label),
      selected: isSelected,
      onSelected: (val) => setState(() => _filter = label),
      selectedColor: AppColors.primaryBlue,
      backgroundColor: AppColors.surfaceDarkGrey,
      labelStyle: TextStyle(
        color: isSelected ? Colors.white : AppColors.textGrey,
        fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(20),
        side: BorderSide(color: isSelected ? Colors.transparent : AppColors.surfaceLightGrey.withAlpha(50)),
      ),
    );
  }

  Widget _buildTimelineItem(LogEntry log, bool isLast) {
    Color typeColor;
    IconData typeIcon;

    switch (log.type) {
      case LogType.financial:
        typeColor = AppColors.successGreen;
        typeIcon = Icons.attach_money;
        break;
      case LogType.alert:
        typeColor = AppColors.errorRed;
        typeIcon = Icons.warning_amber_rounded;
        break;
      case LogType.academic:
        typeColor = Colors.orangeAccent;
        typeIcon = Icons.school_outlined;
        break;
      case LogType.system:
        typeColor = AppColors.primaryBlue;
        typeIcon = Icons.settings_outlined;
        break;
    }

    return IntrinsicHeight(
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. DATE COLUMN
          SizedBox(
            width: 50,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  DateFormat("MMM").format(log.timestamp).toUpperCase(),
                  style: const TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold),
                ),
                Text(
                  DateFormat("dd").format(log.timestamp),
                  style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 4),
                Text(
                  DateFormat("HH:mm").format(log.timestamp),
                  style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 10),
                ),
              ],
            ),
          ),

          const SizedBox(width: 12),

          // 2. TIMELINE LINE
          Column(
            children: [
              Container(
                width: 12,
                height: 12,
                decoration: BoxDecoration(
                  color: AppColors.backgroundBlack,
                  shape: BoxShape.circle,
                  border: Border.all(color: typeColor, width: 2),
                ),
                child: Center(
                  child: Container(
                    width: 4,
                    height: 4,
                    decoration: BoxDecoration(color: typeColor, shape: BoxShape.circle),
                  ),
                ),
              ),
              if (!isLast)
                Expanded(
                  child: Container(width: 2, color: AppColors.surfaceLightGrey.withAlpha(30)),
                ),
            ],
          ),

          const SizedBox(width: 16),

          // 3. CONTENT CARD
          Expanded(
            child: Padding(
              padding: const EdgeInsets.only(bottom: 24.0),
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surfaceDarkGrey,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(typeIcon, size: 14, color: typeColor),
                        const SizedBox(width: 6),
                        Expanded(
                          child: Text(
                            log.title,
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14),
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 6),
                    Text(
                      log.description,
                      style: const TextStyle(color: AppColors.textGrey, fontSize: 12, height: 1.4),
                    ),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        const Icon(Icons.person_outline, size: 12, color: AppColors.textGrey),
                        const SizedBox(width: 4),
                        Text(
                          "By: ${log.performedBy}",
                          style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 10),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.history_toggle_off, size: 48, color: AppColors.textGrey),
          SizedBox(height: 16),
          Text(AppStrings.errLogsNotFound, style: TextStyle(color: AppColors.textGrey)),
        ],
      ),
    );
  }

  Widget _summaryItem(String label, double value, Color color) {
    return Expanded(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
          const SizedBox(height: 6),
          Text(
            "\$${value.toStringAsFixed(2)}",
            style: TextStyle(color: color, fontWeight: FontWeight.bold, fontSize: 14),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/auth/login_screen.dart
// ==========================================

import 'package:google_fonts/google_fonts.dart';
import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart'; // Standardized Import

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  // UI State
  bool _isPasswordVisible = false;
  bool _isLoading = false;
  
  // Controllers
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _handleLogin() async {
    // 1. Input Validation
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();

    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Please enter both email and password."),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    // 2. Set Loading State
    setState(() => _isLoading = true);

    try {
      // 3. Call Auth Service (This handles Supabase Login + School Fetch)
      // Note: We use context.read because we are inside a callback
      await context.read<AuthService>().login(email, password);

      // 4. Success -> Navigation is handled automatically by the Router
      // because it listens to AuthService.
    } catch (e) {
      // 5. Error Handling
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(e.toString().replaceAll("Exception: ", "")), // Clean up error msg
            backgroundColor: AppColors.errorRed,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      // 6. Reset Loading State
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _handleSocialLogin(String provider) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text("$provider Login is coming soon!"),
        backgroundColor: AppColors.surfaceLightGrey,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // Screen Height for responsive layout
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: AppColors.primaryBlue, // Top Background Color
      body: Stack(
        children: [
          // -------------------------------------------------------------------
          // 1. HEADER (Gradient & Logo)
          // -------------------------------------------------------------------
          Container(
            height: size.height * 0.4,
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  AppColors.primaryBlueLight, // Lighter Blue top
                  AppColors.primaryBlue,      // Brand Blue bottom
                ],
              ),
            ),
            child: SafeArea(
              child: Column(
                children: [
                  SizedBox(height: size.height * 0.05),
                  Text(
                    "KwaLegend",
                    style: GoogleFonts.dancingScript( 
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
            ),
          ),

          // -------------------------------------------------------------------
          // 2. THE CARD (Curved Body)
          // -------------------------------------------------------------------
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              height: size.height * 0.75, // Occupies bottom 75%
              width: double.infinity,
              decoration: const BoxDecoration(
                color: AppColors.backgroundBlack, // Dark Theme Body
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(40),
                  topRight: Radius.circular(40),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black45,
                    blurRadius: 20,
                    offset: Offset(0, -5),
                  ),
                ],
              ),
              child: SingleChildScrollView(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    // Title
                    const SizedBox(height: 16),
                    Text(
                      "Welcome back",
                      style: GoogleFonts.jetBrainsMono( 
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textWhite,
                      ),
                    ),
                    const SizedBox(height: 40),

                    // ---------------------------------------------------------
                    // INPUT FIELDS
                    // ---------------------------------------------------------
                    _buildTextField(
                      controller: _emailController,
                      label: "Email Address",
                      icon: Icons.email_outlined,
                      inputType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 20),
                    
                    _buildTextField(
                      controller: _passwordController,
                      label: "Password",
                      icon: Icons.lock_outline,
                      isPassword: true,
                      isVisible: _isPasswordVisible,
                      onVisibilityToggle: () {
                        setState(() {
                          _isPasswordVisible = !_isPasswordVisible;
                        });
                      },
                    ),

                    // ---------------------------------------------------------
                    // FORGOT PASSWORD LINK
                    // ---------------------------------------------------------
                    Align(
                      alignment: Alignment.centerRight,
                      child: TextButton(
                        onPressed: _isLoading ? null : () => context.push(AppRoutes.resetPassword),
                        child: const Text(
                          "Forgot Password?",
                          style: TextStyle(
                            color: AppColors.primaryBlueLight,
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                          ),
                        ),
                      ),
                    ),

                    const SizedBox(height: 24),

                    // ---------------------------------------------------------
                    // LOG IN BUTTON (With Loading State)
                    // ---------------------------------------------------------
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _handleLogin,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.surfaceLightGrey, // Dark button on dark bg
                          foregroundColor: Colors.white,
                          elevation: 0,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          disabledBackgroundColor: AppColors.surfaceDarkGrey,
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                height: 24,
                                width: 24,
                                child: CircularProgressIndicator(
                                  color: Colors.white,
                                  strokeWidth: 2,
                                ),
                              )
                            : const Text(
                                "Log in",
                                style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                              ),
                      ),
                    ),

                    const SizedBox(height: 30),

                    // ---------------------------------------------------------
                    // SOCIAL LOGIN (Divider & Icons)
                    // ---------------------------------------------------------
                    const Row(
                      children: [
                        Expanded(child: Divider(color: AppColors.surfaceLightGrey)),
                        Padding(
                          padding: EdgeInsets.symmetric(horizontal: 16),
                          child: Text("OR", style: TextStyle(color: AppColors.textGrey)),
                        ),
                        Expanded(child: Divider(color: AppColors.surfaceLightGrey)),
                      ],
                    ),
                    
                    const SizedBox(height: 30),
                    
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        _SocialIcon(
                          icon: Icons.g_mobiledata, 
                          color: Colors.red,
                          onTap: () => _handleSocialLogin("Google"),
                        ),
                        const SizedBox(width: 20),
                        _SocialIcon(
                          icon: Icons.facebook,
                          color: Colors.blue,
                          onTap: () => _handleSocialLogin("Facebook"),
                        ),
                        const SizedBox(width: 20),
                        _SocialIcon(
                          icon: Icons.apple,
                          color: Colors.white,
                          onTap: () => _handleSocialLogin("Apple"),
                        ),
                      ],
                    ),

                    const SizedBox(height: 40),

                    // ---------------------------------------------------------
                    // CREATE ACCOUNT LINK
                    // ---------------------------------------------------------
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text(
                          "Don't have an Account? ",
                          style: TextStyle(color: AppColors.textGrey),
                        ),
                        GestureDetector(
                          onTap: _isLoading ? null : () => context.push(AppRoutes.signup),
                          child: const Text(
                            "Create Account",
                            style: TextStyle(
                              color: AppColors.primaryBlueLight,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                    
                    // Bottom Spacer
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    bool isVisible = false,
    VoidCallback? onVisibilityToggle,
    TextInputType inputType = TextInputType.text,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey),
          ),
          child: TextField(
            controller: controller,
            obscureText: isPassword && !isVisible,
            keyboardType: inputType,
            style: const TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText: label,
              hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100)),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              prefixIcon: Icon(icon, color: AppColors.textGrey, size: 22), // Added Icon
              suffixIcon: isPassword
                  ? IconButton(
                      icon: Icon(
                        isVisible ? Icons.visibility : Icons.visibility_off,
                        color: AppColors.textGrey,
                      ),
                      onPressed: onVisibilityToggle,
                    )
                  : null,
            ),
          ),
        ),
      ],
    );
  }
}

class _SocialIcon extends StatelessWidget {
  final IconData icon;
  final Color color;
  final VoidCallback onTap;

  const _SocialIcon({
    required this.icon,
    required this.color,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(50),
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          shape: BoxShape.circle,
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Icon(icon, color: color, size: 28),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/auth/sign_up_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart'; // WIRED: Access Repos & Constants

class SignupScreen extends StatefulWidget {
  const SignupScreen({super.key});

  @override
  State<SignupScreen> createState() => _SignupScreenState();
}

class _SignupScreenState extends State<SignupScreen> {
  // UI State
  bool _isPasswordVisible = false;
  bool _isConfirmPasswordVisible = false;
  bool _isLoading = false;
  
  // Controllers
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _schoolNameController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  final TextEditingController _confirmPasswordController = TextEditingController();

  @override
  void dispose() {
    _nameController.dispose();
    _emailController.dispose();
    _schoolNameController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    super.dispose();
  }

  Future<void> _handleSignup() async {
    // 1. Validation
    if (_nameController.text.isEmpty || 
        _emailController.text.isEmpty || 
        _schoolNameController.text.isEmpty || 
        _passwordController.text.isEmpty) {
      _showSnack("All fields are required", isError: true);
      return;
    }

    if (_passwordController.text != _confirmPasswordController.text) {
      _showSnack("Passwords do not match", isError: true);
      return;
    }

    setState(() => _isLoading = true);

    try {
      final authRepo = context.read<AuthRepository>();
      final schoolRepo = context.read<SchoolRepository>();

      // 2. Create Supabase User
      final response = await authRepo.signUp(
        _emailController.text.trim(),
        _passwordController.text,
        _nameController.text.trim(),
      );

      // 3. Logic Fork: Auto-Login vs Email Verification
      // If we have a session, we can create the school immediately.
      if (response.session != null && response.user != null) {
        
        // Create the School Config for this new owner
        await schoolRepo.createSchool(
          ownerId: response.user!.id,
          schoolName: _schoolNameController.text.trim(),
        );

        // Force a session refresh to load this new school into AuthService
        if (mounted) {
           // We simply go to login, which will auto-detect the session or allow clean entry
           // Alternatively, we could manually trigger AuthService.init(), but redirecting to dashboard
           // via the Router's refreshListenable is safer.
           context.go(AppRoutes.dashboard);
        }

      } else {
        // No Session = Email Confirmation Required
        if (mounted) {
          _showSuccessDialog();
        }
      }

    } catch (e) {
      if (mounted) {
        _showSnack(e.toString(), isError: true);
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  void _showSnack(String msg, {bool isError = false}) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg),
        backgroundColor: isError ? AppColors.errorRed : AppColors.successGreen,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  void _showSuccessDialog() {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) => AlertDialog(
        backgroundColor: AppColors.surfaceDarkGrey,
        title: const Text("Account Created", style: TextStyle(color: Colors.white)),
        content: const Text(
          "Please check your email to confirm your account.\n\nOnce verified, you can log in and manage your school.",
          style: TextStyle(color: AppColors.textGrey),
        ),
        actions: [
          TextButton(
            onPressed: () {
              Navigator.pop(ctx);
              context.go(AppRoutes.login);
            },
            child: const Text("Go to Login", style: TextStyle(color: AppColors.primaryBlue)),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: AppColors.primaryBlue,
      body: Stack(
        children: [
          // -------------------------------------------------------------------
          // 1. HEADER
          // -------------------------------------------------------------------
          Container(
            height: size.height * 0.35, 
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [AppColors.primaryBlueLight, AppColors.primaryBlue],
              ),
            ),
            child: SafeArea(
              child: Column(
                children: [
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Align(
                      alignment: Alignment.centerLeft,
                      child: IconButton(
                        icon: const Icon(Icons.arrow_back_ios, color: Colors.white),
                        onPressed: () => context.pop(),
                      ),
                    ),
                  ),
                  Text(
                    "Join the Academy",
                    style: GoogleFonts.dancingScript(
                      fontSize: 36,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    "Create your Legend",
                    style: GoogleFonts.jetBrainsMono(fontSize: 14, color: Colors.white70),
                  ),
                ],
              ),
            ),
          ),

          // -------------------------------------------------------------------
          // 2. THE CARD
          // -------------------------------------------------------------------
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              height: size.height * 0.80, 
              width: double.infinity,
              decoration: const BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(40),
                  topRight: Radius.circular(40),
                ),
                boxShadow: [
                  BoxShadow(color: Colors.black45, blurRadius: 20, offset: Offset(0, -5)),
                ],
              ),
              child: SingleChildScrollView(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    const SizedBox(height: 8),
                    Text(
                      "Register",
                      style: GoogleFonts.jetBrainsMono(
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textWhite,
                      ),
                    ),
                    const SizedBox(height: 32),

                    // FIELDS
                    _buildTextField(
                      controller: _nameController,
                      label: "Full Name",
                      icon: Icons.person_outline,
                    ),
                    const SizedBox(height: 16),
                    
                    _buildTextField(
                      controller: _emailController,
                      label: "Email",
                      icon: Icons.email_outlined,
                      inputType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 16),

                    _buildTextField(
                      controller: _schoolNameController,
                      label: "School Name (e.g. KwaLegend)",
                      icon: Icons.school_outlined,
                    ),
                    const SizedBox(height: 16),

                    _buildTextField(
                      controller: _passwordController,
                      label: "Password",
                      icon: Icons.lock_outline,
                      isPassword: true,
                      isVisible: _isPasswordVisible,
                      onVisibilityToggle: () => setState(() => _isPasswordVisible = !_isPasswordVisible),
                    ),
                    const SizedBox(height: 16),

                    _buildTextField(
                      controller: _confirmPasswordController,
                      label: "Confirm Password",
                      icon: Icons.lock_outline, 
                      isPassword: true,
                      isVisible: _isConfirmPasswordVisible,
                      onVisibilityToggle: () => setState(() => _isConfirmPasswordVisible = !_isConfirmPasswordVisible),
                    ),

                    const SizedBox(height: 40),

                    // BUTTON
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _handleSignup,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.primaryBlue, 
                          foregroundColor: Colors.white,
                          elevation: 4,
                          shadowColor: AppColors.primaryBlue.withAlpha(100),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                        child: _isLoading 
                          ? const CircularProgressIndicator(color: Colors.white)
                          : const Text("Sign Up", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                      ),
                    ),

                    const SizedBox(height: 24),

                    // LOGIN LINK
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text("Already have an Account? ", style: TextStyle(color: AppColors.textGrey)),
                        GestureDetector(
                          onTap: () => context.go(AppRoutes.login),
                          child: const Text("Log in", style: TextStyle(color: AppColors.primaryBlueLight, fontWeight: FontWeight.bold)),
                        ),
                      ],
                    ),
                    
                    const SizedBox(height: 30),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    bool isVisible = false,
    VoidCallback? onVisibilityToggle,
    TextInputType inputType = TextInputType.text,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.w500),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey),
          ),
          child: TextField(
            controller: controller,
            obscureText: isPassword && !isVisible,
            keyboardType: inputType,
            style: const TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText: label,
              hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100)),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              prefixIcon: Icon(icon, color: AppColors.textGrey, size: 22),
              suffixIcon: isPassword
                  ? IconButton(
                      icon: Icon(isVisible ? Icons.visibility : Icons.visibility_off, color: AppColors.textGrey),
                      onPressed: onVisibilityToggle,
                    )
                  : null,
            ),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./screens/auth/forgot_password.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

// -----------------------------------------------------------------------------
// 1. LOCAL STRINGS
// -----------------------------------------------------------------------------


// -----------------------------------------------------------------------------
// 2. SCREEN IMPLEMENTATION
// -----------------------------------------------------------------------------
class ForgotPasswordScreen extends StatefulWidget {
  const ForgotPasswordScreen({super.key});

  @override
  State<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {
  // State
  int _currentStep = 0; // 0 = Request, 1 = Reset
  bool _isLoading = false;
  bool _isObscure1 = true;
  bool _isObscure2 = true;
  bool _isLoggedInUser = false;

  // Controllers
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _codeController = TextEditingController();
  final TextEditingController _passController = TextEditingController();
  final TextEditingController _confirmController = TextEditingController();

  @override
  void dispose() {
    _emailController.dispose();
    _codeController.dispose();
    _passController.dispose();
    _confirmController.dispose();
    super.dispose();
  }

  @override
  void initState() {
    super.initState();
    final user = context.read<AuthRepository>().currentUser;
    if (user?.email != null && user!.email!.trim().isNotEmpty) {
      _isLoggedInUser = true;
      _emailController.text = user.email!;
    }
  }

  void _showSnack(String msg, {bool isError = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg), 
        backgroundColor: isError ? AppColors.errorRed : AppColors.successGreen,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  // --- Logic: Step 1 (Send Code) ---
  Future<void> _handleSendCode() async {
    final email = _emailController.text.trim();
    if (email.isEmpty || !email.contains('@')) {
      _showSnack("Please enter a valid email", isError: true);
      return;
    }

    setState(() => _isLoading = true);
    
    try {
      // WIRED: Trigger Supabase OTP Recovery
      await context.read<AuthRepository>().sendRecoveryOtp(email);

      if (mounted) {
        setState(() {
          _isLoading = false;
          _currentStep = 1; // Move to next step
        });
        _showSnack(AppStrings.msgSent);
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
        _showSnack(e.toString(), isError: true);
      }
    }
  }

  // --- Logic: Step 2 (Reset) ---
  Future<void> _handleReset() async {
    final code = _codeController.text.trim();
    final pass = _passController.text;
    final confirm = _confirmController.text;
    final email = _emailController.text.trim();

    // Validation
    if (code.length != 6) {
       _showSnack(AppStrings.errCode, isError: true);
      return;
    }
    if (pass != confirm) {
       _showSnack(AppStrings.errMatch, isError: true);
      return;
    }
    if (pass.length < 6) {
      _showSnack("Password must be at least 6 characters", isError: true);
      return;
    }

    setState(() => _isLoading = true);

    try {
      final repo = context.read<AuthRepository>();

      // WIRED: 1. Verify OTP (gets temporary session)
      await repo.verifyOtp(email, code, OtpType.recovery);
      
      // WIRED: 2. Update Password (uses that session)
      await repo.updatePassword(pass);

      if (mounted) {
        setState(() => _isLoading = false);
        _showSnack(AppStrings.msgSuccess);
        if (_isLoggedInUser) {
          context.pop();
        } else {
          context.go(AppRoutes.login);
        }
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
        _showSnack(e.toString(), isError: true);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: AppColors.primaryBlue,
      body: Stack(
        children: [
          // -------------------------------------------------------------------
          // 1. HEADER (Gradient & Title)
          // -------------------------------------------------------------------
          Container(
            height: size.height * 0.35,
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [AppColors.primaryBlueLight, AppColors.primaryBlue],
              ),
            ),
            child: SafeArea(
              child: Column(
                children: [
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Align(
                      alignment: Alignment.centerLeft,
                      child: IconButton(
                        icon: const Icon(Icons.arrow_back_ios, color: Colors.white),
                        onPressed: () => context.pop(),
                      ),
                    ),
                  ),
                  const SizedBox(height: 10),
                  // Animated Icon based on Step
                  Icon(
                    _currentStep == 0 ? Icons.mark_email_unread_outlined : Icons.lock_reset,
                    size: 64,
                    color: Colors.white.withAlpha(200),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    "Recovery",
                    style: GoogleFonts.jetBrainsMono(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
            ),
          ),

          // -------------------------------------------------------------------
          // 2. THE CARD (Form Body)
          // -------------------------------------------------------------------
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              height: size.height * 0.75,
              width: double.infinity,
              decoration: const BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(40),
                  topRight: Radius.circular(40),
                ),
                boxShadow: [
                  BoxShadow(color: Colors.black45, blurRadius: 20, offset: Offset(0, -5)),
                ],
              ),
              child: SingleChildScrollView(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    const SizedBox(height: 8),
                    Text(
                      _currentStep == 0 ? AppStrings.headRequest : AppStrings.headReset,
                      textAlign: TextAlign.center,
                      style: GoogleFonts.jetBrainsMono(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textWhite,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      _currentStep == 0 ? AppStrings.subRequest : AppStrings.subReset,
                      textAlign: TextAlign.center,
                      style: const TextStyle(color: AppColors.textGrey, fontSize: 14),
                    ),
                    const SizedBox(height: 40),

                    // ================= STEP 0: EMAIL INPUT =================
                    if (_currentStep == 0) ...[
                      _buildTextField(
                        controller: _emailController,
                        label: "Email Address",
                        icon: Icons.email_outlined,
                        inputType: TextInputType.emailAddress,
                        readOnly: _isLoggedInUser,
                      ),
                      const SizedBox(height: 32),
                      
                      SizedBox(
                        width: double.infinity,
                        height: 56,
                        child: ElevatedButton(
                          onPressed: _isLoading ? null : _handleSendCode,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primaryBlue,
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                            elevation: 4,
                          ),
                          child: _isLoading 
                              ? const CircularProgressIndicator(color: Colors.white)
                              : const Text(AppStrings.btnSend, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        ),
                      ),
                    ],

                    // ================= STEP 1: VERIFY & RESET =================
                    if (_currentStep == 1) ...[
                      // Code Input
                      _buildTextField(
                        controller: _codeController,
                        label: "6-Digit Code",
                        icon: Icons.vpn_key_outlined,
                        inputType: TextInputType.number,
                        isCodeInput: true, // Special styling
                      ),
                      const SizedBox(height: 20),

                      // New Password
                      _buildTextField(
                        controller: _passController,
                        label: "New Password",
                        icon: Icons.lock_outline,
                        isPassword: true,
                        isVisible: !_isObscure1,
                        onVisibilityToggle: () => setState(() => _isObscure1 = !_isObscure1),
                      ),
                      const SizedBox(height: 16),

                      // Confirm Password
                      _buildTextField(
                        controller: _confirmController,
                        label: "Confirm Password",
                        icon: Icons.lock_outline,
                        isPassword: true,
                        isVisible: !_isObscure2,
                        onVisibilityToggle: () => setState(() => _isObscure2 = !_isObscure2),
                      ),

                      const SizedBox(height: 32),

                      SizedBox(
                        width: double.infinity,
                        height: 56,
                        child: ElevatedButton(
                          onPressed: _isLoading ? null : _handleReset,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primaryBlue,
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                            elevation: 4,
                          ),
                          child: _isLoading 
                              ? const CircularProgressIndicator(color: Colors.white)
                              : const Text(AppStrings.btnReset, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        ),
                      ),
                      
                      const SizedBox(height: 16),
                      TextButton(
                        onPressed: _handleSendCode, // Resend logic reuses step 1
                        child: const Text(AppStrings.resendLink, style: TextStyle(color: AppColors.primaryBlueLight)),
                      ),
                    ],

                    const SizedBox(height: 24),
                    
                    // Back to Login Link
                    GestureDetector(
                      onTap: () => context.go(AppRoutes.login),
                      child: const Text(
                        AppStrings.backToLogin,
                        style: TextStyle(
                          color: AppColors.textGrey,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    bool isVisible = false,
    VoidCallback? onVisibilityToggle,
    TextInputType inputType = TextInputType.text,
    bool isCodeInput = false,
    bool readOnly = false,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey),
          ),
          child: TextField(
            controller: controller,
            readOnly: readOnly,
            obscureText: isPassword && !isVisible,
            keyboardType: inputType,
            textAlign: isCodeInput ? TextAlign.center : TextAlign.start,
            style: TextStyle(
              color: Colors.white, 
              fontSize: isCodeInput ? 20 : 16,
              letterSpacing: isCodeInput ? 8.0 : 0,
              fontWeight: isCodeInput ? FontWeight.bold : FontWeight.normal,
            ),
            maxLength: isCodeInput ? 6 : null,
            decoration: InputDecoration(
              hintText: isCodeInput ? "000000" : label,
              hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100), letterSpacing: 0),
              counterText: "", // Hide counter for code input
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              prefixIcon: isCodeInput ? null : Icon(icon, color: AppColors.textGrey, size: 22),
              suffixIcon: isPassword
                  ? IconButton(
                      icon: Icon(
                        isVisible ? Icons.visibility : Icons.visibility_off,
                        color: AppColors.textGrey,
                      ),
                      onPressed: onVisibilityToggle,
                    )
                  : null,
            ),
          ),
        ),
      ],
    );
  }
}

// ==========================================
// FILE: ./screens/widgets/subjects_modal.dart
// ==========================================

import 'package:legend/app_libs.dart';

class SubjectSelectionModal extends StatefulWidget {
  final List<String> allSubjects;
  final List<String> alreadySelected;
  
  const SubjectSelectionModal({
    super.key, 
    required this.allSubjects, 
    required this.alreadySelected
  });

  @override
  State<SubjectSelectionModal> createState() => _SubjectSelectionModalState();
}

class _SubjectSelectionModalState extends State<SubjectSelectionModal> {
  late List<String> _tempSelected;
  String _searchQuery = "";

  @override
  void initState() {
    super.initState();
    // Clone the list so we don't mutate parent state until "SAVE" is clicked
    _tempSelected = List.from(widget.alreadySelected);
  }

  @override
  Widget build(BuildContext context) {
    // Filter logic
    final visibleSubjects = widget.allSubjects.where((s) {
      return s.toLowerCase().contains(_searchQuery.toLowerCase());
    }).toList();

    return Container(
      height: MediaQuery.of(context).size.height * 0.85, // 85% Height
      decoration: const BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        children: [
          // 1. HEADER
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  "Select Subjects", 
                  style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)
                ),
                TextButton(
                  onPressed: () => Navigator.pop(context, _tempSelected), // Return result
                  child: const Text("DONE", style: TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold)),
                )
              ],
            ),
          ),
          
          // 2. SEARCH BAR
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0),
            child: TextField(
              style: const TextStyle(color: Colors.white),
              decoration: InputDecoration(
                hintText: AppStrings.search, // "Search"
                hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100)),
                prefixIcon: const Icon(Icons.search, color: AppColors.textGrey),
                filled: true,
                fillColor: AppColors.backgroundBlack,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                contentPadding: const EdgeInsets.symmetric(vertical: 0, horizontal: 16),
              ),
              onChanged: (val) => setState(() => _searchQuery = val),
            ),
          ),
          const SizedBox(height: 10),

          // 3. LIST
          Expanded(
            child: ListView.builder(
              itemCount: visibleSubjects.length,
              itemBuilder: (context, index) {
                final subject = visibleSubjects[index];
                final isSelected = _tempSelected.contains(subject);

                return CheckboxListTile(
                  title: Text(subject, style: const TextStyle(color: Colors.white)),
                  value: isSelected,
                  activeColor: AppColors.primaryBlue,
                  checkColor: Colors.white,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16),
                  onChanged: (bool? checked) {
                    setState(() {
                      if (checked == true) {
                        _tempSelected.add(subject);
                      } else {
                        _tempSelected.remove(subject);
                      }
                    });
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/settings/settings_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/constants/app_routes.dart';
import 'package:legend/data/constants/app_strings.dart';
import 'package:legend/data/vmodels/settings_vmodel.dart';
import 'package:provider/provider.dart';

// -----------------------------------------------------------------------------
// SCREEN IMPLEMENTATION
// -----------------------------------------------------------------------------
class SettingsScreen extends StatefulWidget {
  const SettingsScreen({super.key});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<SettingsViewModel>().init();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<SettingsViewModel>(
      builder: (context, viewModel, _) {
        // 1. LOADING
        if (viewModel.isLoading) {
          return const Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
          );
        }

        // 2. ERROR
        if (viewModel.error != null) {
          return _buildErrorState(context, viewModel);
        }

        // 3. CONTENT
        return Scaffold(
          backgroundColor: AppColors.backgroundBlack,
          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            centerTitle: true,
            title: const Text(
              AppStrings.pageTitle,
              style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 18),
            ),
          ),
          body: SingleChildScrollView(
            physics: const BouncingScrollPhysics(),
            padding: const EdgeInsets.symmetric(horizontal: 20.0, vertical: 10.0),
            child: Column(
              children: [
                _buildProfileCard(context, viewModel),
                const SizedBox(height: 24),

                _buildSettingsGroup(
                  title: AppStrings.secIdentity,
                  children: [
                    _buildTile(
                      icon: Icons.person_outline,
                      iconColor: Colors.blueAccent,
                      title: AppStrings.itemEditProfile,
                      subtitle: AppStrings.subManageProfile,
                      isLocked: true,
                      onTap: () => _showFutureRelease(context),
                    ),
                    _buildDivider(),
                    _buildTile(
                      icon: Icons.school_outlined,
                      iconColor: Colors.blueAccent,
                      title: AppStrings.itemSchool,
                      subtitle: AppStrings.subSchoolConfig,
                      isLocked: true,
                      onTap: () => _showFutureRelease(context),
                    ),
                  ],
                ),

                const SizedBox(height: 24),

                _buildSettingsGroup(
                  title: AppStrings.secApp,
                  children: [
                    _buildSwitch(
                      icon: Icons.dark_mode_outlined,
                      iconColor: Colors.purpleAccent,
                      title: AppStrings.itemTheme,
                      subtitle: AppStrings.subThemeFixed,
                      value: viewModel.isDarkMode,
                      onChanged: (val) async {
                        await viewModel.toggleDarkMode();
                        if (mounted) setState(() {});
                      },
                    ),
                    _buildDivider(),
                    _buildSwitch(
                      icon: Icons.notifications_active_outlined,
                      iconColor: Colors.orangeAccent,
                      title: AppStrings.itemNotifs,
                      subtitle: AppStrings.subPushAlerts,
                      value: viewModel.pushNotifications,
                      onChanged: (val) async {
                        await viewModel.togglePushNotifications();
                        if (mounted) setState(() {});
                      },
                    ),
                  ],
                ),

                const SizedBox(height: 24),

                _buildSettingsGroup(
                  title: AppStrings.secData,
                  children: [
                    _buildSwitch(
                      icon: Icons.receipt_long_outlined,
                      iconColor: AppColors.successGreen,
                      title: AppStrings.itemAutoBilling,
                      subtitle: AppStrings.subAutoBillingDesc,
                      value: viewModel.autoBillingEnabled,
                      onChanged: (val) async {
                        await viewModel.toggleAutoBilling(val);
                        if (mounted) setState(() {});
                        if (viewModel.autoBillingLocked && mounted) {
                          await _showAutoBillingLockDialog(context, viewModel);
                        } else if (viewModel.autoBillingError != null && mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                                content: Text(viewModel.autoBillingError!),
                                backgroundColor: AppColors.errorRed),
                          );
                        }
                      },
                    ),
                    _buildDivider(),
                    _buildTile(
                      icon: Icons.error_outline,
                      iconColor: AppColors.errorRed,
                      title: AppStrings.itemAutoBillingErrors,
                      subtitle: AppStrings.subAutoBillingErrors,
                      onTap: () => _showAutoBillingErrors(context, viewModel),
                    ),
                    _buildDivider(),
                    _buildSyncTile(viewModel),
                  ],
                ),

                const SizedBox(height: 24),

                _buildSettingsGroup(
                  title: AppStrings.secSupport,
                  children: [
                    _buildTile(
                      icon: Icons.code,
                      iconColor: Colors.cyanAccent,
                      title: AppStrings.itemContactDev,
                      subtitle: AppStrings.subContactDev,
                      onTap: () => context.push('${AppRoutes.settings}/${AppRoutes.contactDev}'),
                    ),
                  ],
                ),

                const SizedBox(height: 40),

                _buildSettingsGroup(
                  title: AppStrings.secDangerZone,
                  children: [
                    _buildTile(
                      icon: Icons.delete_forever,
                      iconColor: AppColors.errorRed,
                      title: AppStrings.itemDeleteAllStudentData,
                      subtitle: AppStrings.subDeleteAllStudentData,
                      onTap: viewModel.isDeletingData
                          ? () {}
                          : () => _confirmDeleteAllData(context, viewModel),
                    ),
                  ],
                ),

                const SizedBox(height: 24),

                _buildLogoutButton(context, viewModel),
                
                const SizedBox(height: 40),
              ],
            ),
          ),
        );
      },
    );
  }

  // ===========================================================================
  // UI COMPONENTS
  // ===========================================================================

  Widget _buildProfileCard(BuildContext context, SettingsViewModel viewModel) {
    final name = (viewModel.userName ?? '').trim();
    final role = (viewModel.userRole ?? '').trim();
    final displayName = name.isEmpty ? AppStrings.unknownUser : name;
    final initials = _getInitials(displayName);

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            AppColors.primaryBlue,
            AppColors.primaryBlue.withAlpha(150),
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: AppColors.primaryBlue.withAlpha(60),
            blurRadius: 20,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            width: 64,
            height: 64,
            decoration: BoxDecoration(
              color: Colors.white,
              shape: BoxShape.circle,
              border: Border.all(color: Colors.white.withAlpha(100), width: 4),
            ),
            child: Center(
              child: Text(
                initials,
                style: const TextStyle(
                  color: AppColors.primaryBlue,
                  fontWeight: FontWeight.bold,
                  fontSize: 24,
                ),
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  displayName,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                  decoration: BoxDecoration(
                    color: Colors.black.withAlpha(30),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Text(
                    role.toUpperCase(),
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                      letterSpacing: 1,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSettingsGroup({required String title, required List<Widget> children}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.only(left: 12, bottom: 8),
          child: Text(
            title.toUpperCase(),
            style: const TextStyle(
              color: AppColors.textGrey,
              fontSize: 12,
              fontWeight: FontWeight.bold,
              letterSpacing: 1.2,
            ),
          ),
        ),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
          ),
          child: Column(children: children),
        ),
      ],
    );
  }

  Widget _buildTile({
    required IconData icon,
    required Color iconColor,
    required String title,
    String? subtitle,
    required VoidCallback onTap,
    bool isLocked = false,
  }) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: isLocked ? null : onTap,
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: iconColor.withAlpha(30),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Icon(icon, color: iconColor, size: 20),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: TextStyle(
                        color: isLocked ? AppColors.textGrey : Colors.white,
                        fontWeight: FontWeight.w600,
                        fontSize: 15,
                      ),
                    ),
                    if (subtitle != null) ...[
                      const SizedBox(height: 2),
                      Text(
                        subtitle,
                        style: TextStyle(
                          color: AppColors.textGrey.withAlpha(150),
                          fontSize: 12,
                        ),
                      ),
                    ],
                  ],
                ),
              ),
              if (isLocked)
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceLightGrey.withAlpha(30),
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: const Text(
                    AppStrings.locked,
                    style: TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold),
                  ),
                )
              else
                const Icon(Icons.chevron_right, color: AppColors.textGrey, size: 18),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSwitch({
    required IconData icon,
    required Color iconColor,
    required String title,
    String? subtitle,
    required bool value,
    required ValueChanged<bool> onChanged,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: iconColor.withAlpha(30),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(icon, color: iconColor, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.w600,
                    fontSize: 15,
                  ),
                ),
                if (subtitle != null) ...[
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: AppColors.textGrey.withAlpha(150),
                      fontSize: 12,
                    ),
                  ),
                ],
              ],
            ),
          ),
          Switch(
            value: value,
            onChanged: onChanged,
            activeColor: AppColors.primaryBlue,
            activeTrackColor: AppColors.primaryBlue.withAlpha(60),
            inactiveThumbColor: AppColors.textGrey,
            inactiveTrackColor: AppColors.backgroundBlack,
          ),
        ],
      ),
    );
  }

  Widget _buildSyncTile(SettingsViewModel viewModel) {
    // Determine Sync UI State
    final status = viewModel.syncStatus;
    Color color = AppColors.textGrey;
    String statusText = AppStrings.syncDisconnected;
    IconData statusIcon = Icons.cloud_off;
    bool isSyncing = false;

    if (status != null) {
      if (status.anyError != null) {
        color = AppColors.errorRed;
        statusText = AppStrings.syncError;
        statusIcon = Icons.error_outline;
      } else if (status.connecting || status.downloading || status.uploading) {
        color = AppColors.primaryBlue;
        statusText = AppStrings.syncSyncing;
        isSyncing = true;
      } else if (status.connected) {
        color = AppColors.successGreen;
        statusText = AppStrings.syncSynchronized;
        statusIcon = Icons.check_circle;
      }
    }

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: color.withAlpha(30),
              borderRadius: BorderRadius.circular(12),
            ),
            child: isSyncing 
              ? SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2, color: color))
              : Icon(Icons.sync, color: color, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  AppStrings.itemSync,
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 15),
                ),
                const SizedBox(height: 2),
                Text(
                  "${AppStrings.syncStatusPrefix}${viewModel.syncStatusLabel}",
                  style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 12),
                ),
              ],
            ),
          ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
            decoration: BoxDecoration(
              color: color.withAlpha(20),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: color.withAlpha(50)),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                if (!isSyncing) Icon(statusIcon, size: 12, color: color),
                if (!isSyncing) const SizedBox(width: 4),
                Text(
                  statusText,
                  style: TextStyle(color: color, fontSize: 11, fontWeight: FontWeight.bold),
                ),
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _buildLogoutButton(BuildContext context, SettingsViewModel viewModel) {
    return GestureDetector(
      onTap: () async {
        try {
          await viewModel.logout();
          if (context.mounted) context.go(AppRoutes.login);
        } catch (e) {
          if (!context.mounted) return;
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(e.toString()), backgroundColor: AppColors.errorRed),
          );
        }
      },
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(vertical: 16),
        decoration: BoxDecoration(
          border: Border.all(color: AppColors.errorRed.withAlpha(100)),
          borderRadius: BorderRadius.circular(16),
          color: AppColors.errorRed.withAlpha(10),
        ),
        child: const Center(
          child: Text(
            AppStrings.itemLogout,
            style: TextStyle(
              color: AppColors.errorRed,
              fontWeight: FontWeight.bold,
              fontSize: 16,
              letterSpacing: 0.5,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDivider() {
    return Divider(
      height: 1,
      thickness: 1,
      color: AppColors.backgroundBlack.withAlpha(100),
      indent: 60, // Align with text, skipping icon
    );
  }

  Widget _buildErrorState(BuildContext context, SettingsViewModel viewModel) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline, color: AppColors.errorRed, size: 48),
            const SizedBox(height: 16),
            Text(viewModel.error!, style: const TextStyle(color: AppColors.textGrey)),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: viewModel.refresh,
              style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
              child: const Text(AppStrings.retry),
            ),
          ],
        ),
      ),
    );
  }

  String _getInitials(String name) {
    final parts = name.trim().split(RegExp(r'\s+'));
    if (parts.isEmpty) return AppStrings.initialsFallback;
    if (parts.length == 1) return parts[0][0].toUpperCase();
    return "${parts[0][0]}${parts[1][0]}".toUpperCase();
  }

  Future<void> _showAutoBillingLockDialog(BuildContext context, SettingsViewModel viewModel) async {
    await showDialog<void>(
      context: context,
      builder: (dialogContext) {
        return AlertDialog(
          backgroundColor: AppColors.surfaceDarkGrey,
          title: const Text(
            AppStrings.autoBillingLockedTitle,
            style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
          ),
          content: const Text(
            AppStrings.autoBillingLockedBody,
            style: TextStyle(color: AppColors.textGrey),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(dialogContext).pop(),
              child: const Text(AppStrings.cancel, style: TextStyle(color: AppColors.textGrey)),
            ),
            TextButton(
              onPressed: () async {
                await viewModel.takeOverAutoBilling();
                if (dialogContext.mounted) Navigator.of(dialogContext).pop();
              },
              child: const Text(AppStrings.autoBillingTakeOver, style: TextStyle(color: AppColors.primaryBlue)),
            ),
          ],
        );
      },
    );
  }

  Future<void> _showAutoBillingErrors(BuildContext context, SettingsViewModel viewModel) async {
    final errors = await viewModel.loadAutoBillingErrors();
    if (!context.mounted) return;

    if (errors.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text(AppStrings.autoBillingNoErrors)),
      );
      return;
    }

    await showDialog<void>(
      context: context,
      builder: (dialogContext) {
        return AlertDialog(
          backgroundColor: AppColors.surfaceDarkGrey,
          title: const Text(
            AppStrings.autoBillingErrorsTitle,
            style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
          ),
          content: SizedBox(
            width: double.maxFinite,
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: errors.map((e) {
                  final ts = (e['ts'] ?? '').toString();
                  final msg = (e['message'] ?? '').toString();
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 12),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(ts, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
                        const SizedBox(height: 4),
                        Text(msg, style: const TextStyle(color: Colors.white, fontSize: 13)),
                      ],
                    ),
                  );
                }).toList(),
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () async {
                await viewModel.clearAutoBillingErrors();
                if (dialogContext.mounted) Navigator.of(dialogContext).pop();
              },
              child: const Text(AppStrings.autoBillingClearLog, style: TextStyle(color: AppColors.errorRed)),
            ),
            TextButton(
              onPressed: () => Navigator.of(dialogContext).pop(),
              child: const Text(AppStrings.close, style: TextStyle(color: AppColors.primaryBlue)),
            ),
          ],
        );
      },
    );
  }

  Future<void> _confirmDeleteAllData(BuildContext context, SettingsViewModel viewModel) async {
    final controller = TextEditingController();

    final confirmed = await showDialog<bool>(
      context: context,
      builder: (dialogContext) {
        return AlertDialog(
          backgroundColor: AppColors.surfaceDarkGrey,
          title: const Text(
            AppStrings.deleteAllDataTitle,
            style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Text(
                AppStrings.deleteAllDataBody,
                style: TextStyle(color: AppColors.textGrey),
              ),
              const SizedBox(height: 16),
              const Text(
                AppStrings.deleteAllDataPrompt,
                style: TextStyle(color: AppColors.textGrey, fontSize: 12),
              ),
              const SizedBox(height: 8),
              TextField(
                controller: controller,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  hintText: AppStrings.deleteAllDataHint,
                  hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(150)),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                    borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(40)),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                    borderSide: const BorderSide(color: AppColors.errorRed),
                  ),
                ),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(dialogContext).pop(false),
              child: const Text(AppStrings.cancel, style: TextStyle(color: AppColors.textGrey)),
            ),
            TextButton(
              onPressed: () {
                final ok = controller.text.trim().toUpperCase() == AppStrings.deleteAllDataHint;
                Navigator.of(dialogContext).pop(ok);
              },
              child: const Text(AppStrings.delete, style: TextStyle(color: AppColors.errorRed)),
            ),
          ],
        );
      },
    );

    if (confirmed != true || !context.mounted) return;

    showDialog<void>(
      context: context,
      barrierDismissible: false,
      builder: (dialogContext) {
        return const AlertDialog(
          backgroundColor: AppColors.surfaceDarkGrey,
          content: SizedBox(
            height: 80,
            child: Center(
              child: CircularProgressIndicator(color: AppColors.errorRed),
            ),
          ),
        );
      },
    );

    try {
      await viewModel.deleteAllStudentData();
      if (!context.mounted) return;
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(AppStrings.deleteAllDataSuccess),
          backgroundColor: AppColors.errorRed,
        ),
      );
    } catch (e) {
      if (!context.mounted) return;
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.toString()), backgroundColor: AppColors.errorRed),
      );
    }
  }

  void _showFutureRelease(BuildContext context) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text("Future release."),
        backgroundColor: AppColors.surfaceLightGrey,
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/settings/tos_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/data/constants/app_constants.dart';

class TosScreen extends StatelessWidget {
  const TosScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          "Protocol & Terms",
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
      ),
      body: ListView(
        padding: const EdgeInsets.all(20),
        children: [
          // Header
          const Text(
            "OPERATIONAL AGREEMENT",
            style: TextStyle(
              color: AppColors.primaryBlue,
              fontSize: 12,
              fontWeight: FontWeight.bold,
              letterSpacing: 2.0,
            ),
          ),
          const SizedBox(height: 8),
          const Text(
            "By deploying KwaLegend, you agree to the following protocols regarding data sovereignty, financial processing, and system integrity.",
            style: TextStyle(color: AppColors.textGrey, height: 1.5),
          ),
          const SizedBox(height: 32),

          // Accordion Sections
          _buildSection(
            context,
            "1. THE LICENSE",
            "You are granted a non-exclusive, non-transferable license to use KwaLegend for internal school management. This system remains the intellectual property of Greyway.Co.",
          ),
          _buildSection(
            context,
            "2. DATA SOVEREIGNTY",
            "Your data is yours. KwaLegend operates on a 'Local-First' architecture (PowerSync). While data is synced to the cloud for backup, the primary source of truth resides on your device. We do not sell student data.",
          ),
          _buildSection(
            context,
            "3. FINANCIAL LIABILITY",
            "KwaLegend is a recording tool, not a bank. We are not liable for discrepancies between the system's ledger and your actual bank account. Always verify physical cash before logging payments.",
          ),
          _buildSection(
            context,
            "4. SYSTEM UPDATES",
            "We practice 'Continuous Deployment'. Features may evolve. Critical updates will be pushed automatically to ensure security compliance.",
          ),
          _buildSection(
            context,
            "5. TERMINATION",
            "Failure to maintain subscription dues will result in the system entering 'Read-Only' mode. Data will be preserved for 90 days post-termination.",
          ),

          const SizedBox(height: 40),
          
          // Footer
          Center(
            child: Text(
              "Last Updated: January 12, 2026",
              style: TextStyle(
                color: AppColors.textGrey.withAlpha(100),
                fontSize: 12,
                fontFamily: 'monospace',
              ),
            ),
          ),
          const SizedBox(height: 40),
        ],
      ),
    );
  }

  Widget _buildSection(BuildContext context, String title, String content) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
        ),
        child: Theme(
          data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
          child: ExpansionTile(
            title: Text(
              title,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 14,
              ),
            ),
            iconColor: AppColors.primaryBlue,
            collapsedIconColor: AppColors.textGrey,
            childrenPadding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
            children: [
              Text(
                content,
                style: const TextStyle(
                  color: AppColors.textGrey,
                  fontSize: 13,
                  height: 1.5,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/settings/splash_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:flutter_svg/flutter_svg.dart';

class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;
  late Animation<double> _scaleAnimation;
  late Animation<double> _slideAnimation;

  @override
  void initState() {
    super.initState();

    // 1. ANIMATION SETUP
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: const Interval(0.0, 0.6, curve: Curves.easeIn)),
    );

    _scaleAnimation = Tween<double>(begin: 0.8, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: const Interval(0.0, 0.6, curve: Curves.easeOutBack)),
    );

    _slideAnimation = Tween<double>(begin: 30.0, end: 0.0).animate(
      CurvedAnimation(parent: _controller, curve: const Interval(0.4, 1.0, curve: Curves.easeOutCubic)),
    );

    // 2. START ANIMATION
    _controller.forward();

    // 3. NAVIGATE AFTER DELAY
    _navigateToNext();
  }

  Future<void> _navigateToNext() async {
    await Future.delayed(const Duration(seconds: 10));
    if (!mounted) return;

    final auth = context.read<AuthService>();
    if (auth.isLoading) {
      // Let the router/auth listener resolve once auth finishes.
      return;
    }

    if (!auth.isAuthenticated) {
      context.go(AppRoutes.login);
      return;
    }

    if (auth.requiresOnlineSetup) {
      context.go(AppRoutes.offlineSetup);
      return;
    }

    context.go(AppRoutes.dashboard);
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Stack(
        children: [
          // 1. AMBIENT BACKGROUND GLOW
          // Creates a subtle "spotlight" effect behind the logo
          Positioned.fill(
            child: Container(
              decoration: BoxDecoration(
                gradient: RadialGradient(
                  center: Alignment.center,
                  radius: 1.0,
                  colors: [
                    const Color(0xFF1A253A), // Matches the Navy Blue in the Crest
                    AppColors.backgroundBlack,
                  ],
                  stops: const [0.0, 0.8],
                ),
              ),
            ),
          ),

          // 2. CENTERED LOGO CONTENT
          Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // ANIMATED LOGO
                ScaleTransition(
                  scale: _scaleAnimation,
                  child: FadeTransition(
                    opacity: _fadeAnimation,
                    child: Container(
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withAlpha(100),
                            blurRadius: 30,
                            offset: const Offset(0, 10),
                          ),
                        ],
                      ),
                      // REPLACE WITH YOUR ASSET PATH
                      child: SvgPicture.asset(
                        'assets/images/trace.svg',
                        height: 180,
                      ),
                    ),
                  ),
                ),
                
                const SizedBox(height: 24),

                // ANIMATED TEXT (Optional if text is not in image)
                AnimatedBuilder(
                  animation: _controller,
                  builder: (context, child) {
                    return Opacity(
                      opacity: _fadeAnimation.value,
                      child: Transform.translate(
                        offset: Offset(0, _slideAnimation.value),
                        child: child,
                      ),
                    );
                  },
                  child: Column(
                    children: [
                      const Text(
                        "KWA LEGEND",
                        style: TextStyle(
                          fontFamily: 'serif', // Matches the classic academic look
                          fontWeight: FontWeight.bold,
                          fontSize: 24,
                          letterSpacing: 4.0,
                          color: Colors.white,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        "EST. 2025",
                        style: TextStyle(
                          color: AppColors.primaryBlue.withAlpha(200),
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                          letterSpacing: 2.0,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // 3. BOTTOM LOADER (Minimalist)
          Positioned(
            bottom: 60,
            left: 0,
            right: 0,
            child: Center(
              child: SizedBox(
                width: 40,
                height: 40,
                child: FadeTransition(
                  opacity: _fadeAnimation,
                  child: const CircularProgressIndicator(
                    color: AppColors.primaryBlue,
                    strokeWidth: 2,
                  ),
                ),
              ),
            ),
          ),
          
          // 4. FOOTER CREDIT
          Positioned(
            bottom: 20,
            left: 0,
            right: 0,
            child: FadeTransition(
              opacity: _fadeAnimation,
              child: const Text(
                "POWERED BY GREYWAY.CO",
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: AppColors.textGrey,
                  fontSize: 9,
                  fontWeight: FontWeight.w600,
                  letterSpacing: 1.0,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/settings/contact_dev_screen.dart
// ==========================================

import 'dart:math' as math;
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/constants/app_strings.dart';
import 'package:url_launcher/url_launcher.dart';

class ContactDevScreen extends StatefulWidget {
  const ContactDevScreen({super.key});

  @override
  State<ContactDevScreen> createState() => _ContactDevScreenState();
}

class _ContactDevScreenState extends State<ContactDevScreen> with TickerProviderStateMixin {
  late AnimationController _pulseController;
  late AnimationController _spinController;
  late AnimationController _gridController;

  @override
  void initState() {
    super.initState();
    // 1. Pulse for the "Heartbeat" effect
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat(reverse: true);

    // 2. Spin for the Reactor Rings
    _spinController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 10),
    )..repeat();

    // 3. Grid Scan Effect
    _gridController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 3),
    )..repeat();
  }

  @override
  void dispose() {
    _pulseController.dispose();
    _spinController.dispose();
    _gridController.dispose();
    super.dispose();
  }

  Future<void> _launch(String url) async {
    final uri = Uri.parse(url);
    if (!await launchUrl(uri)) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text(AppStrings.devUplinkFailed),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black, // True black for OLED contrast
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: Colors.black.withAlpha(150),
              border: Border.all(color: AppColors.primaryBlue.withAlpha(100)),
              shape: BoxShape.circle,
            ),
            child: const Icon(Icons.arrow_back, color: AppColors.primaryBlue, size: 20),
          ),
          onPressed: () => context.pop(),
        ),
      ),
      body: Stack(
        children: [
          // 1. RETRO-GRID BACKGROUND
          Positioned.fill(
            child: AnimatedBuilder(
              animation: _gridController,
              builder: (context, child) {
                return CustomPaint(
                  painter: _CyberGridPainter(
                    scanValue: _gridController.value,
                    color: AppColors.primaryBlue.withAlpha(30),
                  ),
                );
              },
            ),
          ),

          // 2. VIGNETTE OVERLAY (Focus attention on center)
          Positioned.fill(
            child: Container(
              decoration: BoxDecoration(
                gradient: RadialGradient(
                  center: Alignment.center,
                  radius: 1.2,
                  colors: [
                    Colors.transparent,
                    Colors.black.withAlpha(200),
                    Colors.black,
                  ],
                  stops: const [0.2, 0.7, 1.0],
                ),
              ),
            ),
          ),

          // 3. MAIN CONTENT
          Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const SizedBox(height: 40),
                  
                  // --- THE REACTOR CORE ---
                  _ReactorCore(
                    spinCtrl: _spinController,
                    pulseCtrl: _pulseController,
                  ),

                  const SizedBox(height: 48),

                  // --- IDENTITY BLOCK ---
                  ShaderMask(
                    shaderCallback: (bounds) => const LinearGradient(
                      colors: [Colors.white, AppColors.primaryBlue],
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                    ).createShader(bounds),
                    child: const Text(
                      AppStrings.devContactName,
                      style: TextStyle(
                        fontFamily: 'monospace',
                        fontSize: 28,
                        fontWeight: FontWeight.w900,
                        letterSpacing: 2.0,
                        color: Colors.white,
                      ),
                    ),
                  ),
                  
                  const SizedBox(height: 8),
                  
                  // --- STATUS BADGE ---
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withAlpha(20),
                      borderRadius: BorderRadius.circular(4),
                      border: Border.all(color: AppColors.primaryBlue.withAlpha(100), width: 1),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        _BlinkingCursor(color: AppColors.successGreen),
                        const SizedBox(width: 8),
                        const Text(
                          AppStrings.devSystemOnline,
                          style: TextStyle(
                            color: AppColors.successGreen,
                            fontSize: 10,
                            fontWeight: FontWeight.bold,
                            letterSpacing: 2.0,
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),

                  Text(
                    AppStrings.devDirectUplink,
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontFamily: 'monospace',
                      fontSize: 12,
                      height: 1.5,
                      color: AppColors.textGrey.withAlpha(200),
                    ),
                  ),

                  const SizedBox(height: 48),

                  // --- TACTICAL BUTTONS ---
                  _buildTacticalButton(
                    context,
                    label: AppStrings.devWhatsAppUplink,
                    subLabel: AppStrings.devWhatsAppUplinkSub,
                    icon: Icons.chat,
                    color: const Color(0xFF25D366),
                    onTap: () => _launch(AppStrings.devWhatsAppUrl),
                  ),
                  
                  const SizedBox(height: 16),
                  
                  _buildTacticalButton(
                    context,
                    label: AppStrings.devEmailPayload,
                    subLabel: AppStrings.devEmailPayloadSub,
                    icon: Icons.mark_email_read,
                    color: AppColors.primaryBlue,
                    onTap: () => _launch(AppStrings.devEmailUrl),
                  ),

                  const SizedBox(height: 60),

                  // --- FOOTER SIGNATURE ---
                  Opacity(
                    opacity: 0.5,
                    child: Column(
                      children: [
                        const Icon(Icons.fingerprint, color: AppColors.textGrey, size: 32),
                        const SizedBox(height: 8),
                        Text(
                          "${AppStrings.devFingerprintIdPrefix}${AppStrings.devBuildLabel}",
                          style: const TextStyle(
                            color: AppColors.textGrey,
                            fontSize: 10,
                            fontFamily: 'monospace',
                            letterSpacing: 1.5,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildTacticalButton(
    BuildContext context, {
    required String label,
    required String subLabel,
    required IconData icon,
    required Color color,
    required VoidCallback onTap,
  }) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        splashColor: color.withAlpha(50),
        borderRadius: BorderRadius.circular(12),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
          decoration: BoxDecoration(
            color: Colors.black.withAlpha(100),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: color.withAlpha(80), width: 1),
            boxShadow: [
              BoxShadow(
                color: color.withAlpha(10),
                blurRadius: 10,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: color.withAlpha(20),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(icon, color: color, size: 24),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      label,
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontFamily: 'monospace',
                        letterSpacing: 1.5,
                        fontSize: 14,
                        shadows: [
                          Shadow(color: color.withAlpha(150), blurRadius: 8),
                        ],
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      subLabel,
                      style: TextStyle(
                        color: AppColors.textGrey,
                        fontSize: 10,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
              Icon(Icons.chevron_right, color: color.withAlpha(100)),
            ],
          ),
        ),
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// CUSTOM WIDGETS & PAINTERS
// -----------------------------------------------------------------------------

/// The Spinning "Iron Man" Arc Reactor
class _ReactorCore extends StatelessWidget {
  final AnimationController spinCtrl;
  final AnimationController pulseCtrl;

  const _ReactorCore({required this.spinCtrl, required this.pulseCtrl});

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      width: 160,
      height: 160,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // 1. Outer Ring (Slow Spin)
          AnimatedBuilder(
            animation: spinCtrl,
            builder: (_, _) => Transform.rotate(
              angle: spinCtrl.value * 2 * math.pi,
              child: Container(
                width: 160,
                height: 160,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: AppColors.primaryBlue.withAlpha(60),
                    width: 1,
                  ),
                ),
                child: const Align(
                  alignment: Alignment.topCenter,
                  child: Padding(
                    padding: EdgeInsets.all(4.0),
                    child: Icon(Icons.arrow_drop_down, color: AppColors.primaryBlue, size: 16),
                  ),
                ),
              ),
            ),
          ),
          // 2. Middle Ring (Fast Reverse Spin)
          AnimatedBuilder(
            animation: spinCtrl,
            builder: (_, _) => Transform.rotate(
              angle: -spinCtrl.value * 4 * math.pi,
              child: Container(
                width: 120,
                height: 120,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: AppColors.primaryBlue.withAlpha(100),
                    width: 2,
                    style: BorderStyle.solid,
                  ),
                ),
                child: CustomPaint(
                  painter: _TechRingPainter(color: AppColors.primaryBlue),
                ),
              ),
            ),
          ),
          // 3. Inner Core (Pulsing)
          AnimatedBuilder(
            animation: pulseCtrl,
            builder: (_, _) => Container(
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: AppColors.primaryBlue.withAlpha((100 + (100 * pulseCtrl.value)).toInt()),
                boxShadow: [
                  BoxShadow(
                    color: AppColors.primaryBlue.withAlpha(200),
                    blurRadius: 30 * pulseCtrl.value,
                    spreadRadius: 10 * pulseCtrl.value,
                  ),
                ],
              ),
              child: const Center(
                child: Icon(Icons.code, color: Colors.white, size: 30),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/// Draws tech-y notches on the rings
class _TechRingPainter extends CustomPainter {
  final Color color;
  _TechRingPainter({required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    final center = Offset(size.width / 2, size.height / 2);
    final radius = size.width / 2;

    // Draw 3 segments
    for (int i = 0; i < 3; i++) {
      canvas.drawArc(
        Rect.fromCircle(center: center, radius: radius - 5),
        (i * 120) * (math.pi / 180),
        60 * (math.pi / 180),
        false,
        paint,
      );
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}

/// Scifi Grid Background
class _CyberGridPainter extends CustomPainter {
  final double scanValue;
  final Color color;

  _CyberGridPainter({required this.scanValue, required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..strokeWidth = 1;

    final double gridSpacing = 40.0;
    final double offsetY = scanValue * gridSpacing;

    // Draw Horizontal Lines (Moving down)
    for (double y = -gridSpacing + offsetY; y < size.height; y += gridSpacing) {
      // Fade out at edges
      final opacity = (1.0 - (y / size.height)).clamp(0.0, 1.0);
      paint.color = color.withAlpha((opacity * 255).toInt());
      canvas.drawLine(Offset(0, y), Offset(size.width, y), paint);
    }

    // Draw Vertical Lines (Static perspective illusion)
    paint.color = color.withAlpha(100);
    final _ = size.width / 2;
    for (double x = 0; x <= size.width; x += gridSpacing) {
       // Slightly angle lines towards bottom center for 3D effect? 
       // Keeping it simple flat grid for now to avoid motion sickness
       canvas.drawLine(Offset(x, 0), Offset(x, size.height), paint);
    }
  }

  @override
  bool shouldRepaint(covariant _CyberGridPainter oldDelegate) => oldDelegate.scanValue != scanValue;
}

/// Simple blinking cursor for terminal text
class _BlinkingCursor extends StatefulWidget {
  final Color color;
  const _BlinkingCursor({required this.color});

  @override
  State<_BlinkingCursor> createState() => __BlinkingCursorState();
}

class __BlinkingCursorState extends State<_BlinkingCursor> with SingleTickerProviderStateMixin {
  late AnimationController _ctrl;

  @override
  void initState() {
    super.initState();
    _ctrl = AnimationController(vsync: this, duration: const Duration(milliseconds: 500))..repeat(reverse: true);
  }

  @override
  void dispose() {
    _ctrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return FadeTransition(
      opacity: _ctrl,
      child: Container(
        width: 8,
        height: 8,
        decoration: BoxDecoration(
          color: widget.color,
          shape: BoxShape.circle,
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/finance/finance_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/constants/app_routes.dart';
import 'package:legend/data/vmodels/finance_vmodel.dart';
import 'package:provider/provider.dart';

class FinanceScreen extends StatefulWidget {
  const FinanceScreen({super.key});

  @override
  State<FinanceScreen> createState() => _FinanceScreenState();
}

class _FinanceScreenState extends State<FinanceScreen> {
  // UI State for "Placebo" Filters
  int _selectedTimeRangeIndex = 2; // Default to 'Month'
  int _selectedTxTypeIndex = 0; // Default to 'All'
  final List<String> _timeRanges = ["Today", "Week", "Month", "Year"];
  final List<String> _txFilters = ["All", "Income", "Pending", "Expenses"];

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<FinanceViewModel>().init();
    });
  }

  // ---------------------------------------------------------------------------
  // NAVIGATION HANDLERS
  // ---------------------------------------------------------------------------
  void _navToCreateInvoice() => context.push('${AppRoutes.finance}/${AppRoutes.createInvoice}');
  void _navToRecordPayment() => context.push('${AppRoutes.finance}/${AppRoutes.recordPayment}');
  void _navToDashboardOutstanding() => context.go('${AppRoutes.dashboard}/${AppRoutes.outstanding}');
  void _navToDashboardReceived() => context.go('${AppRoutes.dashboard}/${AppRoutes.received}');
  void _navToDashboardActivity() => context.go('${AppRoutes.dashboard}/${AppRoutes.activity}');
  
  void _navToStudentIfPossible(Map<String, dynamic> item) {
    final targetId = item['targetId']?.toString();
    if (targetId != null && targetId.isNotEmpty) {
      context.push('${AppRoutes.students}/view/$targetId');
    }
  }

  // ---------------------------------------------------------------------------
  // UI BUILDER
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    return Consumer<FinanceViewModel>(
      builder: (context, vm, _) {
        if (vm.isLoading) {
          return const Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
          );
        }

        if (vm.error != null) {
          return _buildErrorState(vm);
        }

        return Scaffold(
          backgroundColor: AppColors.backgroundBlack,
          // Hide default AppBar
          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            toolbarHeight: 0,
          ),
          body: RefreshIndicator(
            onRefresh: vm.refresh,
            color: AppColors.primaryBlue,
            backgroundColor: AppColors.surfaceDarkGrey,
            child: SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              padding: const EdgeInsets.only(bottom: 100), // Nav clearance
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // 1. TOP CONTROL BAR (Header + Time Filters)
                  _buildTopControlBar(vm),
                  
                  const SizedBox(height: 20),

                  // 2. MASTER CARD (The "Central" Dashboard feel)
                  _buildMasterFinancialCard(vm),

                  const SizedBox(height: 24),

                  // 3. ACTION COMMAND CENTER (Replacing demotivating buttons)
                  _buildActionCommandCenter(),

                  const SizedBox(height: 32),

                  // 4. ANALYTICS SECTION
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          "Cash Flow Trend",
                          style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 16),
                        _buildTrendChart(vm.monthlyCollections, vm.monthLabels),
                      ],
                    ),
                  ),

                  const SizedBox(height: 32),

                  // 5. OUTSTANDING BALANCES
                  _buildOutstandingSection(vm.outstandingStudents),

                  const SizedBox(height: 32),

                  // 6. LATEST PAYMENTS
                  _buildRecentPaymentsSection(vm.recentPayments),

                  const SizedBox(height: 32),

                  // 7. SMART ACTIVITY FEED
                  _buildSmartActivitySection(vm.recentActivity),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  // ---------------------------------------------------------------------------
  // 1. TOP CONTROL BAR
  // ---------------------------------------------------------------------------
  Widget _buildTopControlBar(FinanceViewModel vm) {
    return Container(
      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),
      child: Column(
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    "Overview",
                    style: TextStyle(
                      color: AppColors.textGrey.withAlpha(150),
                      fontSize: 12,
                      fontWeight: FontWeight.w600,
                      letterSpacing: 1.0,
                    ),
                  ),
                  const SizedBox(height: 4),
                  const Text(
                    "Financial Health",
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              IconButton(
                onPressed: vm.refresh,
                icon: const Icon(Icons.refresh, color: AppColors.primaryBlue),
              ),
            ],
          ),
          const SizedBox(height: 20),
          // Time Range Filter (Placebo UI)
          SizedBox(
            height: 36,
            child: ListView.separated(
              scrollDirection: Axis.horizontal,
              itemCount: _timeRanges.length,
              separatorBuilder: (_, __) => const SizedBox(width: 8),
              itemBuilder: (context, index) {
                final isSelected = _selectedTimeRangeIndex == index;
                return GestureDetector(
                  onTap: () => setState(() => _selectedTimeRangeIndex = index),
                  child: AnimatedContainer(
                    duration: const Duration(milliseconds: 200),
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                    decoration: BoxDecoration(
                      color: isSelected ? AppColors.primaryBlue : AppColors.surfaceDarkGrey,
                      borderRadius: BorderRadius.circular(20),
                      border: isSelected 
                        ? null 
                        : Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                    ),
                    child: Text(
                      _timeRanges[index],
                      style: TextStyle(
                        color: isSelected ? Colors.white : AppColors.textGrey,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // 2. MASTER FINANCIAL CARD
  // ---------------------------------------------------------------------------
  Widget _buildMasterFinancialCard(FinanceViewModel vm) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20),
      width: double.infinity,
      decoration: BoxDecoration(
        // Subtle gradient effect using the theme blue
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            AppColors.surfaceDarkGrey,
            AppColors.backgroundBlack,
          ],
        ),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withAlpha(100),
            blurRadius: 15,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Stack(
        children: [
          // Background Decor (Abstract Circle)
          Positioned(
            right: -20,
            top: -20,
            child: Container(
              width: 150,
              height: 150,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: AppColors.primaryBlue.withAlpha(15),
              ),
            ),
          ),
          
          Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                      decoration: BoxDecoration(
                        color: AppColors.successGreen.withAlpha(30),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Row(
                        children: [
                          const Icon(Icons.arrow_upward, color: AppColors.successGreen, size: 12),
                          const SizedBox(width: 4),
                          Text(
                            "${vm.percentGrowth}%",
                            style: const TextStyle(
                              color: AppColors.successGreen,
                              fontSize: 12,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Icon(Icons.more_horiz, color: AppColors.textGrey),
                  ],
                ),
                const SizedBox(height: 20),
                const Text(
                  "Total Collections",
                  style: TextStyle(color: AppColors.textGrey, fontSize: 13, fontWeight: FontWeight.w500),
                ),
                const SizedBox(height: 8),
                Text(
                  "\$${vm.totalRevenue.toStringAsFixed(2)}",
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 36,
                    fontWeight: FontWeight.bold,
                    letterSpacing: -1.0,
                  ),
                ),
                const SizedBox(height: 24),
                // Footer Stats (Pending)
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.black.withAlpha(50),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: Colors.orangeAccent.withAlpha(20),
                          shape: BoxShape.circle,
                        ),
                        child: const Icon(Icons.priority_high, color: Colors.orangeAccent, size: 16),
                      ),
                      const SizedBox(width: 12),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            "\$${vm.pendingAmount.toStringAsFixed(0)} Pending",
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 13),
                          ),
                          Text(
                            "${vm.unpaidInvoiceCount} unpaid invoices",
                            style: const TextStyle(color: AppColors.textGrey, fontSize: 11),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // 3. ACTION COMMAND CENTER
  // ---------------------------------------------------------------------------
  Widget _buildActionCommandCenter() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Row(
        children: [
          // Primary Action (Solid Blue)
          Expanded(
            flex: 3,
            child: ElevatedButton(
              onPressed: _navToCreateInvoice,
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 16),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                elevation: 0,
              ),
              child: const Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.add, size: 20),
                  SizedBox(width: 8),
                  Text("New Invoice", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                ],
              ),
            ),
          ),
          const SizedBox(width: 12),
          // Secondary Action (Dark Surface)
          Expanded(
            flex: 2,
            child: ElevatedButton(
              onPressed: _navToRecordPayment,
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.surfaceDarkGrey,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 16),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                  side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(20)),
                ),
                elevation: 0,
              ),
              child: const Text("Record Pay", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // 4. CHART (Cleaner Layout)
  // ---------------------------------------------------------------------------
  Widget _buildTrendChart(List<double> values, List<String> labels) {
    if (values.isEmpty) return const SizedBox.shrink();
    
    final maxVal = values.fold(0.0, (p, c) => p > c ? p : c);
    final safeMax = maxVal > 0 ? maxVal : 1.0;

    return Container(
      height: 180,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(24),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.end,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: List.generate(values.length, (index) {
          final val = values[index];
          final pct = (val / safeMax).clamp(0.0, 1.0);
          final label = labels.length > index ? labels[index] : "";
          final isPeak = pct > 0.9;

          return Column(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              if (isPeak)
                Padding(
                  padding: const EdgeInsets.only(bottom: 4),
                  child: Icon(Icons.star, color: AppColors.primaryBlue.withAlpha(150), size: 10),
                ),
              AnimatedContainer(
                duration: const Duration(milliseconds: 600),
                curve: Curves.easeOutBack,
                width: 32,
                height: 100 * pct + 10,
                decoration: BoxDecoration(
                  color: isPeak ? AppColors.primaryBlue : AppColors.surfaceLightGrey.withAlpha(20),
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              const SizedBox(height: 12),
              Text(
                label,
                style: TextStyle(
                  color: isPeak ? Colors.white : AppColors.textGrey,
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          );
        }),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // 5. SMART ACTIVITY SECTION
  // ---------------------------------------------------------------------------
  Widget _buildSmartActivitySection(List<Map<String, dynamic>> rawActivities) {
    return Column(
      children: [
        // Section Header with Filter Tabs
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20),
          child: Column(
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Text(
                    "Transactions",
                    style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                  ),
                  TextButton(
                    onPressed: _navToDashboardActivity,
                    child: const Text("View All", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12)),
                  ),
                ],
              ),
              Align(
                alignment: Alignment.centerRight,
                child: Container(
                  height: 28,
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: List.generate(_txFilters.length, (index) {
                      final isSelected = _selectedTxTypeIndex == index;
                      if (index > 2) return const SizedBox.shrink(); // Limit to first 3 for space
                      return GestureDetector(
                        onTap: () => setState(() => _selectedTxTypeIndex = index),
                        child: Container(
                          padding: const EdgeInsets.symmetric(horizontal: 12),
                          alignment: Alignment.center,
                          decoration: BoxDecoration(
                            color: isSelected ? AppColors.surfaceLightGrey.withAlpha(50) : null,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Text(
                            _txFilters[index],
                            style: TextStyle(
                              color: isSelected ? Colors.white : AppColors.textGrey,
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      );
                    }),
                  ),
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 16),
        
        // The List
        if (rawActivities.isEmpty) 
          const Padding(
            padding: EdgeInsets.all(20),
            child: Text("No data available", style: TextStyle(color: AppColors.textGrey)),
          )
        else
          ListView.builder(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            padding: const EdgeInsets.symmetric(horizontal: 20),
            itemCount: rawActivities.length,
            itemBuilder: (context, index) {
              final item = _sanitizeActivity(rawActivities[index]);
              final isIncome = item['kind'] == _ActivityKind.income;
              
              // Placebo Filtering Logic (Visual only)
              if (_selectedTxTypeIndex == 1 && !isIncome) return const SizedBox.shrink(); // Show Income Only
              if (_selectedTxTypeIndex == 2 && isIncome) return const SizedBox.shrink(); // Show Expense/Pending Only

              return Container(
                margin: const EdgeInsets.only(bottom: 12),
                child: InkWell(
                  onTap: () => _navToStudentIfPossible(item),
                  borderRadius: BorderRadius.circular(16),
                  child: Row(
                    children: [
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: AppColors.surfaceDarkGrey,
                          shape: BoxShape.circle,
                          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                        ),
                        child: Icon(
                          isIncome ? Icons.arrow_downward : Icons.arrow_upward,
                          color: isIncome ? AppColors.successGreen : Colors.white,
                          size: 18,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              item['name'],
                              style: const TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.bold),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              item['desc'],
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                              style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
                            ),
                          ],
                        ),
                      ),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          Text(
                            "${isIncome ? '+' : '-'}\$${item['amount'].toStringAsFixed(0)}",
                            style: TextStyle(
                              color: isIncome ? AppColors.successGreen : Colors.white,
                              fontSize: 14,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            item['time'],
                            style: TextStyle(color: AppColors.textGrey.withAlpha(100), fontSize: 10),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              );
            },
          ),
      ],
    );
  }

  // ---------------------------------------------------------------------------
  // HELPERS (Error State & Logic)
  // ---------------------------------------------------------------------------

  Widget _buildErrorState(FinanceViewModel vm) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline, color: AppColors.errorRed, size: 48),
            const SizedBox(height: 16),
            Text(vm.error!, style: const TextStyle(color: AppColors.textGrey)),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: vm.refresh,
              style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
              child: const Text("Retry"),
            ),
          ],
        ),
      ),
    );
  }

  Map<String, dynamic> _sanitizeActivity(Map<String, dynamic> raw) {
    final name = (raw['name'] ?? 'Unknown').toString().trim();
    final desc = (raw['desc'] ?? raw['description'] ?? 'No description').toString().trim();
    final amountNum = raw['amount'];
    final amount = (amountNum is num) ? amountNum.toDouble() : 0.0;
    final time = (raw['time'] ?? '').toString().trim();
    final type = (raw['type'] ?? '').toString().toLowerCase().trim();
    final targetId = raw['targetId'] ?? raw['studentId'] ?? raw['student_id'];

    final kind = (type.contains('payment'))
        ? _ActivityKind.income
        : (type.contains('invoice') || type.contains('debit') || type.contains('expense'))
            ? _ActivityKind.expense
            : (amount >= 0 ? _ActivityKind.income : _ActivityKind.expense);

    return {
      'name': name,
      'desc': desc,
      'amount': amount.abs(),
      'time': time.isEmpty ? '' : time,
      'kind': kind,
      'targetId': targetId?.toString(),
    };
  }

  // ---------------------------------------------------------------------------
  // 6. OUTSTANDING SECTION
  // ---------------------------------------------------------------------------
  Widget _buildOutstandingSection(List<Map<String, dynamic>> rows) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                "Outstanding Balances",
                style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
              ),
              TextButton(
                onPressed: _navToDashboardOutstanding,
                child: const Text("View All", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12)),
              ),
            ],
          ),
          const SizedBox(height: 12),
          if (rows.isEmpty)
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: AppColors.surfaceDarkGrey,
                borderRadius: BorderRadius.circular(16),
              ),
              child: const Text("No outstanding balances.", style: TextStyle(color: AppColors.textGrey)),
            )
          else
            Column(
              children: rows.map((row) {
                final amount = (row['amount'] as num?)?.toDouble() ?? 0.0;
                final name = (row['name'] ?? 'Unknown').toString();
                final grade = (row['grade'] ?? '').toString();
                final studentId = (row['id'] ?? '').toString();

                return Container(
                  margin: const EdgeInsets.only(bottom: 12),
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                  ),
                  child: Row(
                    children: [
                      CircleAvatar(
                        backgroundColor: AppColors.errorRed.withAlpha(20),
                        child: Text(
                          name.isNotEmpty ? name[0].toUpperCase() : "?",
                          style: const TextStyle(color: Colors.white),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                            const SizedBox(height: 4),
                            Text("Grade $grade", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                          ],
                        ),
                      ),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          Text(
                            "\$${amount.toStringAsFixed(0)}",
                            style: const TextStyle(color: AppColors.errorRed, fontWeight: FontWeight.bold),
                          ),
                          const SizedBox(height: 6),
                          TextButton(
                            onPressed: studentId.isEmpty
                                ? null
                                : () => context.push(
                                      '${AppRoutes.finance}/${AppRoutes.recordPayment}?studentId=$studentId',
                                    ),
                            child: const Text("Log Payment", style: TextStyle(color: AppColors.primaryBlue, fontSize: 11)),
                          ),
                        ],
                      ),
                    ],
                  ),
                );
              }).toList(),
            ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // 7. RECENT PAYMENTS
  // ---------------------------------------------------------------------------
  Widget _buildRecentPaymentsSection(List<Map<String, dynamic>> rows) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                "Latest Payments",
                style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
              ),
              TextButton(
                onPressed: _navToDashboardReceived,
                child: const Text("View All", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12)),
              ),
            ],
          ),
          const SizedBox(height: 12),
          if (rows.isEmpty)
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: AppColors.surfaceDarkGrey,
                borderRadius: BorderRadius.circular(16),
              ),
              child: const Text("No recent payments.", style: TextStyle(color: AppColors.textGrey)),
            )
          else
            Column(
              children: rows.map((row) {
                final amount = (row['amount'] as num?)?.toDouble() ?? 0.0;
                final name = (row['name'] ?? 'Unknown').toString();
                final method = (row['method'] ?? '').toString();
                final time = (row['time'] ?? '').toString();
                final studentId = (row['studentId'] ?? '').toString();

                return Container(
                  margin: const EdgeInsets.only(bottom: 12),
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                  ),
                  child: InkWell(
                    onTap: studentId.isEmpty ? null : () => context.push('${AppRoutes.students}/view/$studentId'),
                    child: Row(
                      children: [
                        CircleAvatar(
                          backgroundColor: AppColors.successGreen.withAlpha(20),
                          child: const Icon(Icons.arrow_downward, color: AppColors.successGreen, size: 16),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                              const SizedBox(height: 4),
                              Text(method, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                            ],
                          ),
                        ),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          children: [
                            Text(
                              "+\$${amount.toStringAsFixed(0)}",
                              style: const TextStyle(color: AppColors.successGreen, fontWeight: FontWeight.bold),
                            ),
                            const SizedBox(height: 4),
                            Text(time, style: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 10)),
                          ],
                        ),
                      ],
                    ),
                  ),
                );
              }).toList(),
            ),
        ],
      ),
    );
  }
}

enum _ActivityKind { income, expense }

// ==========================================
// FILE: ./screens/finance/logging_payments.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/screens/finance/printing_receipt_screen.dart';
import 'package:legend/data/vmodels/logging_payments_view_model.dart';

class LoggingPaymentsScreen extends StatelessWidget {
  final String studentId;

  const LoggingPaymentsScreen({super.key, required this.studentId});

  @override
  Widget build(BuildContext context) {
    final sid = studentId.trim();
    if (sid.isEmpty) {
      return Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        appBar: AppBar(
          backgroundColor: AppColors.backgroundBlack,
          elevation: 0,
          title: const Text("Error"),
          leading: IconButton(
            icon: const Icon(Icons.close, color: Colors.white),
            onPressed: () => context.pop(),
          ),
        ),
        body: const Center(
          child: Text(
            "Student ID missing. Please go back.",
            style: TextStyle(color: Colors.white70),
          ),
        ),
      );
    }

    final financeRepo = context.read<FinanceRepository>();
    final studentRepo = context.read<StudentRepository>();
    final auth = context.read<AuthService>();

    return ChangeNotifierProvider(
      create: (_) => LoggingPaymentsViewModel(financeRepo, studentRepo, auth, sid)..init(),
      child: const _LoggingPaymentsForm(),
    );
  }
}

class _LoggingPaymentsForm extends StatefulWidget {
  const _LoggingPaymentsForm();

  @override
  State<_LoggingPaymentsForm> createState() => _LoggingPaymentsFormState();
}

class _LoggingPaymentsFormState extends State<_LoggingPaymentsForm> {
  final _formKey = GlobalKey<FormState>();
  final _amountCtrl = TextEditingController();
  final _refCtrl = TextEditingController();

  @override
  void dispose() {
    _amountCtrl.dispose();
    _refCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final vm = context.watch<LoggingPaymentsViewModel>();

    final surface = AppColors.surfaceDarkGrey;
    final border = AppColors.surfaceLightGrey.withAlpha(40);

    final standardBoxDecoration = BoxDecoration(
      color: surface,
      borderRadius: BorderRadius.circular(12),
      border: Border.all(color: border, width: 1),
    );

    final fadedBoxDeco = BoxDecoration(
      color: Colors.blueGrey.withOpacity(0.15),
      borderRadius: BorderRadius.circular(12),
      border: Border.all(color: border, width: 1),
    );

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          onPressed: () => context.pop(),
          icon: const Icon(Icons.receipt_long_rounded, color: Colors.white),
        ),
        title: const Text("Make Payment", style: TextStyle(fontWeight: FontWeight.bold)),
        centerTitle: true,
        actions: [
          Container(
            margin: const EdgeInsets.fromLTRB(0, 0, 8, 0),
            child: IconButton(
              onPressed: () => context.pop(),
              icon: const Icon(Icons.close_rounded, color: Colors.white),
            ),
          ),
        ],
        bottom: PreferredSize(
          preferredSize: const Size.fromHeight(1),
          child: Divider(height: 1, color: AppColors.surfaceLightGrey.withAlpha(40)),
        ),
      ),
      body: Form(
        key: _formKey,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            if (vm.error != null)
              Container(
                margin: const EdgeInsets.fromLTRB(16, 16, 16, 0),
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: AppColors.errorRed.withAlpha(30),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.errorRed.withAlpha(60)),
                ),
                child: Text(
                  vm.error!,
                  style: const TextStyle(color: Colors.white70, fontSize: 12, height: 1.2),
                ),
              ),
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    _sectionTitle("Total Cash Received"),
                    const SizedBox(height: 10),

                    // AMOUNT INPUT
                    TextFormField(
                      controller: _amountCtrl,
                      keyboardType: const TextInputType.numberWithOptions(decimal: true),
                      style: const TextStyle(color: Colors.white),
                      validator: _validateMoney,
                      autovalidateMode: AutovalidateMode.onUserInteraction,
                      onChanged: (val) => vm.updateAmount(double.tryParse(val) ?? 0.0),
                      decoration: InputDecoration(
                        hintText: "Enter amount (e.g. 150)",
                        hintStyle: TextStyle(color: Colors.grey.shade400, fontSize: 14),
                        prefixIcon: Icon(Icons.attach_money, color: Colors.grey.shade400, size: 20),
                        filled: true,
                        fillColor: surface,
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: border),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: AppColors.primaryBlue.withAlpha(200)),
                        ),
                        errorBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: AppColors.errorRed.withAlpha(200)),
                        ),
                        focusedErrorBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: AppColors.errorRed.withAlpha(200)),
                        ),
                      ),
                    ),

                    const SizedBox(height: 16),

                    // QUICK CHIPS
                    Wrap(
                      spacing: 8,
                      runSpacing: 8,
                      children: [
                        _chip(vm, "Full Debt", vm.totalOutstandingDebt),
                        _chip(vm, "50%", vm.totalOutstandingDebt / 2),
                        _chip(vm, "\$100", 100),
                      ],
                    ),

                    const SizedBox(height: 24),

                    // SUMMARY
                    Container(
                      decoration: fadedBoxDeco,
                      padding: const EdgeInsets.all(16),
                      child: Column(
                        children: [
                          _summaryRow(
                            "Total Outstanding Debt:",
                            "\$ ${vm.totalOutstandingDebt.toStringAsFixed(2)}",
                            valueColor: AppColors.errorRed,
                          ),
                          const SizedBox(height: 8),
                          Divider(color: Colors.grey.shade800),
                          const SizedBox(height: 8),
                          _summaryRow(
                            "Amount Entered:",
                            "\$ ${vm.amount.toStringAsFixed(2)}",
                          ),
                          const SizedBox(height: 8),
                          if (vm.remainingCreditAfterDebt > 0)
                            _summaryRow(
                              "Surplus (Future Credit):",
                              "\$ ${vm.remainingCreditAfterDebt.toStringAsFixed(2)}",
                              valueColor: AppColors.successGreen,
                              isBold: true,
                            ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 24),

                    // UNPAID LIST
                    _sectionTitle("Bills to be Paid First"),
                    const SizedBox(height: 10),

                    Container(
                      decoration: standardBoxDecoration,
                      child: vm.isLoading
                          ? const Padding(
                              padding: EdgeInsets.all(20),
                              child: Center(child: CircularProgressIndicator()),
                            )
                          : vm.unpaidInvoices.isEmpty
                              ? const Padding(
                                  padding: EdgeInsets.all(20),
                                  child: Text(
                                    "No outstanding bills.",
                                    style: TextStyle(color: Colors.grey),
                                  ),
                                )
                              : ListView.separated(
                                  shrinkWrap: true,
                                  physics: const NeverScrollableScrollPhysics(),
                                  itemCount: vm.unpaidInvoices.length,
                                  separatorBuilder: (_, __) => Divider(height: 1, color: border),
                                  itemBuilder: (context, index) {
                                    final inv = vm.unpaidInvoices[index];
                                    final due = inv.dueDate;
                                    final isNextUp = index == 0;
                                    final outstanding = vm.outstandingOf(inv);

                                    return ListTile(
                                      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),
                                      leading: Icon(
                                        Icons.priority_high_rounded,
                                        size: 18,
                                        color: isNextUp ? Colors.orangeAccent : Colors.transparent,
                                      ),
                                      title: Text(
                                        DateFormat('MMMM yyyy').format(DateTime(due.year, due.month)),
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontWeight: isNextUp ? FontWeight.bold : FontWeight.normal,
                                          fontSize: 14,
                                        ),
                                      ),
                                      subtitle: Text(
                                        vm.getStatusLabel(inv),
                                        style: TextStyle(color: Colors.grey.shade400, fontSize: 12),
                                      ),
                                      trailing: Text(
                                        "\$${outstanding.toStringAsFixed(2)}",
                                        style: TextStyle(
                                          color: isNextUp ? AppColors.errorRed : Colors.grey,
                                          fontWeight: FontWeight.bold,
                                          fontSize: 16,
                                        ),
                                      ),
                                    );
                                  },
                                ),
                    ),

                    const SizedBox(height: 24),

                    // PAYMENT META
                    _sectionTitle("Payment Details"),
                    const SizedBox(height: 10),

                    Row(
                      children: [
                        Expanded(
                          child: _dropdown(
                            label: "Method",
                            value: vm.method,
                            items: const ["Cash", "EcoCash", "Bank Transfer", "Swipe"],
                            onChanged: (v) => vm.setMethod(v ?? "Cash"),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: _textField(
                            label: "Reference / Ref No.",
                            controller: _refCtrl,
                            onChanged: vm.setReference,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),

            // FOOTER
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: surface,
                border: Border(top: BorderSide(color: border)),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  Row(
                    children: [
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: () => _showReceiptPreview(vm),
                          style: OutlinedButton.styleFrom(
                            side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(40)),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 12),
                          ),
                          icon: const Icon(Icons.receipt_long, size: 18),
                          label: const Text("Receipt"),
                        ),
                      ),
                      const SizedBox(width: 10),
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: () => _openReceiptScreen(vm),
                          style: OutlinedButton.styleFrom(
                            side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(40)),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 12),
                          ),
                          icon: const Icon(Icons.print, size: 18),
                          label: const Text("Print"),
                        ),
                      ),
                      const SizedBox(width: 10),
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: () => _openReceiptScreen(vm),
                          style: OutlinedButton.styleFrom(
                            side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(40)),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 12),
                          ),
                          icon: const Icon(Icons.share, size: 18),
                          label: const Text("Share"),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  SizedBox(
                    height: 52,
                    child: ElevatedButton(
                      onPressed: vm.isLoading
                          ? null
                          : () async {
                              if (!_formKey.currentState!.validate()) return;

                              final ok = await vm.logPayment();
                              if (!context.mounted) return;

                              if (ok) {
                                context.pop();
                                ScaffoldMessenger.of(context).showSnackBar(
                                  const SnackBar(content: Text("Payment Logged Successfully")),
                                );
                              } else {
                                ScaffoldMessenger.of(context).showSnackBar(
                                  SnackBar(content: Text(vm.error ?? "Error: Could not process payment.")),
                                );
                              }
                            },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      ),
                      child: vm.isLoading
                          ? const SizedBox(
                              height: 18,
                              width: 18,
                              child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2),
                            )
                          : const Text("Confirm Payment", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                    ),
                  ),
                  const SizedBox(height: 10),
                  SizedBox(
                    height: 52,
                    child: ElevatedButton(
                      onPressed: () => context.pop(),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.surfaceLightGrey.withAlpha(40),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      ),
                      child: const Text("Cancel", style: TextStyle(color: Colors.white)),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ---- Widgets / helpers ----

  Widget _sectionTitle(String text) {
    return Text(
      text,
      style: const TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.w600),
    );
  }

  Widget _summaryRow(
    String label,
    String value, {
    Color? valueColor,
    bool isBold = false,
  }) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(color: Colors.grey, fontSize: 14)),
        Text(
          value,
          style: TextStyle(
            color: valueColor ?? Colors.white,
            fontSize: 14,
            fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
          ),
        ),
      ],
    );
  }

  Widget _chip(LoggingPaymentsViewModel vm, String label, double amount) {
    return ActionChip(
      label: Text(label),
      backgroundColor: AppColors.surfaceDarkGrey,
      labelStyle: const TextStyle(color: Colors.white, fontSize: 12),
      side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(40)),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      onPressed: () {
        final v = amount.isFinite ? amount : 0.0;
        vm.updateAmount(v);
        _amountCtrl.text = v.toStringAsFixed(2);
      },
    );
  }

  Widget _dropdown({
    required String label,
    required String value,
    required List<String> items,
    required ValueChanged<String?> onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
        const SizedBox(height: 8),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(40)),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<String>(
              value: value,
              isExpanded: true,
              dropdownColor: AppColors.surfaceDarkGrey,
              style: const TextStyle(color: Colors.white),
              items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
              onChanged: onChanged,
            ),
          ),
        ),
      ],
    );
  }

  Widget _textField({
    required String label,
    required TextEditingController controller,
    required ValueChanged<String> onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(40)),
          ),
          child: TextField(
            controller: controller,
            style: const TextStyle(color: Colors.white),
            decoration: const InputDecoration(
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 14),
              isDense: true,
            ),
            onChanged: onChanged,
          ),
        ),
      ],
    );
  }

  // STRICT MONEY VALIDATION (0.50 - 500000.00)  adjust limits if you want
  String? _validateMoney(String? v) {
    final raw = (v ?? "").trim();
    if (raw.isEmpty) return "Amount is required.";
    final n = double.tryParse(raw);
    if (n == null) return "Enter a valid number.";
    if (n < 0.50) return "Minimum is \$0.50";
    if (n > 500000) return "Maximum is \$500,000";
    return null;
  }

  void _showReceiptPreview(LoggingPaymentsViewModel vm) {
    final studentName = vm.student?.fullName ?? "";
    final method = vm.method.trim().isEmpty ? "Cash" : vm.method.trim();
    final ref = vm.reference.trim();
    final amount = vm.amount;
    final now = DateTime.now();
    final debt = vm.totalOutstandingDebt;
    final surplus = vm.remainingCreditAfterDebt;

    showModalBottomSheet<void>(
      context: context,
      backgroundColor: AppColors.backgroundBlack,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
      ),
      builder: (ctx) {
        return SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                const Text(
                  "RECEIPT PREVIEW",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textGrey, fontSize: 11, letterSpacing: 2),
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
                  ),
                  child: Column(
                    children: [
                      _receiptRow("Date", DateFormat("dd/MM/yyyy HH:mm").format(now)),
                      _receiptRow("Student", studentName),
                      _receiptRow("Method", method),
                      if (ref.isNotEmpty) _receiptRow("Reference", ref),
                      const SizedBox(height: 8),
                      _receiptRow("Outstanding", "\$${debt.toStringAsFixed(2)}"),
                      if (surplus > 0) _receiptRow("Surplus", "\$${surplus.toStringAsFixed(2)}"),
                      const Divider(height: 20, color: Colors.white12),
                      _receiptRow("Amount Paid", "\$${amount.toStringAsFixed(2)}"),
                    ],
                  ),
                ),
                const SizedBox(height: 12),
                TextButton(
                  onPressed: () => Navigator.pop(ctx),
                  child: const Text("Close", style: TextStyle(color: AppColors.primaryBlue)),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  void _openReceiptScreen(LoggingPaymentsViewModel vm) {
    final now = DateTime.now();
    final studentName = vm.student?.fullName ?? "";
    final method = vm.method.trim().isEmpty ? "Cash" : vm.method.trim();
    final amount = vm.amount;
    final ref = vm.reference.trim();

    final data = {
      'id': 'PAY-${now.millisecondsSinceEpoch}',
      'date': now.toIso8601String(),
      'student': studentName,
      'items': [
        {
          'desc': ref.isEmpty ? 'Payment ($method)' : 'Payment ($method) - $ref',
          'amount': amount,
        }
      ],
      'total': amount,
      'cashier': 'System',
    };

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => PrintReceiptScreen(
          data: data,
          type: ReceiptType.payment,
        ),
      ),
    );
  }

  Widget _receiptRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
          Text(value, style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/finance/record_payment_screen.dart
// ==========================================

import 'package:flutter/services.dart';
import 'package:legend/app_libs.dart';
import 'package:legend/data/vmodels/payment_view_model.dart';


/// ============================================================================
/// RESULT OBJECT: returned to caller on Confirm.
/// Caller is responsible for persisting (offline-first DB write).
/// ============================================================================
class PaymentDraft {
  final String studentId;
  final String studentName;
  final double amount;
  final String method;
  final String reference;
  final DateTime receivedAt;

  /// Helpful context for UI / receipts
  final double balanceBefore;
  final double balanceAfter;
  final double overpayment;
  final String receiptNumber;

  PaymentDraft({
    required this.studentId,
    required this.studentName,
    required this.amount,
    required this.method,
    required this.reference,
    required this.receivedAt,
    required this.balanceBefore,
    required this.balanceAfter,
    required this.overpayment,
    required this.receiptNumber,
  });
}

// =============================================================================
// SCREEN IMPLEMENTATION
// =============================================================================
class RecordPaymentScreen extends StatefulWidget {
  final String? studentId;

  const RecordPaymentScreen({super.key, this.studentId});

  @override
  State<RecordPaymentScreen> createState() => _RecordPaymentScreenState();
}

class _RecordPaymentScreenState extends State<RecordPaymentScreen> {
  late final PaymentViewModel _vm;

  final TextEditingController _amountCtrl = TextEditingController();
  final TextEditingController _refCtrl = TextEditingController();

  bool _attemptedSubmit = false;
  bool _isSubmitting = false;
  bool _isLoadingStudents = false;
  List<Student> _students = [];
  String _studentQuery = "";

@override
void initState() {
  super.initState();

  final financeRepo = context.read<FinanceRepository>();
  final studentRepo = context.read<StudentRepository>();
  final auth = context.read<AuthService>();

  _vm = PaymentViewModel(
    financeRepo,
    studentRepo,
    auth,
    studentId: widget.studentId,
  );

  WidgetsBinding.instance.addPostFrameCallback((_) {
    _initLoad(); // <-- use the method so its not "unused" AND it triggers setState.
  });
}



  Future<void> _initLoad() async {
    await _vm.init();
    // Ensure a stable default method if VM is empty
    _vm.method = _vm.method.isEmpty ? "Cash" : _vm.method;
    if (mounted) setState(() {});
  }
  @override
  void dispose() {
    _amountCtrl.dispose();
    _refCtrl.dispose();
    _vm.dispose();
    super.dispose();
  }

  // ---------------------------------------------------------------------------
  // BUSINESS CALCS (no placebo)
  // ---------------------------------------------------------------------------
  double get _balanceBefore => max(0.0, _vm.currentDebt);
  double get _amount => max(0.0, _vm.amount);
  double get _balanceAfter => max(0.0, _balanceBefore - _amount);
  double get _overpayment => max(0.0, _amount - _balanceBefore);

  String _money(double v) => NumberFormat.currency(symbol: "\$ ", decimalDigits: 2).format(v);

  String _makeReceiptNumber(DateTime t) {
    // Deterministic enough for offline-first; collision-resistant for a single device.
    final y = t.year.toString();
    final m = t.month.toString().padLeft(2, '0');
    final d = t.day.toString().padLeft(2, '0');
    final tail = t.millisecondsSinceEpoch.toString().substring(max(0, t.millisecondsSinceEpoch.toString().length - 6));
    return "RCPT-$y$m$d-$tail";
  }

  String _initials(String name) {
    final n = name.trim();
    if (n.isEmpty) return "?";
    final parts = n.split(RegExp(r"\s+")).where((p) => p.isNotEmpty).toList();
    if (parts.isEmpty) return "?";
    final a = parts[0].characters.first.toUpperCase();
    final b = parts.length > 1 ? parts[1].characters.first.toUpperCase() : "";
    return "$a$b";
  }

  bool get _studentIsSelected => (_vm.studentId ?? "").trim().isNotEmpty && _vm.studentName.trim().isNotEmpty;

  Future<void> _openStudentPicker() async {
    if (_isLoadingStudents) return;
    if (_students.isEmpty) {
      setState(() => _isLoadingStudents = true);
      try {
        final auth = context.read<AuthService>();
        final school = auth.activeSchool;
        if (school == null) throw Exception("No active school.");
        _students = await context.read<StudentRepository>().getStudents(school.id);
      } catch (e) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(e.toString())),
          );
        }
      } finally {
        if (mounted) setState(() => _isLoadingStudents = false);
      }
    }

    if (!mounted) return;

    _studentQuery = "";

    await showModalBottomSheet<void>(
      context: context,
      isScrollControlled: true,
      backgroundColor: AppColors.backgroundBlack,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
      ),
      builder: (ctx) {
        return StatefulBuilder(
          builder: (ctx, setModalState) {
            final q = _studentQuery.toLowerCase().trim();
            final filtered = _students.where((s) {
              if (q.isEmpty) return true;
              return s.firstName.toLowerCase().contains(q) ||
                  s.lastName.toLowerCase().contains(q) ||
                  (s.admissionNumber?.toLowerCase().contains(q) ?? false);
            }).toList();
            final recent = List<Student>.from(_students)
              ..sort((a, b) {
                final ad = a.createdAt ?? DateTime.fromMillisecondsSinceEpoch(0);
                final bd = b.createdAt ?? DateTime.fromMillisecondsSinceEpoch(0);
                return bd.compareTo(ad);
              });

            return SafeArea(
              child: Padding(
                padding: EdgeInsets.only(
                  left: 16,
                  right: 16,
                  top: 12,
                  bottom: MediaQuery.of(ctx).viewInsets.bottom + 16,
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: AppColors.surfaceLightGrey.withAlpha(80),
                        borderRadius: BorderRadius.circular(4),
                      ),
                    ),
                    const SizedBox(height: 12),
                    const Text(
                      "Select Student",
                      style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16),
                    ),
                    const SizedBox(height: 12),
                    TextField(
                      onChanged: (val) => setModalState(() => _studentQuery = val),
                      style: const TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        hintText: "Search by name or admission...",
                        hintStyle: TextStyle(color: Colors.white.withAlpha(120)),
                        prefixIcon: const Icon(Icons.search, color: AppColors.primaryBlue),
                        filled: true,
                        fillColor: AppColors.surfaceDarkGrey,
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide.none,
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    if (_studentQuery.trim().isEmpty && recent.isNotEmpty) ...[
                      Align(
                        alignment: Alignment.centerLeft,
                        child: Text(
                          "Recent",
                          style: TextStyle(color: Colors.white.withAlpha(180), fontSize: 12, fontWeight: FontWeight.w600),
                        ),
                      ),
                      const SizedBox(height: 8),
                      Wrap(
                        spacing: 8,
                        runSpacing: 8,
                        children: recent.take(5).map((s) {
                          final name = "${s.firstName} ${s.lastName}".trim();
                          return ActionChip(
                            label: Text(name, overflow: TextOverflow.ellipsis),
                            backgroundColor: AppColors.surfaceDarkGrey,
                            labelStyle: const TextStyle(color: Colors.white, fontSize: 12),
                            side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(30)),
                            onPressed: () {
                              setState(() {
                                _vm.studentId = s.id;
                                _vm.student = s;
                                _attemptedSubmit = false;
                              });
                              Navigator.pop(ctx);
                            },
                          );
                        }).toList(),
                      ),
                      const SizedBox(height: 12),
                    ],
                    SizedBox(
                      height: 360,
                      child: _isLoadingStudents
                          ? const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue))
                          : filtered.isEmpty
                              ? const Center(
                                  child: Text("No matches found.", style: TextStyle(color: AppColors.textGrey)),
                                )
                              : ListView.separated(
                                  itemCount: filtered.length,
                                  separatorBuilder: (_, __) => Divider(
                                    color: AppColors.surfaceLightGrey.withAlpha(30),
                                    height: 1,
                                  ),
                                  itemBuilder: (ctx, index) {
                                    final s = filtered[index];
                                    final name = "${s.firstName} ${s.lastName}".trim();
                                    final adm = (s.admissionNumber ?? "").trim();

                                    return ListTile(
                                      title: Text(name, style: const TextStyle(color: Colors.white)),
                                      subtitle: Text(
                                        adm.isEmpty ? "No admission no." : adm,
                                        style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
                                      ),
                                      onTap: () {
                                        setState(() {
                                          _vm.studentId = s.id;
                                          _vm.student = s;
                                          _attemptedSubmit = false;
                                        });
                                        Navigator.pop(ctx);
                                      },
                                    );
                                  },
                                ),
                    ),
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }

  // ---------------------------------------------------------------------------
  // ACTION: Confirm (returns PaymentDraft)
  // ---------------------------------------------------------------------------
  Future<void> _confirm() async {
    setState(() => _attemptedSubmit = true);

    if (!_studentIsSelected) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Select a student first."),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    if (_amount <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Enter a valid amount greater than 0."),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    final method = _vm.method.trim();
    if (method.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Select a payment method."),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    if (_isSubmitting) return;
    setState(() => _isSubmitting = true);

    try {
      await _vm.submitPayment();
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Payment recorded successfully")),
      );
      context.pop(true);
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(e.toString())),
      );
    } finally {
      if (mounted) setState(() => _isSubmitting = false);
    }
  }

  // ---------------------------------------------------------------------------
  // UI
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    if (_vm.isLoading) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(child: CircularProgressIndicator(color: AppColors.successGreen)),
      );
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text("Receive Payment", style: TextStyle(fontWeight: FontWeight.bold)),
      ),
      body: LayoutBuilder(
        builder: (context, constraints) {
          final isWide = constraints.maxWidth >= 980;

          final form = SingleChildScrollView(
            padding: const EdgeInsets.all(20),
            child: Column(
              children: [
                _buildStudentContextCard(),
                const SizedBox(height: 16),
                _buildBalanceStrip(),
                const SizedBox(height: 28),
                _buildAmountInput(),
                const SizedBox(height: 28),
                _buildPaymentDetails(),
                const SizedBox(height: 22),
                if (!isWide) ...[
                  const Text(
                    "RECEIPT PREVIEW",
                    style: TextStyle(color: AppColors.textGrey, fontSize: 10, letterSpacing: 2),
                  ),
                  const SizedBox(height: 12),
                  _buildThermalReceipt(),
                  const SizedBox(height: 40),
                ],
              ],
            ),
          );

          if (!isWide) return form;

          return Row(
            children: [
              Expanded(child: form),
              VerticalDivider(width: 1, color: AppColors.surfaceLightGrey.withAlpha(30)),
              SizedBox(
                width: min(520, constraints.maxWidth * 0.42),
                child: Padding(
                  padding: const EdgeInsets.fromLTRB(20, 20, 20, 20),
                  child: Column(
                    children: [
                      const Text(
                        "RECEIPT PREVIEW",
                        style: TextStyle(color: AppColors.textGrey, fontSize: 10, letterSpacing: 2),
                      ),
                      const SizedBox(height: 12),
                      Expanded(child: SingleChildScrollView(child: _buildThermalReceipt())),
                    ],
                  ),
                ),
              ),
            ],
          );
        },
      ),
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: SizedBox(
            height: 56,
            child: ElevatedButton.icon(
              onPressed: _isSubmitting ? null : _confirm,
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.successGreen,
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                elevation: 10,
                shadowColor: AppColors.successGreen.withAlpha(100),
              ),
              icon: const Icon(Icons.check_circle_outline, size: 20),
              label: _isSubmitting
                  ? const SizedBox(
                      height: 16,
                      width: 16,
                      child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2),
                    )
                  : const Text(
                      "CONFIRM PAYMENT",
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                    ),
            ),
          ),
        ),
      ),
    );
  }

  // ===========================================================================
  // WIDGET BUILDERS
  // ===========================================================================

  Widget _buildStudentContextCard() {
    final name = _vm.studentName.trim();
    final owes = _balanceBefore;

    final showChange = widget.studentId == null;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
      ),
      child: Row(
        children: [
          CircleAvatar(
            backgroundColor: AppColors.primaryBlue,
            child: Text(_initials(name), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name.isEmpty ? "No student selected" : name,
                  style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16),
                ),
                Text(
                  "Owes: ${_money(owes)}",
                  style: TextStyle(
                    color: owes > 0 ? AppColors.errorRed : AppColors.successGreen,
                    fontSize: 13,
                    fontWeight: FontWeight.w700,
                  ),
                ),
                if (_attemptedSubmit && !_studentIsSelected) ...[
                  const SizedBox(height: 6),
                  const Text(
                    "Student is required.",
                    style: TextStyle(color: Colors.redAccent, fontSize: 11, fontWeight: FontWeight.w600),
                  ),
                ],
              ],
            ),
          ),
          if (showChange)
            TextButton(
              onPressed: _openStudentPicker,
              child: const Text("Change"),
            ),
        ],
      ),
    );
  }

  Widget _buildBalanceStrip() {
    final paid = _amount;
    final after = _balanceAfter;
    final over = _overpayment;

    Widget stat(String label, String value, Color valueColor) {
      return Expanded(
        child: Container(
          padding: const EdgeInsets.all(14),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(14),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(25)),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(label, style: TextStyle(color: AppColors.textGrey.withAlpha(160), fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
              const SizedBox(height: 8),
              Text(value, style: TextStyle(color: valueColor, fontSize: 14, fontWeight: FontWeight.w900)),
            ],
          ),
        ),
      );
    }

    return Row(
      children: [
        stat("OWING", _money(_balanceBefore), AppColors.errorRed),
        const SizedBox(width: 10),
        stat("PAID NOW", _money(paid), AppColors.successGreen),
        const SizedBox(width: 10),
        stat("BALANCE", _money(after), after > 0 ? Colors.white : AppColors.successGreen),
        if (over > 0) ...[
          const SizedBox(width: 10),
          stat("OVERPAY", _money(over), Colors.orangeAccent),
        ],
      ],
    );
  }

  Widget _buildAmountInput() {
    return Column(
      children: [
        Text(
          "AMOUNT RECEIVED",
          style: TextStyle(
            color: AppColors.textGrey.withAlpha(150),
            fontSize: 12,
            fontWeight: FontWeight.bold,
            letterSpacing: 1.5,
          ),
        ),
        const SizedBox(height: 10),
        IntrinsicWidth(
          child: TextField(
            controller: _amountCtrl,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [
              FilteringTextInputFormatter.allow(RegExp(r'^\d*\.?\d{0,2}')),
              LengthLimitingTextInputFormatter(12),
            ],
            textAlign: TextAlign.center,
            style: const TextStyle(color: AppColors.successGreen, fontSize: 46, fontWeight: FontWeight.bold),
            decoration: const InputDecoration(
              prefixText: "\$ ",
              prefixStyle: TextStyle(color: AppColors.successGreen, fontSize: 46),
              border: InputBorder.none,
              hintText: "0.00",
              hintStyle: TextStyle(color: Colors.white12),
            ),
            onChanged: (val) {
              setState(() {
                _vm.amount = double.tryParse(val) ?? 0.0;
              });
            },
          ),
        ),
        const SizedBox(height: 10),
        Wrap(
          spacing: 8,
          children: [
            _buildQuickAmountChip("Full Debt", _balanceBefore),
            _buildQuickAmountChip("50%", _balanceBefore / 2),
            _buildQuickAmountChip("\$100", 100),
          ],
        ),
        if (_attemptedSubmit && _amount <= 0) ...[
          const SizedBox(height: 10),
          const Text(
            "Amount must be greater than 0.",
            style: TextStyle(color: Colors.redAccent, fontSize: 12, fontWeight: FontWeight.w700),
          ),
        ],
      ],
    );
  }

  Widget _buildPaymentDetails() {
    return Row(
      children: [
        Expanded(
          child: _buildDropdown(
            label: "Method",
            value: _vm.method.isEmpty ? "Cash" : _vm.method,
            items: const ["Cash", "EcoCash", "Bank Transfer", "Swipe"],
            onChanged: (val) => setState(() => _vm.method = (val ?? "Cash")),
          ),
        ),
        const SizedBox(width: 16),
        Expanded(
          child: _buildTextField(
            label: "Reference / Ref No.",
            controller: _refCtrl,
            onChanged: (val) => _vm.reference = val,
          ),
        ),
      ],
    );
  }

  Widget _buildQuickAmountChip(String label, double amount) {
    return ActionChip(
      label: Text(label),
      backgroundColor: AppColors.surfaceDarkGrey,
      labelStyle: const TextStyle(color: Colors.white, fontSize: 12),
      side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(30)),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      onPressed: () {
        setState(() {
          _vm.amount = amount;
          _amountCtrl.text = amount.toStringAsFixed(2);
        });
      },
    );
  }

  Widget _buildDropdown({
    required String label,
    required String value,
    required List<String> items,
    required ValueChanged<String?> onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
        const SizedBox(height: 8),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<String>(
              value: value,
              isExpanded: true,
              dropdownColor: AppColors.surfaceDarkGrey,
              style: const TextStyle(color: Colors.white),
              items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
              onChanged: onChanged,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildTextField({
    required String label,
    required TextEditingController controller,
    required ValueChanged<String> onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
          ),
          child: TextField(
            controller: controller,
            style: const TextStyle(color: Colors.white),
            decoration: const InputDecoration(
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 14),
              isDense: true,
            ),
            onChanged: onChanged,
          ),
        ),
      ],
    );
  }

  // THERMAL RECEIPT PREVIEW (not claiming printed; it previews the draft)
  Widget _buildThermalReceipt() {
    final now = DateTime.now();
    final receiptNo = _makeReceiptNumber(now);

    final name = _vm.studentName.trim().isEmpty ? "" : _vm.studentName.trim();
    final method = _vm.method.trim().isEmpty ? "Cash" : _vm.method.trim();
    final ref = _vm.reference.trim();

    final allocatedToDebt = min(_amount, _balanceBefore);

    final allocText = _overpayment > 0
        ? "Allocated ${_money(allocatedToDebt)} to debt, ${_money(_overpayment)} as overpayment."
        : "Allocated ${_money(allocatedToDebt)} to outstanding balance.";

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFFFDFDFD),
        borderRadius: BorderRadius.circular(8),
        boxShadow: const [BoxShadow(color: Colors.black26, blurRadius: 10, offset: Offset(0, 4))],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          const Icon(Icons.school, color: Colors.black, size: 32),
          const SizedBox(height: 8),
          const Text("KWA LEGEND ACADEMY", style: TextStyle(color: Colors.black, fontWeight: FontWeight.w900, fontSize: 14)),
          const Text("PAYMENT RECEIPT (DRAFT)", style: TextStyle(color: Colors.black54, fontSize: 10, letterSpacing: 2)),
          const Divider(height: 24, color: Colors.black12, thickness: 1),

          _receiptRow("Date", DateFormat("dd/MM/yyyy HH:mm").format(now)),
          _receiptRow("Receipt #", receiptNo),
          _receiptRow("Student", name),
          _receiptRow("Method", method),
          if (ref.isNotEmpty) _receiptRow("Ref", ref),

          const SizedBox(height: 8),
          _receiptRow("Balance Before", _money(_balanceBefore)),
          _receiptRow("Balance After", _money(_balanceAfter)),
          if (_overpayment > 0) _receiptRow("Overpayment", _money(_overpayment)),

          const Divider(height: 24, color: Colors.black12, thickness: 1),

          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("AMOUNT PAID", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold, fontSize: 14)),
              Text(_money(_amount), style: const TextStyle(color: Colors.black, fontWeight: FontWeight.w900, fontSize: 18)),
            ],
          ),
          const SizedBox(height: 10),
          Text(
            allocText,
            style: const TextStyle(color: Colors.black54, fontSize: 10, fontStyle: FontStyle.italic),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _receiptRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: Colors.black54, fontSize: 11)),
          Text(value, style: const TextStyle(color: Colors.black, fontSize: 11, fontWeight: FontWeight.w600)),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/finance/create_invoice_screen.dart
// ==========================================

import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/data/constants/app_constants.dart';

/// ============================================================================
/// DATA: Returned to caller on Save (NOT a placebo).
/// Whoever pushes this screen can `await` and persist it.
/// ============================================================================
class CreateInvoiceDraft {
  final String invoiceNumber;
  final DateTime issueDate;
  final DateTime dueDate;

  // Party / Context (keep flexible; backend can enforce required keys later)
  final String studentName;
  final String? studentId;
  final String? studentGrade;
  final String? guardianName;

  final List<CreateInvoiceDraftItem> items;

  CreateInvoiceDraft({
    required this.invoiceNumber,
    required this.issueDate,
    required this.dueDate,
    required this.studentName,
    required this.items,
    this.studentId,
    this.studentGrade,
    this.guardianName,
  });

  double get subtotal => items.fold(0.0, (s, i) => s + i.total);
  double get tax => 0.0;
  double get total => subtotal + tax;
}

class CreateInvoiceDraftItem {
  final String description;
  final int quantity;
  final double unitPrice;

  CreateInvoiceDraftItem({
    required this.description,
    required this.quantity,
    required this.unitPrice,
  });

  double get total => quantity * unitPrice;
}

/// ============================================================================
/// VIEWMODEL: Serious, deterministic UI state.
/// ============================================================================
class CreateInvoiceViewModel extends ChangeNotifier {
  final String invoiceNumber;
  DateTime issueDate;
  DateTime dueDate;

  // Controllers (keeps data stable across rebuilds)
  final TextEditingController studentNameCtrl = TextEditingController();
  final TextEditingController studentIdCtrl = TextEditingController();
  final TextEditingController studentGradeCtrl = TextEditingController();
  final TextEditingController guardianNameCtrl = TextEditingController();

  final List<_InvoiceLineItemDraft> _items = [];
  final Map<String, VoidCallback> _itemListeners = {};

  bool _attemptedSubmit = false;

  CreateInvoiceViewModel._({
    required this.invoiceNumber,
    required this.issueDate,
    required this.dueDate,
  }) {
    // Default: 2 professional line items but editable (not fake student, not fake totals)
    addItem(description: "Tuition Fee", quantity: 1, unitPrice: 0.0);
    addItem(description: "Levy / Supplementary", quantity: 1, unitPrice: 0.0);

    // Recalc on party edits where needed
    studentNameCtrl.addListener(_softRebuild);
    studentIdCtrl.addListener(_softRebuild);
    studentGradeCtrl.addListener(_softRebuild);
    guardianNameCtrl.addListener(_softRebuild);
  }

  factory CreateInvoiceViewModel.init() {
    final now = DateTime.now();
    final inv = "INV-${now.year}-${now.month.toString().padLeft(2, '0')}-${now.millisecondsSinceEpoch.toString().substring(7)}";
    return CreateInvoiceViewModel._(
      invoiceNumber: inv,
      issueDate: DateTime(now.year, now.month, now.day),
      dueDate: DateTime(now.year, now.month, now.day).add(const Duration(days: 14)),
    );
  }

  List<_InvoiceLineItemDraft> get items => List.unmodifiable(_items);
  bool get attemptedSubmit => _attemptedSubmit;

  double get subtotal => _items.fold(0.0, (s, i) => s + i.total);
  double get tax => 0.0;
  double get total => subtotal + tax;

  bool get isTimelineValid => !dueDate.isBefore(issueDate);

  bool get canSave {
    // Stand on business: enforce minimum required inputs.
    final hasStudentName = studentNameCtrl.text.trim().isNotEmpty;
    final hasAtLeastOneValidLine = _items.any((i) => i.isValidLine);
    return hasStudentName && hasAtLeastOneValidLine && isTimelineValid;
  }

  void markAttemptedSubmit() {
    _attemptedSubmit = true;
    notifyListeners();
  }

  void setIssueDate(DateTime d) {
    issueDate = DateTime(d.year, d.month, d.day);
    // keep due >= issue
    if (dueDate.isBefore(issueDate)) {
      dueDate = issueDate;
    }
    notifyListeners();
  }

  void setDueDate(DateTime d) {
    dueDate = DateTime(d.year, d.month, d.day);
    notifyListeners();
  }

  void applyQuickDue(int days) {
    dueDate = issueDate.add(Duration(days: days));
    notifyListeners();
  }

  void applyEndOfMonthDue() {
    final lastDay = DateTime(issueDate.year, issueDate.month + 1, 0);
    dueDate = DateTime(lastDay.year, lastDay.month, lastDay.day);
    notifyListeners();
  }

  void addItem({String description = "", int quantity = 1, double unitPrice = 0.0}) {
    final item = _InvoiceLineItemDraft.create(description: description, quantity: quantity, unitPrice: unitPrice);
    _items.add(item);
    _attachItemListeners(item);
    notifyListeners();
  }

  void removeItemById(String id) {
    final idx = _items.indexWhere((e) => e.id == id);
    if (idx < 0) return;
    final item = _items.removeAt(idx);
    _detachItemListeners(item);
    item.dispose();
    notifyListeners();
  }

  CreateInvoiceDraft buildDraftOrThrow() {
    final studentName = studentNameCtrl.text.trim();
    if (studentName.isEmpty) {
      throw StateError("Student name is required.");
    }
    if (!isTimelineValid) {
      throw StateError("Due date cannot be before issue date.");
    }
    final builtItems = _items
        .where((i) => i.isValidLine)
        .map((i) => CreateInvoiceDraftItem(
              description: i.description.trim(),
              quantity: i.quantity,
              unitPrice: i.unitPrice,
            ))
        .toList();

    if (builtItems.isEmpty) {
      throw StateError("At least one valid line item is required.");
    }

    return CreateInvoiceDraft(
      invoiceNumber: invoiceNumber,
      issueDate: issueDate,
      dueDate: dueDate,
      studentName: studentName,
      studentId: studentIdCtrl.text.trim().isEmpty ? null : studentIdCtrl.text.trim(),
      studentGrade: studentGradeCtrl.text.trim().isEmpty ? null : studentGradeCtrl.text.trim(),
      guardianName: guardianNameCtrl.text.trim().isEmpty ? null : guardianNameCtrl.text.trim(),
      items: builtItems,
    );
  }

  void _attachItemListeners(_InvoiceLineItemDraft item) {
    void listener() => notifyListeners();
    _itemListeners[item.id] = listener;

    item.descriptionCtrl.addListener(listener);
    item.qtyCtrl.addListener(listener);
    item.unitPriceCtrl.addListener(listener);
  }

  void _detachItemListeners(_InvoiceLineItemDraft item) {
    final listener = _itemListeners.remove(item.id);
    if (listener == null) return;

    item.descriptionCtrl.removeListener(listener);
    item.qtyCtrl.removeListener(listener);
    item.unitPriceCtrl.removeListener(listener);
  }

  void _softRebuild() => notifyListeners();

  @override
  void dispose() {
    studentNameCtrl.dispose();
    studentIdCtrl.dispose();
    studentGradeCtrl.dispose();
    guardianNameCtrl.dispose();

    for (final i in _items) {
      _detachItemListeners(i);
      i.dispose();
    }
    _items.clear();
    super.dispose();
  }
}

class _InvoiceLineItemDraft {
  final String id;
  final TextEditingController descriptionCtrl;
  final TextEditingController qtyCtrl;
  final TextEditingController unitPriceCtrl;

  _InvoiceLineItemDraft._({
    required this.id,
    required this.descriptionCtrl,
    required this.qtyCtrl,
    required this.unitPriceCtrl,
  });

  static _InvoiceLineItemDraft create({String description = "", int quantity = 1, double unitPrice = 0.0}) {
    final id = "${DateTime.now().microsecondsSinceEpoch}-${Random().nextInt(9999)}";
    return _InvoiceLineItemDraft._(
      id: id,
      descriptionCtrl: TextEditingController(text: description),
      qtyCtrl: TextEditingController(text: max(1, quantity).toString()),
      unitPriceCtrl: TextEditingController(text: unitPrice.toStringAsFixed(2)),
    );
  }

  String get description => descriptionCtrl.text;
  int get quantity => max(1, int.tryParse(qtyCtrl.text.trim()) ?? 1);
  double get unitPrice => double.tryParse(unitPriceCtrl.text.trim()) ?? 0.0;
  double get total => quantity * unitPrice;

  bool get isValidLine {
    // Business: must have description and non-negative price; qty >= 1
    final d = description.trim();
    if (d.isEmpty) return false;
    if (unitPrice < 0) return false;
    if (quantity < 1) return false;
    return true;
  }

  void dispose() {
    descriptionCtrl.dispose();
    qtyCtrl.dispose();
    unitPriceCtrl.dispose();
  }
}

/// ============================================================================
/// SCREEN
/// ============================================================================
class CreateInvoiceScreen extends StatefulWidget {
  const CreateInvoiceScreen({super.key});

  @override
  State<CreateInvoiceScreen> createState() => _CreateInvoiceScreenState();
}

class _CreateInvoiceScreenState extends State<CreateInvoiceScreen> with SingleTickerProviderStateMixin {
  late final CreateInvoiceViewModel _vm;
  TabController? _tabController;

  final _formKey = GlobalKey<FormState>();

  @override
  void initState() {
    super.initState();
    _vm = CreateInvoiceViewModel.init();
  }

  @override
  void dispose() {
    _tabController?.dispose();
    _vm.dispose();
    super.dispose();
  }

  void _attemptSave() {
    _vm.markAttemptedSubmit();

    // Validate form-level inputs
    final validForm = _formKey.currentState?.validate() ?? false;
    if (!validForm) {
      _showError("Fix the highlighted fields before saving.");
      return;
    }

    if (!_vm.isTimelineValid) {
      _showError("Due date cannot be before issue date.");
      return;
    }

    if (!_vm.canSave) {
      _showError("Invoice needs a Student Name and at least one valid line item.");
      return;
    }

    try {
      final draft = _vm.buildDraftOrThrow();
      // Not placebo: return the draft to caller.
      context.pop(draft);
    } catch (e) {
      _showError(e.toString().replaceFirst("StateError: ", ""));
    }
  }

  void _showError(String msg) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.error_outline, color: Colors.white, size: 18),
            const SizedBox(width: 10),
            Expanded(child: Text(msg)),
          ],
        ),
        backgroundColor: AppColors.errorRed,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  String _money(double v) {
    // Dont hardcode locale assumptions; keep it simple and consistent.
    final f = NumberFormat.currency(symbol: "\$ ", decimalDigits: 2);
    return f.format(v);
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _vm,
      builder: (context, _) {
        return LayoutBuilder(
          builder: (context, constraints) {
            final w = constraints.maxWidth;
            final isWide = w >= 920; // auto-adapt; not desktop-specific
            _tabController ??= TabController(length: 2, vsync: this);

            return Scaffold(
              backgroundColor: AppColors.backgroundBlack,
              appBar: AppBar(
                backgroundColor: AppColors.backgroundBlack,
                elevation: 0,
                leading: IconButton(
                  icon: const Icon(Icons.close, color: Colors.white),
                  onPressed: () => context.pop(),
                ),
                title: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("Invoice Studio", style: TextStyle(fontWeight: FontWeight.bold)),
                    Text(
                      "DRAFT  ${_vm.invoiceNumber}",
                      style: TextStyle(color: AppColors.textGrey.withAlpha(180), fontSize: 11),
                    ),
                  ],
                ),
                actions: [
                  Padding(
                    padding: const EdgeInsets.only(right: 10),
                    child: TextButton.icon(
                      onPressed: _vm.canSave ? _attemptSave : _attemptSave, // still validates + explains
                      style: TextButton.styleFrom(
                        backgroundColor: _vm.canSave ? AppColors.successGreen : AppColors.surfaceLightGrey,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                      ),
                      icon: const Icon(Icons.save_alt, size: 18),
                      label: const Text("SAVE", style: TextStyle(fontWeight: FontWeight.bold)),
                    ),
                  ),
                ],
                bottom: isWide
                    ? null
                    : TabBar(
                        controller: _tabController,
                        indicatorColor: AppColors.primaryBlue,
                        labelColor: AppColors.primaryBlue,
                        unselectedLabelColor: AppColors.textGrey,
                        tabs: const [
                          Tab(text: "EDITOR", icon: Icon(Icons.edit_note)),
                          Tab(text: "PREVIEW", icon: Icon(Icons.remove_red_eye_outlined)),
                        ],
                      ),
              ),
              body: isWide
                  ? Row(
                      children: [
                        Expanded(child: _buildEditor()),
                        VerticalDivider(width: 1, color: AppColors.surfaceLightGrey.withAlpha(30)),
                        SizedBox(
                          width: min(520, w * 0.42),
                          child: _buildPreview(dense: true),
                        ),
                      ],
                    )
                  : TabBarView(
                      controller: _tabController,
                      children: [
                        _buildEditor(),
                        _buildPreview(),
                      ],
                    ),
            );
          },
        );
      },
    );
  }

  Widget _buildEditor() {
    return SingleChildScrollView(
      padding: const EdgeInsets.fromLTRB(18, 14, 18, 110),
      child: Form(
        key: _formKey,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _SectionCard(
              title: "BILL TO",
              icon: Icons.person,
              children: [
                _LabeledField(
                  label: "Student Name",
                  requiredMark: true,
                  child: TextFormField(
                    controller: _vm.studentNameCtrl,
                    style: const TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.w600),
                    decoration: _inputDeco(hint: "e.g. Nyasha Gabriel"),
                    validator: (v) {
                      if ((v ?? "").trim().isEmpty) return "Student name is required";
                      return null;
                    },
                  ),
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: _LabeledField(
                        label: "Student ID (Optional)",
                        helper: "Use when linking to the student record.",
                        child: TextFormField(
                          controller: _vm.studentIdCtrl,
                          style: const TextStyle(color: Colors.white, fontSize: 13),
                          decoration: _inputDeco(hint: "UUID / internal id"),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: _LabeledField(
                        label: "Grade / Class (Optional)",
                        child: TextFormField(
                          controller: _vm.studentGradeCtrl,
                          style: const TextStyle(color: Colors.white, fontSize: 13),
                          decoration: _inputDeco(hint: "e.g. Form 4-B"),
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                _LabeledField(
                  label: "Guardian / Payer (Optional)",
                  child: TextFormField(
                    controller: _vm.guardianNameCtrl,
                    style: const TextStyle(color: Colors.white, fontSize: 13),
                    decoration: _inputDeco(hint: "e.g. Mr. Thomas Wilson"),
                  ),
                ),
              ],
            ),

            const SizedBox(height: 16),

            _SectionCard(
              title: "TIMELINE",
              icon: Icons.event,
              accent: AppColors.primaryBlue.withAlpha(18),
              border: AppColors.primaryBlue.withAlpha(60),
              children: [
                Row(
                  children: [
                    Expanded(
                      child: _DateBox(
                        label: "Issue Date",
                        date: _vm.issueDate,
                        color: Colors.white,
                        onPick: () async {
                          final d = await showDatePicker(
                            context: context,
                            initialDate: _vm.issueDate,
                            firstDate: DateTime(2020),
                            lastDate: DateTime(2035),
                          );
                          if (d != null) _vm.setIssueDate(d);
                        },
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: _DateBox(
                        label: "Due Date",
                        date: _vm.dueDate,
                        color: _vm.isTimelineValid ? Colors.white : Colors.redAccent,
                        onPick: () async {
                          final d = await showDatePicker(
                            context: context,
                            initialDate: _vm.dueDate,
                            firstDate: DateTime(2020),
                            lastDate: DateTime(2035),
                          );
                          if (d != null) _vm.setDueDate(d);
                        },
                        warning: !_vm.isTimelineValid ? "Due date must be on/after issue date." : null,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 10,
                  runSpacing: 8,
                  children: [
                    _QuickChip(label: "Net 7", onTap: () => _vm.applyQuickDue(7)),
                    _QuickChip(label: "Net 14", onTap: () => _vm.applyQuickDue(14)),
                    _QuickChip(label: "Net 30", onTap: () => _vm.applyQuickDue(30)),
                    _QuickChip(label: "End of Month", onTap: _vm.applyEndOfMonthDue),
                  ],
                ),
              ],
            ),

            const SizedBox(height: 16),

            _SectionCard(
              title: "LINE ITEMS",
              icon: Icons.receipt_long,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        "At least one valid line is required. Empty lines are ignored on Save.",
                        style: TextStyle(color: AppColors.textGrey.withAlpha(180), fontSize: 12),
                      ),
                    ),
                    const SizedBox(width: 12),
                    TextButton.icon(
                      onPressed: () => _vm.addItem(description: "", quantity: 1, unitPrice: 0.0),
                      style: TextButton.styleFrom(
                        foregroundColor: AppColors.primaryBlue,
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
                      ),
                      icon: const Icon(Icons.add, size: 16),
                      label: const Text("ADD"),
                    ),
                  ],
                ),
                const SizedBox(height: 12),

                ..._vm.items.map((it) => _LineItemCard(
                      key: ValueKey(it.id),
                      item: it,
                      attemptedSubmit: _vm.attemptedSubmit,
                      onDelete: () async {
                        final ok = await showDialog<bool>(
                          context: context,
                          builder: (c) => AlertDialog(
                            backgroundColor: AppColors.surfaceDarkGrey,
                            title: const Text("Remove line item?", style: TextStyle(color: Colors.white)),
                            content: const Text(
                              "This will remove the line item from the invoice.",
                              style: TextStyle(color: AppColors.textGrey),
                            ),
                            actions: [
                              TextButton(
                                onPressed: () => Navigator.pop(c, false),
                                child: const Text("Cancel", style: TextStyle(color: AppColors.textGrey)),
                              ),
                              TextButton(
                                onPressed: () => Navigator.pop(c, true),
                                child: const Text("Remove", style: TextStyle(color: AppColors.errorRed)),
                              ),
                            ],
                          ),
                        );
                        if (ok == true) _vm.removeItemById(it.id);
                      },
                      money: _money,
                    )),

                const SizedBox(height: 16),
                Divider(color: AppColors.surfaceLightGrey.withAlpha(40)),
                const SizedBox(height: 12),

                _TotalsRow(label: "Subtotal", value: _money(_vm.subtotal)),
                _TotalsRow(label: "Tax", value: _money(_vm.tax)),
                const SizedBox(height: 6),
                _TotalsRow(
                  label: "TOTAL",
                  value: _money(_vm.total),
                  bold: true,
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPreview({bool dense = false}) {
    final a4 = 210 / 297; // width/height
    return Container(
      color: Colors.black87,
      child: Center(
        child: InteractiveViewer(
          minScale: dense ? 0.9 : 0.6,
          maxScale: 3.0,
          boundaryMargin: const EdgeInsets.all(20),
          child: ConstrainedBox(
            constraints: BoxConstraints(
              maxWidth: dense ? 500 : 420,
            ),
            child: AspectRatio(
              aspectRatio: a4,
              child: Container(
                decoration: BoxDecoration(
                  color: Colors.white,
                  boxShadow: const [BoxShadow(color: Colors.black, blurRadius: 18)],
                  borderRadius: BorderRadius.circular(8),
                ),
                child: _InvoicePaperTemplate(vm: _vm),
              ),
            ),
          ),
        ),
      ),
    );
  }

  InputDecoration _inputDeco({required String hint}) {
    return InputDecoration(
      hintText: hint,
      hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 13),
      filled: true,
      fillColor: AppColors.backgroundBlack,
      isDense: true,
      contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10),
        borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(70)),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10),
        borderSide: const BorderSide(color: AppColors.primaryBlue),
      ),
      errorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(10),
        borderSide: const BorderSide(color: AppColors.errorRed),
      ),
    );
  }
}

/// ============================================================================
/// UI Pieces
/// ============================================================================
class _SectionCard extends StatelessWidget {
  final String title;
  final IconData icon;
  final List<Widget> children;
  final Color? accent;
  final Color? border;

  const _SectionCard({
    required this.title,
    required this.icon,
    required this.children,
    this.accent,
    this.border,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: accent ?? AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: border ?? AppColors.surfaceLightGrey.withAlpha(25)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(icon, color: AppColors.primaryBlueLight, size: 18),
              const SizedBox(width: 10),
              Text(
                title,
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 1.1,
                  fontSize: 12,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          ...children,
        ],
      ),
    );
  }
}

class _LabeledField extends StatelessWidget {
  final String label;
  final bool requiredMark;
  final String? helper;
  final Widget child;

  const _LabeledField({
    required this.label,
    required this.child,
    this.requiredMark = false,
    this.helper,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
            if (requiredMark) ...[
              const SizedBox(width: 6),
              const Text("*", style: TextStyle(color: Colors.redAccent, fontSize: 12, fontWeight: FontWeight.bold)),
            ],
          ],
        ),
        if (helper != null) ...[
          const SizedBox(height: 3),
          Text(helper!, style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 10)),
        ],
        const SizedBox(height: 6),
        child,
      ],
    );
  }
}

class _DateBox extends StatelessWidget {
  final String label;
  final DateTime date;
  final Color color;
  final VoidCallback onPick;
  final String? warning;

  const _DateBox({
    required this.label,
    required this.date,
    required this.color,
    required this.onPick,
    this.warning,
  });

  @override
  Widget build(BuildContext context) {
    final df = DateFormat('MMM dd, yyyy');
    return InkWell(
      onTap: onPick,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: warning != null ? Colors.redAccent.withAlpha(130) : AppColors.surfaceLightGrey.withAlpha(70),
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
            const SizedBox(height: 6),
            Text(df.format(date), style: TextStyle(color: color, fontWeight: FontWeight.bold)),
            if (warning != null) ...[
              const SizedBox(height: 6),
              Text(warning!, style: const TextStyle(color: Colors.redAccent, fontSize: 10, fontWeight: FontWeight.w600)),
            ],
          ],
        ),
      ),
    );
  }
}

class _QuickChip extends StatelessWidget {
  final String label;
  final VoidCallback onTap;

  const _QuickChip({required this.label, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return ActionChip(
      onPressed: onTap,
      label: Text(label, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 12)),
      backgroundColor: AppColors.surfaceLightGrey.withAlpha(45),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
    );
  }
}

class _LineItemCard extends StatelessWidget {
  final _InvoiceLineItemDraft item;
  final VoidCallback onDelete;
  final bool attemptedSubmit;
  final String Function(double) money;

  const _LineItemCard({
    super.key,
    required this.item,
    required this.onDelete,
    required this.attemptedSubmit,
    required this.money,
  });

  @override
  Widget build(BuildContext context) {
    final invalid = attemptedSubmit && !item.isValidLine && item.description.trim().isNotEmpty;
    return Container(
      margin: const EdgeInsets.only(bottom: 10),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(14),
        border: Border.all(color: invalid ? Colors.redAccent.withAlpha(150) : AppColors.surfaceLightGrey.withAlpha(55)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              const Icon(Icons.drag_indicator, color: AppColors.textGrey, size: 18),
              const SizedBox(width: 8),
              Expanded(
                child: TextFormField(
                  controller: item.descriptionCtrl,
                  style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.w600),
                  decoration: const InputDecoration(
                    border: InputBorder.none,
                    hintText: "Description (e.g. Term 1 Tuition)",
                    hintStyle: TextStyle(color: AppColors.textGrey),
                  ),
                  validator: (v) {
                    // Only validate if user attempted submit AND they typed something (avoid screaming at empty templates)
                    if (!attemptedSubmit) return null;
                    final txt = (v ?? "").trim();
                    if (txt.isEmpty) return "Description required (or clear this line)";
                    return null;
                  },
                ),
              ),
              IconButton(
                onPressed: onDelete,
                icon: const Icon(Icons.delete_outline, color: AppColors.errorRed),
                tooltip: "Remove line",
              ),
            ],
          ),
          const SizedBox(height: 10),
          Row(
            children: [
              Expanded(
                flex: 3,
                child: _miniField(
                  label: "Qty",
                  controller: item.qtyCtrl,
                  inputFormatters: [
                    FilteringTextInputFormatter.digitsOnly,
                    LengthLimitingTextInputFormatter(4),
                  ],
                  align: TextAlign.center,
                ),
              ),
              const SizedBox(width: 10),
              Expanded(
                flex: 5,
                child: _miniField(
                  label: "Unit Price",
                  controller: item.unitPriceCtrl,
                  keyboardType: const TextInputType.numberWithOptions(decimal: true),
                  inputFormatters: [
                    FilteringTextInputFormatter.allow(RegExp(r'^\d*\.?\d{0,2}')),
                    LengthLimitingTextInputFormatter(12),
                  ],
                  prefix: "\$ ",
                ),
              ),
              const SizedBox(width: 10),
              Expanded(
                flex: 5,
                child: Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(40)),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Line Total", style: TextStyle(color: AppColors.textGrey, fontSize: 10)),
                      const SizedBox(height: 6),
                      Text(
                        money(item.total),
                        style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.bold),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
          if (invalid) ...[
            const SizedBox(height: 8),
            const Text(
              "Invalid line: add description + price, or remove the line.",
              style: TextStyle(color: Colors.redAccent, fontSize: 11, fontWeight: FontWeight.w600),
            ),
          ],
        ],
      ),
    );
  }

  Widget _miniField({
    required String label,
    required TextEditingController controller,
    TextInputType keyboardType = TextInputType.number,
    List<TextInputFormatter>? inputFormatters,
    TextAlign align = TextAlign.left,
    String? prefix,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(40)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 10)),
          TextField(
            controller: controller,
            keyboardType: keyboardType,
            inputFormatters: inputFormatters,
            textAlign: align,
            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
            decoration: InputDecoration(
              border: InputBorder.none,
              isDense: true,
              prefixText: prefix,
              prefixStyle: const TextStyle(color: AppColors.textGrey),
            ),
          ),
        ],
      ),
    );
  }
}

class _TotalsRow extends StatelessWidget {
  final String label;
  final String value;
  final bool bold;

  const _TotalsRow({required this.label, required this.value, this.bold = false});

  @override
  Widget build(BuildContext context) {
    final styleLabel = TextStyle(
      color: AppColors.textGrey.withAlpha(bold ? 210 : 170),
      fontSize: bold ? 12 : 11,
      fontWeight: bold ? FontWeight.bold : FontWeight.w600,
      letterSpacing: bold ? 0.8 : 0.4,
    );
    final styleValue = TextStyle(
      color: Colors.white,
      fontSize: bold ? 16 : 12,
      fontWeight: bold ? FontWeight.bold : FontWeight.w700,
    );

    return Padding(
      padding: const EdgeInsets.only(bottom: 6),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label.toUpperCase(), style: styleLabel),
          Text(value, style: styleValue),
        ],
      ),
    );
  }
}

/// ============================================================================
/// PREVIEW TEMPLATE: Uses the VM live.
/// ============================================================================
class _InvoicePaperTemplate extends StatelessWidget {
  final CreateInvoiceViewModel vm;
  const _InvoicePaperTemplate({required this.vm});

  @override
  Widget build(BuildContext context) {
    const textDark = Color(0xFF1E293B);
    const textLight = Color(0xFF64748B);

    String money(double v) => NumberFormat.currency(symbol: "\$ ", decimalDigits: 2).format(v);

    final student = vm.studentNameCtrl.text.trim().isEmpty ? "" : vm.studentNameCtrl.text.trim();
    final grade = vm.studentGradeCtrl.text.trim().isEmpty ? "" : vm.studentGradeCtrl.text.trim();
    final guardian = vm.guardianNameCtrl.text.trim().isEmpty ? "" : vm.guardianNameCtrl.text.trim();

    final df = DateFormat('MMM dd, yyyy');

    // Build printable items: ignore empty lines (serious behavior)
    final printableItems = vm.items
        .where((i) => i.isValidLine)
        .map((i) => (desc: i.description.trim(), qty: i.quantity, total: i.total))
        .toList();

    return Padding(
      padding: const EdgeInsets.all(20.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("INVOICE", style: TextStyle(color: textDark, fontSize: 20, fontWeight: FontWeight.bold, letterSpacing: 2)),
              Text(vm.invoiceNumber, style: const TextStyle(color: textLight, fontSize: 11)),
            ],
          ),
          const Divider(thickness: 2, color: textDark),
          const SizedBox(height: 10),

          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text("Issued: ${df.format(vm.issueDate)}", style: const TextStyle(color: textLight, fontSize: 10)),
              Text("Due: ${df.format(vm.dueDate)}", style: TextStyle(color: vm.isTimelineValid ? Colors.redAccent : Colors.red, fontSize: 10, fontWeight: FontWeight.bold)),
            ],
          ),

          const SizedBox(height: 14),

          // Party
          const Text("BILLED TO", style: TextStyle(color: textLight, fontSize: 9, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
          const SizedBox(height: 6),
          Text(student, style: const TextStyle(color: textDark, fontSize: 12, fontWeight: FontWeight.bold)),
          if (grade.isNotEmpty) Text(grade, style: const TextStyle(color: textDark, fontSize: 10)),
          if (guardian.isNotEmpty) Text("Payer: $guardian", style: const TextStyle(color: textLight, fontSize: 10)),

          const SizedBox(height: 16),

          // Table Header
          Container(
            padding: const EdgeInsets.symmetric(vertical: 6),
            color: Colors.grey[200],
            child: const Row(
              children: [
                Expanded(flex: 5, child: Text("  DESCRIPTION", style: TextStyle(fontSize: 9, fontWeight: FontWeight.bold))),
                Expanded(flex: 1, child: Text("QTY", textAlign: TextAlign.center, style: TextStyle(fontSize: 9, fontWeight: FontWeight.bold))),
                Expanded(flex: 2, child: Text("AMOUNT  ", textAlign: TextAlign.right, style: TextStyle(fontSize: 9, fontWeight: FontWeight.bold))),
              ],
            ),
          ),

          // Rows
          if (printableItems.isEmpty)
            Padding(
              padding: const EdgeInsets.symmetric(vertical: 18),
              child: Text(
                "No valid line items yet.",
                style: TextStyle(color: textLight.withAlpha(220), fontSize: 10, fontStyle: FontStyle.italic),
              ),
            )
          else
            ...printableItems.map(
              (x) => Padding(
                padding: const EdgeInsets.symmetric(vertical: 8),
                child: Row(
                  children: [
                    Expanded(flex: 5, child: Text("  ${x.desc}", style: const TextStyle(fontSize: 10, color: textDark))),
                    Expanded(flex: 1, child: Text("${x.qty}", textAlign: TextAlign.center, style: const TextStyle(fontSize: 10, color: textDark))),
                    Expanded(flex: 2, child: Text("${money(x.total)}  ", textAlign: TextAlign.right, style: const TextStyle(fontSize: 10, color: textDark))),
                  ],
                ),
              ),
            ),

          const Spacer(),

          const Divider(),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("TOTAL DUE", style: TextStyle(color: textDark, fontSize: 12, fontWeight: FontWeight.bold)),
              Text(money(vm.total), style: const TextStyle(color: AppColors.primaryBlue, fontSize: 16, fontWeight: FontWeight.bold)),
            ],
          ),
          const SizedBox(height: 14),
          const Center(
            child: Text(
              "KwaLegend Academy  Fees Department",
              style: TextStyle(color: textLight, fontSize: 9),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/finance/view_invoice_screen.dart
// ==========================================

// lib/screens/finance/view_invoice_screen.dart

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';

import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/repo/financial_repo.dart';
import 'package:legend/data/repo/student_repo.dart';
import 'package:legend/data/vmodels/view_invoice_view_model.dart';
import 'package:legend/screens/finance/printing_receipt_screen.dart';

// =============================================================================
// VIEW INVOICE SCREEN (Complete + matches your ViewInvoiceViewModel)
// - Uses Provider to fetch FinanceRepository + StudentRepository
// - Calls vm.load() (not loadInvoice)
// - Reads invoice/items/student from vm fields (no missing getters)
// - No map indexing on InvoiceItem (uses dynamic-safe field access)
// - WhatsApp share routes to receipt preview screen
// =============================================================================
class ViewInvoiceScreen extends StatefulWidget {
  final String? invoiceId;

  const ViewInvoiceScreen({super.key, this.invoiceId});

  @override
  State<ViewInvoiceScreen> createState() => _ViewInvoiceScreenState();
}

class _ViewInvoiceScreenState extends State<ViewInvoiceScreen> {
  ViewInvoiceViewModel? _vm;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) => _bootstrap());
  }

  void _bootstrap() {
    final id = (widget.invoiceId ?? "").trim();
    if (id.isEmpty) {
      // Hard-block: route must provide invoiceId
      setState(() {});
      return;
    }

    final financeRepo = context.read<FinanceRepository>();
    final studentRepo = context.read<StudentRepository>();

    final vm = ViewInvoiceViewModel(financeRepo, studentRepo, id);
    vm.addListener(_onVmChanged);

    setState(() => _vm = vm);

    vm.load();
  }

  void _onVmChanged() {
    if (mounted) setState(() {});
  }

  @override
  void dispose() {
    _vm?.removeListener(_onVmChanged);
    _vm?.dispose();
    super.dispose();
  }

  Future<void> _retry() async {
    await _vm?.load();
  }

  void _openReceiptScreen(ViewInvoiceViewModel vm) {
    final invoice = vm.invoice;
    final items = vm.items.map((it) {
      final qty = it.quantity <= 0 ? 1 : it.quantity;
      return {
        'desc': it.description,
        'amount': it.amount * qty,
      };
    }).toList();

    final data = {
      'id': invoice?.invoiceNumber ?? invoice?.id ?? '---',
      'date': (invoice?.createdAt ?? DateTime.now()).toIso8601String(),
      'student': vm.student?.fullName ?? '',
      'items': items,
      'total': vm.total,
      'cashier': 'System',
    };

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => PrintReceiptScreen(
          data: data,
          type: ReceiptType.invoice,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final id = (widget.invoiceId ?? "").trim();

    // -------------------------------------------------------------------------
    // HARD BLOCKER: Missing invoiceId
    // -------------------------------------------------------------------------
    if (id.isEmpty) {
      return Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        appBar: AppBar(
          backgroundColor: AppColors.backgroundBlack,
          elevation: 0,
          leading: IconButton(
            icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
            onPressed: () => context.pop(),
          ),
          title: const Text(
            "Invoice Details",
            style: TextStyle(fontWeight: FontWeight.bold),
          ),
        ),
        body: const Center(
          child: Padding(
            padding: EdgeInsets.all(20),
            child: Text(
              "Missing invoiceId.\nThis screen must be opened with a valid invoice id.",
              style: TextStyle(color: Colors.white70, height: 1.3),
              textAlign: TextAlign.center,
            ),
          ),
        ),
      );
    }

    // -------------------------------------------------------------------------
    // BEFORE VM BOOTSTRAPS
    // -------------------------------------------------------------------------
    if (_vm == null) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(
          child: CircularProgressIndicator(color: AppColors.primaryBlue),
        ),
      );
    }

    final vm = _vm!;

    // -------------------------------------------------------------------------
    // LOADING
    // -------------------------------------------------------------------------
    if (vm.isLoading) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
      );
    }

    // -------------------------------------------------------------------------
    // ERROR
    // -------------------------------------------------------------------------
    if (vm.error != null) {
      return Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        appBar: AppBar(
          backgroundColor: AppColors.backgroundBlack,
          elevation: 0,
          leading: IconButton(
            icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
            onPressed: () => context.pop(),
          ),
          title: const Text(
            "Invoice Details",
            style: TextStyle(fontWeight: FontWeight.bold),
          ),
        ),
        body: Center(
          child: Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  vm.error!,
                  style: const TextStyle(color: Colors.white70),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 14),
                SizedBox(
                  height: 46,
                  child: ElevatedButton(
                    onPressed: _retry,
                    child: const Text("Retry"),
                  ),
                ),
              ],
            ),
          ),
        ),
      );
    }

    final invoiceNumber = _invoiceNumber(vm.invoice);
    final heroTag = "invoice_paper_$id";

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,

      // APP BAR
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: Column(
          children: [
            const Text(
              "Invoice Details",
              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
            ),
            Text(
              invoiceNumber,
              style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
            ),
          ],
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.edit_note, color: Colors.white),
            tooltip: "Edit Invoice",
            onPressed: () {
              _openReceiptScreen(vm);
            },
          ),
          IconButton(
            icon: const Icon(Icons.print, color: Colors.white),
            tooltip: "Print",
            onPressed: () {
              _openReceiptScreen(vm);
            },
          ),
        ],
      ),

      // BODY: ZOOMABLE PAPER
      body: Container(
        color: const Color(0xFF121212),
        child: InteractiveViewer(
          minScale: 0.5,
          maxScale: 4.0,
          boundaryMargin: const EdgeInsets.all(40),
          child: Center(
            child: Hero(
              tag: heroTag,
              child: _InvoicePaper(vm: vm),
            ),
          ),
        ),
      ),

      // ACTION BAR (kept but not tied to VM because your VM doesn't implement it)
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: SizedBox(
            height: 56,
            child: ElevatedButton.icon(
              onPressed: () => _openReceiptScreen(vm),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF25D366),
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                elevation: 8,
              ),
              icon: const Icon(Icons.share, size: 22),
              label: const Text(
                "SHARE VIA WHATSAPP",
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900, letterSpacing: 1.0),
              ),
            ),
          ),
        ),
      ),
    );
  }

  // ----------------------------------------------------------------------------
  // SAFE HELPERS (no assumptions about missing fields)
  // ----------------------------------------------------------------------------

  String _invoiceNumber(Invoice? invoice) {
    if (invoice == null) return "";
    final d = invoice as dynamic;
    try {
      final v = d.invoiceNumber;
      if (v != null) return v.toString();
    } catch (_) {}
    try {
      final v = d.id;
      if (v != null) return v.toString();
    } catch (_) {}
    return "";
  }
}

// =============================================================================
// PAPER WIDGET (A4 Representation)
// Uses VM fields that exist: invoice, items (List<InvoiceItem>), student, total
// =============================================================================
class _InvoicePaper extends StatelessWidget {
  final ViewInvoiceViewModel vm;

  const _InvoicePaper({required this.vm});

  String _money(num v) => "\$${v.toStringAsFixed(2)}";

  DateTime _dueDate(Invoice? invoice) {
    if (invoice == null) return DateTime.now();
    final d = invoice as dynamic;
    try {
      final v = d.dueDate;
      if (v is DateTime) return v;
      if (v != null) return DateTime.tryParse(v.toString()) ?? DateTime.now();
    } catch (_) {}
    return DateTime.now();
  }

  String _statusLabel(Invoice? invoice) {
    if (invoice == null) return "UNKNOWN";
    final d = invoice as dynamic;
    try {
      final v = d.status;
      if (v == null) return "UNKNOWN";
      final s = v.toString().split('.').last.toUpperCase();
      return s;
    } catch (_) {}
    return "UNKNOWN";
  }

  String _studentName(Student? student) {
    return student?.fullName ?? "";
  }

  String _itemDesc(InvoiceItem it) {
    final d = it as dynamic;
    try {
      final v = d.description;
      if (v != null && v.toString().trim().isNotEmpty) return v.toString().trim();
    } catch (_) {}
    try {
      final v = d.desc;
      if (v != null && v.toString().trim().isNotEmpty) return v.toString().trim();
    } catch (_) {}
    try {
      final v = d.title;
      if (v != null && v.toString().trim().isNotEmpty) return v.toString().trim();
    } catch (_) {}
    return "Item";
  }

  int _itemQty(InvoiceItem it) {
    final d = it as dynamic;
    try {
      final v = d.quantity;
      if (v is int) return v <= 0 ? 1 : v;
      if (v is num) return v.toInt() <= 0 ? 1 : v.toInt();
    } catch (_) {}
    return 1;
  }

  double _itemUnit(InvoiceItem it) {
    final d = it as dynamic;
    try {
      final v = d.amount;
      if (v is num) return v.toDouble();
    } catch (_) {}
    try {
      final v = d.unitPrice;
      if (v is num) return v.toDouble();
    } catch (_) {}
    return 0.0;
  }

  String _invoiceNumber(Invoice? invoice) {
    if (invoice == null) return "";
    final d = invoice as dynamic;
    try {
      final v = d.invoiceNumber;
      if (v != null) return v.toString();
    } catch (_) {}
    try {
      final v = d.id;
      if (v != null) return v.toString();
    } catch (_) {}
    return "";
  }

  @override
  Widget build(BuildContext context) {
    final invoice = vm.invoice;
    final due = _dueDate(invoice);
    final status = _statusLabel(invoice);
    final invoiceNumber = _invoiceNumber(invoice);
    final studentName = _studentName(vm.student);

    return Container(
      width: 350,
      height: 495,
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        boxShadow: const [BoxShadow(color: Colors.black54, blurRadius: 30, spreadRadius: -5)],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // HEADER
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Container(
                width: 40,
                height: 40,
                decoration: const BoxDecoration(color: AppColors.primaryBlue, shape: BoxShape.circle),
                child: const Icon(Icons.school, color: Colors.white, size: 20),
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  const Text(
                    "INVOICE",
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.w900,
                      letterSpacing: 3,
                      color: Color(0xFF1E293B),
                    ),
                  ),
                  Text(
                    "# $invoiceNumber",
                    style: const TextStyle(fontSize: 10, color: Color(0xFF64748B)),
                  ),
                ],
              ),
            ],
          ),

          const SizedBox(height: 20),

          // INFO GRID (no guardianName in your VM, so we show Student)
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: const [
                  Text(
                    "FROM:",
                    style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF94A3B8)),
                  ),
                  SizedBox(height: 2),
                  Text(
                    "KWA LEGEND ACADEMY",
                    style: TextStyle(fontSize: 9, fontWeight: FontWeight.bold, color: Color(0xFF1E293B)),
                  ),
                  Text(
                    "123 Education Lane\nHarare, Zimbabwe",
                    style: TextStyle(fontSize: 8, color: Color(0xFF475569)),
                  ),
                ],
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  const Text(
                    "BILL TO:",
                    style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF94A3B8)),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    studentName,
                    style: const TextStyle(fontSize: 9, fontWeight: FontWeight.bold, color: Color(0xFF1E293B)),
                  ),
                  Text(
                    "Due: ${DateFormat('dd MMM yyyy').format(due)}",
                    style: const TextStyle(fontSize: 8, color: Colors.redAccent, fontWeight: FontWeight.bold),
                  ),
                  Text(
                    "Status: $status",
                    style: const TextStyle(fontSize: 8, color: Color(0xFF94A3B8)),
                  ),
                ],
              ),
            ],
          ),

          const SizedBox(height: 18),

          // TABLE HEADER
          Container(
            padding: const EdgeInsets.symmetric(vertical: 6, horizontal: 8),
            decoration: BoxDecoration(color: const Color(0xFFF1F5F9), borderRadius: BorderRadius.circular(4)),
            child: const Row(
              children: [
                Expanded(
                  flex: 4,
                  child: Text(
                    "DESCRIPTION",
                    style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF475569)),
                  ),
                ),
                Expanded(
                  flex: 1,
                  child: Text(
                    "QTY",
                    textAlign: TextAlign.center,
                    style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF475569)),
                  ),
                ),
                Expanded(
                  flex: 2,
                  child: Text(
                    "TOTAL",
                    textAlign: TextAlign.right,
                    style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF475569)),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 8),

          // ITEMS
          Expanded(
            child: ListView.separated(
              physics: const NeverScrollableScrollPhysics(),
              itemCount: vm.items.length,
              separatorBuilder: (_, __) => const Divider(height: 12, thickness: 0.5),
              itemBuilder: (ctx, i) {
                final it = vm.items[i];
                final desc = _itemDesc(it);
                final qty = _itemQty(it);
                final unit = _itemUnit(it);
                final lineTotal = unit * qty;

                return Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8),
                  child: Row(
                    children: [
                      Expanded(
                        flex: 4,
                        child: Text(
                          desc,
                          style: const TextStyle(fontSize: 9, color: Color(0xFF1E293B)),
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      Expanded(
                        flex: 1,
                        child: Text(
                          "$qty",
                          textAlign: TextAlign.center,
                          style: const TextStyle(fontSize: 9, color: Color(0xFF1E293B)),
                        ),
                      ),
                      Expanded(
                        flex: 2,
                        child: Text(
                          _money(lineTotal),
                          textAlign: TextAlign.right,
                          style: const TextStyle(
                            fontSize: 9,
                            fontWeight: FontWeight.w700,
                            color: Color(0xFF1E293B),
                          ),
                        ),
                      ),
                    ],
                  ),
                );
              },
            ),
          ),

          // TOTALS
          const Divider(thickness: 1.5, color: Color(0xFFE2E8F0)),
          const SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              const Text(
                "TOTAL:",
                style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Color(0xFF64748B)),
              ),
              const SizedBox(width: 8),
              Text(
                _money(vm.total),
                style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900, color: AppColors.primaryBlue),
              ),
            ],
          ),

          const SizedBox(height: 18),

          // FOOTER
          const Center(
            child: Text(
              "Banking Details: Stanbic Bank | Acc: 9140001234 | Branch: Samora Machel",
              style: TextStyle(fontSize: 7, color: Color(0xFF94A3B8), fontStyle: FontStyle.italic),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/finance/printing_receipt_screen.dart
// ==========================================

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/data/services/auth/auth.dart';
import 'package:path/path.dart' as p;
import 'package:path_provider/path_provider.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:provider/provider.dart';
import 'package:url_launcher/url_launcher.dart';

enum ReceiptType { invoice, payment }

class PrintReceiptScreen extends StatefulWidget {
  final Map<String, dynamic> data;
  final ReceiptType type;

  const PrintReceiptScreen({
    super.key,
    required this.data,
    this.type = ReceiptType.payment,
  });

  @override
  State<PrintReceiptScreen> createState() => _PrintReceiptScreenState();
}

class _PrintReceiptScreenState extends State<PrintReceiptScreen> {
  bool _isGenerating = false;

  String _schoolName() {
    final school = context.read<AuthService>().activeSchool;
    return (widget.data['school'] ?? school?.name ?? "School").toString();
  }

  String _schoolAddress() {
    final school = context.read<AuthService>().activeSchool;
    return (widget.data['address'] ?? school?.address ?? "").toString();
  }

  String _currencySymbol() {
    final school = context.read<AuthService>().activeSchool;
    final currency =
        (widget.data['currency'] ?? school?.currency ?? "USD").toString().toUpperCase();
    switch (currency) {
      case 'USD':
        return '\$';
      case 'ZWL':
        return 'Z\$';
      case 'GBP':
        return '';
      case 'EUR':
        return '';
      default:
        return '\$';
    }
  }

  // ---------------------------------------------------------------------------
  // PROFESSIONAL ACTIONS
  // ---------------------------------------------------------------------------

  Future<void> _handlePrintOrOpen() async {
    setState(() => _isGenerating = true);

    try {
      final Uint8List pdfBytes = widget.type == ReceiptType.invoice
          ? await _generateProfessionalInvoicePDF()
          : await _generateThermalReceiptPDF();

      final dir = await getTemporaryDirectory();
      final filename =
          "${widget.type == ReceiptType.invoice ? 'INV' : 'RCT'}-${widget.data['id'] ?? 'DRAFT'}.pdf";
      final file = File(p.join(dir.path, filename));
      await file.writeAsBytes(pdfBytes);

      final uri = Uri.file(file.path);

      bool opened = false;
      try {
        opened = await launchUrl(uri, mode: LaunchMode.externalApplication);
      } catch (e) {
        debugPrint("LaunchURL error: $e");
      }

      if (mounted) {
        setState(() => _isGenerating = false);
        if (opened) {
          _showSnack("Document opened. Use system menu to Print.", isError: false);
        } else {
          _showSnack("Saved to: ${file.path}", isError: true);
        }
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isGenerating = false);
        _showSnack("Generation Failed: $e", isError: true);
      }
    }
  }

  void _handleShareOptions() {
    showModalBottomSheet(
      context: context,
      backgroundColor: const Color(0xFF1E1E1E),
      builder: (ctx) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ListTile(
              leading: const Icon(Icons.copy, color: Colors.white),
              title: const Text("Copy Details", style: TextStyle(color: Colors.white)),
              onTap: () {
                Navigator.pop(ctx);
                Clipboard.setData(ClipboardData(text: _buildOutgoingMessage()));
                _showSnack("Copied to clipboard", isError: false);
              },
            ),
            ListTile(
              leading: const Icon(Icons.message, color: Colors.green),
              title: const Text("Send via WhatsApp", style: TextStyle(color: Colors.white)),
              onTap: () {
                Navigator.pop(ctx);
                _launchWhatsApp();
              },
            ),
            ListTile(
              leading: const Icon(Icons.email_outlined, color: Colors.white),
              title: const Text("Send via Email", style: TextStyle(color: Colors.white)),
              onTap: () {
                Navigator.pop(ctx);
                _launchEmail();
              },
            ),
          ],
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // PDF GENERATOR: INVOICE (A4 Professional)
  // ---------------------------------------------------------------------------
  Future<Uint8List> _generateProfessionalInvoicePDF() async {
    final pdf = pw.Document();

    final PdfColor primaryColor = PdfColor.fromInt(0xFF2196F3);
    final PdfColor accentColor = PdfColor.fromInt(0xFFEEEEEE);

    final id = widget.data['id']?.toString() ?? "INV-000";
    final date = _formatDate(widget.data['date']);
    final student = widget.data['student']?.toString() ?? "Student";
    final total = (widget.data['total'] as num?)?.toDouble() ?? 0.0;
    final items = (widget.data['items'] as List?) ?? [];
    final school = _schoolName();
    final address = _schoolAddress();
    final currency = _currencySymbol();

    pdf.addPage(
      pw.MultiPage(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(40),
        build: (pw.Context context) {
          return [
            pw.Row(
              mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Column(
                  crossAxisAlignment: pw.CrossAxisAlignment.start,
                  children: [
                    pw.Text(
                      school,
                      style: pw.TextStyle(
                        fontSize: 20,
                        fontWeight: pw.FontWeight.bold,
                        color: primaryColor,
                      ),
                    ),
                    if (address.isNotEmpty)
                      pw.Text(address, style: const pw.TextStyle(fontSize: 10)),
                  ],
                ),
                pw.Column(
                  crossAxisAlignment: pw.CrossAxisAlignment.end,
                  children: [
                    pw.Text("INVOICE",
                        style: pw.TextStyle(fontSize: 24, fontWeight: pw.FontWeight.bold)),
                    pw.SizedBox(height: 8),
                    pw.Text("Invoice #: $id"),
                    pw.Text("Date: $date"),
                  ],
                )
              ],
            ),
            pw.SizedBox(height: 40),
            pw.Container(
              padding: const pw.EdgeInsets.all(10),
              decoration: pw.BoxDecoration(
                color: accentColor,
                borderRadius: const pw.BorderRadius.all(pw.Radius.circular(4)),
              ),
              width: double.infinity,
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text(
                    "BILL TO",
                    style: pw.TextStyle(
                      fontSize: 9,
                      fontWeight: pw.FontWeight.bold,
                      color: PdfColors.grey700,
                    ),
                  ),
                  pw.SizedBox(height: 4),
                  pw.Text(student,
                      style: pw.TextStyle(fontSize: 12, fontWeight: pw.FontWeight.bold)),
                ],
              ),
            ),
            pw.SizedBox(height: 20),
            pw.TableHelper.fromTextArray(
              headers: ['Description', 'Qty', 'Unit Price', 'Total'],
              data: items.isEmpty
                  ? [
                      ['Tuition Fees', '1', '$currency${total.toStringAsFixed(2)}', '$currency${total.toStringAsFixed(2)}']
                    ]
                  : items.map((item) {
                      final desc = item['desc'] ?? item['description'] ?? "Item";
                      final qtyNum = item['qty'] ?? item['quantity'] ?? 1;
                      final qty = (qtyNum is num) ? qtyNum.toInt() : 1;
                      final amtNum = item['amt'] ?? item['amount'] ?? 0.0;
                      final amt = (amtNum is num) ? amtNum.toDouble() : 0.0;
                      final lineTotal = amt * qty;
                      return [
                        desc.toString(),
                        qty.toString(),
                        '$currency${amt.toStringAsFixed(2)}',
                        '$currency${lineTotal.toStringAsFixed(2)}'
                      ];
                    }).toList(),
              border: null,
              headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold, color: PdfColors.white),
              headerDecoration: pw.BoxDecoration(color: primaryColor),
              cellHeight: 30,
              cellAlignments: {
                0: pw.Alignment.centerLeft,
                1: pw.Alignment.center,
                2: pw.Alignment.centerRight,
                3: pw.Alignment.centerRight,
              },
            ),
            pw.Divider(),
            pw.Container(
              alignment: pw.Alignment.centerRight,
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.end,
                children: [
                  pw.SizedBox(height: 10),
                  pw.Text("Total: $currency${total.toStringAsFixed(2)}",
                      style: pw.TextStyle(fontSize: 14, fontWeight: pw.FontWeight.bold)),
                ],
              ),
            ),
            pw.Spacer(),
            pw.Divider(color: PdfColors.grey300),
            pw.Center(
              child: pw.Text(
                "Thank you for your business. Please pay within 30 days.",
                style: const pw.TextStyle(fontSize: 10, color: PdfColors.grey600),
              ),
            ),
          ];
        },
      ),
    );
    return pdf.save();
  }

  // ---------------------------------------------------------------------------
  // PDF GENERATOR: RECEIPT (Thermal / Slip)
  // ---------------------------------------------------------------------------
  Future<Uint8List> _generateThermalReceiptPDF() async {
    final pdf = pw.Document();
    final total = (widget.data['total'] as num?)?.toDouble() ?? 0.0;
    final items = (widget.data['items'] as List?) ?? [];
    final school = _schoolName();
    final address = _schoolAddress();
    final currency = _currencySymbol();

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.roll80,
        margin: const pw.EdgeInsets.all(10),
        build: (pw.Context context) {
          return pw.Column(
            children: [
              pw.Text(school,
                  style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 14)),
              if (address.isNotEmpty) pw.Text(address, style: const pw.TextStyle(fontSize: 8)),
              pw.SizedBox(height: 10),
              pw.Text("PAYMENT RECEIPT",
                  style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 12)),
              pw.Divider(),
              pw.Row(mainAxisAlignment: pw.MainAxisAlignment.spaceBetween, children: [
                pw.Text("Date:", style: const pw.TextStyle(fontSize: 8)),
                pw.Text(_formatDate(widget.data['date']), style: const pw.TextStyle(fontSize: 8)),
              ]),
              pw.Row(mainAxisAlignment: pw.MainAxisAlignment.spaceBetween, children: [
                pw.Text("Ref:", style: const pw.TextStyle(fontSize: 8)),
                pw.Text(widget.data['id']?.toString() ?? "-", style: const pw.TextStyle(fontSize: 8)),
              ]),
              pw.Divider(),
              ...items.map((item) {
                final desc = item['desc']?.toString() ?? item['description']?.toString() ?? "Item";
                final amtNum = item['amt'] ?? item['amount'] ?? 0.0;
                final amt = (amtNum is num) ? amtNum.toDouble() : 0.0;
                return pw.Row(
                  mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
                  children: [
                    pw.Expanded(child: pw.Text(desc, style: const pw.TextStyle(fontSize: 9))),
                    pw.Text("$currency${amt.toStringAsFixed(2)}",
                        style: const pw.TextStyle(fontSize: 9)),
                  ],
                );
              }),
              pw.SizedBox(height: 10),
              pw.Divider(),
              pw.Row(mainAxisAlignment: pw.MainAxisAlignment.spaceBetween, children: [
                pw.Text("TOTAL PAID", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                pw.Text("$currency${total.toStringAsFixed(2)}",
                    style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
              ]),
              pw.SizedBox(height: 20),
              pw.Text("Retain for your records", style: const pw.TextStyle(fontSize: 8)),
            ],
          );
        },
      ),
    );
    return pdf.save();
  }

  // ---------------------------------------------------------------------------
  // HELPERS
  // ---------------------------------------------------------------------------
  void _showSnack(String msg, {required bool isError}) {
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(
      content: Text(msg, style: const TextStyle(color: Colors.white)),
      backgroundColor: isError ? AppColors.errorRed : AppColors.successGreen,
    ));
  }

  String _formatDate(dynamic date) {
    if (date == null) return DateFormat('dd MMM yyyy').format(DateTime.now());
    if (date is DateTime) return DateFormat('dd MMM yyyy').format(date);
    if (date is int) return DateFormat('dd MMM yyyy').format(DateTime.fromMillisecondsSinceEpoch(date));
    if (date is String) {
      final parsed = DateTime.tryParse(date);
      if (parsed != null) return DateFormat('dd MMM yyyy').format(parsed);
      return date;
    }
    return DateFormat('dd MMM yyyy').format(DateTime.now());
  }

  String _buildOutgoingMessage() {
    final total = (widget.data['total'] as num?)?.toDouble() ?? 0.0;
    final id = widget.data['id']?.toString() ?? "---";
    final date = _formatDate(widget.data['date']);
    final student = widget.data['student']?.toString() ?? "Customer";
    final items = (widget.data['items'] as List?) ?? [];
    final school = _schoolName();
    final currency = _currencySymbol();

    final buffer = StringBuffer()
      ..writeln("Hello $student,")
      ..writeln()
      ..writeln("Thank you for your transaction with $school.")
      ..writeln("Below are your receipt details:")
      ..writeln()
      ..writeln("Ref: $id")
      ..writeln("Date: $date")
      ..writeln("Total: $currency${total.toStringAsFixed(2)}")
      ..writeln()
      ..writeln("Items:");

    if (items.isEmpty) {
      buffer.writeln("- No items listed");
    } else {
      for (final item in items) {
        final desc = item['desc'] ?? item['description'] ?? 'Item';
        final amtNum = item['amt'] ?? item['amount'] ?? 0.0;
        final amt = (amtNum is num) ? amtNum.toDouble() : 0.0;
        buffer.writeln("- $desc: $currency${amt.toStringAsFixed(2)}");
      }
    }

    buffer
      ..writeln()
      ..writeln("If you need a PDF copy, it is available in-app.")
      ..writeln()
      ..writeln("Regards,")
      ..writeln(school);

    return buffer.toString();
  }

  Future<void> _launchWhatsApp() async {
    final text = Uri.encodeComponent(_buildOutgoingMessage());
    final url = Uri.parse("https://wa.me/?text=$text");
    if (await canLaunchUrl(url)) {
      await launchUrl(url, mode: LaunchMode.externalApplication);
    } else {
      _showSnack("Could not launch WhatsApp", isError: true);
    }
  }

  Future<void> _launchEmail() async {
    final text = _buildOutgoingMessage();
    final uri = Uri(
      scheme: 'mailto',
      queryParameters: {
        'subject': widget.type == ReceiptType.invoice ? 'Invoice Receipt' : 'Payment Receipt',
        'body': text,
      },
    );
    final ok = await launchUrl(uri, mode: LaunchMode.externalApplication);
    if (!ok) _showSnack("Could not open Email", isError: true);
  }

  // ---------------------------------------------------------------------------
  // UI BUILDER
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    final bool isA4 = widget.type == ReceiptType.invoice;
    final school = _schoolName();
    final address = _schoolAddress();
    final currency = _currencySymbol();
    final total = (widget.data['total'] as num?)?.toDouble() ?? 0.0;
    final items = (widget.data['items'] as List?) ?? [];

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        title: Text(isA4 ? "Invoice Preview" : "Receipt Preview",
            style: const TextStyle(fontSize: 16)),
        centerTitle: true,
        actions: [
          IconButton(
            icon: const Icon(Icons.share, color: Colors.white),
            onPressed: _handleShareOptions,
          )
        ],
      ),
      body: Stack(
        children: [
          SingleChildScrollView(
            padding: const EdgeInsets.fromLTRB(20, 10, 20, 100),
            child: Center(
              child: Column(
                children: [
                  _buildStatusBadge(),
                  const SizedBox(height: 20),
                  Container(
                    width: isA4 ? double.infinity : 300,
                    constraints: BoxConstraints(
                      minHeight: 400,
                      maxWidth: isA4 ? 500 : 350,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(4),
                      boxShadow: [
                        BoxShadow(
          color: Colors.black.withAlpha(128),
                          blurRadius: 20,
                          offset: const Offset(0, 10),
                        )
                      ],
                    ),
                    padding: const EdgeInsets.all(24),
                    child: isA4
                        ? _buildA4Preview(school, address, currency, total, items)
                        : _buildSlipPreview(school, currency, total),
                  ),
                ],
              ),
            ),
          ),
          Positioned(
            bottom: 30,
            left: 20,
            right: 20,
            child: SizedBox(
              height: 56,
              child: ElevatedButton(
                onPressed: _isGenerating ? null : _handlePrintOrOpen,
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryBlue,
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  elevation: 8,
                ),
                child: _isGenerating
                    ? const CircularProgressIndicator(color: Colors.white)
                    : const Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Icons.print_outlined),
                          SizedBox(width: 12),
                          Text("PRINT / SAVE PDF",
                              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        ],
                      ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatusBadge() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: Colors.white10),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(_isGenerating ? Icons.hourglass_top : Icons.check_circle,
              color: _isGenerating ? Colors.orange : AppColors.successGreen, size: 14),
          const SizedBox(width: 8),
          Text(
            _isGenerating ? "Generating PDF..." : "Ready to Generate",
            style: const TextStyle(color: Colors.white70, fontSize: 12),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // SCREEN PREVIEWS (Visual approximation of the PDF)
  // ---------------------------------------------------------------------------

  Widget _buildA4Preview(
    String school,
    String address,
    String currency,
    double total,
    List items,
  ) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(school,
                    style: const TextStyle(
                        color: AppColors.primaryBlue,
                        fontWeight: FontWeight.bold,
                        fontSize: 16)),
                if (address.isNotEmpty)
                  Text(address, style: const TextStyle(color: Colors.black54, fontSize: 10)),
              ],
            ),
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                const Text("INVOICE",
                    style: TextStyle(
                        color: Colors.black, fontSize: 20, fontWeight: FontWeight.w900, letterSpacing: 1)),
                Text("#${widget.data['id'] ?? '---'}",
                    style: const TextStyle(color: Colors.black54, fontSize: 12)),
              ],
            ),
          ],
        ),
        const SizedBox(height: 30),
        const Text("BILL TO:",
            style: TextStyle(color: Colors.black54, fontSize: 10, fontWeight: FontWeight.bold)),
        Text(widget.data['student']?.toString() ?? "N/A",
            style: const TextStyle(color: Colors.black, fontSize: 14, fontWeight: FontWeight.bold)),
        const SizedBox(height: 20),
        Container(
          padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 4),
          color: AppColors.primaryBlue.withAlpha(26),
          child: const Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text("Description",
                  style: TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold)),
              Text("Total",
                  style: TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold)),
            ],
          ),
        ),
        const SizedBox(height: 8),
        if (items.isEmpty)
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Tuition & Fees", style: TextStyle(color: Colors.black, fontSize: 12)),
              Text("$currency${total.toStringAsFixed(2)}",
                  style: const TextStyle(color: Colors.black, fontSize: 12)),
            ],
          )
        else
          ...items.map<Widget>((item) {
            final desc = item['desc'] ?? item['description'] ?? 'Item';
            final amtNum = item['amt'] ?? item['amount'] ?? 0.0;
            final amt = (amtNum is num) ? amtNum.toDouble() : 0.0;
            return Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(desc.toString(), style: const TextStyle(color: Colors.black, fontSize: 12)),
                Text("$currency${amt.toStringAsFixed(2)}",
                    style: const TextStyle(color: Colors.black, fontSize: 12)),
              ],
            );
          }),
        const Divider(height: 40),
        Row(
          mainAxisAlignment: MainAxisAlignment.end,
          children: [
            Text("Total: $currency${total.toStringAsFixed(2)}",
                style: const TextStyle(color: Colors.black, fontSize: 18, fontWeight: FontWeight.bold)),
          ],
        ),
      ],
    );
  }

  Widget _buildSlipPreview(String school, String currency, double total) {
    return Column(
      children: [
        const Icon(Icons.school, color: Colors.black, size: 40),
        const SizedBox(height: 8),
        Text(school, style: const TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        const Text("Official Receipt", style: TextStyle(color: Colors.black54, fontSize: 10)),
        const SizedBox(height: 16),
        const Divider(color: Colors.black12, thickness: 1),
        _row("Date", _formatDate(widget.data['date'])),
        _row("Ref", widget.data['id']?.toString() ?? "-"),
        const Divider(color: Colors.black12),
        const SizedBox(height: 8),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text("TOTAL PAID",
                style: TextStyle(color: Colors.black, fontWeight: FontWeight.w900, fontSize: 16)),
            Text("$currency${total.toStringAsFixed(2)}",
                style: const TextStyle(color: Colors.black, fontWeight: FontWeight.w900, fontSize: 16)),
          ],
        ),
        const SizedBox(height: 20),
        Container(
          height: 30,
          width: double.infinity,
          color: Colors.black12,
          alignment: Alignment.center,
          child: const Text("||| || ||| |||", style: TextStyle(color: Colors.black38, letterSpacing: 5)),
        )
      ],
    );
  }

  Widget _row(String label, String val) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 2),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: Colors.black54, fontSize: 11)),
          Text(val, style: const TextStyle(color: Colors.black, fontSize: 11, fontWeight: FontWeight.w500)),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/dashboard/activity_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';

class DashboardActivityScreen extends StatefulWidget {
  const DashboardActivityScreen({super.key});

  @override
  State<DashboardActivityScreen> createState() => _DashboardActivityScreenState();
}

class _DashboardActivityScreenState extends State<DashboardActivityScreen> {
  late Future<List<Map<String, dynamic>>> _future;

  @override
  void initState() {
    super.initState();
    _future = _load();
  }

  Future<List<Map<String, dynamic>>> _load() async {
    final auth = context.read<AuthService>();
    final school = auth.activeSchool;
    if (school == null) {
      throw Exception("No active school. Please log in again.");
    }
    return context.read<FinanceRepository>().getRecentActivity(school.id, limit: 50);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        title: const Text("Recent Activity", style: TextStyle(color: Colors.white)),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, size: 18, color: Colors.white),
          onPressed: () => context.pop(),
        ),
      ),
      body: FutureBuilder<List<Map<String, dynamic>>>(
        future: _future,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }
          if (snapshot.hasError) {
            return Center(
              child: Text(
                "Error: ${snapshot.error}",
                style: const TextStyle(color: AppColors.errorRed),
              ),
            );
          }

          final rows = snapshot.data ?? [];
          if (rows.isEmpty) {
            return const Center(
              child: Text("No recent activity.", style: TextStyle(color: AppColors.textGrey)),
            );
          }

          return ListView.separated(
            padding: const EdgeInsets.all(20),
            itemCount: rows.length,
            separatorBuilder: (_, __) => const SizedBox(height: 12),
            itemBuilder: (context, index) {
              final item = _sanitizeActivity(rows[index]);
              final isIncome = item['kind'] == _ActivityKind.income;

              return Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surfaceDarkGrey,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      backgroundColor: AppColors.surfaceLightGrey.withAlpha(20),
                      child: Icon(
                        isIncome ? Icons.arrow_downward : Icons.arrow_upward,
                        color: isIncome ? AppColors.successGreen : AppColors.errorRed,
                        size: 16,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(item['name'], style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          const SizedBox(height: 4),
                          Text(item['desc'], style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                        ],
                      ),
                    ),
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.end,
                      children: [
                        Text(
                          "${isIncome ? '+' : '-'}\$${item['amount'].toStringAsFixed(0)}",
                          style: TextStyle(
                            color: isIncome ? AppColors.successGreen : AppColors.errorRed,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(item['time'], style: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 10)),
                      ],
                    ),
                  ],
                ),
              );
            },
          );
        },
      ),
    );
  }

  Map<String, dynamic> _sanitizeActivity(Map<String, dynamic> raw) {
    final name = (raw['name'] ?? 'Unknown').toString().trim();
    final desc = (raw['desc'] ?? raw['description'] ?? 'No description').toString().trim();
    final amountNum = raw['amount'];
    final amount = (amountNum is num) ? amountNum.toDouble() : 0.0;
    final time = (raw['time'] ?? '').toString().trim();
    final type = (raw['type'] ?? '').toString().toLowerCase().trim();

    final kind = (type.contains('payment') || type.contains('income'))
        ? _ActivityKind.income
        : (type.contains('invoice') || type.contains('debit') || type.contains('expense'))
            ? _ActivityKind.expense
            : (amount >= 0 ? _ActivityKind.income : _ActivityKind.expense);

    return {
      'name': name,
      'desc': desc,
      'amount': amount.abs(),
      'time': time.isEmpty ? '' : time,
      'kind': kind,
    };
  }
}

enum _ActivityKind { income, expense }

// ==========================================
// FILE: ./screens/dashboard/dashboard_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

class DashboardScreen extends StatefulWidget {
  const DashboardScreen({super.key});

  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen> {
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final auth = context.read<AuthService>();
      if (auth.activeSchool == null) {
        context.go(AppRoutes.login);
      } else {
        context.read<DashboardViewModel>().init();
      }
    });
  }

  // LOGIC: Time-aware greeting
  String get _timeAwareGreeting {
    final hour = DateTime.now().hour;
    if (hour < 12) return "Good Morning,";
    if (hour < 17) return "Good Afternoon,";
    return "Good Evening,";
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<DashboardViewModel>(
      builder: (context, vm, child) {
        // 1. LOADING
        if (vm.isLoading) {
          return const Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
          );
        }

        // 2. ERROR
        if (vm.error != null) {
          final isSessionError = vm.error.toString().toLowerCase().contains('session');
          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(isSessionError ? Icons.lock_clock : Icons.error_outline, color: AppColors.errorRed, size: 48),
                  const SizedBox(height: 16),
                  Text(vm.error!, style: const TextStyle(color: AppColors.textGrey)),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: isSessionError ? () => _handleLogout(context) : vm.refresh,
                    style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
                    child: Text(isSessionError ? "Log In Again" : "Retry"),
                  ),
                ],
              ),
            ),
          );
        }

        // 3. DATA
        final profile = vm.profile ?? LegendProfile(id: '0', fullName: 'Staff', role: 'STAFF');
        final stats = vm.stats;
        final unreadStream = vm.unreadCountStream;

        return Scaffold(
          backgroundColor: AppColors.backgroundBlack,
          
          // APP BAR (Hidden/Minimal to let greeting shine)
          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            toolbarHeight: 0,
          ),

          // BODY (Pure content, no NavBars or FABs here)
          body: RefreshIndicator(
            onRefresh: vm.refresh,
            color: AppColors.primaryBlue,
            backgroundColor: AppColors.surfaceDarkGrey,
            child: SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              // Padding bottom 100 to ensure content isn't hidden behind the AppShell's GNav
              padding: const EdgeInsets.fromLTRB(20, 20, 20, 100), 
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildWelcomeHeader(context, profile, unreadStream),
                  const SizedBox(height: 24),
                  _buildMonthlyCollectionCard(context, stats),
                  const SizedBox(height: 24),
                  const Text("Quick Actions", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 12),
                  _buildQuickActions(context),
                  const SizedBox(height: 24),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      const Text("Today's Activity", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                      GestureDetector(
                        onTap: () => context.go(AppRoutes.finance),
                        child: const Text("View Ledger", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12, fontWeight: FontWeight.bold)),
                      )
                    ],
                  ),
                  const SizedBox(height: 12),
                  Row(
                    children: [
                      Expanded(
                        child: _buildActivityCard(
                          context,
                          label: "RECEIVED",
                          amount: stats.collectedToday,
                          icon: Icons.arrow_downward,
                          color: AppColors.successGreen,
                          onTap: () => context.go('${AppRoutes.dashboard}/${AppRoutes.received}'),
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: _buildActivityCard(
                          context,
                          label: "OUTSTANDING",
                          amount: stats.totalOwed,
                          icon: Icons.more_horiz,
                          color: Colors.orangeAccent,
                          onTap: () => context.go('${AppRoutes.dashboard}/${AppRoutes.outstanding}'),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 32),
                  _buildRecentPaymentsSection(context, vm.recentActivity),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  void _handleLogout(BuildContext context) async {
    await context.read<AuthService>().logout();
    if (mounted) context.go(AppRoutes.login);
  }

  // ---------------------------------------------------------------------------
  // WIDGET BUILDERS
  // ---------------------------------------------------------------------------

  Widget _buildWelcomeHeader(
    BuildContext context,
    LegendProfile profile,
    Stream<int>? unreadStream,
  ) {
    final schoolName = context.read<AuthService>().activeSchool?.name ?? "";
    final displayName = profile.fullName.trim().isEmpty ? "Staff" : profile.fullName.split(' ').first;
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(_timeAwareGreeting, style: const TextStyle(color: AppColors.textGrey, fontSize: 14)),
            const SizedBox(height: 4),
            Text(displayName, style: const TextStyle(color: Colors.white, fontSize: 28, fontWeight: FontWeight.bold)),
            const SizedBox(height: 4),
            Text(schoolName, style: TextStyle(color: AppColors.primaryBlue.withAlpha(200), fontSize: 12, fontWeight: FontWeight.bold)),
          ],
        ),
        Row(
          children: [
            _buildNotificationsButton(context, unreadStream),
            const SizedBox(width: 12),
            GestureDetector(
              onTap: () => context.go(AppRoutes.settings),
              child: Container(
                padding: const EdgeInsets.all(2),
                decoration: BoxDecoration(shape: BoxShape.circle, border: Border.all(color: AppColors.primaryBlue, width: 2)),
                child: CircleAvatar(
                  radius: 24,
                  backgroundColor: AppColors.surfaceLightGrey,
                  child: Text(profile.fullName.isNotEmpty ? profile.fullName[0].toUpperCase() : "U", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 18)),
                ),
              ),
            ),
          ],
        )
      ],
    );
  }

  Widget _buildNotificationsButton(BuildContext context, Stream<int>? unreadStream) {
    final iconButton = IconButton(
      onPressed: () => context.go('${AppRoutes.dashboard}/${AppRoutes.notifications}'),
      icon: const Icon(Icons.notifications_none, color: Colors.white),
      tooltip: "Notifications",
    );

    if (unreadStream == null) return iconButton;

    return StreamBuilder<int>(
      stream: unreadStream,
      builder: (context, snapshot) {
        final count = snapshot.data ?? 0;
        if (count <= 0) return iconButton;

        return Stack(
          clipBehavior: Clip.none,
          children: [
            iconButton,
            Positioned(
              right: 6,
              top: 6,
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: AppColors.errorRed,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Text(
                  count > 99 ? "99+" : "$count",
                  style: const TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildMonthlyCollectionCard(BuildContext context, DashboardStats stats) {
    return Material(
      color: AppColors.surfaceDarkGrey,
      borderRadius: BorderRadius.circular(24),
      child: InkWell(
        onTap: () => context.go(AppRoutes.finance),
        borderRadius: BorderRadius.circular(24),
        child: Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(24),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
          ),
          child: Row(
            children: [
              Container(
                height: 80,
                width: 80,
                decoration: BoxDecoration(
                  color: AppColors.primaryBlue.withAlpha(20),
                  shape: BoxShape.circle,
                ),
                child: const Icon(Icons.payments_outlined, color: AppColors.primaryBlue, size: 32),
              ),
              const SizedBox(width: 20),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("Today's Collection", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 8),
                    Text("\$${stats.collectedToday.toStringAsFixed(0)}", style: const TextStyle(color: AppColors.primaryBlue, fontSize: 28, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 6),
                    Text("Outstanding: \$${stats.totalOwed.toStringAsFixed(0)}", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                  ],
                ),
              ),
              const Icon(Icons.chevron_right, color: AppColors.textGrey),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildQuickActions(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: _buildActionButton(
            context,
            icon: Icons.payments_outlined,
            label: "Log\nPayment",
            onTap: () => context.go('${AppRoutes.finance}/${AppRoutes.recordPayment}'),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(child: _buildActionButton(context, icon: Icons.person_add_alt_1, label: "Add\nStudent", onTap: () => context.go('${AppRoutes.students}/${AppRoutes.addStudent}'))),
        const SizedBox(width: 12),
        Expanded(child: _buildActionButton(context, icon: Icons.bar_chart, label: "Run\nReports", onTap: () => context.push('${AppRoutes.dashboard}/${AppRoutes.statistics}'))),
      ],
    );
  }

  Widget _buildActionButton(BuildContext context, {required IconData icon, required String label, required VoidCallback onTap}) {
    return Material(
      color: AppColors.surfaceDarkGrey,
      borderRadius: BorderRadius.circular(16),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          height: 90,
          decoration: BoxDecoration(borderRadius: BorderRadius.circular(16), border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20))),
          child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(icon, color: AppColors.primaryBlue, size: 24), const SizedBox(height: 8), Text(label, textAlign: TextAlign.center, style: const TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold))]),
        ),
      ),
    );
  }

  Widget _buildActivityCard(BuildContext context, {required String label, required double amount, required IconData icon, required Color color, required VoidCallback onTap}) {
    return Material(
      color: AppColors.surfaceDarkGrey,
      borderRadius: BorderRadius.circular(16),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(children: [Icon(icon, color: color, size: 16), const SizedBox(width: 8), Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 0.5))]),
              const SizedBox(height: 12),
              Text("\$${amount.toStringAsFixed(0)}", style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildRecentPaymentsSection(BuildContext context, List<Map<String, dynamic>> payments) {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text('Recent Activity', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
            TextButton(
              onPressed: () => context.go('${AppRoutes.dashboard}/${AppRoutes.activity}'),
              child: const Text('View All', style: TextStyle(color: AppColors.primaryBlue, fontSize: 12, fontWeight: FontWeight.bold)),
            ),
          ],
        ),
        const SizedBox(height: 8),
        _buildPaymentList(payments),
      ],
    );
  }

  Widget _buildPaymentList(List<Map<String, dynamic>> payments) {
    if (payments.isEmpty) {
      return Container(
        padding: const EdgeInsets.all(24),
        width: double.infinity,
        decoration: BoxDecoration(color: AppColors.surfaceDarkGrey.withAlpha(50), borderRadius: BorderRadius.circular(16)),
        child: const Center(child: Text("No recent activity", style: TextStyle(color: AppColors.textGrey))),
      );
    }

    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: payments.length > 5 ? 5 : payments.length,
      itemBuilder: (ctx, i) {
        final p = payments[i];
        final amount = (p['amount'] as num).toDouble();
        final isPayment = amount > 0;
        final name = p['name'] as String;

        return Container(
          margin: const EdgeInsets.only(bottom: 12),
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(color: AppColors.surfaceDarkGrey, borderRadius: BorderRadius.circular(16)),
          child: Row(
            children: [
              CircleAvatar(
                backgroundColor: AppColors.surfaceLightGrey.withAlpha(50),
                radius: 18,
                child: Text(name.isNotEmpty ? name[0] : '?', style: const TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.bold)),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14)),
                    Text('${p['desc']}', style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
                  ],
                ),
              ),
              Text(
                isPayment ? '+\$${amount.toStringAsFixed(0)}' : '\$${amount.abs().toStringAsFixed(0)}',
                style: TextStyle(color: isPayment ? AppColors.successGreen : AppColors.errorRed, fontWeight: FontWeight.bold, fontSize: 14)
              ),
            ],
          ),
        );
      },
    );
  }
}

// ==========================================
// FILE: ./screens/dashboard/notifications_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

class NotificationsScreen extends StatefulWidget {
  const NotificationsScreen({super.key});

  @override
  State<NotificationsScreen> createState() => _NotificationsScreenState();
}

class _NotificationsScreenState extends State<NotificationsScreen> {
  // We use Streams to listen to the DB in real-time
  Stream<List<LegendNotification>>? _notificationsStream;

  @override
  void initState() {
    super.initState();
    // 1. Initialize the Stream safely after the widget mounts
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final authService = context.read<AuthService>();
      final vm = context.read<DashboardViewModel>();

      final school = authService.activeSchool;
      if (school != null) {
        setState(() {
          _notificationsStream =
              vm.notificationsStream ?? context.read<DashboardRepository>().watchNotifications(school.id);
        });
      }
    });
  }

  // ---------------------------------------------------------------------------
  // ACTIONS (Wired to Repository)
  // ---------------------------------------------------------------------------

  Future<void> _handleMarkAsRead(String notiId) async {
    await context.read<DashboardViewModel>().markNotificationRead(notiId);
  }

  Future<void> _handleMarkAllRead() async {
    await context.read<DashboardViewModel>().markAllNotificationsRead();
    
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("All notifications marked as read"),
          backgroundColor: AppColors.successGreen,
          behavior: SnackBarBehavior.floating,
          duration: Duration(seconds: 1),
        ),
      );
    }
  }

  Future<void> _handleClearAll() async {
    // Show confirmation dialog first
    final confirm = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: AppColors.surfaceDarkGrey,
        title: const Text("Clear All?", style: TextStyle(color: Colors.white)),
        content: const Text("This will permanently delete all notifications.", style: TextStyle(color: AppColors.textGrey)),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: const Text("Cancel"),
          ),
          TextButton(
            onPressed: () => Navigator.pop(ctx, true),
            child: const Text("Clear", style: TextStyle(color: AppColors.errorRed)),
          ),
        ],
      ),
    );

    if (confirm == true && mounted) {
      await context.read<DashboardViewModel>().clearAllNotifications();
    }
  }

  // THE COUP DE GRCE NAVIGATOR
  void _handleNotificationTap(LegendNotification noti) {
    // 1. Mark as read immediately (User Interaction Feedback)
    if (!noti.isRead) {
      _handleMarkAsRead(noti.id);
    }

    // 2. Navigate to Detail Screen
    // We pass the 'noti' object via 'extra' so the next screen renders instantly
    // The route '/dashboard/notifications/detail' corresponds to the sub-route in app_router.dart
    context.push(
      '${AppRoutes.dashboard}/${AppRoutes.notifications}/detail', 
      extra: noti,
    );
  }

  // ---------------------------------------------------------------------------
  // UI BUILD
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    // If stream is not initialized yet (rare, but possible on fast load)
    if (_notificationsStream == null) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack, 
        body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue))
      );
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      
      // APP BAR
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, size: 20, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          'Notifications',
          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.playlist_remove, color: AppColors.textGrey),
            tooltip: "Clear All",
            onPressed: _handleClearAll,
          ),
          const SizedBox(width: 8),
        ],
      ),

      // LIVE BODY
      body: StreamBuilder<List<LegendNotification>>(
        stream: _notificationsStream,
        builder: (context, snapshot) {
          // 1. Loading
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }
          
          // 2. Error
          if (snapshot.hasError) {
            return Center(child: Text("Error: ${snapshot.error}", style: const TextStyle(color: AppColors.errorRed)));
          }

          final list = snapshot.data ?? [];

          // 3. Empty
          if (list.isEmpty) {
            return _buildEmptyState();
          }

          // 4. Data
          return ListView.separated(
            padding: const EdgeInsets.all(20),
            itemCount: list.length,
            separatorBuilder: (context, index) => const SizedBox(height: 16),
            itemBuilder: (context, index) {
              return _buildGlowCard(list[index]);
            },
          );
        },
      ),
            
      // BOTTOM ACTION
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20.0),
          child: SizedBox(
            height: 50,
            child: OutlinedButton(
              onPressed: _handleMarkAllRead,
              style: OutlinedButton.styleFrom(
                side: const BorderSide(color: AppColors.surfaceLightGrey),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
              ),
              child: const Text("Mark all as read", style: TextStyle(color: Colors.white)),
            ),
          ),
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGET HELPERS
  // ---------------------------------------------------------------------------

  Widget _buildGlowCard(LegendNotification noti) {
    Color accentColor;
    IconData icon;
    Color glowColor;

    switch (noti.type) {
      case NotificationType.success:
        accentColor = const Color(0xFF10B981);
        glowColor = accentColor.withAlpha(40);
        icon = Icons.check_circle;
        break;
      case NotificationType.warning:
        accentColor = const Color(0xFFF59E0B);
        glowColor = accentColor.withAlpha(40);
        icon = Icons.priority_high;
        break;
      case NotificationType.system:
      case NotificationType.insight:
        accentColor = const Color(0xFFEF4444);
        glowColor = accentColor.withAlpha(40);
        icon = Icons.error_outline;
        break;
      case NotificationType.info:
        accentColor = AppColors.primaryBlue;
        glowColor = accentColor.withAlpha(40);
        icon = Icons.info_outline;
        break;
    }

    return GestureDetector(
      onTap: () => _handleNotificationTap(noti),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(16),
          // BORDER: Transparent if read, Colored if unread
          border: Border.all(
            color: noti.isRead ? Colors.transparent : accentColor.withAlpha(50), 
            width: 1,
          ),
          // GLOW: Only if unread
          boxShadow: [
            if (!noti.isRead)
              BoxShadow(
                color: glowColor,
                blurRadius: 16,
                offset: const Offset(0, 4),
                spreadRadius: -4,
              ),
          ],
        ),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: accentColor.withAlpha(30),
                shape: BoxShape.circle,
              ),
              child: Icon(icon, color: accentColor, size: 22),
            ),
            
            const SizedBox(width: 16),
            
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Text(
                          noti.title,
                          style: const TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 15,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      const SizedBox(width: 8),
                      Text(
                        // Simple time formatting (HH:MM)
                        "${noti.createdAt.hour}:${noti.createdAt.minute.toString().padLeft(2,'0')}", 
                        style: const TextStyle(color: AppColors.textGrey, fontSize: 11),
                      ),
                    ],
                  ),
                  const SizedBox(height: 6),
                  Text(
                    noti.message,
                    style: const TextStyle(
                      color: AppColors.textGrey,
                      fontSize: 13,
                      height: 1.4,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.notifications_none, size: 64, color: AppColors.textGrey.withAlpha(50)),
          const SizedBox(height: 16),
          const Text("No new notifications", style: TextStyle(color: AppColors.textGrey)),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/dashboard/statistics_screen.dart
// ==========================================

import 'package:fl_chart/fl_chart.dart';
import 'package:legend/app_libs.dart'; // Imports Auth, VModels, Constants

// -----------------------------------------------------------------------------
// UI IMPLEMENTATION
// -----------------------------------------------------------------------------
class StatisticsScreen extends StatefulWidget {
  const StatisticsScreen({super.key});

  @override
  State<StatisticsScreen> createState() => _StatisticsScreenState();
}

class _StatisticsScreenState extends State<StatisticsScreen> {
  // Local UI State for Filters
  String _timeFilter = 'This Term';
  String _gradeFilter = 'All Grades';

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<StatsViewModel>().loadStats(
            timeFilter: _timeFilter,
            gradeFilter: _gradeFilter,
          );
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: _buildAppBar(context),
      body: Consumer<StatsViewModel>(
        builder: (context, vm, child) {
          // 1. LOADING
          if (vm.isLoading) {
            return const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryBlue,
                strokeWidth: 2,
              ),
            );
          }

          // 2. ERROR
          if (vm.error != null) {
            return _buildErrorState(vm);
          }

          // 3. DATA READY
          final data = vm.data;
          final totalRevenue = data.totalRevenue;
          final totalOutstanding = data.outstandingDebt;
          final collectionRate = _collectionRate(totalRevenue, totalOutstanding);

          return RefreshIndicator(
            onRefresh: () => vm.loadStats(
              timeFilter: _timeFilter,
              gradeFilter: _gradeFilter,
            ),
            color: AppColors.primaryBlue,
            backgroundColor: AppColors.surfaceDarkGrey,
            child: SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // --- FILTERS ---
                  _buildFilterSection(context),
                  const SizedBox(height: 24),

                  // --- PRIMARY METRICS (HERO CARDS) ---
                  Row(
                    children: [
                      Expanded(
                        child: _buildHeroKpiCard(
                          title: "Total Revenue",
                          value: _formatAmount(totalRevenue),
                          subtitle: "Received",
                          icon: Icons.attach_money,
                          gradientColors: [
                            AppColors.primaryBlue,
                            AppColors.primaryBlue.withAlpha(150),
                          ],
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: _buildHeroKpiCard(
                          title: "Outstanding Debt",
                          value: _formatAmount(totalOutstanding),
                          subtitle: "Pending",
                          icon: Icons.warning_amber_rounded,
                          gradientColors: [
                            AppColors.errorRed.withAlpha(200),
                            AppColors.errorRed.withAlpha(100),
                          ],
                          isAlert: true,
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 12),

                  // --- SECONDARY METRICS ---
                  Row(
                    children: [
                      Expanded(
                        child: _buildSecondaryKpiCard(
                          title: "Active Students",
                          value: data.activeStudents.toString(),
                          icon: Icons.people,
                          color: Colors.white,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: _buildSecondaryKpiCard(
                          title: "Collection Rate",
                          value: "${(collectionRate * 100).toStringAsFixed(0)}%",
                          icon: Icons.pie_chart,
                          color: collectionRate >= 0.7
                              ? AppColors.successGreen
                              : Colors.orangeAccent,
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 32),

                  // --- REVENUE TRENDS ---
                  _buildSectionHeader("Revenue Trends", _timeFilter),
                  const SizedBox(height: 16),
                  _buildChartContainer(data.revenueTrend),

                  const SizedBox(height: 32),

                  // --- DEBT BY GRADE ---
                  _buildGradeFilterHeader(vm.availableGrades),
                  const SizedBox(height: 16),
                  _buildDebtList(data.debtByGrade),

                  const SizedBox(height: 32),

                  // --- PAYMENT CHANNELS ---
                  _buildSectionHeader("Payment Channels", ""),
                  const SizedBox(height: 16),
                  _buildPaymentChannels(data.paymentMethods),

                  const SizedBox(height: 48), // Bottom padding
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // SUB-WIDGETS & BUILDERS
  // ---------------------------------------------------------------------------

  PreferredSizeWidget _buildAppBar(BuildContext context) {
    return AppBar(
      backgroundColor: AppColors.backgroundBlack,
      elevation: 0,
      centerTitle: true,
      leading: IconButton(
        icon: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
          ),
          child: const Icon(Icons.arrow_back_ios_new, size: 16, color: Colors.white),
        ),
        onPressed: () => context.pop(),
      ),
      title: const Text(
        'Analytics',
        style: TextStyle(
          color: Colors.white,
          fontSize: 16,
          fontWeight: FontWeight.w600,
          letterSpacing: 0.5,
        ),
      ),
      actions: [
        IconButton(
          icon: const Icon(Icons.calendar_today_outlined, color: AppColors.textGrey, size: 20),
          onPressed: () {
            // Future feature: Date picker
          },
        ),
      ],
    );
  }

  Widget _buildErrorState(StatsViewModel vm) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.cloud_off, color: AppColors.surfaceLightGrey.withAlpha(100), size: 64),
          const SizedBox(height: 16),
          Text(
            "Could not load analytics",
            style: TextStyle(color: AppColors.textGrey, fontSize: 16),
          ),
          const SizedBox(height: 24),
          TextButton(
            onPressed: vm.refresh,
            style: TextButton.styleFrom(
              foregroundColor: AppColors.primaryBlue,
            ),
            child: const Text("Tap to Retry"),
          )
        ],
      ),
    );
  }

  Widget _buildFilterSection(BuildContext context) {
    return SizedBox(
      height: 36,
      child: ListView(
        scrollDirection: Axis.horizontal,
        children: [
          _buildFilterChip('This Term', _timeFilter, (val) => _applyFilters(context, val, _gradeFilter)),
          const SizedBox(width: 8),
          _buildFilterChip('Last Term', _timeFilter, (val) => _applyFilters(context, val, _gradeFilter)),
          const SizedBox(width: 8),
          _buildFilterChip('All Time', _timeFilter, (val) => _applyFilters(context, val, _gradeFilter)),
        ],
      ),
    );
  }

  Widget _buildFilterChip(String label, String currentSelection, Function(String) onSelect) {
    final bool isSelected = label == currentSelection;
    return GestureDetector(
      onTap: () => onSelect(label),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.primaryBlue : AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(20),
          border: isSelected
              ? null
              : Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        child: Center(
          child: Text(
            label,
            style: TextStyle(
              color: isSelected ? Colors.white : AppColors.textGrey,
              fontWeight: isSelected ? FontWeight.w600 : FontWeight.normal,
              fontSize: 12,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildHeroKpiCard({
    required String title,
    required String value,
    required String subtitle,
    required IconData icon,
    required List<Color> gradientColors,
    bool isAlert = false,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: gradientColors,
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(20),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Icon(icon, color: Colors.white.withAlpha(200), size: 20),
              if (isAlert)
                Container(
                  width: 8,
                  height: 8,
                  decoration: const BoxDecoration(
                    color: Colors.white,
                    shape: BoxShape.circle,
                  ),
                )
            ],
          ),
          const SizedBox(height: 16),
          Text(
            value,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            title,
            style: TextStyle(
              color: Colors.white.withAlpha(180),
              fontSize: 11,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSecondaryKpiCard({
    required String title,
    required String value,
    required IconData icon,
    required Color color,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: color.withAlpha(20),
              shape: BoxShape.circle,
            ),
            child: Icon(icon, color: color, size: 18),
          ),
          const SizedBox(width: 12),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                value,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Text(
                title,
                style: const TextStyle(
                  color: AppColors.textGrey,
                  fontSize: 11,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildSectionHeader(String title, String subtitle) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          title,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
        if (subtitle.isNotEmpty)
          Text(
            subtitle,
            style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
          ),
      ],
    );
  }

  Widget _buildChartContainer(List<FlSpot> spots) {
    if (spots.isEmpty) {
      return Container(
        height: 200,
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(20),
        ),
        child: const Text("No chart data available", style: TextStyle(color: AppColors.textGrey)),
      );
    }

    return Container(
      height: 240,
      padding: const EdgeInsets.only(right: 20, left: 10, top: 24, bottom: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: LineChart(
        LineChartData(
          gridData: FlGridData(
            show: true,
            drawVerticalLine: false,
            horizontalInterval: 1000, 
            getDrawingHorizontalLine: (value) {
              return FlLine(
                color: AppColors.surfaceLightGrey.withAlpha(10),
                strokeWidth: 1,
              );
            },
          ),
          titlesData: const FlTitlesData(
            show: true,
            rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            leftTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            bottomTitles: AxisTitles(
              sideTitles: SideTitles(
                showTitles: true,
                reservedSize: 22,
                interval: 1, // Simplified for visual clarity
                // In a real app, you'd map indexes to dates here
              ),
            ),
          ),
          borderData: FlBorderData(show: false),
          minY: 0,
          lineBarsData: [
            LineChartBarData(
              spots: spots,
              isCurved: true,
              color: AppColors.primaryBlue,
              barWidth: 3,
              isStrokeCapRound: true,
              dotData: const FlDotData(show: false),
              belowBarData: BarAreaData(
                show: true,
                gradient: LinearGradient(
                  colors: [
                    AppColors.primaryBlue.withAlpha(80),
                    AppColors.primaryBlue.withAlpha(0),
                  ],
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildGradeFilterHeader(List<String> grades) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionHeader("Debt by Grade", ""),
        const SizedBox(height: 12),
        SingleChildScrollView(
          scrollDirection: Axis.horizontal,
          child: Row(
            children: [
              _buildFilterChip('All Grades', _gradeFilter, (val) => _applyFilters(context, _timeFilter, val)),
              ...grades.map((grade) => Padding(
                    padding: const EdgeInsets.only(left: 8),
                    child: _buildFilterChip(grade, _gradeFilter, (val) => _applyFilters(context, _timeFilter, val)),
                  )),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildDebtList(List<Map<String, dynamic>> debtData) {
    if (debtData.isEmpty) {
      return Container(
        padding: const EdgeInsets.all(24),
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
        ),
        child: const Text("No outstanding debt records.", style: TextStyle(color: AppColors.textGrey)),
      );
    }

    double maxVal = 0;
    for (var i in debtData) {
      final v = (i['amount'] as num).toDouble();
      if (v > maxVal) maxVal = v;
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Column(
        children: debtData.map((item) {
          final amt = (item['amount'] as num).toDouble();
          final pct = maxVal > 0 ? (amt / maxVal) : 0.0;
          return Padding(
            padding: const EdgeInsets.only(bottom: 16),
            child: Row(
              children: [
                SizedBox(
                  width: 50,
                  child: Text(
                    item['grade'] ?? '-',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 13,
                    ),
                  ),
                ),
                Expanded(
                  child: Stack(
                    children: [
                      Container(
                        height: 6,
                        decoration: BoxDecoration(
                          color: Colors.black.withAlpha(100),
                          borderRadius: BorderRadius.circular(3),
                        ),
                      ),
                      FractionallySizedBox(
                        widthFactor: pct.clamp(0.0, 1.0),
                        child: Container(
                          height: 6,
                          decoration: BoxDecoration(
                            color: pct > 0.6 ? AppColors.errorRed : AppColors.primaryBlue,
                            borderRadius: BorderRadius.circular(3),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(width: 12),
                SizedBox(
                  width: 70,
                  child: Text(
                    _formatAmount(amt),
                    textAlign: TextAlign.end,
                    style: TextStyle(
                      color: pct > 0.6 ? AppColors.errorRed : AppColors.textGrey,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          );
        }).toList(),
      ),
    );
  }

  Widget _buildPaymentChannels(Map<String, double> channels) {
    if (channels.isEmpty) {
      return Container(
        width: double.infinity,
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(20),
        ),
        child: const Center(child: Text("No channel data.", style: TextStyle(color: AppColors.textGrey))),
      );
    }

    final total = channels.values.fold(0.0, (p, c) => p + c);
    final entries = channels.entries.toList();
    // Sort by value descending for better pie chart visual
    entries.sort((a, b) => b.value.compareTo(a.value));

    final colors = [
      AppColors.primaryBlue,
      Colors.cyanAccent,
      Colors.purpleAccent,
      AppColors.errorRed,
      Colors.orange,
    ];

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Row(
        children: [
          SizedBox(
            height: 120,
            width: 120,
            child: PieChart(
              PieChartData(
                sectionsSpace: 0,
                centerSpaceRadius: 30,
                sections: entries.asMap().entries.map((e) {
                  final idx = e.key;
                  final item = e.value;
                  return PieChartSectionData(
                    color: colors[idx % colors.length],
                    value: item.value,
                    radius: 20,
                    showTitle: false,
                  );
                }).toList(),
              ),
            ),
          ),
          const SizedBox(width: 24),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: entries.asMap().entries.map((e) {
                final idx = e.key;
                final item = e.value;
                final percentage = total > 0 ? (item.value / total) : 0.0;
                return Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: Row(
                    children: [
                      Container(
                        width: 8,
                        height: 8,
                        decoration: BoxDecoration(
                          color: colors[idx % colors.length],
                          shape: BoxShape.circle,
                        ),
                      ),
                      const SizedBox(width: 10),
                      Expanded(
                        child: Text(
                          item.key,
                          style: const TextStyle(color: AppColors.textGrey, fontSize: 13),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      Text(
                        "${(percentage * 100).toStringAsFixed(0)}%",
                        style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.bold),
                      ),
                    ],
                  ),
                );
              }).toList(),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // LOGIC HELPERS
  // ---------------------------------------------------------------------------

  void _applyFilters(BuildContext context, String time, String grade) {
    setState(() {
      _timeFilter = time;
      _gradeFilter = grade;
    });
    // Fire & Forget - VM handles loading state
    context.read<StatsViewModel>().loadStats(
          timeFilter: _timeFilter,
          gradeFilter: _gradeFilter,
        );
  }

  double _collectionRate(double revenue, double outstanding) {
    final total = revenue + outstanding;
    if (total <= 0) return 0.0;
    return (revenue / total).clamp(0.0, 1.0);
  }

  String _formatAmount(double value) {
    final abs = value.abs();
    if (abs >= 1000000) return "\$${(value / 1000000).toStringAsFixed(1)}M";
    if (abs >= 1000) return "\$${(value / 1000).toStringAsFixed(1)}K";
    return "\$${value.toStringAsFixed(0)}";
  }
}
// ==========================================
// FILE: ./screens/dashboard/received_payments_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

class ReceivedPaymentsScreen extends StatefulWidget {
  const ReceivedPaymentsScreen({super.key});

  @override
  State<ReceivedPaymentsScreen> createState() => _ReceivedPaymentsScreenState();
}

class _ReceivedPaymentsScreenState extends State<ReceivedPaymentsScreen> {
  late Future<List<Map<String, dynamic>>> _future;

  @override
  void initState() {
    super.initState();
    _future = _load();
  }

  Future<List<Map<String, dynamic>>> _load() async {
    final auth = context.read<AuthService>();
    final school = auth.activeSchool;
    if (school == null) {
      throw Exception("No active school. Please log in again.");
    }
    return context.read<FinanceRepository>().getRecentPayments(
          school.id,
          limit: 50,
          onDate: DateTime.now(),
        );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        title: const Text("Today's Received", style: TextStyle(color: Colors.white)),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, size: 18, color: Colors.white),
          onPressed: () => context.pop(),
        ),
      ),
      body: FutureBuilder<List<Map<String, dynamic>>>(
        future: _future,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }
          if (snapshot.hasError) {
            return Center(
              child: Text(
                "Error: ${snapshot.error}",
                style: const TextStyle(color: AppColors.errorRed),
              ),
            );
          }

          final rows = snapshot.data ?? [];
          if (rows.isEmpty) {
            return const Center(
              child: Text("No payments received today.", style: TextStyle(color: AppColors.textGrey)),
            );
          }

          return ListView.separated(
            padding: const EdgeInsets.all(20),
            itemCount: rows.length,
            separatorBuilder: (_, __) => const SizedBox(height: 12),
            itemBuilder: (context, index) {
              final row = rows[index];
              final name = (row['name'] ?? 'Unknown').toString();
              final amount = (row['amount'] as num?)?.toDouble() ?? 0.0;
              final method = (row['method'] ?? '').toString();
              final time = (row['time'] ?? '').toString();
              final studentId = (row['studentId'] ?? '').toString();

              return Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surfaceDarkGrey,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                ),
                child: InkWell(
                  onTap: studentId.isEmpty ? null : () => context.go('${AppRoutes.students}/view/$studentId'),
                  child: Row(
                    children: [
                      CircleAvatar(
                        backgroundColor: AppColors.successGreen.withAlpha(20),
                        child: const Icon(Icons.arrow_downward, color: AppColors.successGreen, size: 16),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                            const SizedBox(height: 4),
                            Text(method, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                          ],
                        ),
                      ),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          Text(
                            "+\$${amount.toStringAsFixed(0)}",
                            style: const TextStyle(color: AppColors.successGreen, fontWeight: FontWeight.bold),
                          ),
                          const SizedBox(height: 4),
                          Text(time, style: TextStyle(color: AppColors.textGrey.withAlpha(120), fontSize: 10)),
                        ],
                      ),
                    ],
                  ),
                ),
              );
            },
          );
        },
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/dashboard/notifications/noti_viewer.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/data/constants/app_routes.dart';
import 'package:legend/data/models/all_models.dart';
import 'package:legend/data/vmodels/dashboard_vmodel.dart';
import 'package:provider/provider.dart'; 
import 'package:legend/data/constants/app_constants.dart';
import 'package:legend/screens/finance/printing_receipt_screen.dart';

class NotificationDetailScreen extends StatelessWidget {
  final LegendNotification notification;

  const NotificationDetailScreen({super.key, required this.notification});

  @override
  Widget build(BuildContext context) {
    // 1. Determine Styles based on Type
    Color accentColor;
    IconData icon;
    String statusLabel;

    switch (notification.type) {
      case NotificationType.success:
        accentColor = AppColors.successGreen;
        icon = Icons.check_circle_outline;
        statusLabel = "SUCCESS";
        break;
      case NotificationType.warning:
        accentColor = Colors.orangeAccent;
        icon = Icons.warning_amber_rounded;
        statusLabel = "ATTENTION";
        break;
      case NotificationType.insight:
        accentColor = const Color(0xFF6366F1); // Indigo
        icon = Icons.auto_awesome;
        statusLabel = "INSIGHT";
        break;
      case NotificationType.system:
        accentColor = AppColors.errorRed;
        icon = Icons.dns_outlined;
        statusLabel = "SYSTEM";
        break;
      case NotificationType.info:
        accentColor = AppColors.primaryBlue;
        icon = Icons.info_outline;
        statusLabel = "INFO";
        break;
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.delete_outline, color: AppColors.textGrey),
            tooltip: "Delete Notification",
            onPressed: () async {
              // WIRED: Delete Logic
              final confirm = await showDialog<bool>(
                context: context,
                builder: (ctx) => AlertDialog(
                  backgroundColor: AppColors.surfaceDarkGrey,
                  title: const Text("Delete?", style: TextStyle(color: Colors.white)),
                  content: const Text("This cannot be undone.", style: TextStyle(color: AppColors.textGrey)),
                  actions: [
                    TextButton(
                      onPressed: () => Navigator.pop(ctx, false),
                      child: const Text("Cancel"),
                    ),
                    TextButton(
                      onPressed: () => Navigator.pop(ctx, true),
                      child: const Text("Delete", style: TextStyle(color: AppColors.errorRed)),
                    ),
                  ],
                ),
              );

              if (confirm == true && context.mounted) {
                // Call Repository
                await context.read<DashboardViewModel>().deleteNotification(notification.id);
                if (context.mounted) {
                  Navigator.pop(context); // Close detail screen
                }
              }
            },
          ),
        ],
      ),
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // ---------------------------------------------------------
                    // 1. HEADER ICON (Glow Effect)
                    // ---------------------------------------------------------
                    Center(
                      child: Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          color: accentColor.withAlpha(20),
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: accentColor.withAlpha(40),
                              blurRadius: 24,
                              spreadRadius: 8,
                            ),
                          ],
                        ),
                        child: Icon(icon, color: accentColor, size: 40),
                      ),
                    ),
                    const SizedBox(height: 32),

                    // ---------------------------------------------------------
                    // 2. METADATA ROW
                    // ---------------------------------------------------------
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        _buildTag(statusLabel, accentColor),
                        const SizedBox(width: 12),
                        Text(
                          DateFormat('MMM d, h:mm a').format(notification.createdAt),
                          style: const TextStyle(color: AppColors.textGrey, fontSize: 13),
                        ),
                      ],
                    ),
                    const SizedBox(height: 24),

                    // ---------------------------------------------------------
                    // 3. CONTENT
                    // ---------------------------------------------------------
                    Text(
                      notification.title,
                      textAlign: TextAlign.center,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 16),
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        color: AppColors.surfaceDarkGrey,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
                      ),
                      child: Text(
                        notification.message,
                        style: const TextStyle(
                          color: Colors.white70,
                          fontSize: 15,
                          height: 1.6,
                        ),
                      ),
                    ),

                    // ---------------------------------------------------------
                    // 4. CONTEXT DATA (If JSON Payload exists)
                    // ---------------------------------------------------------
                    if (notification.metadata.isNotEmpty) ...[
                      const SizedBox(height: 24),
                      const Text(
                        "ADDITIONAL DATA",
                        style: TextStyle(
                          color: AppColors.textGrey,
                          fontSize: 11,
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1.2,
                        ),
                      ),
                      const SizedBox(height: 12),
                      _buildMetadataGrid(notification.metadata),
                    ],
                  ],
                ),
              ),
            ),

            // -----------------------------------------------------------------
            // 5. ACTION BUTTON (Smart)
            // -----------------------------------------------------------------
            _buildActionButton(context, notification.metadata),
          ],
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPERS
  // ---------------------------------------------------------------------------

  Widget _buildTag(String text, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
      decoration: BoxDecoration(
        color: color.withAlpha(30),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: color.withAlpha(50)),
      ),
      child: Text(
        text,
        style: TextStyle(color: color, fontSize: 11, fontWeight: FontWeight.bold),
      ),
    );
  }

  Widget _buildMetadataGrid(Map<String, dynamic> data) {
    // Filters out complex objects, just shows simple Key-Values
    final simpleData = data.entries
        .where((e) => e.value is String || e.value is num || e.value is bool)
        .toList();

    return GridView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        childAspectRatio: 3.5,
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
      ),
      itemCount: simpleData.length,
      itemBuilder: (context, index) {
        final entry = simpleData[index];
        return Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          decoration: BoxDecoration(
            color: AppColors.surfaceLightGrey.withAlpha(30),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                entry.key.toUpperCase().replaceAll('_', ' '),
                style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 9, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 2),
              Text(
                entry.value.toString(),
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
                style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.w500),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildActionButton(BuildContext context, Map<String, dynamic> metadata) {
    // LOGIC: Check metadata keys to determine destination
    String label = "Close";
    VoidCallback onTap = () => Navigator.pop(context);
    IconData btnIcon = Icons.close;
    bool isPrimary = false;

    // WIRED: Smart Routing based on Metadata keys
    if (metadata.containsKey('invoice_id')) {
      label = "View Invoice";
      btnIcon = Icons.receipt_long;
      isPrimary = true;
      onTap = () {
        // Route: /finance/invoice/:invoiceId
        final invoiceId = metadata['invoice_id'];
        context.push('${AppRoutes.finance}/${AppRoutes.viewInvoice}'.replaceAll(':invoiceId', invoiceId));
      };
    } else if (metadata.containsKey('student_id')) {
      label = "View Student Profile";
      btnIcon = Icons.person_search;
      isPrimary = true;
      onTap = () {
        // Route: /students/view/:studentId
        final studentId = metadata['student_id'];
        context.push('${AppRoutes.students}/view/$studentId');
      };
    } else if (metadata['route'] is String) {
      final route = metadata['route'] as String;
      label = "Open";
      btnIcon = Icons.open_in_new;
      isPrimary = true;
      onTap = () => context.go(route);
    } else if (metadata.containsKey('action_url')) {
      label = "Open Link";
      btnIcon = Icons.open_in_new;
      isPrimary = true;
      onTap = () {
        final now = DateTime.now();
        final data = {
          'id': notification.id,
          'date': now.toIso8601String(),
          'student': notification.title,
          'items': [
            {
              'desc': notification.message,
              'amount': 0.0,
            }
          ],
          'total': 0.0,
          'cashier': 'System',
        };

        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (_) => PrintReceiptScreen(
              data: data,
              type: ReceiptType.invoice,
            ),
          ),
        );
      };
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: const BoxDecoration(
        border: Border(top: BorderSide(color: AppColors.surfaceLightGrey, width: 0.5)),
        color: AppColors.surfaceDarkGrey,
      ),
      child: SafeArea(
        top: false,
        child: SizedBox(
          width: double.infinity,
          height: 50,
          child: ElevatedButton.icon(
            onPressed: onTap,
            style: ElevatedButton.styleFrom(
              backgroundColor: isPrimary ? AppColors.primaryBlue : AppColors.surfaceLightGrey,
              foregroundColor: Colors.white,
              elevation: isPrimary ? 4 : 0,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            ),
            icon: Icon(btnIcon, size: 18),
            label: Text(label, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
          ),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/dashboard/outstanding_screen.dart
// ==========================================

import 'package:legend/app_libs.dart';
import 'package:legend/data/constants/app_routes.dart';

class OutstandingStudentsScreen extends StatefulWidget {
  const OutstandingStudentsScreen({super.key});

  @override
  State<OutstandingStudentsScreen> createState() => _OutstandingStudentsScreenState();
}

class _OutstandingStudentsScreenState extends State<OutstandingStudentsScreen> {
  late Future<List<Map<String, dynamic>>> _future;

  @override
  void initState() {
    super.initState();
    _future = _load();
  }

  Future<List<Map<String, dynamic>>> _load() async {
    final auth = context.read<AuthService>();
    final school = auth.activeSchool;
    if (school == null) {
      throw Exception("No active school. Please log in again.");
    }
    return context.read<FinanceRepository>().getOutstandingStudents(school.id, limit: 50);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        title: const Text("Outstanding Balances", style: TextStyle(color: Colors.white)),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, size: 18, color: Colors.white),
          onPressed: () => context.pop(),
        ),
      ),
      body: FutureBuilder<List<Map<String, dynamic>>>(
        future: _future,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }
          if (snapshot.hasError) {
            return Center(
              child: Text(
                "Error: ${snapshot.error}",
                style: const TextStyle(color: AppColors.errorRed),
              ),
            );
          }

          final rows = snapshot.data ?? [];
          if (rows.isEmpty) {
            return const Center(
              child: Text("No outstanding balances.", style: TextStyle(color: AppColors.textGrey)),
            );
          }

          return ListView.separated(
            padding: const EdgeInsets.all(20),
            itemCount: rows.length,
            separatorBuilder: (_, __) => const SizedBox(height: 12),
            itemBuilder: (context, index) {
              final row = rows[index];
              final name = (row['name'] ?? 'Unknown').toString();
              final grade = (row['grade'] ?? '').toString();
              final amount = (row['amount'] as num?)?.toDouble() ?? 0.0;
              final studentId = (row['id'] ?? '').toString();

              return Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surfaceDarkGrey,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      backgroundColor: AppColors.errorRed.withAlpha(20),
                      child: Text(
                        name.isNotEmpty ? name[0].toUpperCase() : "?",
                        style: const TextStyle(color: Colors.white),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          const SizedBox(height: 4),
                          Text("Grade $grade", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                        ],
                      ),
                    ),
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.end,
                      children: [
                        Text(
                          "\$${amount.toStringAsFixed(0)}",
                          style: const TextStyle(color: AppColors.errorRed, fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 8),
                        Row(
                          children: [
                            TextButton(
                              onPressed: studentId.isEmpty ? null : () => context.go('${AppRoutes.students}/view/$studentId'),
                              child: const Text("View", style: TextStyle(color: AppColors.textGrey, fontSize: 11)),
                            ),
                            TextButton(
                              onPressed: studentId.isEmpty
                                  ? null
                                  : () => context.go(
                                        '${AppRoutes.finance}/${AppRoutes.recordPayment}?studentId=$studentId',
                                      ),
                              child: const Text("Log Payment", style: TextStyle(color: AppColors.primaryBlue, fontSize: 11)),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ],
                ),
              );
            },
          );
        },
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/all_screens_export.dart
// ==========================================

export 'auth/login_screen.dart';
export 'auth/forgot_password.dart';
export 'auth/sign_up_screen.dart';
export 'dashboard/dashboard_screen.dart';
export 'dashboard/notifications_screen.dart';
export 'dashboard/statistics_screen.dart';
export 'dashboard/outstanding_screen.dart';
export 'dashboard/received_payments_screen.dart';
export 'dashboard/activity_screen.dart';
export 'students/students_screen.dart';
export 'finance/finance_screen.dart';
export 'settings/settings_screen.dart';
export 'package:legend/data/models/all_models.dart';
export 'package:legend/screens/finance/create_invoice_screen.dart';
export 'package:legend/screens/finance/record_payment_screen.dart';
export 'package:legend/screens/finance/view_invoice_screen.dart';
export 'package:legend/screens/students/add_student_screen.dart';
export 'package:legend/screens/students/student_logs_screen.dart';
export 'package:legend/screens/students/student_invoices_screen.dart';
export 'package:legend/screens/students/view_student_screen.dart';
export 'package:legend/screens/settings/contact_dev_screen.dart';
export 'package:legend/screens/settings/tos_screen.dart';

// ==========================================
// FILE: ./app_init.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:legend/data/constants/env.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:legend/data/services/database_serv.dart';

class AppInit {
  static Future<void> initialize() async {
    WidgetsFlutterBinding.ensureInitialized();

    // 1. Initialize Supabase first
    await Supabase.initialize(
      url: AppEnv.supabaseUrl,
      anonKey: AppEnv.supabaseAnonKey,
      debug: false,
    );
    debugPrint(" Supabase initialized");

    // 2. Initialize PowerSync Database (offline-first layer)
    await DatabaseService().initializeStandalone();
    debugPrint(" PowerSync standalone mode ready (awaiting auth)");

    // Simulate startup delay for splash effect
    await Future.delayed(const Duration(milliseconds: 500));
    debugPrint(" AppInit complete");
  }
}


// ==========================================
// FILE: ./app.dart
// ==========================================

import 'app_libs.dart';
import 'package:legend/data/services/billing/billing_engine.dart';

class KwaLegendApp extends StatefulWidget {
  const KwaLegendApp({super.key});

  @override
  State<KwaLegendApp> createState() => _KwaLegendAppState();
}

class _KwaLegendAppState extends State<KwaLegendApp> with WidgetsBindingObserver {
  // We store the router here so it doesn't get recreated on every build
  late final LegendRouter _legendRouter;
  late final AuthService _authService;

  @override
  void initState() {
    super.initState();
    // Read auth service once to initialize router
    _authService = context.read<AuthService>();
    _legendRouter = LegendRouter(_authService);
    WidgetsBinding.instance.addObserver(this);
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state != AppLifecycleState.resumed) return;
    final schoolId = _authService.activeSchool?.id;
    if (schoolId == null) return;
    BillingEngine().runDaily(schoolId);
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: 'KwaLegend',
      debugShowCheckedModeBanner: false,
      
      // Theme Config
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: AppColors.backgroundBlack,
        primaryColor: AppColors.primaryBlue,
        colorScheme: const ColorScheme.dark(
          primary: AppColors.primaryBlue,
          secondary: AppColors.primaryBlueLight,
          surface: AppColors.surfaceDarkGrey,
        ),
        useMaterial3: true,
      ),

      // CONNECT THE SMART ROUTER
      routerConfig: _legendRouter.router,
    );
  }
}

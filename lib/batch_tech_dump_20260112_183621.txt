
// ==========================================
// FILE: ./main.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

// 1. INIT & APP
import 'package:legend/app_init.dart';
import 'package:legend/app.dart';

// 2. REPOSITORIES
import 'package:legend/repo/auth/auth_repo.dart';
import 'package:legend/repo/auth/school_repo.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:legend/vmodels/students_vmodel.dart'; // Contains PowerSyncStudentRepository
import 'package:legend/vmodels/finance_vmodel.dart';  // Contains PowerSyncFinanceRepository

// 3. SERVICES & VIEW MODELS
import 'package:legend/services/auth/auth_serv.dart';
import 'package:legend/vmodels/settings_vmodel.dart';

void main() async {
  // ---------------------------------------------------------------------------
  // 1. SYSTEM INITIALIZATION
  // ---------------------------------------------------------------------------
  await AppInit.initialize();
  final supabaseClient = Supabase.instance.client;

  // ---------------------------------------------------------------------------
  // 2. BUILD DATA LAYER (Repositories)
  // ---------------------------------------------------------------------------
  // These are stateless or singleton-like workers that talk to DB/API.
  final authRepository = AuthRepository(supabaseClient);
  final schoolRepository = SchoolRepository(supabaseClient);
  final dashboardRepository = DashboardRepository();
  final studentRepository = PowerSyncStudentRepository();
  final financeRepository = PowerSyncFinanceRepository();

  // ---------------------------------------------------------------------------
  // 3. BUILD SERVICE LAYER (Business Logic)
  // ---------------------------------------------------------------------------
  // AuthService needs Repos to function.
  final authService = AuthService(authRepository, schoolRepository);

  // ---------------------------------------------------------------------------
  // 4. LAUNCH APP WITH PROVIDERS
  // ---------------------------------------------------------------------------
  runApp(
    MultiProvider(
      providers: [
        // --- LEVEL 1: CORE SERVICES ---
        // Accessible everywhere. Handles User Session.
        ChangeNotifierProvider<AuthService>(
          create: (_) => authService,
        ),

        // --- LEVEL 2: REPOSITORIES ---
        // Accessible to ViewModels and Screens for direct data fetching.
        Provider<DashboardRepository>(
          create: (_) => dashboardRepository,
        ),
        Provider<StudentRepository>(
          create: (_) => studentRepository,
        ),
        Provider<FinanceRepository>(
          create: (_) => financeRepository,
        ),

        // --- LEVEL 3: GLOBAL VIEW MODELS ---
        // State that persists across screens or is needed by the Shell.
        
        // Settings needs Auth & Dashboard Repo (for profile)
        ChangeNotifierProvider<SettingsViewModel>(
          create: (context) => SettingsViewModel(
            context.read<AuthService>(),
            context.read<DashboardRepository>(),
          ),
        ),

        // Finance VM is heavy, better to instantiate it here if we want 
        // state to persist between tab switches.
        ChangeNotifierProvider<FinanceViewModel>(
          create: (context) => FinanceViewModel(
            context.read<FinanceRepository>(),
            context.read<AuthService>(),
          ),
        ),
      ],
      child: const KwaLegendApp(),
    ),
  );
}
// ==========================================
// FILE: ./vmodels/settings_vmodel.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/models/legend.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:shared_preferences/shared_preferences.dart';

// =============================================================================
// SETTINGS VIEW MODEL
// =============================================================================
class SettingsViewModel extends ChangeNotifier {
  final AuthService _authService;
  final DashboardRepository _dashboardRepo;

  // ---------------------------------------------------------------------------
  // STATE
  // ---------------------------------------------------------------------------
  bool isLoading = true;
  String? error;

  // User Preferences
  bool isDarkMode = true;
  bool pushNotifications = true;

  // User Profile
  LegendProfile? userProfile;
  String? schoolName;

  // Computed properties for null safety
  String? get userName => userProfile?.fullName;
  String? get userRole => userProfile?.role;

  // ---------------------------------------------------------------------------
  // CONSTRUCTOR
  // ---------------------------------------------------------------------------
  SettingsViewModel(this._authService, this._dashboardRepo);

  // ---------------------------------------------------------------------------
  // INITIALIZATION
  // ---------------------------------------------------------------------------
  Future<void> init() async {
    isLoading = true;
    notifyListeners();

    try {
      await _loadSettings();
      await _loadUserProfile();
      error = null;
    } catch (e) {
      error = e.toString();
      debugPrint("Settings VM Init Error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // SETTINGS MANAGEMENT
  // ---------------------------------------------------------------------------
  Future<void> _loadSettings() async {
    final prefs = await SharedPreferences.getInstance();
    isDarkMode = prefs.getBool('isDarkMode') ?? true;
    pushNotifications = prefs.getBool('pushNotifications') ?? true;
  }

  Future<void> _saveSettings() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('isDarkMode', isDarkMode);
    await prefs.setBool('pushNotifications', pushNotifications);
  }

  Future<void> toggleDarkMode() async {
    isDarkMode = !isDarkMode;
    await _saveSettings();
    notifyListeners();
  }

  Future<void> togglePushNotifications() async {
    pushNotifications = !pushNotifications;
    await _saveSettings();
    notifyListeners();
  }

  // ---------------------------------------------------------------------------
  // USER PROFILE
  // ---------------------------------------------------------------------------
  Future<void> _loadUserProfile() async {
    final user = _authService.user;
    final school = _authService.activeSchool;

    if (user != null) {
      try {
        userProfile = await _dashboardRepo.getUserProfile(user.id);
      } catch (e) {
        debugPrint("Error loading user profile: $e");
      }
    }

    if (school != null) {
      schoolName = school.name;
    }
  }

  // ---------------------------------------------------------------------------
  // AUTH ACTIONS
  // ---------------------------------------------------------------------------
  Future<void> logout() async {
    try {
      await _authService.logout();
      // Navigation will be handled by the screen
    } catch (e) {
      error = e.toString();
      debugPrint("Logout Error: $e");
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // ACTIONS
  // ---------------------------------------------------------------------------
  Future<void> refresh() async {
    await init();
  }
}

// ==========================================
// FILE: ./vmodels/finance_vmodel.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/models/billing_models.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:legend/vmodels/students_vmodel.dart';

// =============================================================================
// FINANCE VIEW MODEL
// =============================================================================
class FinanceViewModel extends ChangeNotifier {
  final FinanceRepository _financeRepo;
  final AuthService _authService;

  // ---------------------------------------------------------------------------
  // STATE
  // ---------------------------------------------------------------------------
  bool isLoading = true;
  String? error;

  // Overview Stats
  double totalRevenue = 0.0;
  double pendingAmount = 0.0;
  int unpaidInvoiceCount = 0;
  double percentGrowth = 0.0;

  // Chart Data
  List<double> monthlyCollections = [];
  List<String> monthLabels = [];

  // Activity
  List<Map<String, dynamic>> recentActivity = [];

  // Invoice Creation State
  bool isCreatingInvoice = false;
  String? invoiceCreationError;

  // Payment Recording State
  bool isRecordingPayment = false;
  String? paymentRecordingError;

  // Invoice Viewing
  Invoice? currentInvoice;
  List<InvoiceItem> currentInvoiceItems = [];
  bool isLoadingInvoice = false;

  // ---------------------------------------------------------------------------
  // CONSTRUCTOR
  // ---------------------------------------------------------------------------
  FinanceViewModel(this._financeRepo, this._authService);

  // ---------------------------------------------------------------------------
  // INITIALIZATION
  // ---------------------------------------------------------------------------
  Future<void> init() async {
    isLoading = true;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) {
        // Don't throw - just set error state and wait for user to log in
        error = "Please log in to view finance data";
        isLoading = false;
        notifyListeners();
        return;
      }

      // Load overview data
      await _loadOverviewStats(school.id);
      await _loadRecentActivity(school.id);

      error = null;
    } catch (e) {
      error = e.toString();
      debugPrint("Finance VM Init Error: $e");
    } finally {
      isLoading = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // OVERVIEW METHODS
  // ---------------------------------------------------------------------------
  Future<void> _loadOverviewStats(String schoolId) async {
    final stats = await _financeRepo.getFinanceStats(schoolId);

    totalRevenue = stats['totalRevenue'];
    pendingAmount = stats['pendingAmount'];
    unpaidInvoiceCount = stats['unpaidInvoiceCount'];
    percentGrowth = stats['percentGrowth'];
    monthlyCollections = List<double>.from(stats['monthlyCollections']);
    monthLabels = List<String>.from(stats['monthLabels']);
  }

  Future<void> _loadRecentActivity(String schoolId) async {
    recentActivity = await _financeRepo.getRecentActivity(schoolId);
  }

  // ---------------------------------------------------------------------------
  // INVOICE OPERATIONS
  // ---------------------------------------------------------------------------
  Future<void> createInvoice({
    required String studentId,
    required List<InvoiceItem> items,
    required DateTime dueDate,
  }) async {
    isCreatingInvoice = true;
    invoiceCreationError = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) {
        invoiceCreationError = "No active school found. Please log in again.";
        isCreatingInvoice = false;
        notifyListeners();
        return;
      }

      await _financeRepo.createInvoice(
        Invoice(
          id: 'inv_${DateTime.now().millisecondsSinceEpoch}',
          schoolId: school.id,
          studentId: studentId,
          invoiceNumber:
              'INV-${DateTime.now().year}-${DateTime.now().month.toString().padLeft(2, '0')}-${DateTime.now().millisecondsSinceEpoch.toString().substring(8)}',
          dueDate: dueDate,
          status: InvoiceStatus.draft,
          totalAmount: items.fold(0.0, (sum, item) => sum + item.amount),
        ),
        items
            .map(
              (item) => InvoiceItem(
                id: 'inv_item_${DateTime.now().millisecondsSinceEpoch}_${items.indexOf(item)}',
                schoolId: school.id,
                invoiceId: '', // Will be set in repository
                description: item.description,
                amount: item.amount,
              ),
            )
            .toList(),
      );

      // Refresh overview after creation
      await _loadOverviewStats(school.id);
    } catch (e) {
      invoiceCreationError = e.toString();
      debugPrint("Create Invoice Error: $e");
    } finally {
      isCreatingInvoice = false;
      notifyListeners();
    }
  }

  Future<void> loadInvoice(String invoiceId) async {
    isLoadingInvoice = true;
    notifyListeners();

    try {
      currentInvoice = await _financeRepo.getInvoiceById(invoiceId);
      if (currentInvoice != null) {
        currentInvoiceItems = await _financeRepo.getInvoiceItems(invoiceId);
      } else {
        currentInvoiceItems = [];
      }
    } catch (e) {
      debugPrint("Load Invoice Error: $e");
    } finally {
      isLoadingInvoice = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // PAYMENT OPERATIONS
  // ---------------------------------------------------------------------------
  Future<void> recordPayment({
    required String studentId,
    required double amount,
    required String method,
    String? reference,
  }) async {
    isRecordingPayment = true;
    paymentRecordingError = null;
    notifyListeners();

    try {
      final school = _authService.activeSchool;
      if (school == null) {
        paymentRecordingError = "No active school found. Please log in again.";
        isRecordingPayment = false;
        notifyListeners();
        return;
      }

      await _financeRepo.recordPayment(
        Payment(
          id: '', // Will be generated
          schoolId: school.id,
          studentId: studentId,
          amount: amount,
          method: method,
          reference: reference,
          receivedAt: DateTime.now(),
        ),
      );

      // Refresh overview after payment
      await _loadOverviewStats(school.id);
    } catch (e) {
      paymentRecordingError = e.toString();
      debugPrint("Record Payment Error: $e");
    } finally {
      isRecordingPayment = false;
      notifyListeners();
    }
  }

  // ---------------------------------------------------------------------------
  // STUDENT FINANCE DATA
  // ---------------------------------------------------------------------------
  Future<List<Invoice>> getStudentInvoices(String studentId) async {
    return await _financeRepo.getStudentInvoices(studentId);
  }

  Future<List<Payment>> getStudentPayments(String studentId) async {
    return await _financeRepo.getStudentPayments(studentId);
  }

  Future<List<LedgerEntry>> getStudentLedger(String studentId) async {
    return await _financeRepo.getStudentLedger(studentId);
  }

  // ---------------------------------------------------------------------------
  // ACTIONS
  // ---------------------------------------------------------------------------
  Future<void> refresh() async {
    await init();
  }
}

// ==========================================
// FILE: ./vmodels/dashboard_vmodel.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/models/legend.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:legend/services/database_serv.dart'; // To init DB

class DashboardViewModel extends ChangeNotifier {
  final DashboardRepository _repo;
  final AuthService _authService;

  // ---------------------------------------------------------------------------
  // STATE (Data the UI needs)
  // ---------------------------------------------------------------------------
  bool isLoading = true;
  String? error;

  LegendProfile? profile;
  DashboardStats stats = DashboardStats(
    totalStudents: 0,
    totalOwed: 0,
    collectedToday: 0,
    pendingInvoices: 0,
  );
  List<Map<String, dynamic>> recentActivity = [];

  // Constructor Injection
  DashboardViewModel(this._repo, this._authService);

  // ---------------------------------------------------------------------------
  // INITIALIZATION (The Engine Start)
  // ---------------------------------------------------------------------------
  Future<void> init() async {
    isLoading = true;
    notifyListeners(); // Tell UI to show spinner

    try {
      // 1. Get Current Context (User & School)
      final user = _authService.user;
      final school = _authService.activeSchool;

      if (user == null || school == null) {
        throw Exception("Session invalid. Please login again.");
      }

      // 2. Ignite the Offline Database (If not already running)
      // PowerSync is already connected in AuthService.login()
      await DatabaseService().connectToSchool(school.id);

      // 3. Parallel Data Fetching (Maximum Efficiency)
      // We run all independent queries at the same time.
      await Future.wait([
        _loadProfile(user.id),
        _loadStats(school.id),
        _loadActivity(school.id),
      ]);

      error = null;
    } catch (e) {
      error = e.toString();
      debugPrint("Dashboard VM Error: $e");
    } finally {
      isLoading = false;
      notifyListeners(); // Tell UI we are ready
    }
  }

  // ---------------------------------------------------------------------------
  // HELPER METHODS (Clean Logic)
  // ---------------------------------------------------------------------------

  Future<void> _loadProfile(String userId) async {
    profile = await _repo.getUserProfile(userId);
  }

  Future<void> _loadStats(String schoolId) async {
    stats = await _repo.getDashboardStats(schoolId);
  }

  Future<void> _loadActivity(String schoolId) async {
    recentActivity = await _repo.getRecentActivity(schoolId);
  }

  // ---------------------------------------------------------------------------
  // ACTIONS (User Interactions)
  // ---------------------------------------------------------------------------

  Future<void> refresh() async {
    await init();
  }

  // Called when user logs out to prevent memory leaks or open connections
  Future<void> disconnect() async {
    // FIXED: Use close() instead of disconnect() to match database service API
    await DatabaseService().close();
  }
}

// ==========================================
// FILE: ./vmodels/students_vmodel.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/models/all_models.dart';
import 'package:legend/services/database_serv.dart';

// =============================================================================
// STUDENT REPOSITORY (PowerSync Implementation)
// =============================================================================
abstract class StudentRepository {
  Future<List<Student>> getStudents(String schoolId);
  Future<Student?> getStudentById(String id);
  Future<void> addStudent(Student student);
  Future<void> updateStudent(Student student);
  Future<void> deleteStudent(String id);
  Future<List<Enrollment>> getEnrollments(String studentId);
}

class PowerSyncStudentRepository implements StudentRepository {
  @override
  Future<List<Student>> getStudents(String schoolId) async {
    try {
      final result = await db.getAll(
        '''
        SELECT * FROM students 
        WHERE school_id = ? AND status != 'ARCHIVED'
        ORDER BY last_name, first_name
        ''',
        [schoolId],
      );

      return result.map((row) => Student.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching students: $e");
      rethrow;
    }
  }

  @override
  Future<Student?> getStudentById(String id) async {
    try {
      final result = await db.getOptional(
        'SELECT * FROM students WHERE id = ?',
        [id],
      );

      return result != null ? Student.fromRow(result) : null;
    } catch (e) {
      debugPrint("Error fetching student: $e");
      rethrow;
    }
  }

  @override
  Future<void> addStudent(Student student) async {
    try {
      await db.execute(
        '''
        INSERT INTO students (
          id, school_id, first_name, last_name, admission_number, 
          status, student_type, guardian_name, guardian_phone, 
          guardian_email, guardian_relationship, gender, dob, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''',
        [
          student.id,
          student.schoolId,
          student.firstName,
          student.lastName,
          student.admissionNumber,
          student.status.name.toUpperCase(),
          student.type.name.toUpperCase(),
          student.guardianName,
          student.guardianPhone,
          student.guardianEmail,
          student.guardianRelationship,
          student.gender,
          student.dob?.toIso8601String(),
          DateTime.now().toIso8601String(),
        ],
      );
    } catch (e) {
      debugPrint("Error adding student: $e");
      rethrow;
    }
  }

  @override
  Future<void> updateStudent(Student student) async {
    try {
      await db.execute(
        '''
        UPDATE students SET
          first_name = ?, last_name = ?, admission_number = ?,
          status = ?, student_type = ?, guardian_name = ?, guardian_phone = ?,
          guardian_email = ?, guardian_relationship = ?, gender = ?, dob = ?
        WHERE id = ? AND school_id = ?
        ''',
        [
          student.firstName,
          student.lastName,
          student.admissionNumber,
          student.status.name.toUpperCase(),
          student.type.name.toUpperCase(),
          student.guardianName,
          student.guardianPhone,
          student.guardianEmail,
          student.guardianRelationship,
          student.gender,
          student.dob?.toIso8601String(),
          student.id,
          student.schoolId,
        ],
      );
    } catch (e) {
      debugPrint("Error updating student: $e");
      rethrow;
    }
  }

  @override
  Future<void> deleteStudent(String id) async {
    try {
      // Soft delete by setting status to ARCHIVED
      final row = await db.getOptional(
        'SELECT school_id FROM students WHERE id = ?',
        [id],
      );
      await db.execute(
        '''
        UPDATE students SET status = 'ARCHIVED' 
        WHERE id = ? AND school_id = ?
        ''',
        [id, row!['school_id']],
      );
    } catch (e) {
      debugPrint("Error deleting student: $e");
      rethrow;
    }
  }

  @override
  Future<List<Enrollment>> getEnrollments(String studentId) async {
    try {
      final result = await db.getAll(
        '''
        SELECT * FROM enrollments 
        WHERE student_id = ? AND is_active = 1
        ORDER BY created_at DESC
        ''',
        [studentId],
      );

      return result.map((row) => Enrollment.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching enrollments: $e");
      rethrow;
    }
  }
}

// =============================================================================
// FINANCE REPOSITORY (PowerSync Implementation)
// =============================================================================
abstract class FinanceRepository {
  Future<List<Invoice>> getStudentInvoices(String studentId);
  Future<List<Payment>> getStudentPayments(String studentId);
  Future<List<LedgerEntry>> getStudentLedger(String studentId);
  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items);
  Future<void> recordPayment(Payment payment);
  Future<List<Map<String, dynamic>>> getRecentActivity(String schoolId);
  Future<Invoice?> getInvoiceById(String invoiceId);
  Future<List<InvoiceItem>> getInvoiceItems(String invoiceId);
  Future<Map<String, dynamic>> getFinanceStats(String schoolId);
}

class PowerSyncFinanceRepository implements FinanceRepository {
  @override
  Future<List<Invoice>> getStudentInvoices(String studentId) async {
    try {
      final result = await db.getAll(
        '''
        SELECT * FROM invoices 
        WHERE student_id = ? 
        ORDER BY due_date DESC
        ''',
        [studentId],
      );

      return result.map((row) => Invoice.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching invoices: $e");
      rethrow;
    }
  }

  @override
  Future<List<Payment>> getStudentPayments(String studentId) async {
    try {
      final result = await db.getAll(
        '''
        SELECT * FROM payments 
        WHERE student_id = ? 
        ORDER BY received_at DESC
        ''',
        [studentId],
      );

      return result.map((row) => Payment.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching payments: $e");
      rethrow;
    }
  }

  @override
  Future<List<LedgerEntry>> getStudentLedger(String studentId) async {
    try {
      final result = await db.getAll(
        '''
        SELECT * FROM ledger 
        WHERE student_id = ? 
        ORDER BY occurred_at DESC
        ''',
        [studentId],
      );

      return result.map((row) => LedgerEntry.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching ledger: $e");
      rethrow;
    }
  }

  @override
  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items) async {
    try {
      // Create invoice header
      await db.execute(
        '''
        INSERT INTO invoices (
          id, school_id, student_id, invoice_number, due_date, 
          status, snapshot_grade, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''',
        [
          invoice.id,
          invoice.schoolId,
          invoice.studentId,
          invoice.invoiceNumber,
          invoice.dueDate.toIso8601String(),
          invoice.status.name.toUpperCase(),
          invoice.snapshotGrade,
          DateTime.now().toIso8601String(),
        ],
      );

      // Create invoice items
      for (final item in items) {
        await db.execute(
          '''
          INSERT INTO invoice_items (
            id, school_id, invoice_id, description, amount, created_at
          ) VALUES (?, ?, ?, ?, ?, ?)
          ''',
          [
            item.id,
            item.schoolId,
            item.invoiceId,
            item.description,
            item.amount,
            DateTime.now().toIso8601String(),
          ],
        );
      }

      // Update student fees owed
      await db.execute(
        '''
        UPDATE students 
        SET fees_owed = fees_owed + ?
        WHERE id = ? AND school_id = ?
        ''',
        [invoice.totalAmount, invoice.studentId, invoice.schoolId],
      );
    } catch (e) {
      debugPrint("Error creating invoice: $e");
      rethrow;
    }
  }

  @override
  Future<void> recordPayment(Payment payment) async {
    try {
      // Record payment
      await db.execute(
        '''
        INSERT INTO payments (
          id, school_id, student_id, amount, method, 
          reference_code, received_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?)
        ''',
        [
          payment.id,
          payment.schoolId,
          payment.studentId,
          payment.amount,
          payment.method,
          payment.reference,
          payment.receivedAt.toIso8601String(),
        ],
      );

      // Create ledger entry (credit)
      await db.execute(
        '''
        INSERT INTO ledger (
          id, school_id, student_id, type, amount, 
          description, occurred_at
        ) VALUES (?, ?, ?, 'CREDIT', ?, ?, ?)
        ''',
        [
          'ledger_${DateTime.now().millisecondsSinceEpoch}',
          payment.schoolId,
          payment.studentId,
          payment.amount,
          'Payment received: ${payment.method}',
          DateTime.now().toIso8601String(),
        ],
      );

      // Update student fees owed
      await db.execute(
        '''
        UPDATE students 
        SET fees_owed = MAX(0, fees_owed - ?)
        WHERE id = ? AND school_id = ?
        ''',
        [payment.amount, payment.studentId, payment.schoolId],
      );
    } catch (e) {
      debugPrint("Error recording payment: $e");
      rethrow;
    }
  }

  @override
  Future<List<Map<String, dynamic>>> getRecentActivity(String schoolId) async {
    try {
      final result = await db.getAll(
        '''
        SELECT 
          l.*,
          s.first_name || ' ' || s.last_name as student_name,
          s.grade as grade
        FROM ledger l
        JOIN students s ON l.student_id = s.id
        WHERE l.school_id = ?
        ORDER BY l.occurred_at DESC
        LIMIT 10
        ''',
        [schoolId],
      );

      return result.map((row) {
        final type = row['type'] == 'CREDIT' ? 'INCOME' : 'EXPENSE';
        final amount = (row['amount'] as num).toDouble();
        final desc = row['description'] as String;
        final grade = row['grade'] as String? ?? '';

        return {
          'name': row['student_name'] as String,
          'desc': '$desc ‚Ä¢ $grade',
          'amount': type == 'INCOME' ? amount : -amount,
          'time': _formatTime(DateTime.parse(row['occurred_at'])),
          'type': type,
          'targetId': row['student_id'] as String,
        };
      }).toList();
    } catch (e) {
      debugPrint("Error fetching recent activity: $e");
      rethrow;
    }
  }

  @override
  Future<Invoice?> getInvoiceById(String invoiceId) async {
    try {
      final result = await db.getOptional(
        'SELECT * FROM invoices WHERE id = ?',
        [invoiceId],
      );

      return result != null ? Invoice.fromRow(result) : null;
    } catch (e) {
      debugPrint("Error fetching invoice: $e");
      rethrow;
    }
  }

  @override
  Future<List<InvoiceItem>> getInvoiceItems(String invoiceId) async {
    try {
      final result = await db.getAll(
        'SELECT * FROM invoice_items WHERE invoice_id = ?',
        [invoiceId],
      );

      return result.map((row) => InvoiceItem.fromRow(row)).toList();
    } catch (e) {
      debugPrint("Error fetching invoice items: $e");
      rethrow;
    }
  }

  @override
  Future<Map<String, dynamic>> getFinanceStats(String schoolId) async {
    try {
      // Total revenue (sum of all CREDIT ledger entries)
      final revenueResult = await db.getOptional(
        "SELECT SUM(amount) as total FROM ledger WHERE school_id = ? AND type = 'CREDIT'",
        [schoolId],
      );
      final totalRevenue = (revenueResult?['total'] as num?)?.toDouble() ?? 0.0;

      // Pending amount (sum of unpaid invoices)
      final pendingResult = await db.getOptional(
        "SELECT SUM(total_amount) as total FROM invoices WHERE school_id = ? AND status != 'PAID'",
        [schoolId],
      );
      final pendingAmount =
          (pendingResult?['total'] as num?)?.toDouble() ?? 0.0;

      // Unpaid invoice count
      final countResult = await db.getOptional(
        "SELECT COUNT(*) as count FROM invoices WHERE school_id = ? AND status != 'PAID'",
        [schoolId],
      );
      final unpaidInvoiceCount = (countResult?['count'] as int?) ?? 0;

      // Monthly collections for last 6 months
      final now = DateTime.now();
      final monthlyData = <double>[];
      final monthLabels = <String>[];

      for (int i = 5; i >= 0; i--) {
        final monthStart = DateTime(now.year, now.month - i, 1);
        final monthEnd = DateTime(now.year, now.month - i + 1, 1);

        final monthResult = await db.getOptional(
          "SELECT SUM(amount) as total FROM ledger WHERE school_id = ? AND type = 'CREDIT' AND occurred_at >= ? AND occurred_at < ?",
          [schoolId, monthStart.toIso8601String(), monthEnd.toIso8601String()],
        );
        final monthTotal = (monthResult?['total'] as num?)?.toDouble() ?? 0.0;

        // Normalize to 0-1 for chart (relative to max revenue)
        monthlyData.add(monthTotal / (totalRevenue > 0 ? totalRevenue : 1.0));

        monthLabels.add(_getMonthLabel(monthStart));
      }

      // Percent growth (current month vs previous month)
      double percentGrowth = 0.0;
      if (monthlyData.length >= 2) {
        final current = monthlyData.last * totalRevenue;
        final previous = monthlyData[monthlyData.length - 2] * totalRevenue;
        if (previous > 0) {
          percentGrowth = ((current - previous) / previous) * 100;
        }
      }

      return {
        'totalRevenue': totalRevenue,
        'pendingAmount': pendingAmount,
        'unpaidInvoiceCount': unpaidInvoiceCount,
        'percentGrowth': percentGrowth,
        'monthlyCollections': monthlyData,
        'monthLabels': monthLabels,
      };
    } catch (e) {
      debugPrint("Error fetching finance stats: $e");
      rethrow;
    }
  }

  String _getMonthLabel(DateTime date) {
    const months = [
      'JAN',
      'FEB',
      'MAR',
      'APR',
      'MAY',
      'JUN',
      'JUL',
      'AUG',
      'SEP',
      'OCT',
      'NOV',
      'DEC',
    ];
    return months[date.month - 1];
  }

  String _formatTime(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);

    if (diff.inDays == 0) {
      return 'Today, ${date.hour}:${date.minute.toString().padLeft(2, '0')} ${date.hour >= 12 ? 'PM' : 'AM'}';
    } else if (diff.inDays == 1) {
      return 'Yesterday, ${date.hour}:${date.minute.toString().padLeft(2, '0')} ${date.hour >= 12 ? 'PM' : 'AM'}';
    } else if (diff.inDays < 7) {
      return '${diff.inDays} days ago';
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }
}

// =============================================================================
// STUDENT LIST VIEW MODEL
// =============================================================================
class StudentListViewModel extends ChangeNotifier {
  final StudentRepository _repo;
  final String schoolId;

  bool _isLoading = false;
  List<Student> _students = [];
  String? _error;

  bool get isLoading => _isLoading;
  List<Student> get students => _students;
  String? get error => _error;

  StudentListViewModel(this._repo, this.schoolId);

  Future<void> loadStudents() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _students = await _repo.getStudents(schoolId);
    } catch (e) {
      _error = "Failed to load students: ${e.toString()}";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> deleteStudent(String id) async {
    try {
      await _repo.deleteStudent(id);
      _students.removeWhere((student) => student.id == id);
      notifyListeners();
    } catch (e) {
      _error = "Failed to delete student: ${e.toString()}";
      notifyListeners();
    }
  }
}

// =============================================================================
// STUDENT DETAIL VIEW MODEL
// =============================================================================
class StudentDetailViewModel extends ChangeNotifier {
  final StudentRepository _repo;
  final String schoolId;

  Student? _student;
  List<Enrollment> _enrollments = [];
  bool _isLoading = false;
  String? _error;

  Student? get student => _student;
  List<Enrollment> get enrollments => _enrollments;
  bool get isLoading => _isLoading;
  String? get error => _error;

  StudentDetailViewModel(this._repo, this.schoolId);

  Future<void> loadStudent(String id) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _student = await _repo.getStudentById(id);
      if (_student != null) {
        _enrollments = await _repo.getEnrollments(id);
      }
    } catch (e) {
      _error = "Failed to load student: ${e.toString()}";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> saveStudent(Student student) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      if (student.id.isEmpty) {
        // New student
        student = Student(
          id: 'stu_${DateTime.now().millisecondsSinceEpoch}',
          schoolId: schoolId,
          firstName: student.firstName,
          lastName: student.lastName,
          admissionNumber: student.admissionNumber,
          status: student.status,
          type: student.type,
          guardianName: student.guardianName,
          guardianPhone: student.guardianPhone,
          guardianEmail: student.guardianEmail,
          guardianRelationship: student.guardianRelationship,
          gender: student.gender,
          dob: student.dob,
          feesOwed: 0.0,
          createdAt: DateTime.now(),
        );
        await _repo.addStudent(student);
      } else {
        // Existing student
        await _repo.updateStudent(student);
      }

      _student = student;
    } catch (e) {
      _error = "Failed to save student: ${e.toString()}";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}

// =============================================================================
// STUDENT FINANCE VIEW MODEL
// =============================================================================
class StudentFinanceViewModel extends ChangeNotifier {
  final FinanceRepository _repo;
  final String studentId;
  final String schoolId;

  List<Invoice> _invoices = [];
  List<Payment> _payments = [];
  List<LedgerEntry> _ledger = [];
  bool _isLoading = false;
  String? _error;

  List<Invoice> get invoices => _invoices;
  List<Payment> get payments => _payments;
  List<LedgerEntry> get ledger => _ledger;
  bool get isLoading => _isLoading;
  String? get error => _error;

  StudentFinanceViewModel(this._repo, this.studentId, this.schoolId);

  Future<void> loadFinanceData() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final invoicesFuture = _repo.getStudentInvoices(studentId);
      final paymentsFuture = _repo.getStudentPayments(studentId);
      final ledgerFuture = _repo.getStudentLedger(studentId);

      final results = await Future.wait([
        invoicesFuture,
        paymentsFuture,
        ledgerFuture,
      ]);

      _invoices = (results[0] as List<Invoice>);
      _payments = (results[1] as List<Payment>);
      _ledger = (results[2] as List<LedgerEntry>);
    } catch (e) {
      _error = "Failed to load finance data: ${e.toString()}";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> createInvoice(Invoice invoice, List<InvoiceItem> items) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _repo.createInvoice(invoice, items);
      await loadFinanceData(); // Refresh data
    } catch (e) {
      _error = "Failed to create invoice: ${e.toString()}";
      notifyListeners();
    } finally {
      _isLoading = false;
    }
  }

  Future<void> recordPayment(Payment payment) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _repo.recordPayment(payment);
      await loadFinanceData(); // Refresh data
    } catch (e) {
      _error = "Failed to record payment: ${e.toString()}";
      notifyListeners();
    } finally {
      _isLoading = false;
    }
  }
}

// ==========================================
// FILE: ./services/auth/auth_serv.dart
// ==========================================

import 'package:flutter/foundation.dart';
import 'package:legend/models/legend.dart';
import 'package:legend/repo/auth/auth_repo.dart';
import 'package:legend/repo/auth/school_repo.dart';
import 'package:legend/services/database_serv.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class AuthService extends ChangeNotifier {
  final AuthRepository _authRepo;
  final SchoolRepository _schoolRepo;

  AuthService(this._authRepo, this._schoolRepo);

  User? get user => _authRepo.currentUser;

  bool get isAuthenticated => _authRepo.currentUser != null;

  // STATE: The currently active school for the session
  SchoolConfig? _activeSchool;
  SchoolConfig? get activeSchool => _activeSchool;

  /// Full Login Flow: Auth -> Fetch School -> Connect PowerSync -> Ready
  Future<void> login(String email, String password) async {
    // 1. Authenticate with Supabase
    final response = await _authRepo.signInWithPassword(email, password);
    final userId = response.user?.id;

    if (userId != null) {
      try {
        // 2. Fetch School configuration
        _activeSchool = await _schoolRepo.getSchoolForUser(userId);

        if (_activeSchool != null) {
          // 3. Connect PowerSync to school (start syncing data)
          debugPrint(
            "üîå Connecting PowerSync to school: ${_activeSchool!.name}",
          );
          await DatabaseService().connectToSchool(_activeSchool!.id);
          debugPrint("‚úÖ PowerSync connected & syncing");

          // 4. Wait briefly for initial sync to start
          await Future.delayed(const Duration(milliseconds: 500));
          debugPrint("‚úÖ Initial sync window completed");
        }

        // 5. Notify app that we are fully ready
        notifyListeners();
      } catch (e) {
        debugPrint("‚ùå Auth successful, but setup failed: $e");
        rethrow;
      }
    }
  }

  Future<void> logout() async {
    await _authRepo.signOut();
    _activeSchool = null;
    notifyListeners();
  }
}

// ==========================================
// FILE: ./services/database_serv.dart
// ==========================================

// ignore_for_file: depend_on_referenced_packages

import 'package:flutter/foundation.dart';
import 'package:legend/constants/app_schema.dart';
import 'package:legend/app_init.dart';
import 'package:path/path.dart';
import 'package:path_provider/path_provider.dart';
import 'package:powersync/powersync.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

/// GLOBAL ACCESS
PowerSyncDatabase? _globalDb;
// CRITICAL: This throws if called before AppInit.
PowerSyncDatabase get db {
  if (_globalDb == null) {
    throw Exception("üî• FATAL: Database accessed before initialization!");
  }
  return _globalDb!;
}

class DatabaseService {
  static final DatabaseService _instance = DatabaseService._internal();
  factory DatabaseService() => _instance;
  DatabaseService._internal();

  bool _isStandaloneInitialized = false;
  bool _isConnected = false;

  /// 1. CALLED BY MAIN > APPINIT
  Future<void> initializeStandalone() async {
    if (_isStandaloneInitialized) return;

    try {
      final dir = await getApplicationSupportDirectory();
      final path = join(dir.path, 'kwalegend_offline.db');

      _globalDb = PowerSyncDatabase(schema: schema, path: path);
      await _globalDb!.initialize();
      _isStandaloneInitialized = true;

      debugPrint("‚úÖ PowerSync (Offline Mode) Ready");
    } catch (e) {
      debugPrint("‚ùå PowerSync Init Failed: $e");
      rethrow;
    }
  }

  /// 2. CALLED BY DASHBOARD VM (After Login)
  Future<void> connectToSchool(String schoolId) async {
    if (!_isStandaloneInitialized) await initializeStandalone();

    if (_isConnected) return;

    try {
      _globalDb!.connect(connector: _SupabaseConnector(_globalDb!, schoolId));
      _isConnected = true;
      debugPrint("‚úÖ PowerSync Connected to School: $schoolId");
    } catch (e) {
      debugPrint("‚ùå Connection Failed: $e");
    }
  }

  /// 3. CALLED ON LOGOUT
  Future<void> close() async {
    await _globalDb?.disconnect();
    _isConnected = false;
    debugPrint("üîí PowerSync Disconnected");
  }
}

class _SupabaseConnector extends PowerSyncBackendConnector {
  final PowerSyncDatabase db;
  final String schoolId;

  _SupabaseConnector(this.db, this.schoolId);

  @override
  Future<PowerSyncCredentials?> fetchCredentials() async {
    final session = Supabase.instance.client.auth.currentSession;
    if (session == null) return null;

    return PowerSyncCredentials(
      endpoint: AppEnv.powerSyncUrl,
      token: session.accessToken,
    );
  }

  @override
  Future<void> uploadData(PowerSyncDatabase database) async {
    final transaction = await database.getNextCrudTransaction();
    if (transaction == null) return;

    final rest = Supabase.instance.client.schema('legend');

    try {
      for (var op in transaction.crud) {
        final table = op.table;
        final id = op.id;
        final data = op.opData;

        if (op.op == UpdateType.put) {
          await rest.from(table).upsert({...?data, 'id': id});
        } else if (op.op == UpdateType.patch && data != null) {
          await rest.from(table).update(data).eq('id', id);
        } else if (op.op == UpdateType.delete) {
          await rest.from(table).delete().eq('id', id);
        }
      }
      await transaction.complete();
    } catch (e) {
      debugPrint("üî• Upload Error: $e");
      rethrow;
    }
  }
}

// ==========================================
// FILE: ./models/legend.dart
// ==========================================

// lib/models/screen_models.dart

/// Sir Legend's Profile (Logged In User).
class LegendProfile {
  final String id;
  final String fullName;
  final String role; // OWNER, ADMIN
  final bool isBanned;

  LegendProfile({
    required this.id,
    required this.fullName,
    required this.role,
    this.isBanned = false,
  });

  factory LegendProfile.fromRow(Map<String, dynamic> row) {
    return LegendProfile(
      id: (row['id'] as String?) ?? '',
      fullName: (row['full_name'] as String?) ?? 'Unknown User',
      role: (row['role'] as String?) ?? 'USER',
      isBanned: (row['is_banned'] == 1) || (row['is_banned'] == true),
    );
  }
}

class SchoolConfig {
  final String id;
  final String name;
  final String currency;
  final String? address;
  final String? logoUrl;
  final String ownerId;

  SchoolConfig({
    required this.id,
    required this.name,
    required this.currency,
    this.address,
    this.logoUrl,
    required this.ownerId,
  });

  // Factory to create from Supabase JSON
  factory SchoolConfig.fromJson(Map<String, dynamic> json) {
    return SchoolConfig(
      id: json['id'] as String,
      name: json['school_name'] as String, // Note the column name mapping
      currency: json['currency'] as String? ?? 'USD',
      address: json['address'] as String?,
      logoUrl: json['logo_url'] as String?,
      ownerId: json['owner_id'] as String,
    );
  }

  // To JSON (if needed for local storage)
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'school_name': name,
      'currency': currency,
      'address': address,
      'logo_url': logoUrl,
      'owner_id': ownerId,
    };
  }
}

/// Dashboard Statistics (Aggregated).
class DashboardStats {
  final int totalStudents;
  final double totalOwed;
  final double collectedToday;
  final int pendingInvoices;

  DashboardStats({
    this.totalStudents = 0,
    this.totalOwed = 0.0,
    this.collectedToday = 0.0,
    this.pendingInvoices = 0,
  });
}

/// Menu Items for the Drawer/Nav.
class MenuItem {
  final String title;
  final String route;
  final dynamic icon; // IconData usually

  MenuItem(this.title, this.route, this.icon);
}

/// Notification / Insight Item.
class InsightItem {
  final String title;
  final String message;
  final String type; // ALERT, INFO
  final DateTime time;

  InsightItem({
    required this.title,
    required this.message,
    required this.type,
    required this.time,
  });
}

// ==========================================
// FILE: ./models/additional_models.dart
// ==========================================

import 'dart:convert'; // For JSON decoding

/// Types of notifications generated by the system.
enum NotificationType { info, success, warning, insight, system }

/// Represents a notification or insight from the Legend Engine.
/// Maps to table: `legend.noti`
class LegendNotification {
  final String id;
  final String schoolId;
  final String? userId; // If null, it's a broadcast message
  final String title;
  final String message;
  final NotificationType type;
  final bool isRead;
  final Map<String, dynamic> metadata; // For linking to invoices/students
  final DateTime createdAt;

  LegendNotification({
    required this.id,
    required this.schoolId,
    this.userId,
    required this.title,
    required this.message,
    this.type = NotificationType.info,
    this.isRead = false,
    this.metadata = const {},
    required this.createdAt,
  });

  /// Factory to parse from PowerSync/SQLite Row
  factory LegendNotification.fromRow(Map<String, dynamic> row) {
    return LegendNotification(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      userId: row['user_id'] as String?,
      title: row['title'] as String,
      message: row['message'] as String,
      type: _parseType(row['type']),
      // SQLite stores booleans as 0 or 1 usually, but PowerSync might map to bool.
      // We handle both just in case.
      isRead: row['is_read'] == 1 || row['is_read'] == true,
      metadata: _parseJson(row['metadata']),
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  /// Convert to Map for Saving (if generating local notifications)
  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'user_id': userId,
      'title': title,
      'message': message,
      'type': type.name.toUpperCase(),
      'is_read': isRead ? 1 : 0,
      'metadata': jsonEncode(metadata),
      'created_at': createdAt.toIso8601String(),
    };
  }

  /// Helper to safely parse the Enum
  static NotificationType _parseType(String? val) {
    switch (val?.toUpperCase()) {
      case 'SUCCESS': return NotificationType.success;
      case 'WARNING': return NotificationType.warning;
      case 'INSIGHT': return NotificationType.insight;
      case 'SYSTEM': return NotificationType.system;
      default: return NotificationType.info;
    }
  }

  /// Helper to safely parse JSONB columns
  static Map<String, dynamic> _parseJson(dynamic val) {
    if (val == null) return {};
    if (val is Map) return Map<String, dynamic>.from(val);
    if (val is String) {
      try {
        return jsonDecode(val) as Map<String, dynamic>;
      } catch (e) {
        // Fallback if parsing fails
        return {}; 
      }
    }
    return {};
  }
}

/// Represents developer channel info (The "Red Phone").
/// Maps to table: `legend.dev`
class LegendDevInfo {
  final String id;
  final String schoolId;
  final String section; // e.g., 'CONTACT', 'PATCH_NOTES'
  final String? content;
  final Map<String, dynamic> payload; // Version numbers, feature flags
  final bool isSecret;
  final DateTime createdAt;

  LegendDevInfo({
    required this.id,
    required this.schoolId,
    required this.section,
    this.content,
    this.payload = const {},
    this.isSecret = true,
    required this.createdAt,
  });

  factory LegendDevInfo.fromRow(Map<String, dynamic> row) {
    return LegendDevInfo(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      section: row['section'] as String,
      content: row['content'] as String?,
      payload: _parseJson(row['payload']),
      isSecret: row['is_secret'] == 1 || row['is_secret'] == true,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  static Map<String, dynamic> _parseJson(dynamic val) {
    if (val == null) return {};
    if (val is Map) return Map<String, dynamic>.from(val);
    if (val is String) {
      try {
        return jsonDecode(val) as Map<String, dynamic>;
      } catch (e) {
        return {};
      }
    }
    return {};
  }
}
// ==========================================
// FILE: ./models/billing_models.dart
// ==========================================

// lib/models/billing_models.dart

enum InvoiceStatus { draft, posted, paid, voided }
enum LedgerType { debit, credit }

/// The Rules: Defines a fee (e.g., "Form 1 Tuition").
class FeeStructure {
  final String id;
  final String schoolId;
  final String name;
  final double amount;
  final String billingType; // 'tuition', 'transport'
  final String recurrence; // 'termly', 'monthly'
  
  FeeStructure({
    required this.id,
    required this.schoolId,
    required this.name,
    required this.amount,
    required this.billingType,
    required this.recurrence,
  });

  factory FeeStructure.fromRow(Map<String, dynamic> row) {
    return FeeStructure(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      billingType: row['billing_type'] ?? 'tuition',
      recurrence: row['recurrence'] ?? 'termly',
    );
  }
}

/// The Bill: A request for payment.
class Invoice {
  final String id;
  final String schoolId;
  final String studentId;
  final String invoiceNumber;
  final DateTime dueDate;
  final InvoiceStatus status;
  final String? snapshotGrade; // Grade at time of billing
  final double totalAmount; // Calculated often, but useful if stored

  Invoice({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.invoiceNumber,
    required this.dueDate,
    this.status = InvoiceStatus.draft,
    this.snapshotGrade,
    this.totalAmount = 0.0,
  });

  factory Invoice.fromRow(Map<String, dynamic> row) {
    return Invoice(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      invoiceNumber: row['invoice_number'] as String,
      dueDate: DateTime.parse(row['due_date']),
      status: _parseStatus(row['status']),
      snapshotGrade: row['snapshot_grade'] as String?,
      // Assuming a join or total column exists, else 0
      totalAmount: (row['total_amount'] as num?)?.toDouble() ?? 0.0, 
    );
  }

  static InvoiceStatus _parseStatus(String? val) {
    switch (val?.toUpperCase()) {
      case 'POSTED': return InvoiceStatus.posted;
      case 'PAID': return InvoiceStatus.paid;
      case 'VOID': return InvoiceStatus.voided;
      default: return InvoiceStatus.draft;
    }
  }
}

/// The Details: Lines inside an invoice.
class InvoiceItem {
  final String id;
  final String schoolId;
  final String invoiceId;
  final String description;
  final double amount;

  InvoiceItem({
    required this.id,
    required this.schoolId,
    required this.invoiceId,
    required this.description,
    required this.amount,
  });

  factory InvoiceItem.fromRow(Map<String, dynamic> row) {
    return InvoiceItem(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      invoiceId: row['invoice_id'] as String,
      description: row['description'] as String,
      amount: (row['amount'] as num).toDouble(),
    );
  }
}

/// The Payment: Money In.
class Payment {
  final String id;
  final String schoolId;
  final String studentId;
  final double amount;
  final String method; // Cash, EcoCash
  final String? reference;
  final DateTime receivedAt;

  Payment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.amount,
    required this.method,
    this.reference,
    required this.receivedAt,
  });

  factory Payment.fromRow(Map<String, dynamic> row) {
    return Payment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      amount: (row['amount'] as num).toDouble(),
      method: row['method'] as String,
      reference: row['reference_code'] as String?,
      receivedAt: DateTime.parse(row['received_at']),
    );
  }
}

/// The Truth: Immutable History.
class LedgerEntry {
  final String id;
  final String schoolId;
  final String studentId;
  final LedgerType type; // DEBIT (Owed) vs CREDIT (Paid)
  final double amount;
  final String description;
  final DateTime date;

  LedgerEntry({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.type,
    required this.amount,
    required this.description,
    required this.date,
  });

  factory LedgerEntry.fromRow(Map<String, dynamic> row) {
    return LedgerEntry(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      type: (row['type'] == 'DEBIT') ? LedgerType.debit : LedgerType.credit,
      amount: (row['amount'] as num).toDouble(),
      description: row['description'] ?? 'Transaction',
      date: DateTime.parse(row['occurred_at']),
    );
  }
}
// ==========================================
// FILE: ./models/all_models.dart
// ==========================================

//-------------------------------------------------
// lib/models/all_models.dart
// Barrel file to export all models
// ------------------------------------------------

export 'billing_models.dart';
export 'legend.dart';
export 'students_models.dart';
export 'additional_models.dart';
// ==========================================
// FILE: ./models/students_models.dart
// ==========================================

// lib/models/student_models.dart

/// Represents the status of a student in the academy.
enum StudentStatus { active, suspended, alumni, archived }

/// Represents the type of student (Regular School vs Private Lesson).
enum StudentType { academy, private }

class Student {
  final String id;
  final String schoolId;
  final String firstName;
  final String lastName;
  final String? admissionNumber;
  final String? gender; // 'M' or 'F'
  final DateTime? dob;
  
  // Status & Type
  final StudentStatus status;
  final StudentType type;

  // Guardian Info (Denormalized for Pro Schema Efficiency)
  final String? guardianName;
  final String? guardianPhone;
  final String? guardianEmail;
  final String? guardianRelationship;

  // Cached Financials (Quick access without joining ledger)
  final double feesOwed;

  // Audit
  final DateTime? createdAt;

  Student({
    required this.id,
    required this.schoolId,
    required this.firstName,
    required this.lastName,
    this.admissionNumber,
    this.gender,
    this.dob,
    this.status = StudentStatus.active,
    this.type = StudentType.academy,
    this.guardianName,
    this.guardianPhone,
    this.guardianEmail,
    this.guardianRelationship,
    this.feesOwed = 0.0,
    this.createdAt,
  });

  String get fullName => "$firstName $lastName";

  /// Factory to parse from PowerSync/SQLite Row
  factory Student.fromRow(Map<String, dynamic> row) {
    return Student(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      firstName: row['first_name'] as String,
      lastName: row['last_name'] as String,
      admissionNumber: row['admission_number'] as String?,
      gender: row['gender'] as String?,
      dob: row['dob'] != null ? DateTime.tryParse(row['dob']) : null,
      status: _parseStatus(row['status']),
      type: _parseType(row['student_type']),
      guardianName: row['guardian_name'] as String?,
      guardianPhone: row['guardian_phone'] as String?,
      guardianEmail: row['guardian_email'] as String?,
      guardianRelationship: row['guardian_relationship'] as String?,
      feesOwed: (row['fees_owed'] as num?)?.toDouble() ?? 0.0,
      createdAt: row['created_at'] != null ? DateTime.tryParse(row['created_at']) : null,
    );
  }

  /// Convert to Map for Saving
  Map<String, dynamic> toRow() {
    return {
      'id': id,
      'school_id': schoolId,
      'first_name': firstName,
      'last_name': lastName,
      'admission_number': admissionNumber,
      'gender': gender,
      'dob': dob?.toIso8601String(),
      'status': status.name.toUpperCase(),
      'student_type': type.name.toUpperCase(),
      'guardian_name': guardianName,
      'guardian_phone': guardianPhone,
      'guardian_email': guardianEmail,
      'guardian_relationship': guardianRelationship,
      // 'fees_owed' is usually calculated or updated via triggers, not direct UI edit
    };
  }

  static StudentStatus _parseStatus(String? val) {
    switch (val?.toUpperCase()) {
      case 'SUSPENDED': return StudentStatus.suspended;
      case 'ALUMNI': return StudentStatus.alumni;
      case 'ARCHIVED': return StudentStatus.archived;
      default: return StudentStatus.active;
    }
  }

  static StudentType _parseType(String? val) {
    return val?.toUpperCase() == 'PRIVATE' ? StudentType.private : StudentType.academy;
  }

  void operator [](String other) {}
}

class Enrollment {
  final String id;
  final String schoolId;
  final String studentId;
  final String academicYearId;
  final String gradeLevel; // "Form 1"
  final String? classStream; // "East"
  final bool isActive;

  Enrollment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.academicYearId,
    required this.gradeLevel,
    this.classStream,
    this.isActive = true,
  });

  factory Enrollment.fromRow(Map<String, dynamic> row) {
    return Enrollment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      academicYearId: row['academic_year_id'] as String,
      gradeLevel: row['grade_level'] as String,
      classStream: row['class_stream'] as String?,
      isActive: row['is_active'] == 1, // SQLite booleans are 0/1
    );
  }
}
// ==========================================
// FILE: ./repo/auth/auth_repo.dart
// ==========================================

import 'package:supabase_flutter/supabase_flutter.dart';

/// Custom Exception for UI consumption
class AppAuthException implements Exception {
  final String message;
  final String? code;
  AppAuthException(this.message, [this.code]);
  
  @override
  String toString() => message;
}

class AuthRepository {
  final SupabaseClient _supabase;

  AuthRepository(this._supabase);

  // ---------------------------------------------------------------------------
  // SESSION MANAGEMENT
  // ---------------------------------------------------------------------------
  
  User? get currentUser => _supabase.auth.currentUser;
  
  Stream<AuthState> get authStateChanges => _supabase.auth.onAuthStateChange;

  // ---------------------------------------------------------------------------
  // AUTH ACTIONS
  // ---------------------------------------------------------------------------

  /// Login with Email & Password
  Future<AuthResponse> signInWithPassword(String email, String password) async {
    try {
      final response = await _supabase.auth.signInWithPassword(
        email: email,
        password: password,
      );
      return response;
    } on AuthException catch (e) {
      throw AppAuthException(_mapAuthError(e.message), e.code);
    } catch (e) {
      throw AppAuthException('An unexpected error occurred during login.');
    }
  }

  /// Sign Up (Triggers OTP/Confirmation Email)
  Future<AuthResponse> signUp(String email, String password, String fullName) async {
    try {
      final response = await _supabase.auth.signUp(
        email: email,
        password: password,
        data: {'full_name': fullName}, // Stored in raw_user_meta_data
      );
      return response;
    } on AuthException catch (e) {
      throw AppAuthException(e.message, e.code);
    } catch (e) {
      throw AppAuthException('Sign up failed. Please try again.');
    }
  }

  /// Login with OTP (Magic Link / Code)
  Future<void> signInWithOtp(String email) async {
    try {
      await _supabase.auth.signInWithOtp(
        email: email,
        emailRedirectTo: 'io.supabase.flutter://login-callback/',
      );
    } on AuthException catch (e) {
      throw AppAuthException(e.message);
    }
  }

  /// Verify OTP (Email or Phone)
  Future<AuthResponse> verifyOtp(String email, String token, OtpType type) async {
    try {
      final response = await _supabase.auth.verifyOTP(
        email: email,
        token: token,
        type: type,
      );
      return response;
    } on AuthException {
      throw AppAuthException('Invalid Code. Please check and try again.');
    }
  }

  /// Sign Out
  Future<void> signOut() async {
    try {
      await _supabase.auth.signOut();
    } catch (e) {
      // Fail silently on logout errors, just clear local state usually
    }
  }

  /// Password Reset Request
  Future<void> resetPasswordForEmail(String email) async {
    try {
      await _supabase.auth.resetPasswordForEmail(email);
    } on AuthException catch (e) {
      throw AppAuthException(e.message);
    }
  }

  // ---------------------------------------------------------------------------
  // HELPER: Error Mapping
  // ---------------------------------------------------------------------------
  String _mapAuthError(String rawMessage) {
    if (rawMessage.contains("Invalid login credentials")) {
      return "Incorrect email or password.";
    }
    if (rawMessage.contains("Email not confirmed")) {
      return "Please confirm your email address first.";
    }
    return rawMessage;
  }
}
// ==========================================
// FILE: ./repo/auth/school_repo.dart
// ==========================================

import 'package:flutter/cupertino.dart';
import 'package:legend/models/legend.dart'; // Ensure SchoolConfig is in here
import 'package:supabase_flutter/supabase_flutter.dart';

class SchoolException implements Exception {
  final String message;
  SchoolException(this.message);
  @override
  String toString() => message;
}

class SchoolRepository {
  final SupabaseClient _supabase;

  SchoolRepository(this._supabase);

  /// --------------------------------------------------------------------------
  /// FETCH SCHOOL FOR USER (STAFF MODE)
  /// --------------------------------------------------------------------------
  Future<SchoolConfig> getSchoolForUser(String userId) async {
    try {
      debugPrint("üîç (1/2) Checking Staff Profile for: $userId");

      // STEP 1: Check the 'profiles' table to see which school this user belongs to.
      // This works because we added the 'Users manage own profile' policy.
      final profileResponse = await _supabase
          .schema('legend')
          .from('profiles')
          .select('school_id')
          .eq('id', userId)
          .maybeSingle();

      if (profileResponse == null) {
        throw SchoolException("Profile not found. Please contact support.");
      }

      if (profileResponse['school_id'] == null) {
        debugPrint("‚ùå User exists but is not linked to a school.");
        throw SchoolException("You are not linked to any school. Contact Admin.");
      }

      final String schoolId = profileResponse['school_id'];
      debugPrint("‚úÖ (1/2) Staff confirmed for School ID: $schoolId");

      // STEP 2: Fetch the School Config using the found ID.
      // This works because of the 'Staff access school config' policy.
      final configResponse = await _supabase
          .schema('legend')
          .from('config')
          .select()
          .eq('id', schoolId)
          .maybeSingle();

      if (configResponse == null) {
        throw SchoolException("Critical: Linked school configuration is missing.");
      }
      
      debugPrint("‚úÖ (2/2) School '${configResponse['school_name']}' Loaded.");

      return SchoolConfig.fromJson(configResponse);

    } on PostgrestException catch (e) {
      debugPrint("üî• DB ERROR: ${e.message} (Code: ${e.code})");
      throw SchoolException("Database Access Error: ${e.message}");
    } catch (e) {
      debugPrint("üí• SYSTEM ERROR: $e");
      throw SchoolException("System failure during school fetch.");
    }
  }

  /// --------------------------------------------------------------------------
  /// CREATE NEW SCHOOL
  /// --------------------------------------------------------------------------
  Future<SchoolConfig> createSchool({
    required String ownerId,
    required String schoolName,
    String currency = 'USD',
  }) async {
    try {
      final response = await _supabase
          .schema('legend')
          .from('config')
          .insert({
            'owner_id': ownerId,
            'school_name': schoolName,
            'currency': currency,
          })
          .select()
          .single();

      return SchoolConfig.fromJson(response);
    } catch (e) {
      throw SchoolException("Failed to register new school.");
    }
  }
}
// ==========================================
// FILE: ./repo/dashboard_repo.dart
// ==========================================

import 'package:legend/models/legend.dart';
import 'package:legend/models/additional_models.dart';
import 'package:legend/services/database_serv.dart'; // Access to global 'db'

class DashboardRepository {
  // ===========================================================================
  // 1. DASHBOARD HOME (Metrics & Feeds)
  // ===========================================================================

  /// Fetches the 4 key numbers for the Dashboard Header
  Future<DashboardStats> getDashboardStats(String schoolId) async {
    try {
      // 1. Total Students (Active)
      final studentsRes = await db.get(
        "SELECT count(*) as count FROM students WHERE school_id = ? AND status = 'ACTIVE'",
        [schoolId],
      );

      // 2. Pending Invoices (Posted but not paid)
      final invoiceRes = await db.get(
        "SELECT count(*) as count FROM invoices WHERE school_id = ? AND status = 'POSTED'",
        [schoolId],
      );

      // 3. Collected Today (Payments received since midnight)
      // SQLite: date('now') returns YYYY-MM-DD. We check if received_at starts with today's date.
      final todayRes = await db.get(
        "SELECT sum(amount) as total FROM payments WHERE school_id = ? AND date(received_at) = date('now')",
        [schoolId],
      );

      // 4. Total Owed (Sum of fees_owed column in students table)
      // This assumes you run a background job or trigger to keep student.fees_owed updated
      final owedRes = await db.get(
        "SELECT sum(fees_owed) as total FROM students WHERE school_id = ?",
        [schoolId],
      );

      return DashboardStats(
        totalStudents: (studentsRes['count'] as num?)?.toInt() ?? 0,
        pendingInvoices: (invoiceRes['count'] as num?)?.toInt() ?? 0,
        collectedToday: (todayRes['total'] as num?)?.toDouble() ?? 0.0,
        totalOwed: (owedRes['total'] as num?)?.toDouble() ?? 0.0,
      );
    } catch (e) {
      // PowerSync tables might not be ready yet
      print('Error fetching dashboard stats from PowerSync: $e');
      return DashboardStats(
        totalStudents: 0,
        pendingInvoices: 0,
        collectedToday: 0.0,
        totalOwed: 0.0,
      );
    }
  }

  /// Fetches recent payments and enrollments for the "Recent Activity" list.
  /// Formats them directly for the UI.
  Future<List<Map<String, dynamic>>> getRecentActivity(String schoolId) async {
    try {
      const sql = """
      SELECT 
        p.id, 
        'payment' as type, 
        p.amount, 
        s.first_name || ' ' || s.last_name as name,
        'Payment - ' || p.method as description,
        p.received_at as date 
      FROM payments p
      LEFT JOIN students s ON p.student_id = s.id
      WHERE p.school_id = ?
      ORDER BY p.received_at DESC 
      LIMIT 5
    """;

      final rows = await db.getAll(sql, [schoolId]);

      // Format for UI (Calculates "2 mins ago" etc.)
      return rows.map((row) {
        final date = DateTime.parse(
          (row['date'] as String?) ?? DateTime.now().toIso8601String(),
        );
        final diff = DateTime.now().difference(date);
        String timeLabel;

        if (diff.inMinutes < 60) {
          timeLabel = '${diff.inMinutes} mins ago';
        } else if (diff.inHours < 24) {
          timeLabel = '${diff.inHours} hours ago';
        } else {
          timeLabel = '${diff.inDays} days ago';
        }

        return {
          'name': row['name'] ?? 'Unknown',
          'desc': row['description'] ?? 'No description',
          'time': timeLabel,
          'amount': ((row['amount'] as num?) ?? 0).toDouble(),
        };
      }).toList();
    } catch (e) {
      // PowerSync tables might not be ready yet
      print('Error fetching recent activity from PowerSync: $e');
      return [];
    }
  }

  // ===========================================================================
  // 2. STATISTICS SCREEN (Charts & Analysis)
  // ===========================================================================

  /// Fetches daily revenue for the last 7 days for the Line Chart.
  /// Returns a Map of { 'MM-DD': amount }
  Future<List<Map<String, dynamic>>> getRevenueTrend(String schoolId) async {
    const sql = """
      SELECT 
        date(received_at) as day, 
        sum(amount) as total 
      FROM payments 
      WHERE school_id = ? 
      AND received_at >= date('now', '-7 days')
      GROUP BY day
      ORDER BY day ASC
    """;

    return await db.getAll(sql, [schoolId]);
  }

  /// Aggregates Debt by Grade Level for the Bar Chart.
  Future<List<Map<String, dynamic>>> getDebtByGrade(String schoolId) async {
    // We join Students with Enrollments to get the grade_level
    const sql = """
      SELECT 
        e.grade_level as grade, 
        sum(s.fees_owed) as amount 
      FROM students s
      JOIN enrollments e ON s.id = e.student_id
      WHERE s.school_id = ? AND e.is_active = 1
      GROUP BY e.grade_level
      ORDER BY amount DESC
    """;

    return await db.getAll(sql, [schoolId]);
  }

  /// Payment Method Breakdown (Cash vs EcoCash vs Bank)
  Future<Map<String, double>> getPaymentMethodStats(String schoolId) async {
    final rows = await db.getAll(
      "SELECT method, count(*) as count FROM payments WHERE school_id = ? GROUP BY method",
      [schoolId],
    );

    final Map<String, double> result = {};
    for (var row in rows) {
      result[row['method'] as String] = (row['count'] as num).toDouble();
    }
    return result;
  }

  // ===========================================================================
  // 3. NOTIFICATIONS (Live Streams)
  // ===========================================================================

  /// WATCH: List of notifications (Real-time updates)
  Stream<List<LegendNotification>> watchNotifications(String schoolId) {
    return db
        .watch(
          "SELECT * FROM noti WHERE school_id = ? ORDER BY created_at DESC",
          parameters: [schoolId],
        )
        .map((rows) {
          return rows.map((row) => LegendNotification.fromRow(row)).toList();
        });
  }

  /// WATCH: Count of unread notifications (For Badge)
  Stream<int> watchUnreadCount(String schoolId) {
    return db
        .watch(
          "SELECT count(*) as count FROM noti WHERE school_id = ? AND is_read = 0",
          parameters: [schoolId],
        )
        .map((rows) => (rows.first['count'] as num).toInt());
  }

  /// WRITE: Mark specific notification as read
  Future<void> markAsRead(String notiId) async {
    await db.execute("UPDATE noti SET is_read = 1 WHERE id = ?", [notiId]);
  }

  /// WRITE: Mark ALL as read
  Future<void> markAllAsRead(String schoolId) async {
    await db.execute("UPDATE noti SET is_read = 1 WHERE school_id = ?", [
      schoolId,
    ]);
  }

  /// WRITE: Clear all notifications
  Future<void> clearAllNotifications(String schoolId) async {
    await db.execute("DELETE FROM noti WHERE school_id = ?", [schoolId]);
  }

  // In lib/repositories/dashboard_repo.dart
  Future<void> deleteNotification(String id) async {
    await db.execute("DELETE FROM noti WHERE id = ?", [id]);
  }

  /// Fetches user profile from the profiles table
  Future<LegendProfile?> getUserProfile(String userId) async {
    try {
      final result = await db.getOptional(
        "SELECT * FROM profiles WHERE id = ?",
        [userId],
      );

      if (result != null) {
        return LegendProfile.fromRow(result);
      }
      return null;
    } catch (e) {
      // PowerSync table might not exist yet or data is incomplete
      print('Error fetching user profile from PowerSync: $e');
      return null;
    }
  }
}

// ==========================================
// FILE: ./constants/app_constants.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

// -----------------------------------------------------------------------------
// APP COLORS (Slate & Blue)
// -----------------------------------------------------------------------------
class AppColors {
  // Backgrounds
  static const Color backgroundBlack = Color(0xFF0F172A); // Slate 900
  static const Color surfaceDarkGrey = Color(0xFF1E293B); // Slate 800
  static const Color surfaceLightGrey = Color(0xFF334155); // Slate 700

  // Brand
  static const Color primaryBlue = Color(0xFF3B82F6); // Blue 500
  static const Color primaryBlueDark = Color(0xFF2563EB); // Blue 600
  static const Color primaryBlueLight = Color(0xFF60A5FA); // Blue 400

  // Text
  static const Color textWhite = Color(0xFFF8FAFC); // Slate 50
  static const Color textGrey = Color(0xFF94A3B8); // Slate 400
  
  // Functional
  static const Color errorRed = Color(0xFFEF4444);
  static const Color successGreen = Color(0xFF10B981);
}

// -----------------------------------------------------------------------------
// APP STRINGS
// -----------------------------------------------------------------------------
class AppStrings {
  static const String appName = "KwaLegend Manager";
  
  // Shell Titles
  static const String dashboardTitle = "Dashboard";
  static const String studentsTitle = "Students";
  static const String financeTitle = "Finance";
  static const String settingsTitle = "Profile"; // Combined Settings/Profile for Sir Legend

  // Screen Titles
  static const String statsTitle = "Statistics";
  static const String notificationsTitle = "Notifications";
  static const String invoicesTitle = "Invoices";
  static const String createInvoiceTitle = "New Invoice";
  static const String logsTitle = "Activity Logs";
  static const String tosTitle = "Terms of Service";
  static const String contactDevTitle = "Contact Developer";
}

// -----------------------------------------------------------------------------
// APP THEME
// -----------------------------------------------------------------------------
class AppTheme {
  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      scaffoldBackgroundColor: AppColors.backgroundBlack,
      primaryColor: AppColors.primaryBlue,
      fontFamily: GoogleFonts.jetBrainsMono().fontFamily,
      colorScheme: const ColorScheme.dark(
        primary: AppColors.primaryBlue,
        onPrimary: Colors.white,
        secondary: AppColors.surfaceDarkGrey,
        onSecondary: Colors.white,
        surface: AppColors.surfaceDarkGrey,
        error: AppColors.errorRed,
        background: AppColors.backgroundBlack,
      ),
      appBarTheme: const AppBarTheme(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: false,
        titleTextStyle: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white),
        iconTheme: IconThemeData(color: Colors.white),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColors.primaryBlue,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          textStyle: const TextStyle(fontWeight: FontWeight.bold),
        ),
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// ROUTES
// -----------------------------------------------------------------------------
class AppRoutes {
  // --- 1. Auth & Legal ---
  static const String login = '/login';
  static const String signup = '/signup';
  static const String resetPassword = '/reset-password';
  static const String tos = '/tos'; // Terms of Service

  // --- 2. Shell (Main Tabs) ---
  static const String dashboard = '/dashboard';
  static const String students = '/students';
  static const String finance = '/finance';
  static const String settings = '/settings';

  // --- 3. Dashboard Features ---
  static const String notifications = 'notifications'; // /dashboard/notifications
  static const String statistics = 'statistics'; // /dashboard/statistics

  // --- 4. Student Features ---
  static const String addStudent = 'add'; // /students/add
  static const String viewStudent = 'view/:studentId'; // /students/view/123
  static const String studentLogs = 'logs/:studentId'; // /students/logs/123

  // --- 5. Finance Features ---
  static const String createInvoice = 'invoice/new'; // /finance/invoice/new
  static const String viewInvoice = 'invoice/:invoiceId'; // /finance/invoice/INV-001
  static const String recordPayment = 'payment/new'; // /finance/payment/new

  // --- 6. Settings Features ---
  static const String contactDev = 'contact-dev'; // /settings/contact-dev
}
// ==========================================
// FILE: ./constants/app_schema.dart
// ==========================================

import 'package:powersync/powersync.dart';

/// The Official Offline-First Schema for KwaLegend
/// Matches the 'legend' schema in Supabase exactly.
final schema = Schema([
  // ---------------------------------------------------------------------------
  // 1. CORE ACADEMIC CONFIGURATION
  // ---------------------------------------------------------------------------
  Table('academic_years', [
    Column.text('name'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('is_active'), // 0 or 1
    Column.integer('is_locked'), // 0 or 1
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('terms', [
    Column.text('academic_year_id'),
    Column.text('name'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('is_active'),
    Column.text('school_id'),
  ]),

  Table('grades', [
    Column.text('name'),
    Column.integer('level_index'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('classes', [
    Column.text('school_id'),
    Column.text('grade_id'),
    Column.text('name'),
    Column.text('teacher_id'), // Link to profiles
    Column.text('created_at'),
  ]),

  Table('fee_categories', [
    Column.text('name'),
    Column.integer('is_taxable'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('fee_structures', [
    Column.text('academic_year_id'),
    Column.text('category_id'),
    Column.text('name'),
    Column.real('amount'),
    Column.text('billing_type'), // tuition, exam, etc.
    Column.text('recurrence'),   // termly, monthly
    Column.text('billable_months'), // stored as JSON string or comma-separated
    Column.text('target_grade'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  // ---------------------------------------------------------------------------
  // 2. PEOPLE (Students & Staff)
  // ---------------------------------------------------------------------------
  Table('profiles', [
    Column.text('full_name'),
    Column.text('role'),
    Column.integer('is_banned'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('students', [
    Column.text('first_name'),
    Column.text('last_name'),
    Column.text('admission_number'),
    Column.text('gender'),
    Column.text('status'),       // ACTIVE, ARREARS
    Column.text('student_type'), // ACADEMY, PRIVATE
    Column.text('guardian_name'),
    Column.text('guardian_phone'),
    Column.text('guardian_email'),
    Column.text('guardian_relationship'),
    Column.real('fees_owed'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('enrollments', [
    Column.text('student_id'),
    Column.text('academic_year_id'),
    Column.text('grade_level'),
    Column.text('class_stream'),
    Column.integer('is_active'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  // ---------------------------------------------------------------------------
  // 3. FINANCE & BILLING
  // ---------------------------------------------------------------------------
  Table('invoices', [
    Column.text('student_id'),
    Column.text('invoice_number'),
    Column.text('term_id'),
    Column.text('due_date'),
    Column.text('status'), // DRAFT, POSTED, PAID, VOID
    Column.text('snapshot_grade'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('invoice_items', [
    Column.text('invoice_id'),
    Column.text('fee_structure_id'),
    Column.text('description'),
    Column.real('amount'),
    Column.integer('quantity'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('payments', [
    Column.text('student_id'),
    Column.real('amount'),
    Column.text('method'),
    Column.text('reference_code'),
    Column.text('received_at'),
    Column.text('school_id'),
  ]),

  Table('payment_allocations', [
    Column.text('payment_id'),
    Column.text('invoice_item_id'),
    Column.real('amount_allocated'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  Table('ledger', [
    Column.text('student_id'),
    Column.text('type'), // DEBIT, CREDIT
    Column.text('category'),
    Column.real('amount'),
    Column.text('invoice_id'),
    Column.text('payment_id'),
    Column.text('description'),
    Column.text('occurred_at'),
    Column.text('school_id'),
  ]),

  // ---------------------------------------------------------------------------
  // 4. SYSTEM & UTILITY
  // ---------------------------------------------------------------------------
  Table('config', [
    Column.text('school_name'),
    Column.text('address'),
    Column.text('currency'),
    Column.text('logo_url'),
    Column.text('owner_id'),
    Column.text('created_at'),
  ]),

  Table('noti', [
    Column.text('school_id'),
    Column.text('user_id'),
    Column.text('title'),
    Column.text('message'),
    Column.text('type'),
    Column.integer('is_read'),
    Column.text('metadata'), // JSON String
    Column.text('created_at'),
  ]),
  
  // Dev table excluded for safety unless explicitly requested
]);
// ==========================================
// FILE: ./constants/subjects.dart
// ==========================================

// File: lib/models/subjects.dart

class ZimsecSubject {
  static const Map<int, String> _codeMap = {
    // --- FORM 1 - 4 (O-LEVEL) CORE ---
    // These are the "Must-Haves" for almost every student.
    4005: 'English Language',
    4004: 'Mathematics',
    4003: 'Combined Science', // Replaces Integrated Science
    4006: 'Heritage Studies',
    4007: 'Shona',
    4068: 'Ndebele',
    4001: 'Agriculture',

    // --- FORM 1 - 4 (O-LEVEL) POPULAR ELECTIVES ---
    // Commercials & Arts
    4049: 'Commerce',
    4037: 'Geography',
    4044: 'History',
    4047: 'Family & Religious Studies', // F.R.S (formerly Divinity/R.E)
    4048: 'Business Enterprise Skills',
    4051: 'Principles of Accounting',

    // Sciences & Tech
    4029: 'Computer Science',
    4025: 'Biology',
    4023: 'Physics',
    4024:
        'Chemistry', // Often listed as 5070/5071 in older systems, but 4024 in new curriculum maps
    4059: 'Wood Technology and Design',

    // --- FORM 5 - 6 (A-LEVEL) ---
    // Commercials
    6001: 'Accounting (A-Level)',
    6025: 'Business Studies',
    6073: 'Economics',

    // Arts / Humanities
    6022: 'Geography (A-Level)',
    6006: 'History (A-Level)',
    6003: 'Divinity',
    6009: 'Literature in English',
    6081: 'Heritage Studies (A-Level)',

    // Sciences
    6042: 'Pure Mathematics',
    6030: 'Biology (A-Level)',
    6031: 'Chemistry (A-Level)',
    6032: 'Physics (A-Level)',
    6046: 'Statistics',
    6008: 'Computer Science (A-Level)',
  };

  // This is the getter your Registration Page is looking for:
  static List<String> get allNames => _codeMap.values.toList();

  static String nameFromCode(int code) => _codeMap[code] ?? 'Unknown';
}

class EnrolledSubject {
  final String subjectName;
  final String studentId;

  EnrolledSubject({required this.subjectName, required this.studentId});

  Map<String, dynamic> toJson() => {
    'subjectName': subjectName,
    'studentId': studentId,
  };

  factory EnrolledSubject.fromJson(Map<String, dynamic> json) {
    return EnrolledSubject(
      subjectName: json['subjectName'],
      studentId: json['studentId'],
    );
  }
}

// ==========================================
// FILE: ./app_router.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:google_nav_bar/google_nav_bar.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/screens/contact_dev_screen.dart';
import 'package:legend/screens/settings/tos_screen.dart';
import 'package:legend/services/auth/auth_serv.dart';

// Import Screens
import 'package:legend/screens/all_screens_export.dart';
import 'package:legend/screens/finance/create_invoice_screen.dart';
import 'package:legend/screens/finance/record_payment_screen.dart';
import 'package:legend/screens/finance/view_invoice_screen.dart';
import 'package:legend/screens/students/add_student_screen.dart';
import 'package:legend/screens/students/student_logs_screen.dart';
import 'package:legend/screens/students/view_student_screen.dart';

final GlobalKey<NavigatorState> _rootNavigatorKey = GlobalKey<NavigatorState>();

class LegendRouter {
  final AuthService authService;

  LegendRouter(this.authService);

  late final GoRouter router = GoRouter(
    navigatorKey: _rootNavigatorKey,
    initialLocation: AppRoutes.dashboard, // We aim for dashboard, redirect handles the rest
    
    // -------------------------------------------------------------------------
    // THE MAGIC LINK: This listens to AuthService.notifyListeners()
    // -------------------------------------------------------------------------
    refreshListenable: authService,

    // -------------------------------------------------------------------------
    // THE BOUNCER: Security Logic
    // -------------------------------------------------------------------------
    redirect: (context, state) {
      final isLoggedIn = authService.isAuthenticated;
      final location = state.uri.toString();

      // Define public routes
      final isAuthRoute = location == AppRoutes.login || 
                          location == AppRoutes.signup || 
                          location == AppRoutes.resetPassword;

      // 1. If NOT logged in...
      if (!isLoggedIn) {
        // ...and trying to go to a protected route -> Redirect to Login
        if (!isAuthRoute) return AppRoutes.login;
      }

      // 2. If LOGGED IN...
      if (isLoggedIn) {
        // ...and trying to go to Login/Signup -> Redirect to Dashboard
        if (isAuthRoute) return AppRoutes.dashboard;
      }

      // 3. Otherwise, let them pass
      return null;
    },

    errorBuilder: (context, state) => const Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Center(child: Text('Route Error', style: TextStyle(color: Colors.white))),
    ),

    routes: [
      // =========================================================================
      // 1. AUTH & PUBLIC
      // =========================================================================
      GoRoute(path: AppRoutes.login, builder: (context, state) => const LoginScreen()),
      GoRoute(path: AppRoutes.signup, builder: (context, state) => const SignupScreen()),
      GoRoute(path: AppRoutes.resetPassword, builder: (context, state) => const ForgotPasswordScreen()),
      GoRoute(path: AppRoutes.tos, builder: (context, state) => const TosScreen()),

      // =========================================================================
      // 2. SHELL ROUTES (Bottom Navigation)
      // =========================================================================
      StatefulShellRoute.indexedStack(
        builder: (context, state, navigationShell) {
          return AppShell(navigationShell: navigationShell);
        },
        branches: [
          // --- BRANCH 0: DASHBOARD ---
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.dashboard,
                builder: (context, state) => const DashboardScreen(),
                routes: [
                  GoRoute(path: AppRoutes.notifications, builder: (context, state) => const NotificationsScreen()),
                  GoRoute(path: AppRoutes.statistics, builder: (context, state) => const StatisticsScreen()),
                ],
              ),
            ],
          ),

          // --- BRANCH 1: STUDENTS ---
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.students,
                builder: (context, state) => const StudentsScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.addStudent,
                    parentNavigatorKey: _rootNavigatorKey, 
                    builder: (context, state) => const AddStudentScreen(),
                  ),
                  GoRoute(
                    path: AppRoutes.viewStudent,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => ViewStudentScreen(studentId: state.pathParameters['studentId']),
                  ),
                  GoRoute(
                    path: AppRoutes.studentLogs,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => StudentLogsScreen(studentId: state.pathParameters['studentId']),
                  ),
                ],
              ),
            ],
          ),

          // --- BRANCH 2: FINANCE ---
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.finance,
                builder: (context, state) => const FinanceScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.createInvoice,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => const CreateInvoiceScreen(),
                  ),
                  GoRoute(
                    path: AppRoutes.viewInvoice,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => ViewInvoiceScreen(invoiceId: state.pathParameters['invoiceId']),
                  ),
                  GoRoute(
                    path: AppRoutes.recordPayment,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => RecordPaymentScreen(studentId: state.uri.queryParameters['studentId']),
                  ),
                ],
              ),
            ],
          ),

          // --- BRANCH 3: SETTINGS ---
          StatefulShellBranch(
            routes: [
              GoRoute(
                path: AppRoutes.settings,
                builder: (context, state) => const SettingsScreen(),
                routes: [
                  GoRoute(
                    path: AppRoutes.contactDev,
                    parentNavigatorKey: _rootNavigatorKey,
                    builder: (context, state) => const ContactDevScreen(),
                  ),
                ],
              ),
            ],
          ),
        ],
      ),
    ],
  );
}

// =============================================================================
// APP SHELL
// =============================================================================
class AppShell extends StatelessWidget {
  final StatefulNavigationShell navigationShell;

  const AppShell({required this.navigationShell, super.key});

  void _onTabSelected(int index) {
    navigationShell.goBranch(
      index,
      initialLocation: index == navigationShell.currentIndex,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: navigationShell,
      bottomNavigationBar: Container(
        decoration: const BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          border: Border(top: BorderSide(color: AppColors.surfaceLightGrey, width: 0.5)),
        ),
        child: SafeArea(
          top: false,
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
            child: GNav(
              backgroundColor: AppColors.surfaceDarkGrey,
              tabBackgroundColor: AppColors.primaryBlueLight.withAlpha(50),
              color: AppColors.textGrey,
              activeColor: AppColors.textWhite,
              gap: 8,
              tabBorderRadius: 12,
              iconSize: 22,
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              selectedIndex: navigationShell.currentIndex,
              onTabChange: _onTabSelected,
              tabs: const [
                GButton(icon: Icons.dashboard_outlined, text: AppStrings.dashboardTitle),
                GButton(icon: Icons.people_outline, text: AppStrings.studentsTitle),
                GButton(icon: Icons.account_balance_wallet_outlined, text: AppStrings.financeTitle),
                GButton(icon: Icons.person_outline, text: AppStrings.settingsTitle),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/utils/all_utils.dart
// ==========================================

export 'subject_selector_field.dart';
// ==========================================
// FILE: ./screens/utils/subject_selector_field.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:legend/constants/app_constants.dart';
import '../../constants/subjects.dart'; // Ensure this points to your ZimsecSubject model

class SubjectSelectorField extends StatefulWidget {
  final List<String> selectedSubjects;
  final ValueChanged<List<String>> onChanged;

  const SubjectSelectorField({
    super.key,
    required this.selectedSubjects,
    required this.onChanged,
  });

  @override
  State<SubjectSelectorField> createState() => _SubjectSelectorFieldState();
}

class _SubjectSelectorFieldState extends State<SubjectSelectorField> {
  void _openSearchModal() async {
    final result = await showModalBottomSheet<List<String>>(
      context: context,
      isScrollControlled: true, // Critical for full height
      backgroundColor: Colors.transparent,
      builder: (context) => _SubjectSearchModal(
        initialSelection: widget.selectedSubjects,
        allSubjects: ZimsecSubject.allNames, 
      ),
    );

    if (result != null) {
      widget.onChanged(result);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // 1. THE TRIGGER BUTTON
        InkWell(
          onTap: _openSearchModal,
          borderRadius: BorderRadius.circular(12),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            decoration: BoxDecoration(
              color: AppColors.backgroundBlack,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
            ),
            child: Row(
              children: [
                const Icon(Icons.menu_book_outlined, color: AppColors.textGrey, size: 20),
                const SizedBox(width: 12),
                Text(
                  widget.selectedSubjects.isEmpty 
                      ? "Select Subjects..." 
                      : "${widget.selectedSubjects.length} Subjects Selected",
                  style: TextStyle(
                    color: widget.selectedSubjects.isEmpty ? AppColors.textGrey : Colors.white,
                    fontSize: 16,
                  ),
                ),
                const Spacer(),
                const Icon(Icons.arrow_drop_down, color: AppColors.textGrey),
              ],
            ),
          ),
        ),

        // 2. THE CHIP DISPLAY (If items selected)
        if (widget.selectedSubjects.isNotEmpty) ...[
          const SizedBox(height: 12),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: widget.selectedSubjects.map((subject) {
              return Chip(
                label: Text(
                  subject, 
                  style: const TextStyle(fontSize: 12, color: Colors.white),
                ),
                backgroundColor: AppColors.primaryBlue.withAlpha(40),
                deleteIcon: const Icon(Icons.close, size: 14, color: Colors.white70),
                side: BorderSide.none,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                onDeleted: () {
                  final newList = List<String>.from(widget.selectedSubjects);
                  newList.remove(subject);
                  widget.onChanged(newList);
                },
              );
            }).toList(),
          ),
        ],
      ],
    );
  }
}

// -----------------------------------------------------------------------------
// INTERNAL MODAL WIDGET (With Custom Adder)
// -----------------------------------------------------------------------------
class _SubjectSearchModal extends StatefulWidget {
  final List<String> initialSelection;
  final List<String> allSubjects;

  const _SubjectSearchModal({
    required this.initialSelection,
    required this.allSubjects,
  });

  @override
  State<_SubjectSearchModal> createState() => _SubjectSearchModalState();
}

class _SubjectSearchModalState extends State<_SubjectSearchModal> {
  late List<String> _selected;
  late List<String> _filteredList;
  final TextEditingController _searchCtrl = TextEditingController();
  
  // Custom Subject Helper State
  String? _customSubjectCandidate;

  @override
  void initState() {
    super.initState();
    _selected = List.from(widget.initialSelection);
    _filteredList = List.from(widget.allSubjects);
    
    // Ensure existing custom subjects (not in the static list) are visible
    for (var s in _selected) {
      if (!_filteredList.contains(s)) {
        _filteredList.add(s);
      }
    }
    
    _sortList();
  }

  void _sortList() {
    _filteredList.sort((a, b) {
      final aSelected = _selected.contains(a);
      final bSelected = _selected.contains(b);
      if (aSelected && !bSelected) return -1;
      if (!aSelected && bSelected) return 1;
      return a.compareTo(b);
    });
  }

  void _filter(String query) {
    setState(() {
      final cleanQuery = query.trim();
      
      if (cleanQuery.isEmpty) {
        _filteredList = List.from(widget.allSubjects);
        // Re-add selected custom ones if any
        for (var s in _selected) {
          if (!_filteredList.contains(s)) _filteredList.add(s);
        }
        _customSubjectCandidate = null;
      } else {
        // Standard Filter
        _filteredList = widget.allSubjects
            .where((s) => s.toLowerCase().contains(cleanQuery.toLowerCase()))
            .toList();
        
        // Check if exact match exists
        final exactMatch = _filteredList.any((s) => s.toLowerCase() == cleanQuery.toLowerCase());
        
        // If no exact match, propose adding it
        if (!exactMatch && cleanQuery.isNotEmpty) {
          _customSubjectCandidate = cleanQuery;
        } else {
          _customSubjectCandidate = null;
        }
      }
      _sortList();
    });
  }

  void _toggleItem(String subject) {
    setState(() {
      if (_selected.contains(subject)) {
        _selected.remove(subject);
      } else {
        _selected.add(subject);
      }
      _searchCtrl.clear();
      _filter(''); // Reset filter to show selection
    });
  }

  void _addCustomSubject() {
    if (_customSubjectCandidate != null) {
      // Capitalize first letter for neatness
      final formatted = toBeginningOfSentenceCase(_customSubjectCandidate!) ?? _customSubjectCandidate!;
      
      setState(() {
        if (!_filteredList.contains(formatted)) {
          _filteredList.insert(0, formatted); // Add to local list view
        }
        if (!_selected.contains(formatted)) {
          _selected.add(formatted);
        }
        _searchCtrl.clear();
        _customSubjectCandidate = null;
        _filter(''); // Reset view
      });
    }
  }
  
  // Helper for capitalization since intl might not be everywhere
  String? toBeginningOfSentenceCase(String input) {
    if (input.isEmpty) return input;
    return input[0].toUpperCase() + input.substring(1);
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.85, 
      decoration: const BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          // 1. DRAG HANDLE & TITLE
          const SizedBox(height: 12),
          Container(
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: AppColors.surfaceLightGrey,
              borderRadius: BorderRadius.circular(2),
            ),
          ),
          const Padding(
            padding: EdgeInsets.symmetric(vertical: 16),
            child: Text(
              "Manage Enrollment",
              style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold),
            ),
          ),

          // 2. SEARCH BAR
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20),
            child: TextField(
              controller: _searchCtrl,
              onChanged: _filter,
              style: const TextStyle(color: Colors.white),
              decoration: InputDecoration(
                hintText: "Search or add custom...",
                hintStyle: const TextStyle(color: AppColors.textGrey),
                prefixIcon: const Icon(Icons.search, color: AppColors.textGrey),
                filled: true,
                fillColor: AppColors.surfaceDarkGrey,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                contentPadding: const EdgeInsets.symmetric(vertical: 12),
              ),
            ),
          ),
          const SizedBox(height: 16),

          // 3. LIST VIEW
          Expanded(
            child: ListView(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              children: [
                // A. CUSTOM ADDER TILE (Only if candidate exists)
                if (_customSubjectCandidate != null) ...[
                  ListTile(
                    onTap: _addCustomSubject,
                    contentPadding: EdgeInsets.zero,
                    leading: Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: AppColors.successGreen.withAlpha(20),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: const Icon(Icons.add, color: AppColors.successGreen, size: 20),
                    ),
                    title: RichText(
                      text: TextSpan(
                        text: "Add custom: ",
                        style: const TextStyle(color: AppColors.textGrey, fontSize: 14),
                        children: [
                          TextSpan(
                            text: '"$_customSubjectCandidate"',
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 15),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const Divider(color: AppColors.surfaceLightGrey, height: 24),
                ],

                // B. STANDARD LIST
                ..._filteredList.map((subject) {
                  final isSelected = _selected.contains(subject);
                  return Column(
                    children: [
                      ListTile(
                        onTap: () => _toggleItem(subject),
                        contentPadding: EdgeInsets.zero,
                        title: Text(
                          subject,
                          style: TextStyle(
                            color: isSelected ? AppColors.primaryBlueLight : Colors.white,
                            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                          ),
                        ),
                        trailing: isSelected
                            ? const Icon(Icons.check_circle, color: AppColors.primaryBlue)
                            : const Icon(Icons.circle_outlined, color: AppColors.textGrey),
                      ),
                      const Divider(color: AppColors.surfaceDarkGrey, height: 1),
                    ],
                  );
                }),
              ],
            ),
          ),

          // 4. DONE BUTTON
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(20),
              child: SizedBox(
                width: double.infinity,
                height: 50,
                child: ElevatedButton(
                  onPressed: () => Navigator.pop(context, _selected),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                  child: Text("Done (${_selected.length})", style: const TextStyle(fontWeight: FontWeight.bold)),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/contact_dev_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:url_launcher/url_launcher.dart';

class ContactDevScreen extends StatefulWidget {
  const ContactDevScreen({super.key});

  @override
  State<ContactDevScreen> createState() => _ContactDevScreenState();
}

class _ContactDevScreenState extends State<ContactDevScreen> with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 4),
    )..repeat(reverse: true);
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  Future<void> _launch(String url) async {
    final uri = Uri.parse(url);
    if (!await launchUrl(uri)) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Could not launch uplink.")),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black, // Pure black for drama
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
      ),
      body: Stack(
        children: [
          // 1. BACKGROUND GLOW
          Positioned.fill(
            child: Container(
              decoration: BoxDecoration(
                gradient: RadialGradient(
                  center: Alignment.topCenter,
                  radius: 1.5,
                  colors: [
                    const Color(0xFF1A1A2E), // Deep Blue/Purple
                    Colors.black,
                  ],
                ),
              ),
            ),
          ),

          // 2. MAIN CONTENT
          Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(32),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  // --- THE CORE (Icon) ---
                  AnimatedBuilder(
                    animation: _controller,
                    builder: (context, child) {
                      return Container(
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: AppColors.primaryBlue.withAlpha(100),
                              blurRadius: 50 + (20 * _controller.value),
                              spreadRadius: 10 * _controller.value,
                            ),
                          ],
                        ),
                        child: child,
                      );
                    },
                    child: const Icon(
                      Icons.coronavirus, // The "Spiky Science" Icon
                      size: 120,
                      color: Colors.white,
                    ),
                  ),
                  
                  const SizedBox(height: 48),

                  // --- THE TITLE ---
                  const Text(
                    "THE ARCHITECT",
                    style: TextStyle(
                      fontFamily: 'monospace', // Or JetBrains Mono if available
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      letterSpacing: 4.0,
                      color: Colors.white,
                    ),
                  ),
                  
                  const SizedBox(height: 16),
                  
                  // --- THE SUBTITLE ---
                  Text(
                    "System behaving unexpectedly?\nNeed a feature injection?\nInitiate protocol.",
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 14,
                      height: 1.6,
                      color: Colors.white.withAlpha(150),
                      letterSpacing: 1.2,
                    ),
                  ),

                  const SizedBox(height: 64),

                  // --- ACTION BUTTONS ---
                  _buildDramaticButton(
                    context,
                    label: "WHATSAPP UPLINK",
                    icon: Icons.chat_bubble_outline,
                    color: const Color(0xFF25D366),
                    onTap: () => _launch("https://wa.me/263771234567"), // Replace with your number
                  ),
                  
                  const SizedBox(height: 20),
                  
                  _buildDramaticButton(
                    context,
                    label: "SEND PAYLOAD (EMAIL)",
                    icon: Icons.alternate_email,
                    color: AppColors.primaryBlue,
                    onTap: () => _launch("mailto:dev@greyway.co"), // Replace with your email
                  ),
                  
                  const SizedBox(height: 40),
                  
                  // --- FOOTER ---
                  Text(
                    "BUILD: ALPHA 0.9.2 // GREYWAY.CO",
                    style: TextStyle(
                      fontFamily: 'monospace',
                      fontSize: 10,
                      color: Colors.white.withAlpha(50),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDramaticButton(BuildContext context, {
    required String label, 
    required IconData icon, 
    required Color color,
    required VoidCallback onTap,
  }) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(8),
        child: Container(
          width: double.infinity,
          padding: const EdgeInsets.symmetric(vertical: 20),
          decoration: BoxDecoration(
            border: Border.all(color: color.withAlpha(150), width: 1),
            borderRadius: BorderRadius.circular(8),
            gradient: LinearGradient(
              colors: [
                color.withAlpha(20),
                Colors.transparent,
              ],
              begin: Alignment.centerLeft,
              end: Alignment.centerRight,
            ),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(icon, color: color, size: 20),
              const SizedBox(width: 12),
              Text(
                label,
                style: TextStyle(
                  color: color,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 2.0,
                  fontSize: 14,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/students/view_student_screen.dart
// ==========================================

// ignore_for_file: unused_field

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/models/students_models.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:legend/vmodels/students_vmodel.dart';
import 'package:provider/provider.dart';

// =============================================================================
// 1. LOCAL STRINGS & CONSTANTS
// =============================================================================
class _ViewStrings {
  static const String pageTitle = "Student Profile";

  // Status Labels
  static const String statusActive = "ACTIVE";
  static const String statusArrears = "ARREARS";

  // Tabs
  static const String tabOverview = "Overview";
  static const String tabFinance = "Finance";
  static const String tabAcademic = "Academic";

  // Actions
  static const String actCall = "Call Guardian";
  static const String actWhatsApp = "WhatsApp";
  static const String actLogPayment = "Log Payment";

  // Section Headers
  static const String secIdentity = "Identity & Class";
  static const String secGuardian = "Guardian / Payer";
  static const String secSubjects = "Enrolled Subjects";
  static const String secLedger = "Recent Transactions";

  // Labels
  static const String lblAdmNum = "ID";
  static const String lblDob = "DOB";
  static const String lblGender = "Gender";
  static const String lblType = "Type";
  static const String lblPhone = "Phone";
  static const String lblRelation = "Relation";

  // Finance
  static const String lblOwed = "Outstanding Balance";
  static const String lblPaid = "Paid YTD";

  // Fallbacks
  static const String noSubjects = "No subjects registered";
  static const String loading = "Loading student profile...";
  static const String error = "Could not load student data.";
}

// =============================================================================
// 3. SCREEN IMPLEMENTATION
// =============================================================================
class ViewStudentScreen extends StatefulWidget {
  final String? studentId;

  const ViewStudentScreen({super.key, this.studentId});

  @override
  State<ViewStudentScreen> createState() => _ViewStudentScreenState();
}

class _ViewStudentScreenState extends State<ViewStudentScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  late StudentDetailViewModel _vm;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);

    // Get dependencies from context
    final authService = context.read<AuthService>();
    final repo = PowerSyncStudentRepository();
    final schoolId = authService.activeSchool?.id ?? '';

    _vm = StudentDetailViewModel(repo, schoolId);
    _load();
  }

  void _load() async {
    // Load student data - handle null gracefully
    final studentId = widget.studentId;
    if (studentId != null && studentId.isNotEmpty) {
      await _vm.loadStudent(studentId);
    } else {
      // Set error state if no studentId provided
      debugPrint('ERROR: No student ID provided to ViewStudentScreen');
    }
    if (mounted) setState(() {});
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  String _getStatusText(StudentStatus status) {
    switch (status) {
      case StudentStatus.active:
        return "ACTIVE";
      case StudentStatus.suspended:
        return "SUSPENDED";
      case StudentStatus.alumni:
        return "ALUMNI";
      case StudentStatus.archived:
        return "ARCHIVED";
    }
  }

  String _getTypeText(StudentType type) {
    switch (type) {
      case StudentType.academy:
        return "Academy";
      case StudentType.private:
        return "Private";
    }
  }

  String? _getCurrentGrade() {
    // Get current grade from enrollments
    if (_vm.enrollments.isNotEmpty) {
      // Return the most recent active enrollment's grade level
      final activeEnrollment = _vm.enrollments.firstWhere(
        (e) => e.isActive,
        orElse: () => _vm.enrollments.first,
      );
      return activeEnrollment.gradeLevel;
    }
    return null;
  }

  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider.value(
      value: _vm,
      child: Consumer<StudentDetailViewModel>(
        builder: (context, vm, _) {
          if (vm.isLoading) {
            return const Scaffold(
              backgroundColor: AppColors.backgroundBlack,
              body: Center(
                child: CircularProgressIndicator(color: AppColors.primaryBlue),
              ),
            );
          }

          if (vm.student == null) {
            return Scaffold(
              backgroundColor: AppColors.backgroundBlack,
              appBar: AppBar(backgroundColor: AppColors.backgroundBlack),
              body: Center(
                child: Text(
                  vm.error ?? _ViewStrings.error,
                  style: const TextStyle(color: Colors.white),
                ),
              ),
            );
          }

          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: NestedScrollView(
              headerSliverBuilder: (context, innerBoxIsScrolled) {
                return [
                  SliverAppBar(
                    expandedHeight: 250.0,
                    floating: false,
                    pinned: true,
                    backgroundColor: AppColors.backgroundBlack,
                    elevation: 0,
                    leading: IconButton(
                      icon: const Icon(
                        Icons.arrow_back_ios_new,
                        color: Colors.white,
                      ),
                      onPressed: () => context.pop(),
                    ),
                    actions: [
                      IconButton(
                        icon: const Icon(
                          Icons.edit_outlined,
                          color: Colors.white,
                        ),
                        onPressed: vm.student != null
                            ? () {
                                context.push(
                                  '${AppRoutes.students}/add?studentId=${vm.student!.id}',
                                );
                              }
                            : null,
                      ),
                    ],
                    flexibleSpace: FlexibleSpaceBar(
                      background: _buildDigitalIdHeader(),
                    ),
                    bottom: TabBar(
                      controller: _tabController,
                      indicatorColor: AppColors.primaryBlue,
                      indicatorWeight: 3,
                      labelColor: Colors.white,
                      unselectedLabelColor: AppColors.textGrey,
                      labelStyle: const TextStyle(fontWeight: FontWeight.bold),
                      tabs: const [
                        Tab(text: _ViewStrings.tabOverview),
                        Tab(text: _ViewStrings.tabFinance),
                        Tab(text: _ViewStrings.tabAcademic),
                      ],
                    ),
                  ),
                ];
              },
              body: TabBarView(
                controller: _tabController,
                children: [
                  _buildOverviewTab(),
                  _buildFinanceTab(),
                  _buildAcademicTab(),
                ],
              ),
            ),
            floatingActionButton: FloatingActionButton.extended(
              onPressed: () {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text("Payment Gateway Init...")),
                );
              },
              backgroundColor: AppColors.successGreen,
              icon: const Icon(Icons.receipt_long, color: Colors.white),
              label: const Text(
                _ViewStrings.actLogPayment,
                style: TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  // ===========================================================================
  // HEADER: DIGITAL ID CARD
  // ===========================================================================
  Widget _buildDigitalIdHeader() {
    final student = _vm.student!;

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [
            AppColors.primaryBlue.withAlpha(50),
            AppColors.backgroundBlack,
          ],
        ),
      ),
      child: Padding(
        padding: const EdgeInsets.fromLTRB(24, 80, 24, 20),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.center,
          children: [
            // Avatar
            Hero(
              tag: 'student_avatar_${student.id}',
              child: Container(
                width: 90,
                height: 90,
                decoration: BoxDecoration(
                  color: AppColors.primaryBlue,
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: AppColors.backgroundBlack,
                    width: 4,
                  ),
                  boxShadow: [
                    BoxShadow(
                      color: AppColors.primaryBlue.withAlpha(100),
                      blurRadius: 20,
                      offset: const Offset(0, 5),
                    ),
                  ],
                ),
                child: Center(
                  child: Text(
                    "${student.firstName[0]}${student.lastName[0]}",
                    style: const TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ),
              ),
            ),

            const SizedBox(width: 20),

            // Text Info
            Expanded(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 8,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      color: AppColors.successGreen.withAlpha(30),
                      borderRadius: BorderRadius.circular(4),
                      border: Border.all(
                        color: AppColors.successGreen.withAlpha(100),
                      ),
                    ),
                    child: Text(
                      _getStatusText(student.status),
                      style: const TextStyle(
                        color: AppColors.successGreen,
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 1.0,
                      ),
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    "${student.firstName} ${student.lastName}",
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    "${_ViewStrings.lblAdmNum}: ${student.admissionNumber ?? 'N/A'}",
                    style: const TextStyle(
                      color: AppColors.textGrey,
                      fontFamily: 'monospace',
                      fontSize: 13,
                    ),
                  ),
                  Text(
                    _getCurrentGrade() ?? 'No Grade',
                    style: const TextStyle(
                      color: AppColors.primaryBlueLight,
                      fontSize: 13,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ===========================================================================
  // TAB 1: OVERVIEW
  // ===========================================================================
  Widget _buildOverviewTab() {
    final student = _vm.student!;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Quick Actions
          Row(
            children: [
              Expanded(
                child: _buildActionButton(
                  icon: Icons.call_outlined,
                  label: _ViewStrings.actCall,
                  onTap:
                      () {}, // launchUrl("tel:${student.guardianPhone ?? ''}"),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildActionButton(
                  icon: Icons.message_outlined,
                  label: _ViewStrings.actWhatsApp,
                  onTap: () {},
                  color: AppColors.successGreen,
                ),
              ),
            ],
          ),

          const SizedBox(height: 24),

          // Identity
          _buildSectionHeader(_ViewStrings.secIdentity),
          _buildInfoCard([
            _InfoRow(
              _ViewStrings.lblDob,
              student.dob?.toString().split(' ')[0] ?? 'N/A',
            ),
            _InfoRow(_ViewStrings.lblGender, student.gender ?? 'N/A'),
            _InfoRow(_ViewStrings.lblType, _getTypeText(student.type)),
          ]),

          const SizedBox(height: 24),

          // Guardian
          _buildSectionHeader(_ViewStrings.secGuardian),
          _buildInfoCard([
            _InfoRow(
              _ViewStrings.lblRelation,
              student.guardianRelationship ?? 'N/A',
            ),
            _InfoRow("Name", student.guardianName ?? 'N/A'),
            _InfoRow(_ViewStrings.lblPhone, student.guardianPhone ?? 'N/A'),
          ]),

          const SizedBox(height: 80), // Fab space
        ],
      ),
    );
  }

  // ===========================================================================
  // TAB 2: FINANCE (The Ledger Style)
  // ===========================================================================
  Widget _buildFinanceTab() {
    final student = _vm.student!;
    final owed = student.feesOwed;
    final paid = 0.0; // TODO: Calculate from ledger
    final total = owed + paid;
    final progress = total == 0 ? 0.0 : paid / total;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. FINANCIAL SUMMARY CARD
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: AppColors.surfaceDarkGrey,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: AppColors.surfaceLightGrey.withAlpha(30),
              ),
            ),
            child: Column(
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text(
                      _ViewStrings.lblOwed,
                      style: TextStyle(color: Colors.white70, fontSize: 14),
                    ),
                    Text(
                      "\$${owed.toStringAsFixed(2)}",
                      style: TextStyle(
                        color: owed > 0
                            ? AppColors.errorRed
                            : AppColors.successGreen,
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                ClipRRect(
                  borderRadius: BorderRadius.circular(8),
                  child: LinearProgressIndicator(
                    value: progress,
                    backgroundColor: AppColors.surfaceLightGrey.withAlpha(50),
                    color: AppColors.successGreen,
                    minHeight: 8,
                  ),
                ),
                const SizedBox(height: 12),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      "${(progress * 100).toInt()}% Paid",
                      style: const TextStyle(
                        color: AppColors.textGrey,
                        fontSize: 12,
                      ),
                    ),
                    Text(
                      "Total Invoiced: \$${total.toStringAsFixed(2)}",
                      style: const TextStyle(
                        color: AppColors.textGrey,
                        fontSize: 12,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),

          const SizedBox(height: 24),
          _buildSectionHeader(_ViewStrings.secLedger),

          // 2. TRANSACTION LIST (Placeholder)
          const Center(
            child: Padding(
              padding: EdgeInsets.all(40),
              child: Text(
                "Transaction history coming soon...",
                style: TextStyle(color: AppColors.textGrey),
              ),
            ),
          ),
          const SizedBox(height: 80),
        ],
      ),
    );
  }

  // ===========================================================================
  // TAB 3: ACADEMIC
  // ===========================================================================
  Widget _buildAcademicTab() {
    final enrollments = _vm.enrollments;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildSectionHeader("Enrollments"),
          if (enrollments.isEmpty)
            const Center(
              child: Padding(
                padding: EdgeInsets.all(40),
                child: Text(
                  "No enrollments found",
                  style: TextStyle(color: AppColors.textGrey),
                ),
              ),
            )
          else
            Wrap(
              spacing: 8,
              runSpacing: 12,
              children: enrollments.map((enrollment) {
                return Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: 8,
                  ),
                  decoration: BoxDecoration(
                    color: enrollment.isActive
                        ? AppColors.primaryBlue.withAlpha(20)
                        : AppColors.surfaceLightGrey.withAlpha(20),
                    borderRadius: BorderRadius.circular(20),
                    border: Border.all(
                      color: enrollment.isActive
                          ? AppColors.primaryBlue.withAlpha(50)
                          : AppColors.surfaceLightGrey.withAlpha(50),
                    ),
                  ),
                  child: Text(
                    "${enrollment.gradeLevel}${enrollment.classStream != null ? ' ${enrollment.classStream}' : ''}",
                    style: TextStyle(
                      color: enrollment.isActive
                          ? AppColors.primaryBlueLight
                          : AppColors.textGrey,
                      fontWeight: FontWeight.w600,
                      fontSize: 13,
                    ),
                  ),
                );
              }).toList(),
            ),
        ],
      ),
    );
  }

  // ===========================================================================
  // HELPER WIDGETS
  // ===========================================================================

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Text(
        title.toUpperCase(),
        style: const TextStyle(
          color: AppColors.textGrey,
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.2,
        ),
      ),
    );
  }

  Widget _buildActionButton({
    required IconData icon,
    required String label,
    required VoidCallback onTap,
    Color? color,
  }) {
    final btnColor = color ?? Colors.white;
    return Material(
      color: AppColors.surfaceDarkGrey,
      borderRadius: BorderRadius.circular(12),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Container(
          padding: const EdgeInsets.symmetric(vertical: 16),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
          ),
          child: Column(
            children: [
              Icon(icon, color: btnColor),
              const SizedBox(height: 8),
              Text(
                label,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: btnColor,
                  fontSize: 13,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildInfoCard(List<_InfoRow> rows) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
      ),
      child: Column(
        children: rows
            .map(
              (row) => Padding(
                padding: const EdgeInsets.only(bottom: 12.0),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    SizedBox(
                      width: 100,
                      child: Text(
                        row.label,
                        style: const TextStyle(
                          color: AppColors.textGrey,
                          fontSize: 13,
                        ),
                      ),
                    ),
                    Expanded(
                      child: Text(
                        row.value ?? "-",
                        style: const TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.w500,
                          fontSize: 14,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            )
            .toList(),
      ),
    );
  }
}

class _InfoRow {
  final String label;
  final String? value;
  _InfoRow(this.label, this.value);
}

// ==========================================
// FILE: ./screens/students/add_student_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/screens/utils/subject_selector_field.dart';

// -----------------------------------------------------------------------------
// VIEW MODEL (Updated)
// -----------------------------------------------------------------------------
class AddStudentViewModel {
  // Dropdown Data Sources
  final List<String> grades = ['Form 1', 'Form 2', 'Form 3', 'Form 4', 'Lower 6', 'Upper 6'];
  final List<String> billingTypes = ['Standard Termly', 'Monthly (Fixed)', 'Monthly (Custom Date)'];
  
  // Form Controllers
  final TextEditingController firstNameCtrl = TextEditingController();
  final TextEditingController lastNameCtrl = TextEditingController();
  // Removed admNumberCtrl (Auto-generated)
  final TextEditingController guardianNameCtrl = TextEditingController();
  final TextEditingController guardianPhoneCtrl = TextEditingController();
  
  // Financial Controllers
  final TextEditingController openingBalanceCtrl = TextEditingController();
  final TextEditingController debtDescriptionCtrl = TextEditingController(text: "Balance Brought Forward");

  // Form State
  String? selectedGrade;
  String? selectedGender;
  String selectedStudentType = 'ACADEMY'; 
  String? selectedBillingCycle;
  bool generateInvoiceNow = true;
  DateTime? customBillingDate;
  
  // Subject List
  List<String> selectedSubjects = []; 

  void dispose() {
    firstNameCtrl.dispose();
    lastNameCtrl.dispose();
    // admNumberCtrl.dispose(); 
    guardianNameCtrl.dispose();
    guardianPhoneCtrl.dispose();
    openingBalanceCtrl.dispose();
    debtDescriptionCtrl.dispose();
  }
}

// -----------------------------------------------------------------------------
// SCREEN UI
// -----------------------------------------------------------------------------
class AddStudentScreen extends StatefulWidget {
  const AddStudentScreen({super.key});

  @override
  State<AddStudentScreen> createState() => _AddStudentScreenState();
}

class _AddStudentScreenState extends State<AddStudentScreen> {
  final _formKey = GlobalKey<FormState>();
  final _vm = AddStudentViewModel();

  @override
  void dispose() {
    _vm.dispose();
    super.dispose();
  }

  void _handleSubmit() {
    if (_formKey.currentState!.validate()) {
      // -----------------------------------------------------------------------
      // TODO: IMPLEMENT REGISTRATION LOGIC
      // -----------------------------------------------------------------------
      
      // 1. INSERT into legend.students
      // Note: Do NOT send 'admission_number'. Let DB trigger/default handle it.
      
      // 2. INSERT into legend.enrollments
      
      // 3. HANDLE OPENING BALANCE 
      
      // 4. HANDLE IMMEDIATE BILLING

      debugPrint("Saving Subjects: ${_vm.selectedSubjects}");
      
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Student Registered Successfully (Mock)'), backgroundColor: AppColors.successGreen),
      );
      context.pop(); 
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text('New Admission', style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
        actions: [
          TextButton(
            onPressed: _handleSubmit,
            child: const Text("SAVE", style: TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold)),
          )
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // ---------------------------------------------------------------
              // 1. IDENTITY SECTION
              // ---------------------------------------------------------------
              _buildSectionHeader("Identity"),
              _buildCard(
                children: [
                  // Names
                  Row(
                    children: [
                      Expanded(
                        child: _buildTextField(
                          controller: _vm.firstNameCtrl,
                          label: "First Name",
                          icon: Icons.person_outline,
                          validator: (v) => v!.isEmpty ? "Required" : null,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: _buildTextField(
                          controller: _vm.lastNameCtrl,
                          label: "Last Name",
                          icon: Icons.person_outline,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  
                  // Gender & Type (Moved Type here to fill the gap)
                  Row(
                    children: [
                      Expanded(
                        child: _buildDropdown(
                          value: _vm.selectedGender,
                          items: ['Male', 'Female'],
                          label: "Gender",
                          icon: Icons.wc,
                          onChanged: (val) => setState(() => _vm.selectedGender = val),
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: _buildDropdown(
                          value: _vm.selectedStudentType,
                          items: ['ACADEMY', 'PRIVATE'],
                          label: "Student Type",
                          icon: Icons.category_outlined,
                          onChanged: (val) => setState(() => _vm.selectedStudentType = val!),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // ---------------------------------------------------------------
              // 2. ACADEMIC PLACEMENT
              // ---------------------------------------------------------------
              _buildSectionHeader("Placement"),
              _buildCard(
                children: [
                  // Grade Level (Now Full Width since Type moved up)
                  _buildDropdown(
                    value: _vm.selectedGrade,
                    items: _vm.grades,
                    label: "Grade Level",
                    icon: Icons.school_outlined,
                    onChanged: (val) => setState(() => _vm.selectedGrade = val),
                  ),
                  
                  const SizedBox(height: 16),
                  const Divider(color: AppColors.surfaceLightGrey),
                  const SizedBox(height: 16),
                  
                  // Subject Selector
                  SubjectSelectorField(
                    selectedSubjects: _vm.selectedSubjects,
                    onChanged: (list) => setState(() => _vm.selectedSubjects = list),
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // ---------------------------------------------------------------
              // 3. GUARDIAN CONTACT
              // ---------------------------------------------------------------
              _buildSectionHeader("Guardian Contact"),
              _buildCard(
                children: [
                  _buildTextField(controller: _vm.guardianNameCtrl, label: "Guardian Name", icon: Icons.family_restroom),
                  const SizedBox(height: 16),
                  _buildTextField(controller: _vm.guardianPhoneCtrl, label: "Phone Number", icon: Icons.phone_outlined, inputType: TextInputType.phone),
                ],
              ),
              const SizedBox(height: 24),

              // ---------------------------------------------------------------
              // 4. FINANCIAL ESSENTIALS
              // ---------------------------------------------------------------
              _buildSectionHeader("Billing Essentials"),
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF1E293B).withAlpha(200),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: AppColors.primaryBlue.withAlpha(50)),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildDropdown(
                      value: _vm.selectedBillingCycle,
                      items: _vm.billingTypes,
                      label: "Billing Schedule",
                      icon: Icons.calendar_month_outlined,
                      onChanged: (val) => setState(() => _vm.selectedBillingCycle = val),
                    ),
                    if (_vm.selectedBillingCycle == 'Monthly (Custom Date)') ...[
                      const SizedBox(height: 16),
                      _buildDatePicker(
                        context,
                        label: "Select Billing Date",
                        selectedDate: _vm.customBillingDate,
                        onSelect: (date) => setState(() => _vm.customBillingDate = date),
                      ),
                    ],
                    const SizedBox(height: 24),
                    const Divider(color: AppColors.surfaceLightGrey),
                    const SizedBox(height: 16),
                    Text("PREVIOUS TUITION CHARGES", style: TextStyle(color: AppColors.errorRed.withAlpha(200), fontSize: 11, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 12),
                    Row(
                      children: [
                        Expanded(flex: 2, child: _buildTextField(controller: _vm.openingBalanceCtrl, label: "Amount (Owing)", icon: Icons.attach_money, inputType: const TextInputType.numberWithOptions(decimal: true), textColor: AppColors.errorRed)),
                        const SizedBox(width: 16),
                        Expanded(flex: 3, child: _buildTextField(controller: _vm.debtDescriptionCtrl, label: "Description", icon: Icons.description_outlined)),
                      ],
                    ),
                    const SizedBox(height: 24),
                    const Divider(color: AppColors.surfaceLightGrey),
                    SwitchListTile(
                      contentPadding: EdgeInsets.zero,
                      activeThumbColor: AppColors.successGreen,
                      title: const Text("Generate Current Invoice?", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14)),
                      subtitle: const Text("Will apply standard fees immediately.", style: TextStyle(color: AppColors.textGrey, fontSize: 12)),
                      value: _vm.generateInvoiceNow,
                      onChanged: (val) => setState(() => _vm.generateInvoiceNow = val),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 40),
            ],
          ),
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------
  
  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12, left: 4),
      child: Text(
        title.toUpperCase(),
        style: const TextStyle(
          color: AppColors.textGrey,
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.2,
        ),
      ),
    );
  }

  Widget _buildCard({required List<Widget> children}) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Column(children: children),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    TextInputType inputType = TextInputType.text,
    Color? textColor,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: inputType,
      validator: validator,
      style: TextStyle(color: textColor ?? Colors.white),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: AppColors.textGrey),
        prefixIcon: Icon(icon, color: AppColors.textGrey, size: 20),
        filled: true,
        fillColor: AppColors.backgroundBlack,
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: AppColors.primaryBlue),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      ),
    );
  }

  Widget _buildDropdown({
    required String? value,
    required List<String> items,
    required String label,
    required IconData icon,
    required ValueChanged<String?> onChanged,
  }) {
    return DropdownButtonFormField<String>(
      initialValue: value,
      items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
      onChanged: onChanged,
      dropdownColor: AppColors.surfaceDarkGrey,
      style: const TextStyle(color: Colors.white),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: AppColors.textGrey),
        prefixIcon: Icon(icon, color: AppColors.textGrey, size: 20),
        filled: true,
        fillColor: AppColors.backgroundBlack,
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: AppColors.primaryBlue),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context, {
    required String label,
    required DateTime? selectedDate,
    required ValueChanged<DateTime> onSelect,
  }) {
    return InkWell(
      onTap: () async {
        final date = await showDatePicker(
          context: context,
          initialDate: selectedDate ?? DateTime.now(),
          firstDate: DateTime(2020),
          lastDate: DateTime(2030),
          builder: (context, child) {
            return Theme(
              data: ThemeData.dark().copyWith(
                colorScheme: const ColorScheme.dark(
                  primary: AppColors.primaryBlue,
                  onPrimary: Colors.white,
                  surface: AppColors.surfaceDarkGrey,
                ),
              ),
              child: child!,
            );
          },
        );
        if (date != null) onSelect(date);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        child: Row(
          children: [
            const Icon(Icons.calendar_today, color: AppColors.textGrey, size: 20),
            const SizedBox(width: 12),
            Text(
              selectedDate != null 
                  ? DateFormat('MMM d, yyyy').format(selectedDate) 
                  : label,
              style: TextStyle(
                color: selectedDate != null ? Colors.white : AppColors.textGrey,
                fontSize: 16,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/students/students_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/models/students_models.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:legend/vmodels/students_vmodel.dart';
import 'package:provider/provider.dart';
import 'package:fl_chart/fl_chart.dart';

class StudentsScreen extends StatefulWidget {
  const StudentsScreen({super.key});

  @override
  State<StudentsScreen> createState() => _StudentsScreenState();
}

class _StudentsScreenState extends State<StudentsScreen> {
  final _searchController = TextEditingController();
  String _searchQuery = '';

  StudentListViewModel? _viewModel;

  @override
  void initState() {
    super.initState();
    _searchController.addListener(() {
      setState(() {
        _searchQuery = _searchController.text.toLowerCase();
      });
    });

    // Initialize view model
    final authService = context.read<AuthService>();
    final schoolId = authService.activeSchool?.id ?? '';

    // Only initialize if we have a valid school
    if (schoolId.isNotEmpty) {
      _viewModel = StudentListViewModel(PowerSyncStudentRepository(), schoolId);
      // Load students
      _viewModel!.loadStudents();
    }
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  // ---------------------------------------------------------------------------
  // UI BUILDER
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    // If no view model, show error state
    if (_viewModel == null) {
      return Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(
                Icons.error_outline,
                color: Colors.redAccent,
                size: 48,
              ),
              const SizedBox(height: 16),
              const Text(
                'No active school found',
                style: TextStyle(color: Colors.white, fontSize: 18),
              ),
              const SizedBox(height: 8),
              const Text(
                'Please log in again',
                style: TextStyle(color: AppColors.textGrey, fontSize: 14),
              ),
            ],
          ),
        ),
      );
    }

    return ChangeNotifierProvider.value(
      value: _viewModel!,
      child: Consumer<StudentListViewModel>(
        builder: (context, vm, _) {
          // 1. FILTER LOGIC (reactive to vm)
          final allStudents = vm.students;
          final displayList = allStudents.where((student) {
            final name = student.fullName.toLowerCase();
            final adm = student.admissionNumber?.toLowerCase() ?? '';
            return name.contains(_searchQuery) || adm.contains(_searchQuery);
          }).toList();

          // 2. STATS CALCULATION (reactive to vm)
          double totalDebt = 0;
          int paidCount = 0;
          int owingCount = 0;

          for (var student in allStudents) {
            double bal = student.feesOwed;
            totalDebt += bal;
            if (bal <= 0) {
              paidCount++;
            } else {
              owingCount++;
            }
          }

          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,

            // APP BAR
            appBar: AppBar(
              backgroundColor: AppColors.backgroundBlack,
              elevation: 0,
              centerTitle: true,
              automaticallyImplyLeading: false,
              title: const Text(
                'Student Directory',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              actions: [
                IconButton(
                  icon: const Icon(Icons.tune, color: Colors.white),
                  onPressed: () {
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text('Filter coming soon'),
                        backgroundColor: AppColors.surfaceLightGrey,
                      ),
                    );
                  },
                ),
              ],
            ),

            // ADD BUTTON
            floatingActionButton: FloatingActionButton.extended(
              onPressed: () =>
                  context.push('${AppRoutes.students}/${AppRoutes.addStudent}'),
              backgroundColor: AppColors.primaryBlue,
              elevation: 4,
              icon: const Icon(Icons.person_add, color: Colors.white, size: 20),
              label: const Text(
                'Add Student',
                style: TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),

            // BODY (reactive)
            body: vm.isLoading
                ? const Center(child: CircularProgressIndicator())
                : vm.error != null
                ? _buildErrorState(vm.error!)
                : Column(
                    children: [
                      _buildStatsHeader(totalDebt, paidCount, owingCount),

                      Padding(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 8,
                        ),
                        child: TextField(
                          controller: _searchController,
                          style: const TextStyle(color: Colors.white),
                          decoration: InputDecoration(
                            hintText: 'Search name or admission number...',
                            hintStyle: const TextStyle(
                              color: AppColors.textGrey,
                            ),
                            prefixIcon: const Icon(
                              Icons.search,
                              color: AppColors.textGrey,
                            ),
                            filled: true,
                            fillColor: AppColors.surfaceDarkGrey,
                            contentPadding: const EdgeInsets.symmetric(
                              vertical: 14,
                            ),
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                              borderSide: BorderSide.none,
                            ),
                          ),
                        ),
                      ),

                      Expanded(
                        child: displayList.isEmpty
                            ? _buildEmptyState()
                            : ListView.separated(
                                padding: const EdgeInsets.fromLTRB(
                                  16,
                                  8,
                                  16,
                                  80,
                                ),
                                itemCount: displayList.length,
                                separatorBuilder: (context, index) =>
                                    const SizedBox(height: 12),
                                itemBuilder: (context, index) {
                                  final student = displayList[index];
                                  return _buildStudentCard(student);
                                },
                              ),
                      ),
                    ],
                  ),
          );
        },
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildStatsHeader(double totalDebt, int paidCount, int owingCount) {
    return Container(
      margin: const EdgeInsets.all(16),
      padding: const EdgeInsets.all(20),
      height: 160, // Fixed height for chart area
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(50)),
      ),
      child: Row(
        children: [
          // LEFT: TEXT STATS
          Expanded(
            flex: 3,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Text(
                  "Outstanding Debt",
                  style: TextStyle(
                    color: AppColors.textGrey,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  "\$${totalDebt.toStringAsFixed(2)}",
                  style: const TextStyle(
                    color: AppColors.errorRed,
                    fontSize: 26,
                    fontWeight: FontWeight.bold,
                    fontFamily: 'JetBrains Mono', // Or default if not loaded
                  ),
                ),
                const SizedBox(height: 16),
                Row(
                  children: [
                    _buildLegendDot(Colors.greenAccent, "Paid: $paidCount"),
                    const SizedBox(width: 12),
                    _buildLegendDot(AppColors.errorRed, "Owing: $owingCount"),
                  ],
                ),
              ],
            ),
          ),

          // RIGHT: FL_CHART
          Expanded(
            flex: 2,
            child: PieChart(
              PieChartData(
                sectionsSpace: 0,
                centerSpaceRadius: 25,
                startDegreeOffset: -90,
                sections: [
                  // OWING SLICE (Red)
                  PieChartSectionData(
                    color: AppColors.errorRed,
                    value: owingCount.toDouble(),
                    title:
                        '${((owingCount / (owingCount + paidCount)) * 100).toInt()}%',
                    radius: 40,
                    titleStyle: const TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  // PAID SLICE (Green)
                  PieChartSectionData(
                    color: Colors.greenAccent,
                    value: paidCount.toDouble(),
                    title: '', // Hide title for cleaner look if small
                    radius: 35, // Slightly smaller for effect
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLegendDot(Color color, String label) {
    return Row(
      children: [
        Container(
          width: 8,
          height: 8,
          decoration: BoxDecoration(color: color, shape: BoxShape.circle),
        ),
        const SizedBox(width: 6),
        Text(label, style: const TextStyle(color: Colors.white, fontSize: 12)),
      ],
    );
  }

  Widget _buildErrorState(String error) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.error_outline, size: 64, color: AppColors.errorRed),
          const SizedBox(height: 16),
          Text(
            'Error loading students',
            style: TextStyle(color: AppColors.textGrey, fontSize: 16),
          ),
          const SizedBox(height: 8),
          Text(
            error,
            style: TextStyle(color: AppColors.textGrey, fontSize: 12),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: () => _viewModel?.loadStudents(),
            child: const Text('Retry'),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.search_off,
            size: 64,
            color: AppColors.textGrey.withAlpha(100),
          ),
          const SizedBox(height: 16),
          const Text(
            'No students found',
            style: TextStyle(color: AppColors.textGrey, fontSize: 16),
          ),
        ],
      ),
    );
  }

  Widget _buildStudentCard(Student student) {
    final double balance = student.feesOwed;
    final bool isPaidUp = balance <= 0;

    return InkWell(
      onTap: () => context.push('${AppRoutes.students}/view/${student.id}'),
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: AppColors.surfaceLightGrey.withAlpha(30),
            width: 0.5,
          ),
        ),
        child: Row(
          children: [
            // Avatar
            CircleAvatar(
              radius: 24,
              backgroundColor: AppColors.primaryBlue.withAlpha(30),
              child: Text(
                _getInitials(student.fullName),
                style: const TextStyle(
                  color: AppColors.primaryBlue,
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
            ),
            const SizedBox(width: 16),

            // Info
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    student.fullName,
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '${student.admissionNumber ?? 'No ADM'} ‚Ä¢ ${student.status.name}',
                    style: const TextStyle(
                      color: AppColors.textGrey,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),

            // Balance Pill
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
              decoration: BoxDecoration(
                color: isPaidUp
                    ? Colors.green.withAlpha(20)
                    : Colors.red.withAlpha(20),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(
                isPaidUp ? 'PAID' : '-\$${balance.toStringAsFixed(0)}',
                style: TextStyle(
                  color: isPaidUp ? Colors.greenAccent : AppColors.errorRed,
                  fontWeight: FontWeight.bold,
                  fontSize: 12,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _getInitials(String name) {
    if (name.isEmpty) return '';
    final parts = name.split(' ');
    if (parts.length > 1) return '${parts[0][0]}${parts[1][0]}'.toUpperCase();
    return name[0].toUpperCase();
  }
}

// ==========================================
// FILE: ./screens/students/student_logs_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/constants/app_constants.dart';

// =============================================================================
// 1. DATA MODELS & ENUMS
// =============================================================================
enum LogType { financial, academic, system, alert }

class LogEntry {
  final String id;
  final String title;
  final String description;
  final DateTime timestamp;
  final LogType type;
  final String performedBy; // "Admin", "System", "Guardian"

  LogEntry({
    required this.id,
    required this.title,
    required this.description,
    required this.timestamp,
    required this.type,
    required this.performedBy,
  });
}

// =============================================================================
// 2. VIEW MODEL
// =============================================================================
class StudentLogsViewModel {
  final String studentId;
  List<LogEntry> logs = [];
  bool isLoading = true;

  StudentLogsViewModel(this.studentId);

  Future<void> loadLogs() async {
    // Simulate Network Delay
    await Future.delayed(const Duration(milliseconds: 800));

    final now = DateTime.now();
    
    // MOCK DATA: In production, fetch WHERE student_id = x ORDER BY created_at DESC
    logs = [
      LogEntry(
        id: "1",
        title: "Payment Received",
        description: "Guardian paid \$450.00 via EcoCash (Ref: EC-9982).",
        timestamp: now.subtract(const Duration(minutes: 45)),
        type: LogType.financial,
        performedBy: "System (Auto)",
      ),
      LogEntry(
        id: "2",
        title: "Invoice Generated",
        description: "Term 1 2026 Tuition fees posted (\$600.00).",
        timestamp: now.subtract(const Duration(hours: 3)),
        type: LogType.financial,
        performedBy: "Admin (Sir Legend)",
      ),
      LogEntry(
        id: "3",
        title: "Profile Updated",
        description: "Guardian phone number changed from +263... to +263...",
        timestamp: now.subtract(const Duration(days: 1, hours: 2)),
        type: LogType.system,
        performedBy: "Admin",
      ),
      LogEntry(
        id: "4",
        title: "Academic Warning",
        description: "Missed 3 consecutive Math assignments.",
        timestamp: now.subtract(const Duration(days: 2)),
        type: LogType.alert,
        performedBy: "Teacher (Mr. Moyo)",
      ),
      LogEntry(
        id: "5",
        title: "Subject Enrollment",
        description: "Added to 'Computer Science' class list.",
        timestamp: now.subtract(const Duration(days: 5)),
        type: LogType.academic,
        performedBy: "Admin",
      ),
      LogEntry(
        id: "6",
        title: "Admission Created",
        description: "Student profile created and set to ACTIVE.",
        timestamp: now.subtract(const Duration(days: 10)),
        type: LogType.system,
        performedBy: "Admin",
      ),
    ];
    
    isLoading = false;
  }
}

// =============================================================================
// 3. SCREEN IMPLEMENTATION
// =============================================================================
class StudentLogsScreen extends StatefulWidget {
  final String? studentId;

  const StudentLogsScreen({super.key, this.studentId});

  @override
  State<StudentLogsScreen> createState() => _StudentLogsScreenState();
}

class _StudentLogsScreenState extends State<StudentLogsScreen> {
  late StudentLogsViewModel _vm;
  String _filter = "All"; // "All", "Financial", "System"

  @override
  void initState() {
    super.initState();
    _vm = StudentLogsViewModel(widget.studentId ?? "000");
    _initLoad();
  }

  void _initLoad() async {
    await _vm.loadLogs();
    if (mounted) setState(() {});
  }

  // Filter Logic
  List<LogEntry> get _filteredLogs {
    if (_filter == "All") return _vm.logs;
    if (_filter == "Financial") return _vm.logs.where((l) => l.type == LogType.financial).toList();
    if (_filter == "System") return _vm.logs.where((l) => l.type == LogType.system).toList();
    if (_filter == "Alerts") return _vm.logs.where((l) => l.type == LogType.alert).toList();
    return _vm.logs;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          "Activity History",
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.download_outlined, color: AppColors.primaryBlue),
            tooltip: "Export Logs",
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text("Exporting audit trail to CSV..."), backgroundColor: AppColors.surfaceLightGrey),
              );
            },
          ),
        ],
      ),
      body: _vm.isLoading
          ? const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue))
          : Column(
              children: [
                // 1. FILTER CHIPS
                SingleChildScrollView(
                  scrollDirection: Axis.horizontal,
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  child: Row(
                    children: [
                      _buildFilterChip("All"),
                      const SizedBox(width: 8),
                      _buildFilterChip("Financial"),
                      const SizedBox(width: 8),
                      _buildFilterChip("System"),
                      const SizedBox(width: 8),
                      _buildFilterChip("Alerts"),
                    ],
                  ),
                ),

                // 2. TIMELINE LIST
                Expanded(
                  child: _filteredLogs.isEmpty
                      ? _buildEmptyState()
                      : ListView.builder(
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                          itemCount: _filteredLogs.length,
                          itemBuilder: (context, index) {
                            final log = _filteredLogs[index];
                            final isLast = index == _filteredLogs.length - 1;
                            return _buildTimelineItem(log, isLast);
                          },
                        ),
                ),
              ],
            ),
    );
  }

  // ===========================================================================
  // WIDGET BUILDERS
  // ===========================================================================

  Widget _buildFilterChip(String label) {
    final isSelected = _filter == label;
    return ChoiceChip(
      label: Text(label),
      selected: isSelected,
      onSelected: (val) => setState(() => _filter = label),
      selectedColor: AppColors.primaryBlue,
      backgroundColor: AppColors.surfaceDarkGrey,
      labelStyle: TextStyle(
        color: isSelected ? Colors.white : AppColors.textGrey,
        fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(20),
        side: BorderSide(color: isSelected ? Colors.transparent : AppColors.surfaceLightGrey.withAlpha(50)),
      ),
    );
  }

  Widget _buildTimelineItem(LogEntry log, bool isLast) {
    Color typeColor;
    IconData typeIcon;

    switch (log.type) {
      case LogType.financial:
        typeColor = AppColors.successGreen;
        typeIcon = Icons.attach_money;
        break;
      case LogType.alert:
        typeColor = AppColors.errorRed;
        typeIcon = Icons.warning_amber_rounded;
        break;
      case LogType.academic:
        typeColor = Colors.orangeAccent;
        typeIcon = Icons.school_outlined;
        break;
      case LogType.system:
        typeColor = AppColors.primaryBlue;
        typeIcon = Icons.settings_outlined;
        break;
    }

    return IntrinsicHeight(
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. DATE COLUMN
          SizedBox(
            width: 50,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  DateFormat('MMM').format(log.timestamp).toUpperCase(),
                  style: const TextStyle(color: AppColors.textGrey, fontSize: 10, fontWeight: FontWeight.bold),
                ),
                Text(
                  DateFormat('dd').format(log.timestamp),
                  style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 4),
                Text(
                  DateFormat('HH:mm').format(log.timestamp),
                  style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 10),
                ),
              ],
            ),
          ),

          const SizedBox(width: 12),

          // 2. TIMELINE LINE
          Column(
            children: [
              Container(
                width: 12,
                height: 12,
                decoration: BoxDecoration(
                  color: AppColors.backgroundBlack,
                  shape: BoxShape.circle,
                  border: Border.all(color: typeColor, width: 2),
                ),
                child: Center(
                  child: Container(
                    width: 4, 
                    height: 4, 
                    decoration: BoxDecoration(color: typeColor, shape: BoxShape.circle),
                  ),
                ),
              ),
              if (!isLast)
                Expanded(
                  child: Container(
                    width: 2,
                    color: AppColors.surfaceLightGrey.withAlpha(30),
                  ),
                ),
            ],
          ),

          const SizedBox(width: 16),

          // 3. CONTENT CARD
          Expanded(
            child: Padding(
              padding: const EdgeInsets.only(bottom: 24.0),
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surfaceDarkGrey,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(typeIcon, size: 14, color: typeColor),
                        const SizedBox(width: 6),
                        Text(
                          log.title,
                          style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14),
                        ),
                      ],
                    ),
                    const SizedBox(height: 6),
                    Text(
                      log.description,
                      style: const TextStyle(color: AppColors.textGrey, fontSize: 12, height: 1.4),
                    ),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        const Icon(Icons.person_outline, size: 12, color: AppColors.textGrey),
                        const SizedBox(width: 4),
                        Text(
                          "By: ${log.performedBy}",
                          style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 10),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.history_toggle_off, size: 48, color: AppColors.textGrey),
          SizedBox(height: 16),
          Text("No logs found", style: TextStyle(color: AppColors.textGrey)),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/auth/login_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:provider/provider.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  // UI State
  bool _isPasswordVisible = false;
  bool _isLoading = false;
  
  // Controllers
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _handleLogin() async {
    // 1. Input Validation
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();

    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Please enter both email and password."),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    // 2. Set Loading State
    setState(() => _isLoading = true);

    try {
      // 3. Call Auth Service (This handles Supabase Login + School Fetch)
      // Note: We use context.read because we are inside a callback, not build()
      await context.read<AuthService>().login(email, password);

      if (mounted) {
        // 4. Success -> Navigate
        context.go(AppRoutes.dashboard);
      }
    } catch (e) {
      // 5. Error Handling
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(e.toString().replaceAll("Exception: ", "")), // Clean up error msg
            backgroundColor: AppColors.errorRed,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      // 6. Reset Loading State (if still on screen)
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _handleSocialLogin(String provider) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text("$provider Login is coming soon!"),
        backgroundColor: AppColors.surfaceLightGrey,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // Screen Height for responsive layout
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: AppColors.primaryBlue, // Top Background Color
      body: Stack(
        children: [
          // -------------------------------------------------------------------
          // 1. HEADER (Gradient & Logo)
          // -------------------------------------------------------------------
          Container(
            height: size.height * 0.4,
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  AppColors.primaryBlueLight, // Lighter Blue top
                  AppColors.primaryBlue,      // Brand Blue bottom
                ],
              ),
            ),
            child: SafeArea(
              child: Column(
                children: [
                  SizedBox(height: size.height * 0.05),
                  Text(
                    "KwaLegend",
                    style: GoogleFonts.dancingScript( 
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
            ),
          ),

          // -------------------------------------------------------------------
          // 2. THE CARD (Curved Body)
          // -------------------------------------------------------------------
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              height: size.height * 0.75, // Occupies bottom 75%
              width: double.infinity,
              decoration: const BoxDecoration(
                color: AppColors.backgroundBlack, // Dark Theme Body
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(40),
                  topRight: Radius.circular(40),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black45,
                    blurRadius: 20,
                    offset: Offset(0, -5),
                  ),
                ],
              ),
              child: SingleChildScrollView(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    // Title
                    const SizedBox(height: 16),
                    Text(
                      "Welcome back",
                      style: GoogleFonts.jetBrainsMono( 
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textWhite,
                      ),
                    ),
                    const SizedBox(height: 40),

                    // ---------------------------------------------------------
                    // INPUT FIELDS
                    // ---------------------------------------------------------
                    _buildTextField(
                      controller: _emailController,
                      label: "Email Address",
                      icon: Icons.email_outlined,
                      inputType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 20),
                    
                    _buildTextField(
                      controller: _passwordController,
                      label: "Password",
                      icon: Icons.lock_outline,
                      isPassword: true,
                      isVisible: _isPasswordVisible,
                      onVisibilityToggle: () {
                        setState(() {
                          _isPasswordVisible = !_isPasswordVisible;
                        });
                      },
                    ),

                    // ---------------------------------------------------------
                    // FORGOT PASSWORD LINK
                    // ---------------------------------------------------------
                    Align(
                      alignment: Alignment.centerRight,
                      child: TextButton(
                        onPressed: _isLoading ? null : () => context.push(AppRoutes.resetPassword),
                        child: const Text(
                          "Forgot Password?",
                          style: TextStyle(
                            color: AppColors.primaryBlueLight,
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                          ),
                        ),
                      ),
                    ),

                    const SizedBox(height: 24),

                    // ---------------------------------------------------------
                    // LOG IN BUTTON (With Loading State)
                    // ---------------------------------------------------------
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _handleLogin,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.surfaceLightGrey, // Dark button on dark bg
                          foregroundColor: Colors.white,
                          elevation: 0,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          disabledBackgroundColor: AppColors.surfaceDarkGrey,
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                height: 24,
                                width: 24,
                                child: CircularProgressIndicator(
                                  color: Colors.white,
                                  strokeWidth: 2,
                                ),
                              )
                            : const Text(
                                "Log in",
                                style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                              ),
                      ),
                    ),

                    const SizedBox(height: 30),

                    // ---------------------------------------------------------
                    // SOCIAL LOGIN (Divider & Icons)
                    // ---------------------------------------------------------
                    const Row(
                      children: [
                        Expanded(child: Divider(color: AppColors.surfaceLightGrey)),
                        Padding(
                          padding: EdgeInsets.symmetric(horizontal: 16),
                          child: Text("OR", style: TextStyle(color: AppColors.textGrey)),
                        ),
                        Expanded(child: Divider(color: AppColors.surfaceLightGrey)),
                      ],
                    ),
                    
                    const SizedBox(height: 30),
                    
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        _SocialIcon(
                          icon: Icons.g_mobiledata, 
                          color: Colors.red,
                          onTap: () => _handleSocialLogin("Google"),
                        ),
                        const SizedBox(width: 20),
                        _SocialIcon(
                          icon: Icons.facebook,
                          color: Colors.blue,
                          onTap: () => _handleSocialLogin("Facebook"),
                        ),
                        const SizedBox(width: 20),
                        _SocialIcon(
                          icon: Icons.apple,
                          color: Colors.white,
                          onTap: () => _handleSocialLogin("Apple"),
                        ),
                      ],
                    ),

                    const SizedBox(height: 40),

                    // ---------------------------------------------------------
                    // CREATE ACCOUNT LINK
                    // ---------------------------------------------------------
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text(
                          "Don't have an Account? ",
                          style: TextStyle(color: AppColors.textGrey),
                        ),
                        GestureDetector(
                          onTap: _isLoading ? null : () => context.push(AppRoutes.signup),
                          child: const Text(
                            "Create Account",
                            style: TextStyle(
                              color: AppColors.primaryBlueLight,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                    
                    // Bottom Spacer
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    bool isVisible = false,
    VoidCallback? onVisibilityToggle,
    TextInputType inputType = TextInputType.text,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey),
          ),
          child: TextField(
            controller: controller,
            obscureText: isPassword && !isVisible,
            keyboardType: inputType,
            style: const TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText: label,
              hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100)),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              suffixIcon: isPassword
                  ? IconButton(
                      icon: Icon(
                        isVisible ? Icons.visibility : Icons.visibility_off,
                        color: AppColors.textGrey,
                      ),
                      onPressed: onVisibilityToggle,
                    )
                  : null,
            ),
          ),
        ),
      ],
    );
  }
}

class _SocialIcon extends StatelessWidget {
  final IconData icon;
  final Color color;
  final VoidCallback onTap;

  const _SocialIcon({
    required this.icon,
    required this.color,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(50),
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          shape: BoxShape.circle,
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Icon(icon, color: color, size: 28),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/auth/sign_up_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:legend/constants/app_constants.dart';

class SignupScreen extends StatefulWidget {
  const SignupScreen({super.key});

  @override
  State<SignupScreen> createState() => _SignupScreenState();
}

class _SignupScreenState extends State<SignupScreen> {
  // UI State
  bool _isPasswordVisible = false;
  bool _isConfirmPasswordVisible = false;
  
  // Controllers
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _schoolNameController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  final TextEditingController _confirmPasswordController = TextEditingController();

  @override
  void dispose() {
    _nameController.dispose();
    _emailController.dispose();
    _schoolNameController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    super.dispose();
  }

  void _handleSignup() {
    // PLACEBO: Navigate to Dashboard directly
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("Account Created! Welcome to the Academy.")),
    );
    context.go(AppRoutes.dashboard);
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: AppColors.primaryBlue,
      body: Stack(
        children: [
          // -------------------------------------------------------------------
          // 1. HEADER (Gradient & Title)
          // -------------------------------------------------------------------
          Container(
            height: size.height * 0.35, // Slightly shorter header for Signup
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  AppColors.primaryBlueLight,
                  AppColors.primaryBlue,
                ],
              ),
            ),
            child: SafeArea(
              child: Column(
                children: [
                  // Back Button (Custom for aesthetics)
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Align(
                      alignment: Alignment.centerLeft,
                      child: IconButton(
                        icon: const Icon(Icons.arrow_back_ios, color: Colors.white),
                        onPressed: () => context.pop(),
                      ),
                    ),
                  ),
                  Text(
                    "Join the Academy",
                    style: GoogleFonts.dancingScript(
                      fontSize: 36,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    "Create your Legend",
                    style: GoogleFonts.jetBrainsMono(
                      fontSize: 14,
                      color: Colors.white70,
                    ),
                  ),
                ],
              ),
            ),
          ),

          // -------------------------------------------------------------------
          // 2. THE CARD (Form Body)
          // -------------------------------------------------------------------
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              height: size.height * 0.80, // Taller card for more fields
              width: double.infinity,
              decoration: const BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(40),
                  topRight: Radius.circular(40),
                ),
                boxShadow: [
                  BoxShadow(color: Colors.black45, blurRadius: 20, offset: Offset(0, -5)),
                ],
              ),
              child: SingleChildScrollView(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    const SizedBox(height: 8),
                    Text(
                      "Register",
                      style: GoogleFonts.jetBrainsMono(
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textWhite,
                      ),
                    ),
                    const SizedBox(height: 32),

                    // ---------------------------------------------------------
                    // INPUT FIELDS
                    // ---------------------------------------------------------
                    _buildTextField(
                      controller: _nameController,
                      label: "Full Name",
                      icon: Icons.person_outline,
                    ),
                    const SizedBox(height: 16),
                    
                    _buildTextField(
                      controller: _emailController,
                      label: "Email",
                      icon: Icons.email_outlined,
                      inputType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 16),

                    _buildTextField(
                      controller: _schoolNameController,
                      label: "School Name (e.g. KwaLegend)",
                      icon: Icons.school_outlined,
                    ),
                    const SizedBox(height: 16),

                    _buildTextField(
                      controller: _passwordController,
                      label: "Password",
                      icon: Icons.lock_outline,
                      isPassword: true,
                      isVisible: _isPasswordVisible,
                      onVisibilityToggle: () => setState(() => _isPasswordVisible = !_isPasswordVisible),
                    ),
                    const SizedBox(height: 16),

                    _buildTextField(
                      controller: _confirmPasswordController,
                      label: "Confirm Password",
                      icon: Icons.lock_outline, // Different icon
                      isPassword: true,
                      isVisible: _isConfirmPasswordVisible,
                      onVisibilityToggle: () => setState(() => _isConfirmPasswordVisible = !_isConfirmPasswordVisible),
                    ),

                    const SizedBox(height: 40),

                    // ---------------------------------------------------------
                    // SIGN UP BUTTON
                    // ---------------------------------------------------------
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _handleSignup,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.primaryBlue, // Blue button for action
                          foregroundColor: Colors.white,
                          elevation: 4,
                          shadowColor: AppColors.primaryBlue.withAlpha(100),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                        child: const Text(
                          "Sign Up",
                          style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                        ),
                      ),
                    ),

                    const SizedBox(height: 24),

                    // ---------------------------------------------------------
                    // ALREADY HAVE ACCOUNT
                    // ---------------------------------------------------------
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text(
                          "Already have an Account? ",
                          style: TextStyle(color: AppColors.textGrey),
                        ),
                        GestureDetector(
                          onTap: () => context.go(AppRoutes.login), // Use go to reset stack if needed, or pop
                          child: const Text(
                            "Log in",
                            style: TextStyle(
                              color: AppColors.primaryBlueLight,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                    
                    // Bottom Spacer for scrolling
                    const SizedBox(height: 30),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    bool isVisible = false,
    VoidCallback? onVisibilityToggle,
    TextInputType inputType = TextInputType.text,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey),
          ),
          child: TextField(
            controller: controller,
            obscureText: isPassword && !isVisible,
            keyboardType: inputType,
            style: const TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText: label,
              hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100)),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              prefixIcon: Icon(icon, color: AppColors.textGrey, size: 22), // Added Prefix Icon
              suffixIcon: isPassword
                  ? IconButton(
                      icon: Icon(
                        isVisible ? Icons.visibility : Icons.visibility_off,
                        color: AppColors.textGrey,
                      ),
                      onPressed: onVisibilityToggle,
                    )
                  : null,
            ),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./screens/auth/forgot_password.dart
// ==========================================

// ignore_for_file: unused_field

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:legend/constants/app_constants.dart';

// -----------------------------------------------------------------------------
// 1. LOCAL STRINGS
// -----------------------------------------------------------------------------
class _ForgotStrings {
  _ForgotStrings();
  static const String backToLogin = "Back to Login";
  
  // Step 1: Request
  static const String headRequest = "Forgot Password?";
  static const String subRequest = "Enter your email address to receive a 6-digit verification code.";
  static const String btnSend = "Send Reset Code";
  
  // Step 2: Verify & Reset
  static const String headReset = "Secure Your Account";
  static const String subReset = "Enter the code sent to your email and set your new password.";
  static const String hintCode = "123456";
  static const String btnReset = "Reset Password";
  static const String resendLink = "Didn't receive code? Resend";
  
  // Messages
  static const String msgSent = "Code sent to your email";
  static const String msgSuccess = "Password reset successfully. Please login.";
  static const String errMatch = "Passwords do not match";
  static const String errCode = "Invalid code format";
}

// -----------------------------------------------------------------------------
// 2. SCREEN IMPLEMENTATION
// -----------------------------------------------------------------------------
class ForgotPasswordScreen extends StatefulWidget {
  const ForgotPasswordScreen({super.key});

  @override
  State<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {
  final _formKey = GlobalKey<FormState>();
  
  // State
  int _currentStep = 0; // 0 = Request, 1 = Reset
  bool _isLoading = false;
  bool _isObscure1 = true;
  bool _isObscure2 = true;

  // Controllers
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _codeController = TextEditingController();
  final TextEditingController _passController = TextEditingController();
  final TextEditingController _confirmController = TextEditingController();

  @override
  void dispose() {
    _emailController.dispose();
    _codeController.dispose();
    _passController.dispose();
    _confirmController.dispose();
    super.dispose();
  }

  // --- Logic: Step 1 (Send Code) ---
  Future<void> _handleSendCode() async {
    if (_emailController.text.isEmpty || !_emailController.text.contains('@')) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Please enter a valid email"), backgroundColor: AppColors.errorRed),
      );
      return;
    }

    setState(() => _isLoading = true);
    
    // Simulate API Call
    await Future.delayed(const Duration(seconds: 1));

    if (mounted) {
      setState(() {
        _isLoading = false;
        _currentStep = 1; // Move to next step
      });
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text(_ForgotStrings.msgSent), backgroundColor: AppColors.successGreen),
      );
    }
  }

  // --- Logic: Step 2 (Reset) ---
  Future<void> _handleReset() async {
    // Basic validation logic...
    if (_codeController.text.length != 6) {
       ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text(_ForgotStrings.errCode), backgroundColor: AppColors.errorRed),
      );
      return;
    }
    if (_passController.text != _confirmController.text) {
       ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text(_ForgotStrings.errMatch), backgroundColor: AppColors.errorRed),
      );
      return;
    }

    setState(() => _isLoading = true);

    // Simulate API Call
    await Future.delayed(const Duration(seconds: 2));

    if (mounted) {
      setState(() => _isLoading = false);
      
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text(_ForgotStrings.msgSuccess), backgroundColor: AppColors.successGreen),
      );
      context.go(AppRoutes.login); 
    }
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: AppColors.primaryBlue,
      body: Stack(
        children: [
          // -------------------------------------------------------------------
          // 1. HEADER (Gradient & Title)
          // -------------------------------------------------------------------
          Container(
            height: size.height * 0.35,
            width: double.infinity,
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [AppColors.primaryBlueLight, AppColors.primaryBlue],
              ),
            ),
            child: SafeArea(
              child: Column(
                children: [
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Align(
                      alignment: Alignment.centerLeft,
                      child: IconButton(
                        icon: const Icon(Icons.arrow_back_ios, color: Colors.white),
                        onPressed: () => context.pop(),
                      ),
                    ),
                  ),
                  const SizedBox(height: 10),
                  // Animated Icon based on Step
                  Icon(
                    _currentStep == 0 ? Icons.mark_email_unread_outlined : Icons.lock_reset,
                    size: 64,
                    color: Colors.white.withAlpha(200),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    "Recovery",
                    style: GoogleFonts.jetBrainsMono(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
            ),
          ),

          // -------------------------------------------------------------------
          // 2. THE CARD (Form Body)
          // -------------------------------------------------------------------
          Align(
            alignment: Alignment.bottomCenter,
            child: Container(
              height: size.height * 0.75,
              width: double.infinity,
              decoration: const BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.only(
                  topLeft: Radius.circular(40),
                  topRight: Radius.circular(40),
                ),
                boxShadow: [
                  BoxShadow(color: Colors.black45, blurRadius: 20, offset: Offset(0, -5)),
                ],
              ),
              child: SingleChildScrollView(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    const SizedBox(height: 8),
                    Text(
                      _currentStep == 0 ? _ForgotStrings.headRequest : _ForgotStrings.headReset,
                      textAlign: TextAlign.center,
                      style: GoogleFonts.jetBrainsMono(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textWhite,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      _currentStep == 0 ? _ForgotStrings.subRequest : _ForgotStrings.subReset,
                      textAlign: TextAlign.center,
                      style: const TextStyle(color: AppColors.textGrey, fontSize: 14),
                    ),
                    const SizedBox(height: 40),

                    // ================= STEP 0: EMAIL INPUT =================
                    if (_currentStep == 0) ...[
                      _buildTextField(
                        controller: _emailController,
                        label: "Email Address",
                        icon: Icons.email_outlined,
                        inputType: TextInputType.emailAddress,
                      ),
                      const SizedBox(height: 32),
                      
                      SizedBox(
                        width: double.infinity,
                        height: 56,
                        child: ElevatedButton(
                          onPressed: _isLoading ? null : _handleSendCode,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primaryBlue,
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                            elevation: 4,
                          ),
                          child: _isLoading 
                              ? const CircularProgressIndicator(color: Colors.white)
                              : const Text(_ForgotStrings.btnSend, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        ),
                      ),
                    ],

                    // ================= STEP 1: VERIFY & RESET =================
                    if (_currentStep == 1) ...[
                      // Code Input
                      _buildTextField(
                        controller: _codeController,
                        label: "6-Digit Code",
                        icon: Icons.vpn_key_outlined,
                        inputType: TextInputType.number,
                        isCodeInput: true, // Special styling
                      ),
                      const SizedBox(height: 20),

                      // New Password
                      _buildTextField(
                        controller: _passController,
                        label: "New Password",
                        icon: Icons.lock_outline,
                        isPassword: true,
                        isVisible: !_isObscure1,
                        onVisibilityToggle: () => setState(() => _isObscure1 = !_isObscure1),
                      ),
                      const SizedBox(height: 16),

                      // Confirm Password
                      _buildTextField(
                        controller: _confirmController,
                        label: "Confirm Password",
                        icon: Icons.lock_outline,
                        isPassword: true,
                        isVisible: !_isObscure2,
                        onVisibilityToggle: () => setState(() => _isObscure2 = !_isObscure2),
                      ),

                      const SizedBox(height: 32),

                      SizedBox(
                        width: double.infinity,
                        height: 56,
                        child: ElevatedButton(
                          onPressed: _isLoading ? null : _handleReset,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primaryBlue,
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                            elevation: 4,
                          ),
                          child: _isLoading 
                              ? const CircularProgressIndicator(color: Colors.white)
                              : const Text(_ForgotStrings.btnReset, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        ),
                      ),
                      
                      const SizedBox(height: 16),
                      TextButton(
                        onPressed: () {
                           ScaffoldMessenger.of(context).showSnackBar(
                             const SnackBar(content: Text(_ForgotStrings.msgSent), backgroundColor: AppColors.surfaceLightGrey)
                           );
                        },
                        child: const Text(_ForgotStrings.resendLink, style: TextStyle(color: AppColors.primaryBlueLight)),
                      ),
                    ],

                    const SizedBox(height: 24),
                    
                    // Back to Login Link
                    GestureDetector(
                      onTap: () => context.go(AppRoutes.login),
                      child: const Text(
                        _ForgotStrings.backToLogin,
                        style: TextStyle(
                          color: AppColors.textGrey,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool isPassword = false,
    bool isVisible = false,
    VoidCallback? onVisibilityToggle,
    TextInputType inputType = TextInputType.text,
    bool isCodeInput = false,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey),
          ),
          child: TextField(
            controller: controller,
            obscureText: isPassword && !isVisible,
            keyboardType: inputType,
            textAlign: isCodeInput ? TextAlign.center : TextAlign.start,
            style: TextStyle(
              color: Colors.white, 
              fontSize: isCodeInput ? 20 : 16,
              letterSpacing: isCodeInput ? 8.0 : 0,
              fontWeight: isCodeInput ? FontWeight.bold : FontWeight.normal,
            ),
            maxLength: isCodeInput ? 6 : null,
            decoration: InputDecoration(
              hintText: isCodeInput ? "000000" : label,
              hintStyle: TextStyle(color: AppColors.textGrey.withAlpha(100), letterSpacing: 0),
              counterText: "", // Hide counter for code input
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
              prefixIcon: isCodeInput ? null : Icon(icon, color: AppColors.textGrey, size: 22),
              suffixIcon: isPassword
                  ? IconButton(
                      icon: Icon(
                        isVisible ? Icons.visibility : Icons.visibility_off,
                        color: AppColors.textGrey,
                      ),
                      onPressed: onVisibilityToggle,
                    )
                  : null,
            ),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./screens/auth/change_password.dart
// ==========================================


// ==========================================
// FILE: ./screens/settings/settings_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/vmodels/settings_vmodel.dart';
import 'package:provider/provider.dart';

// -----------------------------------------------------------------------------
// 1. LOCAL STRINGS & CONSTANTS (Strictly No UI String Literals)
// -----------------------------------------------------------------------------
class _ConfigStrings {
  static const String pageTitle = "Profile & Settings";

  // Sections
  static const String secIdentity = "Identity";
  static const String secApp = "Application";
  static const String secData = "Data & Sync";
  static const String secSupport = "Support";

  // Items
  static const String itemEditProfile = "Edit Profile";
  static const String subEditProfile = "Update name and role";

  static const String itemSchool = "School Details";
  static const String subSchool = "Logo, address, and contact";

  static const String itemTheme = "Dark Mode";
  static const String itemNotifs = "Notifications";

  static const String itemSync = "Sync Status";
  static const String subSync = "Last synced: Just now";

  static const String itemContactDev = "Contact Developer";
  static const String subContactDev = "Report bugs or request features";

  static const String itemLogout = "Log Out";
}

// -----------------------------------------------------------------------------
// 2. SCREEN IMPLEMENTATION
// -----------------------------------------------------------------------------
class SettingsScreen extends StatefulWidget {
  const SettingsScreen({super.key});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  @override
  void initState() {
    super.initState();
    // Initialize settings when screen loads
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<SettingsViewModel>().init();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<SettingsViewModel>(
      builder: (context, viewModel, _) {
        return Scaffold(
          backgroundColor: AppColors.backgroundBlack,

          // APP BAR
          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            centerTitle: true,
            automaticallyImplyLeading: false, // Root tab
            title: const Text(
              _ConfigStrings.pageTitle,
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),

          // BODY
          body: SingleChildScrollView(
            padding: const EdgeInsets.all(20.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // --- Profile Card ---
                _buildProfileHeader(context),

                const SizedBox(height: 32),

                // ================= SECTION 1: IDENTITY =================
                _buildSectionHeader(_ConfigStrings.secIdentity),
                _buildSettingsTile(
                  context,
                  icon: Icons.person_outline,
                  title: _ConfigStrings.itemEditProfile,
                  subtitle: _ConfigStrings.subEditProfile,
                  onTap: () {
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text('Edit Profile coming soon'),
                        backgroundColor: AppColors.surfaceLightGrey,
                      ),
                    );
                  },
                ),
                _buildSettingsTile(
                  context,
                  icon: Icons.business_outlined,
                  title: _ConfigStrings.itemSchool,
                  subtitle: _ConfigStrings.subSchool,
                  onTap: () {
                    // Navigate to School Edit Screen (Using createSchool route for now or new one)
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text('Edit School Details coming soon'),
                        backgroundColor: AppColors.surfaceLightGrey,
                      ),
                    );
                  },
                ),

                const SizedBox(height: 24),

                // ================= SECTION 2: APP SETTINGS =================
                _buildSectionHeader(_ConfigStrings.secApp),

                // Dark Mode Switch
                _buildSwitchTile(
                  context,
                  icon: Icons.dark_mode_outlined,
                  title: _ConfigStrings.itemTheme,
                  value: viewModel.isDarkMode,
                  onChanged: (val) async {
                    await viewModel.toggleDarkMode();
                    if (mounted) setState(() {});
                  },
                ),

                const SizedBox(height: 8), // Small spacing between switches
                // Notifications Switch
                _buildSwitchTile(
                  context,
                  icon: Icons.notifications_outlined,
                  title: _ConfigStrings.itemNotifs,
                  value: viewModel.pushNotifications,
                  onChanged: (val) async {
                    await viewModel.togglePushNotifications();
                    if (mounted) setState(() {});
                  },
                ),

                const SizedBox(height: 24),

                // ================= SECTION 3: DATA =================
                _buildSectionHeader(_ConfigStrings.secData),
                _buildSettingsTile(
                  context,
                  icon: Icons.sync,
                  title: _ConfigStrings.itemSync,
                  subtitle: _ConfigStrings.subSync,
                  trailing: const Icon(
                    Icons.check_circle,
                    color: AppColors.successGreen,
                    size: 18,
                  ),
                  onTap: () {},
                ),

                const SizedBox(height: 24),

                // ================= SECTION 4: SUPPORT =================
                _buildSectionHeader(_ConfigStrings.secSupport),
                _buildSettingsTile(
                  context,
                  icon: Icons.code,
                  title: _ConfigStrings.itemContactDev,
                  subtitle: _ConfigStrings.subContactDev,
                  onTap: () => context.push(
                    '${AppRoutes.settings}/${AppRoutes.contactDev}',
                  ),
                ),

                const SizedBox(height: 32),

                // LOGOUT BUTTON
                SizedBox(
                  width: double.infinity,
                  child: TextButton.icon(
                    onPressed: () {
                      // TODO: Implement Auth Logout Logic
                      context.go(AppRoutes.login);
                    },
                    icon: const Icon(Icons.logout, color: AppColors.errorRed),
                    label: const Text(
                      _ConfigStrings.itemLogout,
                      style: TextStyle(
                        color: AppColors.errorRed,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    style: TextButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      backgroundColor: AppColors.errorRed.withAlpha(20),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                  ),
                ),

                const SizedBox(height: 40), // Bottom padding
              ],
            ),
          ),
        );
      },
    );
  }

  // ===========================================================================
  // HELPER WIDGETS
  // ===========================================================================

  Widget _buildProfileHeader(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [AppColors.primaryBlue, AppColors.primaryBlueDark],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: AppColors.primaryBlue.withAlpha(60),
            blurRadius: 15,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Row(
        children: [
          // Avatar
          Container(
            width: 60,
            height: 60,
            decoration: BoxDecoration(
              color: Colors.white,
              shape: BoxShape.circle,
              border: Border.all(color: Colors.white, width: 2),
            ),
            child: const Center(
              child: Text(
                "SL", // Initials
                style: TextStyle(
                  color: AppColors.primaryBlue,
                  fontWeight: FontWeight.bold,
                  fontSize: 22,
                ),
              ),
            ),
          ),
          const SizedBox(width: 16),
          // Info
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  "Sir Legend",
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 8,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.white.withAlpha(40),
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: const Text(
                    "Owner ‚Ä¢ KwaLegend Academy",
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 11,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: Text(
        title.toUpperCase(),
        style: const TextStyle(
          color: AppColors.textGrey,
          fontSize: 12,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.2,
        ),
      ),
    );
  }

  Widget _buildSettingsTile(
    BuildContext context, {
    required IconData icon,
    required String title,
    String? subtitle,
    required VoidCallback onTap,
    Widget? trailing,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: ListTile(
        onTap: onTap,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        tileColor: AppColors.surfaceDarkGrey, // Legend Dark Theme background
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        leading: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.surfaceLightGrey.withAlpha(50),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: Colors.white, size: 22),
        ),
        title: Text(
          title,
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.bold,
            fontSize: 15,
          ),
        ),
        subtitle: subtitle != null
            ? Text(
                subtitle,
                style: const TextStyle(color: AppColors.textGrey, fontSize: 12),
              )
            : null,
        trailing:
            trailing ??
            const Icon(
              Icons.chevron_right,
              size: 20,
              color: AppColors.textGrey,
            ),
      ),
    );
  }

  Widget _buildSwitchTile(
    BuildContext context, {
    required IconData icon,
    required String title,
    required bool value,
    required ValueChanged<bool> onChanged,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(12),
      ),
      child: SwitchListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        secondary: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.surfaceLightGrey.withAlpha(50),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: Colors.white, size: 22),
        ),
        title: Text(
          title,
          style: const TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.bold,
            fontSize: 15,
          ),
        ),
        value: value,
        activeThumbColor: AppColors.primaryBlue,
        activeTrackColor: AppColors.primaryBlue.withAlpha(100),
        inactiveThumbColor: Colors.grey,
        inactiveTrackColor: AppColors.surfaceLightGrey,
        onChanged: onChanged,
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/settings/tos_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';

class TosScreen extends StatelessWidget {
  const TosScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          "Protocol & Terms",
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
      ),
      body: ListView(
        padding: const EdgeInsets.all(20),
        children: [
          // Header
          const Text(
            "OPERATIONAL AGREEMENT",
            style: TextStyle(
              color: AppColors.primaryBlue,
              fontSize: 12,
              fontWeight: FontWeight.bold,
              letterSpacing: 2.0,
            ),
          ),
          const SizedBox(height: 8),
          const Text(
            "By deploying KwaLegend, you agree to the following protocols regarding data sovereignty, financial processing, and system integrity.",
            style: TextStyle(color: AppColors.textGrey, height: 1.5),
          ),
          const SizedBox(height: 32),

          // Accordion Sections
          _buildSection(
            context,
            "1. THE LICENSE",
            "You are granted a non-exclusive, non-transferable license to use KwaLegend for internal school management. This system remains the intellectual property of Greyway.Co.",
          ),
          _buildSection(
            context,
            "2. DATA SOVEREIGNTY",
            "Your data is yours. KwaLegend operates on a 'Local-First' architecture (PowerSync). While data is synced to the cloud for backup, the primary source of truth resides on your device. We do not sell student data.",
          ),
          _buildSection(
            context,
            "3. FINANCIAL LIABILITY",
            "KwaLegend is a recording tool, not a bank. We are not liable for discrepancies between the system's ledger and your actual bank account. Always verify physical cash before logging payments.",
          ),
          _buildSection(
            context,
            "4. SYSTEM UPDATES",
            "We practice 'Continuous Deployment'. Features may evolve. Critical updates will be pushed automatically to ensure security compliance.",
          ),
          _buildSection(
            context,
            "5. TERMINATION",
            "Failure to maintain subscription dues will result in the system entering 'Read-Only' mode. Data will be preserved for 90 days post-termination.",
          ),

          const SizedBox(height: 40),
          
          // Footer
          Center(
            child: Text(
              "Last Updated: January 12, 2026",
              style: TextStyle(
                color: AppColors.textGrey.withAlpha(100),
                fontSize: 12,
                fontFamily: 'monospace',
              ),
            ),
          ),
          const SizedBox(height: 40),
        ],
      ),
    );
  }

  Widget _buildSection(BuildContext context, String title, String content) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
        ),
        child: Theme(
          data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
          child: ExpansionTile(
            title: Text(
              title,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 14,
              ),
            ),
            iconColor: AppColors.primaryBlue,
            collapsedIconColor: AppColors.textGrey,
            childrenPadding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
            children: [
              Text(
                content,
                style: const TextStyle(
                  color: AppColors.textGrey,
                  fontSize: 13,
                  height: 1.5,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/finance/finance_screen.dart
// ==========================================

import 'dart:core';

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/vmodels/finance_vmodel.dart';
import 'package:provider/provider.dart';

// -----------------------------------------------------------------------------
// FINANCE SCREEN UI
// -----------------------------------------------------------------------------
class FinanceScreen extends StatefulWidget {
  const FinanceScreen({super.key});

  @override
  State<FinanceScreen> createState() => _FinanceScreenState();
}

class _FinanceScreenState extends State<FinanceScreen> {
  // STATE
  String _selectedTimeRange = 'Monthly';

  @override
  void initState() {
    super.initState();
    // Use the FinanceViewModel from Provider and initialize it when screen loads
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<FinanceViewModel>().init();
    });
  }

  // ---------------------------------------------------------------------------
  // NAVIGATION HANDLERS
  // ---------------------------------------------------------------------------
  void _navToTransactions() {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('Transaction History module coming in next sprint'),
      ),
    );
  }

  void _navToStudent(String studentId) {
    context.push('${AppRoutes.students}/view/$studentId');
  }

  void _navToCreateInvoice() {
    context.push('${AppRoutes.finance}/${AppRoutes.createInvoice}');
  }

  // ---------------------------------------------------------------------------
  // UI BUILD
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    return Consumer<FinanceViewModel>(
      builder: (context, vm, _) {
        if (vm.isLoading) {
          return const Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(
              child: CircularProgressIndicator(color: AppColors.primaryBlue),
            ),
          );
        }

        if (vm.error != null) {
          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            appBar: AppBar(
              backgroundColor: AppColors.backgroundBlack,
              title: const Text(
                'Finance Command',
                style: TextStyle(color: Colors.white),
              ),
            ),
            body: Center(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(vm.error!, style: const TextStyle(color: Colors.white)),
                  const SizedBox(height: 12),
                  ElevatedButton(
                    onPressed: vm.refresh,
                    child: const Text('Retry'),
                  ),
                ],
              ),
            ),
          );
        }

        return Scaffold(
          backgroundColor: AppColors.backgroundBlack,

          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            centerTitle: true,
            automaticallyImplyLeading: false,
            title: const Text(
              'Finance Command',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
            actions: [
              IconButton(
                icon: const Icon(Icons.filter_list, color: Colors.white),
                onPressed: () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Filter options coming soon'),
                      backgroundColor: AppColors.surfaceLightGrey,
                    ),
                  );
                },
              ),
              const SizedBox(width: 8),
            ],
          ),

          body: SingleChildScrollView(
            padding: const EdgeInsets.fromLTRB(20, 10, 20, 100),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: _buildStatCard(
                        title: 'REVENUE',
                        amount: '\$${vm.totalRevenue.toStringAsFixed(0)}',
                        subtitle: '+${vm.percentGrowth}% vs last month',
                        icon: Icons.attach_money,
                        color: AppColors.successGreen,
                        isPositive: true,
                        onTap: _navToTransactions,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: _buildStatCard(
                        title: 'PENDING',
                        amount: '\$${vm.pendingAmount.toStringAsFixed(0)}',
                        subtitle: '! ${vm.unpaidInvoiceCount} Unpaid invoices',
                        icon: Icons.pending_actions_outlined,
                        color: Colors.orangeAccent,
                        isPositive: false,
                        onTap: () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text('Filtering Pending Invoices...'),
                              backgroundColor: AppColors.surfaceLightGrey,
                            ),
                          );
                        },
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 24),

                _buildChartSection(vm),

                const SizedBox(height: 24),

                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text(
                      'Recent Activity',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    TextButton(
                      onPressed: _navToTransactions,
                      child: const Text(
                        'View All',
                        style: TextStyle(color: AppColors.primaryBlue),
                      ),
                    ),
                  ],
                ),

                ListView.separated(
                  physics: const NeverScrollableScrollPhysics(),
                  shrinkWrap: true,
                  itemCount: vm.recentActivity.length,
                  separatorBuilder: (_, _) => const SizedBox(height: 12),
                  itemBuilder: (context, index) {
                    final item = vm.recentActivity[index];
                    return _buildActivityTile(
                      name: item['name'],
                      desc: item['desc'],
                      amount: item['amount'],
                      time: item['time'],
                      type: item['type'],
                      onTap: () => _navToStudent(item['targetId']),
                    );
                  },
                ),

                const SizedBox(height: 24),

                _buildInvoiceSection(),
              ],
            ),
          ),

          floatingActionButton: _buildFab(),
        );
      },
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGET BUILDERS
  // ---------------------------------------------------------------------------

  Widget _buildStatCard({
    required String title,
    required String amount,
    required String subtitle,
    required IconData icon,
    required Color color,
    required bool isPositive,
    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: color.withAlpha(20),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, color: color, size: 20),
                ),
                Icon(
                  Icons.chevron_right,
                  color: AppColors.textGrey.withAlpha(50),
                  size: 18,
                ),
              ],
            ),
            const SizedBox(height: 16),
            Text(
              title,
              style: const TextStyle(
                color: AppColors.textGrey,
                fontSize: 10,
                fontWeight: FontWeight.bold,
                letterSpacing: 1.0,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              amount,
              style: const TextStyle(
                color: Colors.white,
                fontSize: 22,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              subtitle,
              style: TextStyle(
                color: isPositive ? AppColors.successGreen : Colors.redAccent,
                fontSize: 11,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildChartSection(FinanceViewModel vm) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Collections Trend',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    'Academic Year 2026',
                    style: TextStyle(color: AppColors.textGrey, fontSize: 12),
                  ),
                ],
              ),
              // Time Range Toggle
              Container(
                height: 32,
                decoration: BoxDecoration(
                  color: Colors.black.withAlpha(50),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  children: [
                    _buildToggleButton('Weekly'),
                    _buildToggleButton('Monthly'),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 24),

          // DYNAMIC BAR CHART VISUALIZER
          SizedBox(
            height: 150,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              crossAxisAlignment: CrossAxisAlignment.end,
              // Generating bars from the ViewModel's list
              children: List.generate(vm.monthlyCollections.length, (index) {
                return _buildBar(
                  heightPct: vm.monthlyCollections[index],
                  label: vm.monthLabels[index],
                  isActive:
                      index ==
                      3, // Mock active state logic (e.g., current month)
                );
              }),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildToggleButton(String text) {
    final isSelected = _selectedTimeRange == text;
    return GestureDetector(
      onTap: () => setState(() => _selectedTimeRange = text),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.surfaceLightGrey : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
        ),
        child: Text(
          text,
          style: TextStyle(
            color: isSelected ? Colors.white : AppColors.textGrey,
            fontSize: 12,
            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
          ),
        ),
      ),
    );
  }

  Widget _buildBar({
    required double heightPct,
    required String label,
    bool isActive = false,
  }) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.end,
      children: [
        // The Bar
        AnimatedContainer(
          duration: const Duration(milliseconds: 500),
          curve: Curves.easeOutBack,
          width: 32,
          height: 110 * heightPct,
          decoration: BoxDecoration(
            color: isActive
                ? AppColors.primaryBlue
                : AppColors.surfaceLightGrey.withAlpha(30),
            borderRadius: BorderRadius.circular(4),
            gradient: isActive
                ? const LinearGradient(
                    begin: Alignment.bottomCenter,
                    end: Alignment.topCenter,
                    colors: [AppColors.primaryBlue, AppColors.primaryBlueLight],
                  )
                : null,
          ),
        ),
        const SizedBox(height: 12),
        // The Label
        Text(
          label,
          style: TextStyle(
            color: isActive ? AppColors.primaryBlue : AppColors.textGrey,
            fontSize: 10,
            fontWeight: FontWeight.bold,
          ),
        ),
      ],
    );
  }

  Widget _buildActivityTile({
    required String name,
    required String desc,
    required double amount,
    required String time,
    required String type,
    required VoidCallback onTap,
  }) {
    final isWarning = type == 'WARNING';
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
        ),
        child: Row(
          children: [
            CircleAvatar(
              radius: 20,
              backgroundColor: isWarning
                  ? Colors.redAccent.withAlpha(20)
                  : AppColors.primaryBlue.withAlpha(20),
              child: Icon(
                isWarning ? Icons.priority_high : Icons.person,
                color: isWarning ? Colors.redAccent : AppColors.primaryBlue,
                size: 20,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    name,
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    desc,
                    style: const TextStyle(
                      color: AppColors.textGrey,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  isWarning
                      ? '\$${amount.toStringAsFixed(2)}'
                      : '+\$${amount.toStringAsFixed(2)}',
                  style: TextStyle(
                    color: isWarning
                        ? Colors.redAccent
                        : AppColors.successGreen,
                    fontWeight: FontWeight.bold,
                    fontSize: 14,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  time,
                  style: const TextStyle(
                    color: AppColors.textGrey,
                    fontSize: 10,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInvoiceSection() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'Pending Invoices',
            style: TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 12),
          Text(
            'Manage and track unpaid invoices',
            style: TextStyle(color: AppColors.textGrey, fontSize: 12),
          ),
          const SizedBox(height: 12),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              onPressed: _navToCreateInvoice,
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
              ),
              child: const Text('View Invoices'),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFab() {
    return FloatingActionButton.extended(
      onPressed: _navToCreateInvoice,
      backgroundColor: AppColors.primaryBlue,
      elevation: 4,
      icon: const Icon(Icons.add_circle_outline, color: Colors.white),
      label: const Text(
        'Generate Invoice',
        style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
      ),
    );
  }

  Widget _buildTransactionCard({
    required String name,
    required String description,
    required String amount,
    required String time,
    required bool isIncome,
    bool isWarning = false,
    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
        ),
        child: Row(
          children: [
            // Icon
            CircleAvatar(
              radius: 20,
              backgroundColor: isWarning
                  ? Colors.redAccent.withAlpha(20)
                  : AppColors.primaryBlue.withAlpha(20),
              child: Icon(
                isWarning ? Icons.priority_high : Icons.person,
                color: isWarning ? Colors.redAccent : AppColors.primaryBlue,
                size: 20,
              ),
            ),
            const SizedBox(width: 16),
            // Text Info
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    name,
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    description,
                    style: const TextStyle(
                      color: AppColors.textGrey,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            // Amount & Time
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  amount,
                  style: TextStyle(
                    color: isWarning
                        ? Colors.redAccent
                        : (isIncome ? AppColors.successGreen : Colors.white),
                    fontWeight: FontWeight.bold,
                    fontSize: 14,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  time,
                  style: const TextStyle(
                    color: AppColors.textGrey,
                    fontSize: 10,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./screens/finance/record_payment_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/constants/app_constants.dart';

// =============================================================================
// 1. VIEW MODEL
// =============================================================================
class PaymentViewModel {
  // Student Context
  final String? studentId;
  String studentName = "Select Student...";
  String grade = "";
  double currentDebt = 0.0;
  
  // Payment Data
  double amount = 0.0;
  String method = "Cash"; // Cash, EcoCash, Bank
  String reference = "";
  DateTime date = DateTime.now();
  String receiptNumber = "RCP-${DateTime.now().millisecondsSinceEpoch.toString().substring(8)}";

  // Logic State
  bool isLoading = false;

  PaymentViewModel({this.studentId});

  Future<void> loadContext() async {
    isLoading = true;
    await Future.delayed(const Duration(milliseconds: 500)); // Sim network
    
    if (studentId != null) {
      // Mock fetch
      studentName = "Nyasha Gabriel";
      grade = "Form 4A";
      currentDebt = 150.00;
    }
    isLoading = false;
  }

  // Smart Allocation: Suggests what this payment covers
  String get allocationPreview {
    if (amount <= 0) return "Pending input...";
    if (amount >= currentDebt && currentDebt > 0) return "Clears Full Balance";
    return "Partially covers Outstanding Balance";
  }
}

// =============================================================================
// 2. SCREEN IMPLEMENTATION
// =============================================================================
class RecordPaymentScreen extends StatefulWidget {
  final String? studentId;

  const RecordPaymentScreen({super.key, this.studentId});

  @override
  State<RecordPaymentScreen> createState() => _RecordPaymentScreenState();
}

class _RecordPaymentScreenState extends State<RecordPaymentScreen> {
  late PaymentViewModel _vm;
  final TextEditingController _amountCtrl = TextEditingController();

  @override
  void initState() {
    super.initState();
    _vm = PaymentViewModel(studentId: widget.studentId);
    _initLoad();
  }

  void _initLoad() async {
    await _vm.loadContext();
    if (mounted) setState(() {});
  }

  void _processPayment() {
    if (_vm.amount <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Enter a valid amount"), backgroundColor: AppColors.errorRed),
      );
      return;
    }

    // TODO: Write to legend.payments & legend.ledger
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text("Payment of \$${_vm.amount} Recorded!"),
        backgroundColor: AppColors.successGreen,
      ),
    );
    context.pop();
  }

  @override
  Widget build(BuildContext context) {
    if (_vm.isLoading) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(child: CircularProgressIndicator(color: AppColors.successGreen)),
      );
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text("Receive Payment", style: TextStyle(fontWeight: FontWeight.bold)),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            // -----------------------------------------------------------------
            // 1. STUDENT CONTEXT CARD
            // -----------------------------------------------------------------
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: AppColors.surfaceDarkGrey,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
              ),
              child: Row(
                children: [
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue,
                    child: Text(_vm.studentName[0], style: const TextStyle(color: Colors.white)),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(_vm.studentName, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16)),
                        Text("Owes: \$${_vm.currentDebt.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.errorRed, fontSize: 13)),
                      ],
                    ),
                  ),
                  if (_vm.studentId == null)
                    TextButton(
                      onPressed: () {}, // TODO: Search logic
                      child: const Text("Change"),
                    ),
                ],
              ),
            ),

            const SizedBox(height: 32),

            // -----------------------------------------------------------------
            // 2. THE MONEY INPUT
            // -----------------------------------------------------------------
            Text("AMOUNT RECEIVED", style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.5)),
            const SizedBox(height: 8),
            IntrinsicWidth(
              child: TextField(
                controller: _amountCtrl,
                keyboardType: const TextInputType.numberWithOptions(decimal: true),
                textAlign: TextAlign.center,
                style: const TextStyle(color: AppColors.successGreen, fontSize: 48, fontWeight: FontWeight.bold),
                decoration: const InputDecoration(
                  prefixText: "\$ ",
                  prefixStyle: TextStyle(color: AppColors.successGreen, fontSize: 48),
                  border: InputBorder.none,
                  hintText: "0.00",
                  hintStyle: TextStyle(color: Colors.white12),
                ),
                onChanged: (val) {
                  setState(() {
                    _vm.amount = double.tryParse(val) ?? 0.0;
                  });
                },
              ),
            ),
            
            // Quick Action Chips
            Wrap(
              spacing: 8,
              children: [
                _buildQuickAmountChip("Full Debt", _vm.currentDebt),
                _buildQuickAmountChip("50%", _vm.currentDebt / 2),
                _buildQuickAmountChip("\$100", 100),
              ],
            ),

            const SizedBox(height: 32),

            // -----------------------------------------------------------------
            // 3. PAYMENT DETAILS
            // -----------------------------------------------------------------
            Row(
              children: [
                Expanded(
                  child: _buildDropdown(
                    label: "Method",
                    value: _vm.method,
                    items: ["Cash", "EcoCash", "Bank Transfer", "Swipe"],
                    onChanged: (val) => setState(() => _vm.method = val!),
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: _buildTextField(
                    label: "Reference / Ref No.",
                    onChanged: (val) => _vm.reference = val,
                  ),
                ),
              ],
            ),

            const SizedBox(height: 40),

            // -----------------------------------------------------------------
            // 4. LIVE RECEIPT PREVIEW
            // -----------------------------------------------------------------
            const Text("RECEIPT PREVIEW", style: TextStyle(color: AppColors.textGrey, fontSize: 10, letterSpacing: 2)),
            const SizedBox(height: 12),
            _buildThermalReceipt(),

            const SizedBox(height: 40),
          ],
        ),
      ),
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: SizedBox(
            height: 56,
            child: ElevatedButton.icon(
              onPressed: _processPayment,
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.successGreen,
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                elevation: 10,
                shadowColor: AppColors.successGreen.withAlpha(100),
              ),
              icon: const Icon(Icons.print, size: 20),
              label: const Text("CONFIRM & PRINT", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
            ),
          ),
        ),
      ),
    );
  }

  // ===========================================================================
  // WIDGET BUILDERS
  // ===========================================================================

  Widget _buildQuickAmountChip(String label, double amount) {
    return ActionChip(
      label: Text(label),
      backgroundColor: AppColors.surfaceDarkGrey,
      labelStyle: const TextStyle(color: Colors.white, fontSize: 12),
      side: BorderSide(color: AppColors.surfaceLightGrey.withAlpha(30)),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      onPressed: () {
        setState(() {
          _vm.amount = amount;
          _amountCtrl.text = amount.toStringAsFixed(2);
        });
      },
    );
  }

  Widget _buildDropdown({required String label, required String value, required List<String> items, required ValueChanged<String?> onChanged}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
        const SizedBox(height: 8),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<String>(
              value: value,
              isExpanded: true,
              dropdownColor: AppColors.surfaceDarkGrey,
              style: const TextStyle(color: Colors.white),
              items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
              onChanged: onChanged,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildTextField({required String label, required ValueChanged<String> onChanged}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
          ),
          child: TextField(
            style: const TextStyle(color: Colors.white),
            decoration: const InputDecoration(
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 14),
              isDense: true,
            ),
            onChanged: onChanged,
          ),
        ),
      ],
    );
  }

  // THE THERMAL RECEIPT VISUAL
  Widget _buildThermalReceipt() {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFFFDFDFD), // Paper White
        borderRadius: BorderRadius.circular(8),
        boxShadow: const [
          BoxShadow(color: Colors.black26, blurRadius: 10, offset: Offset(0, 4)),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          const Icon(Icons.school, color: Colors.black, size: 32),
          const SizedBox(height: 8),
          const Text("KWA LEGEND ACADEMY", style: TextStyle(color: Colors.black, fontWeight: FontWeight.w900, fontSize: 14)),
          const Text("OFFICIAL RECEIPT", style: TextStyle(color: Colors.black54, fontSize: 10, letterSpacing: 2)),
          
          const Divider(height: 24, color: Colors.black12, thickness: 1),
          
          _receiptRow("Date", DateFormat("dd/MM/yyyy HH:mm").format(_vm.date)),
          _receiptRow("Receipt #", _vm.receiptNumber),
          _receiptRow("Student", _vm.studentName),
          const SizedBox(height: 8),
          _receiptRow("Method", _vm.method),
          if (_vm.reference.isNotEmpty) _receiptRow("Ref", _vm.reference),
          
          const Divider(height: 24, color: Colors.black12, thickness: 1), // Dashed preferred, logic simplifed
          
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("AMOUNT PAID", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold, fontSize: 14)),
              Text("\$${_vm.amount.toStringAsFixed(2)}", style: const TextStyle(color: Colors.black, fontWeight: FontWeight.w900, fontSize: 18)),
            ],
          ),
          
          const SizedBox(height: 8),
          Text(
            "Allocation: ${_vm.allocationPreview}",
            style: const TextStyle(color: Colors.black54, fontSize: 10, fontStyle: FontStyle.italic),
            textAlign: TextAlign.center,
          ),
          
          const SizedBox(height: 20),
          // Barcode Placebo
          Container(height: 30, width: 200, color: Colors.black12, child: const Center(child: Text("||||||| ||| ||||||", style: TextStyle(fontFamily: 'monospace', fontSize: 10, color: Colors.black26)))),
        ],
      ),
    );
  }

  Widget _receiptRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: Colors.black54, fontSize: 11)),
          Text(value, style: const TextStyle(color: Colors.black, fontSize: 11, fontWeight: FontWeight.w600)),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/finance/create_invoice_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/constants/app_constants.dart';

// -----------------------------------------------------------------------------
// 1. VIEW MODEL (State & Logic)
// -----------------------------------------------------------------------------
class CreateInvoiceViewModel {
  // Metadata
  final String invoiceNumber; // Auto-generated
  DateTime issueDate;
  DateTime dueDate;
  
  // Student Context
  String? studentName;
  String? studentGrade;
  String? guardianName;

  // Financials
  List<InvoiceLineItem> items;
  
  // Getters
  double get subtotal => items.fold(0, (sum, item) => sum + item.total);
  double get tax => 0.0; // Mock 0% tax for schools usually
  double get total => subtotal + tax;

  CreateInvoiceViewModel({
    required this.invoiceNumber,
    required this.issueDate,
    required this.dueDate,
    this.studentName,
    this.studentGrade,
    this.guardianName,
    required this.items,
  });

  // Factory for "No User Effort" - Defaults
  factory CreateInvoiceViewModel.init() {
    final now = DateTime.now();
    return CreateInvoiceViewModel(
      invoiceNumber: "INV-${now.year}-${(now.month).toString().padLeft(2,'0')}-0042",
      issueDate: now,
      dueDate: now.add(const Duration(days: 14)), // Default 2 weeks
      items: [
        InvoiceLineItem(description: "Term 1 Tuition Fee", quantity: 1, unitPrice: 450.00),
        InvoiceLineItem(description: "Technology Levy", quantity: 1, unitPrice: 50.00),
      ],
    );
  }

  void addItem() {
    items.add(InvoiceLineItem(description: "New Item", quantity: 1, unitPrice: 0.0));
  }

  void removeItem(int index) {
    items.removeAt(index);
  }
}

class InvoiceLineItem {
  String description;
  int quantity;
  double unitPrice;

  InvoiceLineItem({required this.description, required this.quantity, required this.unitPrice});

  double get total => quantity * unitPrice;
}

// -----------------------------------------------------------------------------
// 2. MAIN SCREEN
// -----------------------------------------------------------------------------
class CreateInvoiceScreen extends StatefulWidget {
  const CreateInvoiceScreen({super.key});

  @override
  State<CreateInvoiceScreen> createState() => _CreateInvoiceScreenState();
}

class _CreateInvoiceScreenState extends State<CreateInvoiceScreen> with SingleTickerProviderStateMixin {
  late CreateInvoiceViewModel _vm;
  late TabController _tabController;

  @override
  void initState() {
    super.initState();
    _vm = CreateInvoiceViewModel.init();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  void _saveInvoice() {
    // TODO: Write to legend.invoices and legend.invoice_items
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("Invoice Posted & PDF Generated"), backgroundColor: AppColors.successGreen),
    );
    context.pop();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      // APP BAR with TABS
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text("Invoice Studio", style: TextStyle(fontWeight: FontWeight.bold)),
        bottom: TabBar(
          controller: _tabController,
          indicatorColor: AppColors.primaryBlue,
          labelColor: AppColors.primaryBlue,
          unselectedLabelColor: AppColors.textGrey,
          tabs: const [
            Tab(text: "EDITOR", icon: Icon(Icons.edit_note)),
            Tab(text: "PREVIEW", icon: Icon(Icons.remove_red_eye_outlined)),
          ],
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.save_alt, color: AppColors.successGreen),
            onPressed: _saveInvoice,
            tooltip: "Save & Post",
          ),
        ],
      ),
      
      // BODY
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildEditor(context),
          _buildPreview(context),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // TAB 1: THE EDITOR (Data Entry)
  // ---------------------------------------------------------------------------
  Widget _buildEditor(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. HEADER DETAILS
          _buildSectionHeader("Bill To"),
          _buildSearchField(
            label: "Select Student",
            icon: Icons.person_search,
            value: _vm.studentName,
            onTap: () {
              // TODO: Open Student Selector Modal
              setState(() {
                _vm.studentName = "James Wilson";
                _vm.studentGrade = "Form 4-B";
                _vm.guardianName = "Mr. Thomas Wilson";
              });
            },
          ),
          if (_vm.studentName != null) ...[
            const SizedBox(height: 8),
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: AppColors.surfaceDarkGrey,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: AppColors.primaryBlue.withAlpha(50)),
              ),
              child: Row(
                children: [
                  const Icon(Icons.info_outline, size: 16, color: AppColors.primaryBlue),
                  const SizedBox(width: 8),
                  Text("Billed to ${_vm.guardianName} (Parent)", style: const TextStyle(color: Colors.white70, fontSize: 12)),
                ],
              ),
            ),
          ],
          
          const SizedBox(height: 24),

          // 2. DATES
          _buildSectionHeader("Timeline"),
          Row(
            children: [
              Expanded(
                child: _buildDatePicker(
                  label: "Issue Date",
                  date: _vm.issueDate,
                  onPick: (d) => setState(() => _vm.issueDate = d),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: _buildDatePicker(
                  label: "Due Date",
                  date: _vm.dueDate,
                  isDue: true,
                  onPick: (d) => setState(() => _vm.dueDate = d),
                ),
              ),
            ],
          ),

          const SizedBox(height: 24),

          // 3. LINE ITEMS
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              _buildSectionHeader("Line Items"),
              TextButton.icon(
                onPressed: () => setState(() => _vm.addItem()),
                icon: const Icon(Icons.add, size: 16, color: AppColors.primaryBlue),
                label: const Text("Add Item", style: TextStyle(color: AppColors.primaryBlue)),
              )
            ],
          ),
          
          ListView.separated(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            itemCount: _vm.items.length,
            separatorBuilder: (ctx, i) => const SizedBox(height: 12),
            itemBuilder: (ctx, i) {
              return _buildLineItemRow(i);
            },
          ),

          const SizedBox(height: 24),
          const Divider(color: AppColors.surfaceLightGrey),
          
          // 4. TOTALS
          Align(
            alignment: Alignment.centerRight,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text("Total Amount", style: TextStyle(color: AppColors.textGrey.withAlpha(150))),
                const SizedBox(height: 4),
                Text(
                  "\$${_vm.total.toStringAsFixed(2)}",
                  style: const TextStyle(color: Colors.white, fontSize: 32, fontWeight: FontWeight.bold),
                ),
              ],
            ),
          ),
          const SizedBox(height: 40),
        ],
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // TAB 2: THE PREVIEW (Zoomable Paper)
  // ---------------------------------------------------------------------------
  Widget _buildPreview(BuildContext context) {
    return Container(
      color: Colors.black87, // Dark backdrop for the "Paper"
      child: InteractiveViewer(
        minScale: 0.5,
        maxScale: 3.0,
        boundaryMargin: const EdgeInsets.all(20),
        child: Center(
          child: Container(
            // A4 Aspect Ratio (approx width 350 -> height 495)
            width: 350, 
            height: 495, 
            decoration: BoxDecoration(
              color: Colors.white,
              boxShadow: const [BoxShadow(color: Colors.black, blurRadius: 20)],
            ),
            child: _InvoicePaperTemplate(vm: _vm),
          ),
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPER WIDGETS
  // ---------------------------------------------------------------------------

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Text(
        title.toUpperCase(),
        style: const TextStyle(color: AppColors.textGrey, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.2),
      ),
    );
  }

  Widget _buildSearchField({required String label, required IconData icon, required VoidCallback onTap, String? value}) {
    return InkWell(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        child: Row(
          children: [
            Icon(icon, color: value != null ? Colors.white : AppColors.textGrey),
            const SizedBox(width: 12),
            Text(
              value ?? label,
              style: TextStyle(color: value != null ? Colors.white : AppColors.textGrey, fontSize: 16),
            ),
            const Spacer(),
            const Icon(Icons.arrow_drop_down, color: AppColors.textGrey),
          ],
        ),
      ),
    );
  }

  Widget _buildDatePicker({required String label, required DateTime date, required Function(DateTime) onPick, bool isDue = false}) {
    return InkWell(
      onTap: () async {
        final d = await showDatePicker(context: context, initialDate: date, firstDate: DateTime(2020), lastDate: DateTime(2030));
        if (d != null) onPick(d);
      },
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: isDue ? Colors.redAccent.withAlpha(50) : AppColors.surfaceLightGrey.withAlpha(30)),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(label, style: const TextStyle(color: AppColors.textGrey, fontSize: 11)),
            const SizedBox(height: 4),
            Text(
              DateFormat('MMM dd, yyyy').format(date),
              style: TextStyle(color: isDue ? Colors.redAccent : Colors.white, fontWeight: FontWeight.bold),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLineItemRow(int index) {
    final item = _vm.items[index];
    return Dismissible(
      key: UniqueKey(),
      onDismissed: (_) => setState(() => _vm.removeItem(index)),
      direction: DismissDirection.endToStart,
      background: Container(color: AppColors.errorRed, alignment: Alignment.centerRight, padding: const EdgeInsets.only(right: 20), child: const Icon(Icons.delete, color: Colors.white)),
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          children: [
            Expanded(
              flex: 4,
              child: TextFormField(
                initialValue: item.description,
                style: const TextStyle(color: Colors.white, fontSize: 14),
                decoration: const InputDecoration(border: InputBorder.none, hintText: "Description", hintStyle: TextStyle(color: AppColors.textGrey)),
                onChanged: (v) => item.description = v,
              ),
            ),
            Expanded(
              flex: 1,
              child: TextFormField(
                initialValue: item.quantity.toString(),
                keyboardType: TextInputType.number,
                textAlign: TextAlign.center,
                style: const TextStyle(color: Colors.white, fontSize: 14),
                decoration: const InputDecoration(border: InputBorder.none, hintText: "Qty"),
                onChanged: (v) => setState(() => item.quantity = int.tryParse(v) ?? 1),
              ),
            ),
            Expanded(
              flex: 2,
              child: TextFormField(
                initialValue: item.unitPrice.toStringAsFixed(2),
                keyboardType: TextInputType.number,
                textAlign: TextAlign.right,
                style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 14),
                decoration: const InputDecoration(border: InputBorder.none, prefixText: "\$ ", prefixStyle: TextStyle(color: AppColors.textGrey)),
                onChanged: (v) => setState(() => item.unitPrice = double.tryParse(v) ?? 0.0),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// 3. THE PAPER TEMPLATE (Pure UI - No Input)
// -----------------------------------------------------------------------------
class _InvoicePaperTemplate extends StatelessWidget {
  final CreateInvoiceViewModel vm;
  const _InvoicePaperTemplate({required this.vm});

  @override
  Widget build(BuildContext context) {
    const textDark = Color(0xFF1E293B);
    const textLight = Color(0xFF64748B);

    return Padding(
      padding: const EdgeInsets.all(24.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("INVOICE", style: TextStyle(color: textDark, fontSize: 20, fontWeight: FontWeight.bold, letterSpacing: 2)),
              Text(vm.invoiceNumber, style: const TextStyle(color: textLight, fontSize: 12)),
            ],
          ),
          const Divider(thickness: 2, color: textDark),
          const SizedBox(height: 16),
          
          // Details
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text("BILLED TO:", style: TextStyle(color: textLight, fontSize: 8, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 4),
                  Text(vm.studentName ?? "Walk-in Student", style: const TextStyle(color: textDark, fontSize: 10, fontWeight: FontWeight.bold)),
                  Text(vm.studentGrade ?? "", style: const TextStyle(color: textDark, fontSize: 9)),
                ],
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Text("Due: ${DateFormat('MMM dd, yyyy').format(vm.dueDate)}", style: const TextStyle(color: Colors.redAccent, fontSize: 9, fontWeight: FontWeight.bold)),
                ],
              ),
            ],
          ),
          const SizedBox(height: 24),

          // Table Header
          Container(
            padding: const EdgeInsets.symmetric(vertical: 4),
            color: Colors.grey[200],
            child: const Row(
              children: [
                Expanded(flex: 4, child: Text(" DESCRIPTION", style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold))),
                Expanded(flex: 1, child: Text("QTY", textAlign: TextAlign.center, style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, ))),
                Expanded(flex: 2, child: Text("AMOUNT ",  textAlign: TextAlign.right,style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold,))),
              ],
            ),
          ),
          
          // Table Rows
          ...vm.items.map((item) => Padding(
            padding: const EdgeInsets.symmetric(vertical: 6),
            child: Row(
              children: [
                Expanded(flex: 4, child: Text(" ${item.description}", style: const TextStyle(fontSize: 9, color: textDark))),
                Expanded(flex: 1, child: Text("${item.quantity}", textAlign: TextAlign.center, style: const TextStyle(fontSize: 9, color: textDark))),
                Expanded(flex: 2, child: Text("\$${item.total.toStringAsFixed(2)} ", textAlign: TextAlign.right, style: const TextStyle(fontSize: 9, color: textDark))),
              ],
            ),
          )),

          const Spacer(),
          
          // Total
          const Divider(),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("TOTAL DUE", style: TextStyle(color: textDark, fontSize: 12, fontWeight: FontWeight.bold)),
              Text("\$${vm.total.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.primaryBlue, fontSize: 16, fontWeight: FontWeight.bold)),
            ],
          ),
          const SizedBox(height: 20),
          const Center(child: Text("Thank you for choosing KwaLegend Academy", style: TextStyle(color: textLight, fontSize: 8))),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/finance/view_invoice_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/constants/app_constants.dart';

// =============================================================================
// 1. VIEW MODEL
// =============================================================================
class ViewInvoiceViewModel {
  final String invoiceId;
  bool isLoading = true;
  
  // Invoice Data
  late String invoiceNumber;
  late DateTime issueDate;
  late DateTime dueDate;
  late String studentName;
  late String guardianName;
  late String guardianPhone; // For WhatsApp
  late List<Map<String, dynamic>> items;
  late double total;
  late String status; // PAID, UNPAID, OVERDUE

  ViewInvoiceViewModel(this.invoiceId);

  Future<void> loadInvoice() async {
    // Simulate DB Fetch
    await Future.delayed(const Duration(milliseconds: 600));
    
    // MOCK DATA
    invoiceNumber = "INV-2026-001-${invoiceId.substring(0, 4)}";
    issueDate = DateTime.now().subtract(const Duration(days: 2));
    dueDate = DateTime.now().add(const Duration(days: 12));
    studentName = "Nyasha Gabriel";
    guardianName = "Mr. T. Kuudzadombo";
    guardianPhone = "+263771234567";
    status = "UNPAID";
    
    items = [
      {"desc": "Term 1 Tuition", "qty": 1, "price": 450.00},
      {"desc": "Computer Lab Levy", "qty": 1, "price": 50.00},
      {"desc": "Sports Uniform", "qty": 1, "price": 35.00},
    ];
    
    total = items.fold(0.0, (sum, item) => sum + (item['price'] * item['qty']));
    isLoading = false;
  }

  Future<void> shareViaWhatsApp(BuildContext context) async {
    // TODO: Implement actual PDF Generation & Share Intent
    // 1. Convert Widget to Image/PDF
    // 2. Write to Temp File
    // 3. ShareX.shareFiles([path], text: "Hello $guardianName, please find invoice...")
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: const [
            Icon(Icons.check_circle, color: Colors.white),
            SizedBox(width: 8),
            Text("Generating PDF & Opening WhatsApp..."),
          ],
        ),
        backgroundColor: const Color(0xFF25D366), // WhatsApp Green
        behavior: SnackBarBehavior.floating,
      ),
    );
  }
}

// =============================================================================
// 2. SCREEN IMPLEMENTATION
// =============================================================================
class ViewInvoiceScreen extends StatefulWidget {
  final String? invoiceId;

  const ViewInvoiceScreen({super.key, this.invoiceId});

  @override
  State<ViewInvoiceScreen> createState() => _ViewInvoiceScreenState();
}

class _ViewInvoiceScreenState extends State<ViewInvoiceScreen> {
  late ViewInvoiceViewModel _vm;

  @override
  void initState() {
    super.initState();
    _vm = ViewInvoiceViewModel(widget.invoiceId ?? "0000");
    _initLoad();
  }

  void _initLoad() async {
    await _vm.loadInvoice();
    if (mounted) setState(() {});
  }

  @override
  Widget build(BuildContext context) {
    if (_vm.isLoading) {
      return const Scaffold(
        backgroundColor: AppColors.backgroundBlack,
        body: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
      );
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      
      // APP BAR
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: Column(
          children: [
            const Text("Invoice Details", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
            Text(_vm.invoiceNumber, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
          ],
        ),
        actions: [
          // Edit Action (If draft/admin)
          IconButton(
            icon: const Icon(Icons.edit_note, color: Colors.white),
            tooltip: "Edit Invoice",
            onPressed: () {},
          ),
          // Print Action
          IconButton(
            icon: const Icon(Icons.print, color: Colors.white),
            tooltip: "Print",
            onPressed: () {},
          ),
        ],
      ),

      // BODY: ZOOMABLE PAPER
      body: Container(
        color: const Color(0xFF121212), // Slightly lighter black for contrast
        child: InteractiveViewer(
          minScale: 0.5,
          maxScale: 4.0,
          boundaryMargin: const EdgeInsets.all(40),
          child: Center(
            child: Hero(
              tag: 'invoice_paper',
              child: _InvoicePaper(vm: _vm),
            ),
          ),
        ),
      ),

      // ACTION BAR: WHATSAPP SHARE
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: SizedBox(
            height: 56,
            child: ElevatedButton.icon(
              onPressed: () => _vm.shareViaWhatsApp(context),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF25D366), // WhatsApp Brand Color
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                elevation: 8,
              ),
              icon: const Icon(Icons.share, size: 22),
              label: const Text(
                "SHARE VIA WHATSAPP", 
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900, letterSpacing: 1.0),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// =============================================================================
// 3. THE "PAPER" WIDGET (A4 Representation)
// =============================================================================
class _InvoicePaper extends StatelessWidget {
  final ViewInvoiceViewModel vm;

  const _InvoicePaper({required this.vm});

  @override
  Widget build(BuildContext context) {
    // A4 Ratio: 1 : 1.414
    // Base Width: 350 -> Height: ~495
    return Container(
      width: 350,
      height: 495,
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        boxShadow: const [BoxShadow(color: Colors.black54, blurRadius: 30, spreadRadius: -5)],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // --- HEADER ---
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // Logo Placeholder
              Container(
                width: 40, 
                height: 40, 
                decoration: const BoxDecoration(color: AppColors.primaryBlue, shape: BoxShape.circle),
                child: const Icon(Icons.school, color: Colors.white, size: 20),
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  const Text("INVOICE", style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900, letterSpacing: 3, color: Color(0xFF1E293B))),
                  Text("# ${vm.invoiceNumber}", style: const TextStyle(fontSize: 10, color: Color(0xFF64748B))),
                ],
              ),
            ],
          ),
          
          const SizedBox(height: 20),
          
          // --- INFO GRID ---
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // FROM
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: const [
                  Text("FROM:", style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF94A3B8))),
                  SizedBox(height: 2),
                  Text("KWA LEGEND ACADEMY", style: TextStyle(fontSize: 9, fontWeight: FontWeight.bold, color: Color(0xFF1E293B))),
                  Text("123 Education Lane\nHarare, Zimbabwe", style: TextStyle(fontSize: 8, color: Color(0xFF475569))),
                ],
              ),
              // TO
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  const Text("BILL TO:", style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF94A3B8))),
                  const SizedBox(height: 2),
                  Text(vm.guardianName, style: const TextStyle(fontSize: 9, fontWeight: FontWeight.bold, color: Color(0xFF1E293B))),
                  Text("Student: ${vm.studentName}", style: const TextStyle(fontSize: 8, color: Color(0xFF475569))),
                ],
              ),
            ],
          ),

          const SizedBox(height: 24),

          // --- TABLE HEADER ---
          Container(
            padding: const EdgeInsets.symmetric(vertical: 6, horizontal: 8),
            decoration: BoxDecoration(color: const Color(0xFFF1F5F9), borderRadius: BorderRadius.circular(4)),
            child: Row(
              children: const [
                Expanded(flex: 4, child: Text("DESCRIPTION", style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF475569)))),
                Expanded(flex: 1, child: Text("QTY", textAlign: TextAlign.center, style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF475569)))),
                Expanded(flex: 2, child: Text("TOTAL", textAlign: TextAlign.right, style: TextStyle(fontSize: 8, fontWeight: FontWeight.bold, color: Color(0xFF475569)))),
              ],
            ),
          ),
          const SizedBox(height: 8),

          // --- ITEMS ---
          Expanded(
            child: ListView.separated(
              physics: const NeverScrollableScrollPhysics(),
              itemCount: vm.items.length,
              separatorBuilder: (_, __) => const Divider(height: 12, thickness: 0.5),
              itemBuilder: (ctx, i) {
                final item = vm.items[i];
                return Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8),
                  child: Row(
                    children: [
                      Expanded(flex: 4, child: Text(item['desc'], style: const TextStyle(fontSize: 9, color: Color(0xFF1E293B)))),
                      Expanded(flex: 1, child: Text("${item['qty']}", textAlign: TextAlign.center, style: const TextStyle(fontSize: 9, color: Color(0xFF1E293B)))),
                      Expanded(flex: 2, child: Text("\$${(item['price'] * item['qty']).toStringAsFixed(2)}", textAlign: TextAlign.right, style: const TextStyle(fontSize: 9, fontWeight: FontWeight.w600, color: Color(0xFF1E293B)))),
                    ],
                  ),
                );
              },
            ),
          ),

          // --- TOTALS ---
          const Divider(thickness: 1.5, color: Color(0xFFE2E8F0)),
          const SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text("Due Date: ${DateFormat('dd MMM yyyy').format(vm.dueDate)}", style: const TextStyle(fontSize: 8, color: Colors.redAccent, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 2),
                  const Text("Status: UNPAID", style: TextStyle(fontSize: 8, color: Color(0xFF94A3B8))),
                ],
              ),
              Row(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  const Text("TOTAL:", style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Color(0xFF64748B))),
                  const SizedBox(width: 8),
                  Text("\$${vm.total.toStringAsFixed(2)}", style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900, color: AppColors.primaryBlue)),
                ],
              ),
            ],
          ),
          
          const SizedBox(height: 24),
          
          // --- FOOTER ---
          const Center(
            child: Text(
              "Banking Details: Stanbic Bank | Acc: 9140001234 | Branch: Samora Machel",
              style: TextStyle(fontSize: 7, color: Color(0xFF94A3B8), fontStyle: FontStyle.italic),
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/dashboard/dashboard_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/models/legend.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:provider/provider.dart';

// -----------------------------------------------------------------------------
// VIEW MODEL (Data Container)
// -----------------------------------------------------------------------------
class DashboardViewModel {
  final LegendProfile profile;
  final DashboardStats stats;
  final List<Map<String, dynamic>> recentPayments;

  DashboardViewModel({
    required this.profile,
    required this.stats,
    required this.recentPayments,
  });

  // Empty State Factory (Safety Fallback)
  factory DashboardViewModel.empty() {
    return DashboardViewModel(
      profile: LegendProfile(id: "", fullName: "Staff Member", role: "STAFF"),
      stats: DashboardStats(
        totalStudents: 0,
        totalOwed: 0,
        collectedToday: 0,
        pendingInvoices: 0,
      ),
      recentPayments: [],
    );
  }
}

// -----------------------------------------------------------------------------
// DASHBOARD SCREEN UI
// -----------------------------------------------------------------------------
class DashboardScreen extends StatefulWidget {
  const DashboardScreen({super.key});

  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen> {
  late Future<DashboardViewModel> _dataFuture;

  @override
  void initState() {
    super.initState();
    _dataFuture = _loadData();
  }

  Future<void> _refreshData() async {
    setState(() {
      _dataFuture = _loadData();
    });
    await _dataFuture;
  }

  /// --------------------------------------------------------------------------
  /// DATA LOADER (Real DB Fetching)
  /// --------------------------------------------------------------------------
  Future<DashboardViewModel> _loadData() async {
    final authService = context.read<AuthService>();
    final dashboardRepo = context.read<DashboardRepository>();

    final school = authService.activeSchool;
    final user = authService.user;

    // Safety Check: If logged out or no school selected
    if (school == null || user == null) {
      return DashboardViewModel.empty();
    }

    try {
      // PowerSync is already connected via AuthService.login()
      // Just fetch the data from local SQLite cache

      // 1. Fetch Data in Parallel (Fastest way)
      final results = await Future.wait([
        dashboardRepo.getDashboardStats(school.id),
        dashboardRepo.getRecentActivity(school.id),
      ]);

      final stats = results[0] as DashboardStats;
      final recentActivity = results[1] as List<Map<String, dynamic>>;

      // 2. Construct Profile from Auth Metadata
      // We check Supabase metadata for name, or fallback to email/default
      final String fullName =
          user.userMetadata?['full_name'] ??
          user.email?.split('@')[0] ??
          'Staff Member';

      final profile = LegendProfile(
        id: user.id,
        fullName: fullName,
        role: 'OWNER', // In future, fetch actual role from 'profiles' table
      );

      return DashboardViewModel(
        profile: profile,
        stats: stats,
        recentPayments: recentActivity,
      );
    } catch (e) {
      debugPrint("Dashboard Load Error: $e");
      return DashboardViewModel.empty();
    }
  }

  // ---------------------------------------------------------------------------
  // UI BUILD
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    return FutureBuilder<DashboardViewModel>(
      future: _dataFuture,
      builder: (context, snapshot) {
        // 1. Loading
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(
              child: CircularProgressIndicator(color: AppColors.primaryBlue),
            ),
          );
        }
        // 2. Error
        else if (snapshot.hasError) {
          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            body: Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Icon(
                    Icons.error_outline,
                    color: AppColors.errorRed,
                    size: 48,
                  ),
                  const SizedBox(height: 16),
                  Text(
                    'Error: ${snapshot.error}',
                    style: const TextStyle(color: Colors.white),
                  ),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: _refreshData,
                    child: const Text("Retry"),
                  ),
                ],
              ),
            ),
          );
        }
        // 3. Data Ready
        else if (snapshot.hasData) {
          final data = snapshot.data!;
          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,
            appBar: _buildAppBar(context, data.profile),
            body: RefreshIndicator(
              onRefresh: _refreshData,
              color: AppColors.primaryBlue,
              backgroundColor: AppColors.surfaceDarkGrey,
              child: SingleChildScrollView(
                physics: const AlwaysScrollableScrollPhysics(),
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // 1. WELCOME HEADER
                    _buildWelcomeHeader(data.profile),
                    const SizedBox(height: 24),

                    // 2. PRIMARY ACTION BUTTON
                    _buildPrimaryAction(context),
                    const SizedBox(height: 24),

                    // 3. FINANCIAL OVERVIEW CARD
                    _buildFinancialOverview(data.stats),
                    const SizedBox(height: 24),

                    // 4. STATS GRID
                    _buildStatsGrid(data.stats),
                    const SizedBox(height: 32),

                    // 5. RECENT PAYMENTS
                    _buildRecentPaymentsSection(context, data.recentPayments),
                  ],
                ),
              ),
            ),
          );
        } else {
          return const Scaffold(body: Center(child: Text('No data')));
        }
      },
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGET BUILDERS
  // ---------------------------------------------------------------------------

  PreferredSizeWidget _buildAppBar(
    BuildContext context,
    LegendProfile profile,
  ) {
    return AppBar(
      backgroundColor: AppColors.backgroundBlack,
      elevation: 0,
      title: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: const BoxDecoration(
              color: AppColors.primaryBlue,
              shape: BoxShape.circle,
            ),
            child: const Icon(Icons.school, color: Colors.white, size: 20),
          ),
          const SizedBox(width: 12),
          const Text(
            AppStrings.appName,
            style: TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
              fontSize: 20,
            ),
          ),
        ],
      ),
      actions: [
        IconButton(
          icon: const Icon(Icons.notifications_outlined, color: Colors.white),
          onPressed: () =>
              context.push('${AppRoutes.dashboard}/${AppRoutes.notifications}'),
        ),
        Padding(
          padding: const EdgeInsets.only(right: 16.0, left: 8.0),
          child: GestureDetector(
            onTap: () => context.go(AppRoutes.settings),
            child: CircleAvatar(
              radius: 18,
              backgroundColor: AppColors.surfaceLightGrey,
              // Initials from Name
              child: Text(
                profile.fullName.isNotEmpty
                    ? profile.fullName[0].toUpperCase()
                    : "U",
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildWelcomeHeader(LegendProfile profile) {
    // Get School Name safely
    final schoolName =
        context.read<AuthService>().activeSchool?.name ?? "KwaLegend Academy";

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Good morning, ${profile.fullName}',
          style: const TextStyle(
            color: Colors.white,
            fontSize: 24,
            fontWeight: FontWeight.bold,
          ),
        ),
        Text(
          schoolName,
          style: const TextStyle(color: AppColors.textGrey, fontSize: 14),
        ),
      ],
    );
  }

  Widget _buildPrimaryAction(BuildContext context) {
    return SizedBox(
      width: double.infinity,
      height: 56,
      child: ElevatedButton.icon(
        onPressed: () =>
            context.push('${AppRoutes.students}/${AppRoutes.addStudent}'),
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColors.primaryBlue,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          elevation: 4,
        ),
        icon: const Icon(Icons.person_add, color: Colors.white),
        label: const Text(
          'Add New Student',
          style: TextStyle(
            color: Colors.white,
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
    );
  }

  Widget _buildFinancialOverview(DashboardStats stats) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(50)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                'Current Term Overview',
                style: TextStyle(color: AppColors.textGrey, fontSize: 12),
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: Colors.greenAccent.withAlpha(30),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: const Text(
                  'ACTIVE',
                  style: TextStyle(
                    color: Colors.greenAccent,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          const Text(
            'Financial Status',
            style: TextStyle(
              color: Colors.white,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 24),
          Row(
            children: [
              Expanded(
                child: _buildFinanceValueItem(
                  label: 'COLLECTED TODAY',
                  amount: stats.collectedToday,
                  color: AppColors.primaryBlue,
                ),
              ),
              Container(
                width: 1,
                height: 40,
                color: AppColors.surfaceLightGrey.withAlpha(50),
              ),
              const SizedBox(width: 24),
              Expanded(
                child: _buildFinanceValueItem(
                  label: 'TOTAL OWED',
                  amount: stats.totalOwed,
                  color: AppColors.errorRed,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildFinanceValueItem({
    required String label,
    required double amount,
    required Color color,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textGrey,
            fontSize: 11,
            fontWeight: FontWeight.bold,
            letterSpacing: 0.5,
          ),
        ),
        const SizedBox(height: 6),
        Text(
          '\$${amount.toStringAsFixed(2)}',
          style: TextStyle(
            color: color,
            fontSize: 22,
            fontWeight: FontWeight.bold,
          ),
        ),
      ],
    );
  }

  Widget _buildStatsGrid(DashboardStats stats) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'Enrollment Stats',
          style: TextStyle(
            color: Colors.white,
            fontSize: 18,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _buildStatCard(
                title: 'Total Students',
                value: stats.totalStudents.toString(),
                subtext: 'Active Learners',
                icon: Icons.people_outline,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: _buildStatCard(
                title: 'Pending Invoices',
                value: stats.pendingInvoices.toString(),
                subtext: 'Due this week',
                icon: Icons.description_outlined,
                isGrowth: false,
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildStatCard({
    required String title,
    required String value,
    required String subtext,
    required IconData icon,
    bool isGrowth = true,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(icon, color: AppColors.primaryBlue, size: 18),
              const SizedBox(width: 8),
              Expanded(
                child: Text(
                  title,
                  style: const TextStyle(
                    color: AppColors.textGrey,
                    fontSize: 12,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            value,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 24,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 6),
          Text(
            subtext,
            style: TextStyle(
              color: isGrowth ? Colors.greenAccent : AppColors.textGrey,
              fontSize: 12,
              fontWeight: isGrowth ? FontWeight.bold : FontWeight.normal,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildRecentPaymentsSection(
    BuildContext context,
    List<Map<String, dynamic>> payments,
  ) {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text(
              'Recent Activity',
              style: TextStyle(
                color: Colors.white,
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
            TextButton(
              onPressed: () =>
                  context.push('${AppRoutes.finance}/transactions'),
              child: const Text(
                'View All',
                style: TextStyle(color: AppColors.primaryBlue),
              ),
            ),
          ],
        ),
        const SizedBox(height: 8),
        _buildPaymentList(payments),
      ],
    );
  }

  Widget _buildPaymentList(List<Map<String, dynamic>> payments) {
    if (payments.isEmpty) {
      return Container(
        padding: const EdgeInsets.all(24),
        width: double.infinity,
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey.withAlpha(50),
          borderRadius: BorderRadius.circular(16),
        ),
        child: const Column(
          children: [
            Icon(Icons.history, color: AppColors.textGrey, size: 32),
            SizedBox(height: 8),
            Text(
              "No recent activity",
              style: TextStyle(color: AppColors.textGrey),
            ),
          ],
        ),
      );
    }

    return ListView.separated(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: payments.length,
      separatorBuilder: (ctx, i) => const SizedBox(height: 12),
      itemBuilder: (ctx, i) {
        final p = payments[i];
        final amount = (p['amount'] as num).toDouble();
        final isPayment = amount > 0; // Simple heuristic: Payments have value

        return Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.surfaceDarkGrey,
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: isPayment
                      ? Colors.green.withAlpha(30)
                      : AppColors.primaryBlue.withAlpha(30),
                  borderRadius: BorderRadius.circular(10),
                ),
                child: Icon(
                  isPayment ? Icons.attach_money : Icons.person_add_alt_1,
                  color: isPayment ? Colors.greenAccent : AppColors.primaryBlue,
                  size: 24,
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      p['name'] as String,
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 15,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '${p['desc']} ‚Ä¢ ${p['time']}',
                      style: const TextStyle(
                        color: AppColors.textGrey,
                        fontSize: 12,
                      ),
                    ),
                  ],
                ),
              ),
              if (isPayment)
                Text(
                  '+\$${amount.toStringAsFixed(2)}',
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
            ],
          ),
        );
      },
    );
  }
}

// ==========================================
// FILE: ./screens/dashboard/notifications_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:provider/provider.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/models/additional_models.dart';

class NotificationsScreen extends StatefulWidget {
  const NotificationsScreen({super.key});

  @override
  State<NotificationsScreen> createState() => _NotificationsScreenState();
}

class _NotificationsScreenState extends State<NotificationsScreen> {
  // We use Streams to listen to the DB in real-time
  Stream<List<LegendNotification>>? _notificationsStream;
  String? _schoolId;

  @override
  void initState() {
    super.initState();
    // 1. Initialize the Stream
    // We use postFrameCallback to safely access Provider in initState
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final authService = context.read<AuthService>();
      final repo = context.read<DashboardRepository>();
      
      final school = authService.activeSchool;
      if (school != null) {
        setState(() {
          _schoolId = school.id;
          _notificationsStream = repo.watchNotifications(school.id);
        });
      }
    });
  }

  // ---------------------------------------------------------------------------
  // ACTIONS (Wired to Repository)
  // ---------------------------------------------------------------------------

  Future<void> _handleMarkAsRead(String notiId) async {
    await context.read<DashboardRepository>().markAsRead(notiId);
  }

  Future<void> _handleMarkAllRead() async {
    if (_schoolId == null) return;
    
    await context.read<DashboardRepository>().markAllAsRead(_schoolId!);
    
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("All notifications marked as read"),
          backgroundColor: AppColors.successGreen,
          behavior: SnackBarBehavior.floating,
          duration: Duration(seconds: 1),
        ),
      );
    }
  }

  Future<void> _handleClearAll() async {
    if (_schoolId == null) return;

    // Show confirmation dialog first
    final confirm = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: AppColors.surfaceDarkGrey,
        title: const Text("Clear All?", style: TextStyle(color: Colors.white)),
        content: const Text("This will permanently delete all notifications.", style: TextStyle(color: AppColors.textGrey)),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: const Text("Cancel"),
          ),
          TextButton(
            onPressed: () => Navigator.pop(ctx, true),
            child: const Text("Clear", style: TextStyle(color: AppColors.errorRed)),
          ),
        ],
      ),
    );

    if (confirm == true && mounted) {
      await context.read<DashboardRepository>().clearAllNotifications(_schoolId!);
    }
  }

  void _handleNotificationTap(LegendNotification noti) {
    // 1. Mark as read immediately
    if (!noti.isRead) {
      _handleMarkAsRead(noti.id);
    }

    // 2. Handle Navigation (Smart Routing)
    // Checks the 'metadata' JSON to see if we should go somewhere
    if (noti.metadata.containsKey('invoice_id')) {
      // Example: context.push('${AppRoutes.finance}/invoice/${noti.metadata['invoice_id']}');
    } else if (noti.metadata.containsKey('student_id')) {
      context.push('${AppRoutes.students}/view/${noti.metadata['student_id']}');
    }
  }

  // ---------------------------------------------------------------------------
  // UI BUILD
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    // If stream is not initialized yet (rare, but possible on fast load)
    if (_notificationsStream == null) {
      return const Scaffold(backgroundColor: AppColors.backgroundBlack, body: Center(child: CircularProgressIndicator()));
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      
      // APP BAR
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, size: 20, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          'Notifications',
          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.playlist_remove, color: AppColors.textGrey),
            tooltip: "Clear All",
            onPressed: _handleClearAll,
          ),
          const SizedBox(width: 8),
        ],
      ),

      // LIVE BODY
      body: StreamBuilder<List<LegendNotification>>(
        stream: _notificationsStream,
        builder: (context, snapshot) {
          // 1. Loading
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }
          
          // 2. Error
          if (snapshot.hasError) {
            return Center(child: Text("Error: ${snapshot.error}", style: const TextStyle(color: AppColors.errorRed)));
          }

          final list = snapshot.data ?? [];

          // 3. Empty
          if (list.isEmpty) {
            return _buildEmptyState();
          }

          // 4. Data
          return ListView.separated(
            padding: const EdgeInsets.all(20),
            itemCount: list.length,
            separatorBuilder: (context, index) => const SizedBox(height: 16),
            itemBuilder: (context, index) {
              return _buildGlowCard(list[index]);
            },
          );
        },
      ),
            
      // BOTTOM ACTION
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20.0),
          child: SizedBox(
            height: 50,
            child: OutlinedButton(
              onPressed: _handleMarkAllRead,
              style: OutlinedButton.styleFrom(
                side: const BorderSide(color: AppColors.surfaceLightGrey),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
              ),
              child: const Text("Mark all as read", style: TextStyle(color: Colors.white)),
            ),
          ),
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGET HELPERS
  // ---------------------------------------------------------------------------

  Widget _buildGlowCard(LegendNotification noti) {
    Color accentColor;
    IconData icon;
    Color glowColor;

    switch (noti.type) {
      case NotificationType.success:
        accentColor = const Color(0xFF10B981);
        glowColor = accentColor.withAlpha(40);
        icon = Icons.check_circle;
        break;
      case NotificationType.warning:
        accentColor = const Color(0xFFF59E0B);
        glowColor = accentColor.withAlpha(40);
        icon = Icons.priority_high;
        break;
      case NotificationType.system:
      case NotificationType.insight:
        accentColor = const Color(0xFFEF4444);
        glowColor = accentColor.withAlpha(40);
        icon = Icons.error_outline;
        break;
      case NotificationType.info:
        accentColor = AppColors.primaryBlue;
        glowColor = accentColor.withAlpha(40);
        icon = Icons.info_outline;
        break;
    }

    return GestureDetector(
      onTap: () => _handleNotificationTap(noti),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(16),
          // BORDER: Transparent if read, Colored if unread
          border: Border.all(
            color: noti.isRead ? Colors.transparent : accentColor.withAlpha(50), 
            width: 1,
          ),
          // GLOW: Only if unread
          boxShadow: [
            if (!noti.isRead)
              BoxShadow(
                color: glowColor,
                blurRadius: 16,
                offset: const Offset(0, 4),
                spreadRadius: -4,
              ),
          ],
        ),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: accentColor.withAlpha(30),
                shape: BoxShape.circle,
              ),
              child: Icon(icon, color: accentColor, size: 22),
            ),
            
            const SizedBox(width: 16),
            
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        noti.title,
                        style: const TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                          fontSize: 15,
                        ),
                      ),
                      Text(
                        // Simple time formatting
                        "${noti.createdAt.hour}:${noti.createdAt.minute.toString().padLeft(2,'0')}", 
                        style: const TextStyle(color: AppColors.textGrey, fontSize: 11),
                      ),
                    ],
                  ),
                  const SizedBox(height: 6),
                  Text(
                    noti.message,
                    style: const TextStyle(
                      color: AppColors.textGrey,
                      fontSize: 13,
                      height: 1.4,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.notifications_none, size: 64, color: AppColors.textGrey.withAlpha(50)),
          const SizedBox(height: 16),
          const Text("No new notifications", style: TextStyle(color: AppColors.textGrey)),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/dashboard/statistics_screen.dart
// ==========================================

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:legend/constants/app_constants.dart';
import 'package:legend/models/legend.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:provider/provider.dart';

// -----------------------------------------------------------------------------
// VIEW MODEL (Data Container)
// -----------------------------------------------------------------------------
class StatsViewModel {
  final double totalRevenue;
  final double outstandingDebt;
  final int activeStudents;

  // Chart Data
  final List<FlSpot> revenueTrend;
  final List<Map<String, dynamic>> debtByGrade;
  final Map<String, double> paymentMethods;

  StatsViewModel({
    required this.totalRevenue,
    required this.outstandingDebt,
    required this.activeStudents,
    required this.revenueTrend,
    required this.debtByGrade,
    required this.paymentMethods,
  });

  // Empty state to avoid null crashes if DB is empty
  factory StatsViewModel.empty() {
    return StatsViewModel(
      totalRevenue: 0,
      outstandingDebt: 0,
      activeStudents: 0,
      revenueTrend: [const FlSpot(0, 0)],
      debtByGrade: [],
      paymentMethods: {},
    );
  }
}

// -----------------------------------------------------------------------------
// UI IMPLEMENTATION
// -----------------------------------------------------------------------------
class StatisticsScreen extends StatefulWidget {
  const StatisticsScreen({super.key});

  @override
  State<StatisticsScreen> createState() => _StatisticsScreenState();
}

class _StatisticsScreenState extends State<StatisticsScreen> {
  // Filters State
  String _timeFilter = 'This Term';
  String _gradeFilter = 'All Grades';

  // Async State
  late Future<StatsViewModel> _dataFuture;

  @override
  void initState() {
    super.initState();
    _dataFuture = _loadData();
  }

  /// --------------------------------------------------------------------------
  /// DATA LOADER (Real DB Fetching)
  /// --------------------------------------------------------------------------
  Future<StatsViewModel> _loadData() async {
    final authService = context.read<AuthService>();
    final dashboardRepo = context.read<DashboardRepository>();
    
    final school = authService.activeSchool;
    if (school == null) return StatsViewModel.empty();

    try {
      // 1. Fetch all required data in parallel
      final results = await Future.wait([
        dashboardRepo.getRevenueTrend(school.id),      // index 0
        dashboardRepo.getDebtByGrade(school.id),       // index 1
        dashboardRepo.getPaymentMethodStats(school.id),// index 2
        dashboardRepo.getDashboardStats(school.id),    // index 3
      ]);

      final revenueTrendRows = results[0] as List<Map<String, dynamic>>;
      final debtByGrade = results[1] as List<Map<String, dynamic>>;
      final paymentMethods = results[2] as Map<String, double>;
      final dashboardStats = results[3] as DashboardStats;

      // 2. Process Revenue Trend (SQL Date -> FlSpot)
      double calculatedRevenue = 0;
      List<FlSpot> spots = [];
      
      for (int i = 0; i < revenueTrendRows.length; i++) {
        final row = revenueTrendRows[i];
        final amount = (row['total'] as num).toDouble();
        calculatedRevenue += amount;
        // X-Axis = Index (Day 0, Day 1...), Y-Axis = Amount in Thousands (k)
        spots.add(FlSpot(i.toDouble(), amount / 1000)); 
      }

      return StatsViewModel(
        totalRevenue: calculatedRevenue,
        outstandingDebt: dashboardStats.totalOwed, // Source of Truth from Repo
        activeStudents: dashboardStats.totalStudents,
        revenueTrend: spots.isEmpty ? [const FlSpot(0, 0)] : spots,
        debtByGrade: debtByGrade,
        paymentMethods: paymentMethods,
      );

    } catch (e) {
      debugPrint("Stats Load Error: $e");
      return StatsViewModel.empty();
    }
  }

  // ---------------------------------------------------------------------------
  // UI BUILD
  // ---------------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,

      // HEADER
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new, size: 20, color: Colors.white),
          onPressed: () => context.pop(),
        ),
        title: const Text(
          'Analytics',
          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.download, color: AppColors.primaryBlue),
            tooltip: "Export Report",
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Exporting PDF...'), backgroundColor: AppColors.surfaceLightGrey),
              );
            },
          ),
        ],
      ),

      // BODY
      body: FutureBuilder<StatsViewModel>(
        future: _dataFuture,
        builder: (context, snapshot) {
          // 1. Loading
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
          }

          // 2. Error
          if (snapshot.hasError) {
             return Center(child: Text("Error: ${snapshot.error}", style: const TextStyle(color: AppColors.errorRed)));
          }

          // 3. Data Ready
          final _data = snapshot.data!;

          return SingleChildScrollView(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // 1. FILTER BAR
                SingleChildScrollView(
                  scrollDirection: Axis.horizontal,
                  child: Row(
                    children: [
                      _buildFilterChip('This Term', _timeFilter, (val) => setState(() => _timeFilter = val)),
                      const SizedBox(width: 8),
                      _buildFilterChip('Last Term', _timeFilter, (val) => setState(() => _timeFilter = val)),
                      const SizedBox(width: 8),
                      _buildFilterChip('All Grades', _gradeFilter, (val) => setState(() => _gradeFilter = val)),
                    ],
                  ),
                ),

                const SizedBox(height: 24),

                // 2. KPI CARDS
                Row(
                  children: [
                    Expanded(
                      child: _buildKpiCard(
                        title: "Revenue (7 Days)",
                        value: "\$${(_data.totalRevenue).toStringAsFixed(0)}",
                        // Trend is removed because we need previous period data to calculate it truthfully
                        trend: "Real-time", 
                        isPositive: true,
                        icon: Icons.show_chart,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: _buildKpiCard(
                        title: "Total Outstanding",
                        value: "\$${(_data.outstandingDebt / 1000).toStringAsFixed(1)}k",
                        trend: "Unpaid Fees",
                        isPositive: false,
                        icon: Icons.warning_amber,
                        color: AppColors.errorRed,
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 32),

                // 3. REVENUE TREND
                const Text(
                  "Income Trajectory",
                  style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 4),
                const Text(
                  "Daily collections (in thousands)",
                  style: TextStyle(color: AppColors.textGrey, fontSize: 12),
                ),
                const SizedBox(height: 16),
                Container(
                  height: 200,
                  padding: const EdgeInsets.only(right: 16, top: 24, bottom: 12),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
                  ),
                  child: LineChart(
                    LineChartData(
                      gridData: const FlGridData(show: false),
                      titlesData: const FlTitlesData(show: false),
                      borderData: FlBorderData(show: false),
                      minY: 0,
                      lineBarsData: [
                        LineChartBarData(
                          spots: _data.revenueTrend,
                          isCurved: true,
                          color: AppColors.primaryBlue,
                          barWidth: 3,
                          isStrokeCapRound: true,
                          dotData: const FlDotData(show: true),
                          belowBarData: BarAreaData(
                            show: true,
                            color: AppColors.primaryBlue.withAlpha(30),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),

                const SizedBox(height: 32),

                // 4. DEBT BY GRADE
                const Text(
                  "Debt Distribution",
                  style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceDarkGrey,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Column(
                    children: _data.debtByGrade.isEmpty 
                    ? [const Padding(padding: EdgeInsets.all(8.0), child: Text("No debt records found.", style: TextStyle(color: AppColors.textGrey)))]
                    : _data.debtByGrade.map((item) {
                        // Dynamic Max for Scaling Bars correctly
                        // Find max debt in the list to normalize the bar width
                        final double maxDebtInList = _data.debtByGrade.fold(0.0, (prev, e) {
                          final amt = (e['amount'] as num).toDouble();
                          return amt > prev ? amt : prev;
                        });
                        
                        final double amount = (item['amount'] as num).toDouble();
                        final double pct = maxDebtInList > 0 ? (amount / maxDebtInList).clamp(0.0, 1.0) : 0.0;
                        
                        return Padding(
                          padding: const EdgeInsets.only(bottom: 12.0),
                          child: Row(
                            children: [
                              SizedBox(
                                width: 60,
                                child: Text(
                                  item['grade'] ?? 'N/A',
                                  style: const TextStyle(color: AppColors.textGrey, fontWeight: FontWeight.bold, fontSize: 12),
                                ),
                              ),
                              Expanded(
                                child: Stack(
                                  children: [
                                    Container(
                                      height: 8,
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceLightGrey.withAlpha(50),
                                        borderRadius: BorderRadius.circular(4),
                                      ),
                                    ),
                                    FractionallySizedBox(
                                      widthFactor: pct,
                                      child: Container(
                                        height: 8,
                                        decoration: BoxDecoration(
                                          color: pct > 0.7 ? AppColors.errorRed : Colors.orangeAccent,
                                          borderRadius: BorderRadius.circular(4),
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(width: 12),
                              SizedBox(
                                width: 60,
                                child: Text(
                                  "\$${amount.toStringAsFixed(0)}",
                                  textAlign: TextAlign.end,
                                  style: const TextStyle(color: Colors.white, fontSize: 12),
                                ),
                              ),
                            ],
                          ),
                        );
                      }).toList(),
                  ),
                ),

                const SizedBox(height: 40),
              ],
            ),
          );
        },
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // WIDGET HELPERS
  // ---------------------------------------------------------------------------

  Widget _buildFilterChip(String label, String currentSelection, Function(String) onSelect) {
    final bool isSelected = label == currentSelection;
    return GestureDetector(
      onTap: () => onSelect(label),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.primaryBlue : AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: isSelected ? AppColors.primaryBlue : AppColors.surfaceLightGrey.withAlpha(50),
          ),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: isSelected ? Colors.white : AppColors.textGrey,
            fontWeight: FontWeight.bold,
            fontSize: 12,
          ),
        ),
      ),
    );
  }

  Widget _buildKpiCard({
    required String title,
    required String value,
    required String trend,
    required bool isPositive,
    required IconData icon,
    Color? color,
  }) {
    final themeColor = color ?? AppColors.primaryBlue;
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceDarkGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(20)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: themeColor.withAlpha(20),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(icon, color: themeColor, size: 20),
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: isPositive ? AppColors.successGreen.withAlpha(20) : AppColors.errorRed.withAlpha(20),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Text(
                  trend,
                  style: TextStyle(
                    color: isPositive ? AppColors.successGreen : AppColors.errorRed,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Text(title, style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
          const SizedBox(height: 4),
          Text(value, style: const TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/dashboard/notifications/noti_viewer.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:legend/repo/dashboard_repo.dart';
import 'package:provider/provider.dart'; 
import 'package:legend/constants/app_constants.dart';
import 'package:legend/models/additional_models.dart';

class NotificationDetailScreen extends StatelessWidget {
  final LegendNotification notification;

  const NotificationDetailScreen({super.key, required this.notification});

  @override
  Widget build(BuildContext context) {
    // 1. Determine Styles based on Type
    Color accentColor;
    IconData icon;
    String statusLabel;

    switch (notification.type) {
      case NotificationType.success:
        accentColor = AppColors.successGreen;
        icon = Icons.check_circle_outline;
        statusLabel = "SUCCESS";
        break;
      case NotificationType.warning:
        accentColor = Colors.orangeAccent;
        icon = Icons.warning_amber_rounded;
        statusLabel = "ATTENTION";
        break;
      case NotificationType.insight:
        accentColor = const Color(0xFF6366F1); // Indigo
        icon = Icons.auto_awesome;
        statusLabel = "INSIGHT";
        break;
      case NotificationType.system:
        accentColor = AppColors.errorRed;
        icon = Icons.dns_outlined;
        statusLabel = "SYSTEM";
        break;
      case NotificationType.info:
        accentColor = AppColors.primaryBlue;
        icon = Icons.info_outline;
        statusLabel = "INFO";
        break;
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundBlack,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.delete_outline, color: AppColors.textGrey),
            tooltip: "Delete Notification",
            onPressed: () async {
              // WIRED: Delete Logic
              final confirm = await showDialog<bool>(
                context: context,
                builder: (ctx) => AlertDialog(
                  backgroundColor: AppColors.surfaceDarkGrey,
                  title: const Text("Delete?", style: TextStyle(color: Colors.white)),
                  content: const Text("This cannot be undone.", style: TextStyle(color: AppColors.textGrey)),
                  actions: [
                    TextButton(
                      onPressed: () => Navigator.pop(ctx, false),
                      child: const Text("Cancel"),
                    ),
                    TextButton(
                      onPressed: () => Navigator.pop(ctx, true),
                      child: const Text("Delete", style: TextStyle(color: AppColors.errorRed)),
                    ),
                  ],
                ),
              );

              if (confirm == true && context.mounted) {
                // Call Repository
                await context.read<DashboardRepository>().deleteNotification(notification.id);
                if (context.mounted) {
                  Navigator.pop(context); // Close detail screen
                }
              }
            },
          ),
        ],
      ),
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // ---------------------------------------------------------
                    // 1. HEADER ICON (Glow Effect)
                    // ---------------------------------------------------------
                    Center(
                      child: Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          color: accentColor.withAlpha(20),
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: accentColor.withAlpha(40),
                              blurRadius: 24,
                              spreadRadius: 8,
                            ),
                          ],
                        ),
                        child: Icon(icon, color: accentColor, size: 40),
                      ),
                    ),
                    const SizedBox(height: 32),

                    // ---------------------------------------------------------
                    // 2. METADATA ROW
                    // ---------------------------------------------------------
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        _buildTag(statusLabel, accentColor),
                        const SizedBox(width: 12),
                        Text(
                          DateFormat('MMM d, h:mm a').format(notification.createdAt),
                          style: const TextStyle(color: AppColors.textGrey, fontSize: 13),
                        ),
                      ],
                    ),
                    const SizedBox(height: 24),

                    // ---------------------------------------------------------
                    // 3. CONTENT
                    // ---------------------------------------------------------
                    Text(
                      notification.title,
                      textAlign: TextAlign.center,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 16),
                    Container(
                      width: double.infinity,
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        color: AppColors.surfaceDarkGrey,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: AppColors.surfaceLightGrey.withAlpha(30)),
                      ),
                      child: Text(
                        notification.message,
                        style: const TextStyle(
                          color: Colors.white70,
                          fontSize: 15,
                          height: 1.6,
                        ),
                      ),
                    ),

                    // ---------------------------------------------------------
                    // 4. CONTEXT DATA (If JSON Payload exists)
                    // ---------------------------------------------------------
                    if (notification.metadata.isNotEmpty) ...[
                      const SizedBox(height: 24),
                      const Text(
                        "ADDITIONAL DATA",
                        style: TextStyle(
                          color: AppColors.textGrey,
                          fontSize: 11,
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1.2,
                        ),
                      ),
                      const SizedBox(height: 12),
                      _buildMetadataGrid(notification.metadata),
                    ],
                  ],
                ),
              ),
            ),

            // -----------------------------------------------------------------
            // 5. ACTION BUTTON (Smart)
            // -----------------------------------------------------------------
            _buildActionButton(context, notification.metadata),
          ],
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // HELPERS
  // ---------------------------------------------------------------------------

  Widget _buildTag(String text, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
      decoration: BoxDecoration(
        color: color.withAlpha(30),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: color.withAlpha(50)),
      ),
      child: Text(
        text,
        style: TextStyle(color: color, fontSize: 11, fontWeight: FontWeight.bold),
      ),
    );
  }

  Widget _buildMetadataGrid(Map<String, dynamic> data) {
    // Filters out complex objects, just shows simple Key-Values
    final simpleData = data.entries
        .where((e) => e.value is String || e.value is num || e.value is bool)
        .toList();

    return GridView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        childAspectRatio: 3.5,
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
      ),
      itemCount: simpleData.length,
      itemBuilder: (context, index) {
        final entry = simpleData[index];
        return Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          decoration: BoxDecoration(
            color: AppColors.surfaceLightGrey.withAlpha(30),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                entry.key.toUpperCase().replaceAll('_', ' '),
                style: TextStyle(color: AppColors.textGrey.withAlpha(150), fontSize: 9, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 2),
              Text(
                entry.value.toString(),
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
                style: const TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.w500),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildActionButton(BuildContext context, Map<String, dynamic> metadata) {
    // LOGIC: Check metadata keys to determine destination
    String label = "Close";
    VoidCallback onTap = () => Navigator.pop(context);
    IconData btnIcon = Icons.close;
    bool isPrimary = false;

    // WIRED: Smart Routing based on Metadata keys
    if (metadata.containsKey('invoice_id')) {
      label = "View Invoice";
      btnIcon = Icons.receipt_long;
      isPrimary = true;
      onTap = () {
        // Route: /finance/invoice/:invoiceId
        final invoiceId = metadata['invoice_id'];
        context.push('${AppRoutes.finance}/${AppRoutes.viewInvoice}'.replaceAll(':invoiceId', invoiceId));
      };
    } else if (metadata.containsKey('student_id')) {
      label = "View Student Profile";
      btnIcon = Icons.person_search;
      isPrimary = true;
      onTap = () {
        // Route: /students/view/:studentId
        final studentId = metadata['student_id'];
        context.push('${AppRoutes.students}/view/$studentId');
      };
    } else if (metadata.containsKey('action_url')) {
      label = "Open Link";
      btnIcon = Icons.open_in_new;
      isPrimary = true;
      onTap = () {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("External links disabled in offline mode.")));
      };
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: const BoxDecoration(
        border: Border(top: BorderSide(color: AppColors.surfaceLightGrey, width: 0.5)),
        color: AppColors.surfaceDarkGrey,
      ),
      child: SafeArea(
        top: false,
        child: SizedBox(
          width: double.infinity,
          height: 50,
          child: ElevatedButton.icon(
            onPressed: onTap,
            style: ElevatedButton.styleFrom(
              backgroundColor: isPrimary ? AppColors.primaryBlue : AppColors.surfaceLightGrey,
              foregroundColor: Colors.white,
              elevation: isPrimary ? 4 : 0,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            ),
            icon: Icon(btnIcon, size: 18),
            label: Text(label, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./screens/all_screens_export.dart
// ==========================================

export 'auth/change_password.dart';
export 'auth/login_screen.dart';
export 'auth/forgot_password.dart';
export 'auth/sign_up_screen.dart';
export 'dashboard/dashboard_screen.dart';
export 'dashboard/notifications_screen.dart';
export 'dashboard/statistics_screen.dart';
export 'students/students_screen.dart';
export 'finance/finance_screen.dart';
export 'settings/settings_screen.dart';
// ==========================================
// FILE: ./app_init.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:legend/services/database_serv.dart';

class AppInit {
  static Future<void> initialize() async {
    WidgetsFlutterBinding.ensureInitialized();

    // 1. Initialize Supabase first
    await Supabase.initialize(
      url: AppEnv.supabaseUrl,
      anonKey: AppEnv.supabaseAnonKey,
      debug: false,
    );
    debugPrint("‚úÖ Supabase initialized");

    // 2. Initialize PowerSync Database (offline-first layer)
    await DatabaseService().initializeStandalone();
    debugPrint("‚úÖ PowerSync standalone mode ready (awaiting auth)");

    // Simulate startup delay for splash effect
    await Future.delayed(const Duration(milliseconds: 500));
    debugPrint("‚úÖ AppInit complete");
  }
}

class AppEnv {
  //Secrets Cannot be implemented on a project that is not working yet.
  static const bool isProduction = bool.fromEnvironment('dart.vm.product');
  static const String powerSyncUrl =
      "https://6943ea857e2a07e6df7daa4e.powersync.journeyapps.com";
  static const String supabaseUrl = "https://hcxvsygvihhdkkyynqzw.supabase.co";
  static const String supabaseAnonKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjeHZzeWd2aWhoZGtreXlucXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTA3OTEsImV4cCI6MjA3ODQ4Njc5MX0.Tn1vzaNWHW9bV6FchGU_du-HQ9QDDXphxWJL1cM75qY";
}

// ==========================================
// FILE: ./app.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:legend/services/auth/auth_serv.dart';
import 'package:provider/provider.dart';
import 'app_router.dart';
import 'constants/app_constants.dart';

class KwaLegendApp extends StatefulWidget {
  const KwaLegendApp({super.key});

  @override
  State<KwaLegendApp> createState() => _KwaLegendAppState();
}

class _KwaLegendAppState extends State<KwaLegendApp> {
  // We store the router here so it doesn't get recreated on every build
  late final LegendRouter _legendRouter;

  @override
  void initState() {
    super.initState();
    // Read auth service once to initialize router
    final authService = context.read<AuthService>();
    _legendRouter = LegendRouter(authService);
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: 'KwaLegend',
      debugShowCheckedModeBanner: false,
      
      // Theme Config
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: AppColors.backgroundBlack,
        primaryColor: AppColors.primaryBlue,
        colorScheme: const ColorScheme.dark(
          primary: AppColors.primaryBlue,
          secondary: AppColors.primaryBlueLight,
          surface: AppColors.surfaceDarkGrey,
        ),
        useMaterial3: true,
      ),

      // CONNECT THE SMART ROUTER
      routerConfig: _legendRouter.router,
    );
  }
}